{% extends 'be/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* Stili generali - dimensioni ridotte */
    .project-header {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #0d6efd;
    }

    .project-title {
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        font-size: 1.2rem;
    }

    .project-title i {
        margin-right: 0.5rem;
        color: #0d6efd;
    }

    .project-description {
        color: #6c757d;
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    /* Stili per i documenti - thumbnails più piccole */
    .documents-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0;
    }

    .document-card {
        position: relative;
        width: 90px;  /* Ridotto da 120px */
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.2s;
        cursor: pointer;
    }

    .document-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .document-thumb {
        height: 75px;  /* Ridotto da 100px */
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 0.25rem;
        overflow: hidden;
    }

    .document-icon {
        font-size: 1.5rem;  /* Ridotto da 2rem */
        color: #6c757d;
    }

    .document-icon.pdf { color: #dc3545; }
    .document-icon.doc, .document-icon.docx { color: #0d6efd; }
    .document-icon.xls, .document-icon.xlsx { color: #198754; }
    .document-icon.ppt, .document-icon.pptx { color: #fd7e14; }
    .document-icon.txt { color: #6c757d; }
    .document-icon.img { color: #6f42c1; }

    .document-name {
        font-size: 0.7rem;  /* Ridotto da 0.75rem */
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 0 0.5rem;
    }

    .document-actions {
        position: absolute;
        top: 3px;
        right: 3px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .document-card:hover .document-actions {
        opacity: 1;
    }

    .delete-file-btn {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        width: 20px;  /* Ridotto da 24px */
        height: 20px;  /* Ridotto da 24px */
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .delete-file-btn i {
        font-size: 10px;  /* Ridotto da 12px */
    }

    /* Stili per le notes */
    .notes-container {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;  /* Ridotto da 2rem */
    }

    .notes-toolbar {
        padding: 0.5rem;  /* Ridotto da 0.75rem */
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }

    .notes-editor {
        padding: 0.75rem;  /* Ridotto da 1rem */
        min-height: 150px;  /* Ridotto da 200px */
    }

    /* Stili per Ask Anything */
    .ask-container {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;  /* Ridotto da 1.5rem */
        margin-bottom: 1.5rem;  /* Ridotto da 2rem */
    }

    .chat-messages {
        max-height: 350px;
        overflow-y: auto;
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: white;
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }

    .message {
        position: relative;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        max-width: 80%;
    }

    .user-message {
        background-color: #e9f5ff;
        border-top-right-radius: 0;
        margin-left: auto;
        margin-right: 0;
        align-self: flex-end;
    }

    .ai-message {
        background-color: #f1f3f5;
        border-top-left-radius: 0;
        margin-right: auto;
        margin-left: 0;
        align-self: flex-start;
    }

    .message-header {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .message-content {
        word-wrap: break-word;
    }

    .chat-input-container {
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .chat-input {
        resize: none;
        border-radius: 0.5rem;
        padding-right: 60px;
    }

    .chat-input-send-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        border-radius: 50%;
        height: 40px;
        width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #0d6efd;
        color: white;
        border: none;
    }

    .chat-input-send-btn:hover {
        background-color: #0b5ed7;
    }

    .chat-input-send-btn i {
        font-size: 1.2rem;
    }

    .loader {
        text-align: center;
        margin-top: 0.5rem;
    }

    /* Sources styles */
    .sources-wrapper {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .source-card {
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 1rem !important;
    }

    .source-header {
        background-color: #f8f9fa;
        font-weight: 500;
    }

    .source-icon {
        font-size: 1.25rem;
    }

    .source-content {
        padding: 1rem;
    }

    .source-chunk {
        font-family: var(--bs-font-monospace);
        font-size: 0.875rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 200px;
        overflow-y: auto;
        border-left: 3px solid #0d6efd;
    }

    .empty-project {
        text-align: center;
        padding: 2rem 1.5rem;  /* Ridotto da 3rem 2rem */
        background-color: #f8f9fa;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;  /* Ridotto da 2rem */
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.2s;
    }

    .empty-project:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .empty-project i {
        font-size: 3rem;  /* Ridotto da 4rem */
        color: #dee2e6;
        margin-bottom: 0.75rem;  /* Ridotto da 1rem */
    }

    /* Bottoni in basso */
    .action-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 1.5rem;  /* Ridotto da 2rem */
        padding-top: 0.75rem;  /* Ridotto da 1rem */
        border-top: 1px solid #dee2e6;
    }

    .card-header .document-count {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .card-body {
        padding: 0.75rem;  /* Ridotto da 1rem */
    }

    /* Keys hint for chat */
    .keys-hint {
        display: block;
        text-align: right;
        color: #6c757d;
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    /* Chat history and current conversation separator */
    .chat-history {
        border-bottom: 1px dashed #dee2e6;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    .current-conversation {
        padding-top: 0.5rem;
    }

    /* Message timestamp */
    .message-time {
        font-size: 0.7rem;
        color: #adb5bd;
        margin-top: 0.25rem;
        text-align: right;
    }

    .app-content-header {
        margin-bottom: 0.75rem;  /* Ridotto */
    }

    .app-content-header h3 {
        font-size: 1.5rem;  /* Ridotto */
    }
</style>
{% endblock %}

{% block content %}
{# INIZIO NAVIGAZIONE SOTTONAVBAR #}
<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h3 class="mb-0">Project Details</h3>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'projects_list' %}">Projects</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ project.name }}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{# FINE NAVIGAZIONE SOTTONAVBAR #}

{% if messages %}
<div class="container-fluid">
    <div class="messages mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="container-fluid">
    <!-- Project Header - Ridotto e semplificato -->
    <div class="project-header">
        <div class="row">
            <div class="col-md-9">
                <h4 class="project-title">
                    <i class="bi bi-kanban"></i>
                    {{ project.name }}
                </h4>
                <p class="project-description">
                    {% if project.description %}
                        {{ project.description }}
                    {% else %}
                        <span class="text-muted">No description provided</span>
                    {% endif %}
                </p>
            </div>
            <div class="col-md-3 text-md-end">
                <span class="badge bg-success badge-status">Active</span>
                <p class="small text-muted mt-1">Created: {{ project.created_at|date:"M d, Y" }}</p>
            </div>
        </div>
    </div>

    <!-- Documents Section -->
    <h5 class="section-title">Documents</h5>

    {% if project_files %}
        <!-- Upload Actions Card - Semplificata -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                    <i class="bi bi-file-earmark-plus me-1"></i> Upload Files
                </button>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#uploadFolderModal">
                    <i class="bi bi-folder-plus me-1"></i> Upload Folder
                </button>
                <div class="document-count badge bg-secondary">
                    {{ project_files|length }} Files
                </div>
            </div>
            <div class="card-body">
                <div class="documents-container">
                {% for file in project_files %}
                    <div class="document-card">
                        <div class="document-thumb" data-bs-toggle="modal" data-bs-target="#documentModal"
                             data-file-id="{{ file.id }}"
                             data-file-name="{{ file.filename }}"
                             data-file-url="/media/projects/{{ project.user.id }}/{{ project.id }}/{{ file.filename }}">
                            {% if file.extension == '.pdf' %}
                                <i class="bi bi-file-earmark-pdf document-icon pdf"></i>
                            {% elif file.extension == '.doc' or file.extension == '.docx' %}
                                <i class="bi bi-file-earmark-word document-icon doc"></i>
                            {% elif file.extension == '.xls' or file.extension == '.xlsx' %}
                                <i class="bi bi-file-earmark-excel document-icon xls"></i>
                            {% elif file.extension == '.ppt' or file.extension == '.pptx' %}
                                <i class="bi bi-file-earmark-slides document-icon ppt"></i>
                            {% elif file.extension == '.txt' %}
                                <i class="bi bi-file-earmark-text document-icon txt"></i>
                            {% elif file.extension == '.jpg' or file.extension == '.jpeg' or file.extension == '.png' or file.extension == '.gif' %}
                                <img src="/media/projects/{{ project.user.id }}/{{ project.id }}/{{ file.filename }}"
                                     alt="{{ file.filename }}"
                                     style="max-height: 100%; max-width: 100%; object-fit: contain;">
                            {% else %}
                                <i class="bi bi-file-earmark document-icon"></i>
                            {% endif %}
                        </div>
                        <div class="document-name" title="{{ file.filename }}">
                            {{ file.filename|truncatechars:15 }}
                        </div>
                        <div class="document-actions">
                            <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn"
                                    data-file-id="{{ file.id }}"
                                    data-file-name="{{ file.filename }}"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteFileModal">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="empty-project mb-3">
            <i class="bi bi-file-earmark-x"></i>
            <h5>No documents yet</h5>
            <p class="text-muted">Upload files to start working with this project.</p>
            <div class="mt-2">
                <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                    <i class="bi bi-file-earmark-plus me-1"></i> Upload Files
                </button>
                <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadFolderModal">
                    <i class="bi bi-folder-plus me-1"></i> Upload Folder
                </button>
            </div>
        </div>
    {% endif %}


    <!-- Notes Section - Semplificata -->
    <h5 class="section-title">Notes</h5>
    <form method="post" action="{% url 'project' %}" id="notes-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="save_notes">
        <input type="hidden" name="project_id" value="{{ project.id }}">

        <div class="notes-container">
            <div class="notes-toolbar">
                <div class="btn-group me-1">
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-type-bold"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-type-italic"></i>
                    </button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-list-ul"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-link"></i>
                    </button>
                </div>
            </div>

            <div class="notes-editor">
                <textarea class="form-control border-0" name="notes" id="project-notes" rows="5" style="resize: none;"
                    placeholder="Enter your project notes here...">{{ project.notes }}</textarea>
            </div>
        </div>

        <div class="mt-2 text-end">
            <button type="submit" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-save me-1"></i> Save Notes
            </button>
        </div>
    </form>

    <!-- Ask Anything Section - AJAX enabled -->
    <h5 class="section-title">Ask Anything</h5>

    <div class="ask-container">
        <div class="chat-messages" id="chat-messages">
            {% if conversation_history %}
                {% for message in conversation_history %}
                    <div class="message {% if message.is_user %}user-message{% else %}ai-message{% endif %}">
                        <div class="message-header">
                            {% if message.is_user %}You{% else %}AI Assistant{% endif %}
                        </div>
                        <div class="message-content">
                            {{ message.content|linebreaks }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-chat-square-text mb-2" style="font-size: 2.5rem; color: #dee2e6;"></i>
                    <h5>Ask me anything about your documents</h5>
                    <p class="text-muted small">I can analyze your project files and answer questions about their content.</p>
                    <div class="mt-2">
                        <p><strong>Example questions:</strong></p>
                        <ul class="text-start d-inline-block small">
                            <li>Summarize the main points from all documents</li>
                            <li>What does document X say about topic Y?</li>
                            <li>Compare the information in these documents</li>
                        </ul>
                    </div>
                </div>
            {% endif %}

            {% if answer %}
                <div class="message ai-message" id="last-response">
                    <div class="message-header">
                        AI Assistant
                    </div>
                    <div class="message-content">
                        {{ answer|linebreaks }}

                        {% if sources %}
                            <div class="sources-wrapper mt-3">
                                <button class="btn btn-sm btn-outline-primary w-100" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#sourcesList"
                                    aria-expanded="false" aria-controls="sourcesList">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    Show Sources ({{ sources|length }})
                                    <i class="bi bi-chevron-down ms-2"></i>
                                </button>

                                <div class="collapse mt-2" id="sourcesList">
                                    <div class="sources-list">
                                        {% for source in sources %}
                                            <div class="card mb-2 source-card">
                                                <div class="card-header d-flex align-items-center source-header p-2">
                                                    {% if source.type == ".pdf" %}
                                                        <i class="bi bi-file-earmark-pdf source-icon me-2"></i>
                                                    {% elif source.type == ".docx" or source.type == ".doc" %}
                                                        <i class="bi bi-file-earmark-word source-icon me-2"></i>
                                                    {% elif source.type == ".txt" %}
                                                        <i class="bi bi-file-earmark-text source-icon me-2"></i>
                                                    {% elif source.type == ".csv" %}
                                                        <i class="bi bi-file-earmark-spreadsheet source-icon me-2"></i>
                                                    {% elif source.type == ".jpg" or source.type == ".jpeg" or source.type == ".png" or source.type == ".gif" %}
                                                        <i class="bi bi-file-earmark-image source-icon me-2"></i>
                                                    {% else %}
                                                        <i class="bi bi-file-earmark source-icon me-2"></i>
                                                    {% endif %}
                                                    <span class="small">{{ source.filename }}</span>
                                                </div>
                                                <div class="card-body source-content p-2">
                                                    <div class="source-chunk p-2 bg-light rounded">
                                                        {{ source.content|linebreaks }}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <div id="ajax-ask-form">
            <div class="chat-input-container">
                <textarea class="form-control chat-input mb-2" id="question-input" rows="2"
                    placeholder="Type your question here..." required></textarea>
                <div class="d-grid">
                    <button type="button" id="send-question-btn" class="btn btn-primary btn-sm">
                        <i class="bi bi-send me-1"></i> Send
                    </button>
                </div>
            </div>
        </div>

        <div class="loader mt-2" id="loading-indicator" style="display: none;">
            <div class="spinner-border text-primary spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="small mt-1">Processing your question...</p>
        </div>
    </div>

    <!-- Hidden form for AJAX fallback -->
    <form id="hidden-ask-form" method="post" action="{% url 'project' %}" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="ask_question">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <input type="hidden" name="question" id="hidden-question-input">
    </form>

    <!-- Action Buttons (Bottom) -->
    <div class="action-buttons">
        <a href="{% url 'projects_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Back to Projects
        </a>
        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">
            <i class="bi bi-trash me-1"></i> Delete Project
        </button>
    </div>
</div>

<!-- Modal: View Document -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentModalLabel">Document Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Contenitore per diverse visualizzazioni -->
                <div id="document-preview-container">
                    <!-- Iframe per PDF -->
                    <div class="ratio ratio-16x9" id="iframe-container">
                        <iframe id="document-frame" src="" allowfullscreen style="display:none;"></iframe>
                    </div>

                    <!-- Contenitore per immagini -->
                    <div class="text-center d-none" id="image-container">
                        <img id="image-preview" class="img-fluid" src="" alt="Document Preview">
                    </div>

                    <!-- Messaggio per tipi di file non supportati -->
                    <div class="alert alert-info d-none" id="unsupported-file-message">
                        <i class="bi bi-info-circle me-2"></i>
                        <span>Questo tipo di file non può essere visualizzato in anteprima. Utilizzare i pulsanti qui sotto per aprirlo o scaricarlo.</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary btn-sm" id="open-document" target="_blank">
                    <i class="bi bi-box-arrow-up-right me-1"></i> Apri in nuova scheda
                </a>
                <a href="#" class="btn btn-success btn-sm" id="download-document" download>
                    <i class="bi bi-download me-1"></i> Download
                </a>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Upload Files -->
<div class="modal fade" id="uploadFilesModal" tabindex="-1" aria-labelledby="uploadFilesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFilesModalLabel">Upload Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'project' %}" enctype="multipart/form-data" id="upload-files-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_files">
                    <input type="hidden" name="project_id" value="{{ project.id }}">

                    <div class="mb-3">
                        <label for="project-files" class="form-label">Select Files</label>
                        <input type="file" class="form-control" id="project-files" name="files[]" multiple
                            accept=".pdf,.docx,.doc,.txt,.csv,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                        <div class="form-text">
                            Supported: PDF, DOCX, TXT, CSV, XLS, XLSX, PPT, PPTX, JPG, PNG, GIF.
                        </div>
                    </div>

                    <div id="selected-files-preview" class="d-none mt-3">
                        <h6>Selected Files</h6>
                        <div id="files-preview-list" class="list-group">
                            <!-- Selected files will be shown here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="upload-files-form" class="btn btn-primary btn-sm">
                    <i class="bi bi-cloud-upload me-1"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Upload Folder -->
<div class="modal fade" id="uploadFolderModal" tabindex="-1" aria-labelledby="uploadFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFolderModalLabel">Upload Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small">
                    <i class="bi bi-info-circle me-2"></i>
                    Select an entire folder to upload all its contents at once.
                </div>

                <form method="post" action="{% url 'project' %}" enctype="multipart/form-data" id="upload-folder-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_folder">
                    <input type="hidden" name="project_id" value="{{ project.id }}">

                    <div class="mb-3">
                        <label for="project-folder" class="form-label">Select Folder</label>
                        <input type="file" class="form-control" id="project-folder" name="folder[]" webkitdirectory directory multiple
                            accept=".pdf,.docx,.doc,.txt,.csv,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                    </div>

                    <div id="selected-folder-info" class="d-none mt-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Folder Summary</h6>
                                <p class="mb-1"><strong>Folder name:</strong> <span id="folder-name"></span></p>
                                <p class="mb-1"><strong>Total files:</strong> <span id="file-count">0</span></p>
                                <p class="mb-0"><strong>Valid files:</strong> <span id="valid-files">0</span></p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="upload-folder-form" class="btn btn-primary btn-sm">
                    <i class="bi bi-cloud-upload me-1"></i> Upload Folder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Delete Project Confirmation -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteProjectModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Warning: This action cannot be undone!
                </div>
                <p>Are you sure you want to delete this project and all its associated files?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'projects_list' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_project">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash me-1"></i> Delete Project
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Delete File Confirmation -->
<div class="modal fade" id="deleteFileModal" tabindex="-1" aria-labelledby="deleteFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteFileModalLabel">Conferma eliminazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Attenzione: Questa operazione non può essere annullata!
                </div>
                <p>Sei sicuro di voler eliminare il file <strong id="delete-file-name"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                <form method="post" action="{% url 'project' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_file">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <input type="hidden" name="file_id" id="delete-file-id">
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash me-1"></i> Elimina file
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // AJAX for Ask Anything section
    const sendButton = document.getElementById('send-question-btn');
    const questionInput = document.getElementById('question-input');
    const chatMessages = document.getElementById('chat-messages');
    const loadingIndicator = document.getElementById('loading-indicator');

    if (sendButton && questionInput) {
        sendButton.addEventListener('click', function() {
            // Handle form submission
            sendQuestion();
        });

        // Handle Enter key in chat input
        questionInput.addEventListener('keydown', function(e) {
            // Check if Enter was pressed without Shift key (Shift+Enter for new line)
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
                e.preventDefault(); // Prevent default behavior (new line)
                if (!sendButton.disabled) {
                    sendQuestion();
                }
            }
        });

        // Function to send question via AJAX
        function sendQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            // Disable input and button
            questionInput.disabled = true;
            sendButton.disabled = true;

            // Show loading
            loadingIndicator.style.display = 'block';

            // Add user message to chat
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.innerHTML = `
                <div class="message-header">You</div>
                <div class="message-content">${question.replace(/\n/g, '<br>')}</div>
            `;
            chatMessages.appendChild(userMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Prepare form data
            const formData = new FormData();
            formData.append('action', 'ask_question');
            formData.append('project_id', '{{ project.id }}');
            formData.append('question', question);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            // Make AJAX request
            fetch('{% url "project" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                } else {
                    // If response is not JSON, extract data we need
                    return response.text().then(html => {
                        // Create a temporary element to parse the HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;

                        // Find the answer and sources in the HTML
                        const answerElement = tempDiv.querySelector('#last-response .message-content');
                        const answer = answerElement ? answerElement.innerHTML : 'No answer found';

                        // Extract sources if available
                        const sourceElements = tempDiv.querySelectorAll('.source-card');
                        const sources = [];

                        sourceElements.forEach(element => {
                            const filenameElement = element.querySelector('.source-header span');
                            const contentElement = element.querySelector('.source-chunk');
                            const typeClass = element.querySelector('.source-icon').className;

                            let type = '.txt'; // Default
                            if (typeClass.includes('pdf')) type = '.pdf';
                            else if (typeClass.includes('word')) type = '.docx';
                            else if (typeClass.includes('excel')) type = '.xlsx';
                            else if (typeClass.includes('image')) type = '.jpg';

                            sources.push({
                                filename: filenameElement ? filenameElement.textContent : 'Unknown source',
                                content: contentElement ? contentElement.innerHTML : '',
                                type: type
                            });
                        });

                        return { answer, sources };
                    });
                }
            })
            .then(data => {
                // Create and add AI message
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai-message';

                let messageContent = `
                    <div class="message-header">AI Assistant</div>
                    <div class="message-content">${data.answer.replace(/\n/g, '<br>')}`;

                // Add sources if available
                if (data.sources && data.sources.length > 0) {
                    const sourceId = `sourcesList-${Date.now()}`;
                    messageContent += `
                        <div class="sources-wrapper mt-3">
                            <button class="btn btn-sm btn-outline-primary w-100" type="button"
                                data-bs-toggle="collapse" data-bs-target="#${sourceId}"
                                aria-expanded="false" aria-controls="${sourceId}">
                                <i class="bi bi-file-earmark-text me-2"></i>
                                Show Sources (${data.sources.length})
                                <i class="bi bi-chevron-down ms-2"></i>
                            </button>

                            <div class="collapse mt-2" id="${sourceId}">
                                <div class="sources-list">`;

                    // Add each source
                    data.sources.forEach(source => {
                        let iconClass = 'bi-file-earmark';
                        if (source.type === '.pdf') iconClass = 'bi-file-earmark-pdf';
                        else if (['.doc', '.docx'].includes(source.type)) iconClass = 'bi-file-earmark-word';
                        else if (source.type === '.txt') iconClass = 'bi-file-earmark-text';
                        else if (source.type === '.csv') iconClass = 'bi-file-earmark-spreadsheet';
                        else if (['.jpg', '.jpeg', '.png', '.gif'].includes(source.type)) iconClass = 'bi-file-earmark-image';

                        messageContent += `
                            <div class="card mb-2 source-card">
                                <div class="card-header d-flex align-items-center source-header p-2">
                                    <i class="bi ${iconClass} source-icon me-2"></i>
                                    <span class="small">${source.filename}</span>
                                </div>
                                <div class="card-body source-content p-2">
                                    <div class="source-chunk p-2 bg-light rounded">
                                        ${source.content.replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                            </div>`;
                    });

                    messageContent += `
                                </div>
                            </div>
                        </div>`;
                }

                messageContent += `</div>`;
                aiMessage.innerHTML = messageContent;

                chatMessages.appendChild(aiMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Initialize Bootstrap collapse for sources
                const sourcesButton = aiMessage.querySelector('[data-bs-toggle="collapse"]');
                const sourcesCollapse = aiMessage.querySelector('.collapse');

                if (sourcesButton && sourcesCollapse) {
                    const collapse = new bootstrap.Collapse(sourcesCollapse, {
                        toggle: false
                    });

                    sourcesCollapse.addEventListener('show.bs.collapse', function () {
                        sourcesButton.innerHTML = '<i class="bi bi-file-earmark-text me-2"></i> Hide Sources <i class="bi bi-chevron-up ms-2"></i>';
                    });

                    sourcesCollapse.addEventListener('hide.bs.collapse', function () {
                        const sourcesCount = aiMessage.querySelectorAll('.source-card').length;
                        sourcesButton.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i> Show Sources (${sourcesCount}) <i class="bi bi-chevron-down ms-2"></i>`;
                    });
                }

                // Reset form
                questionInput.value = '';
                questionInput.disabled = false;
                sendButton.disabled = false;
                loadingIndicator.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                // Create error message
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message ai-message';
                errorMessage.innerHTML = `
                    <div class="message-header">System</div>
                    <div class="message-content">
                        <div class="alert alert-danger mb-0">
                            An error occurred while processing your request. Please try again later.
                        </div>
                    </div>
                `;
                chatMessages.appendChild(errorMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Reset form
                questionInput.disabled = false;
                sendButton.disabled = false;
                loadingIndicator.style.display = 'none';
            });
        }
    }

    // Handle document modal
    const documentModal = document.getElementById('documentModal');
    if (documentModal) {
        documentModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const fileId = button.getAttribute('data-file-id');
            const fileName = button.getAttribute('data-file-name');

            const modalTitle = documentModal.querySelector('.modal-title');
            const documentFrame = document.getElementById('document-frame');
            const imageContainer = document.getElementById('image-container');
            const unsupportedMessage = document.getElementById('unsupported-file-message');
            const iframeContainer = document.getElementById('iframe-container');
            const downloadButton = document.getElementById('download-document');
            const openButton = document.getElementById('open-document');
            const imagePreview = document.getElementById('image-preview');

            // Resetta tutti i contenitori
            documentFrame.style.display = 'none';
            iframeContainer.style.display = 'none';
            imageContainer.classList.add('d-none');
            unsupportedMessage.classList.add('d-none');

            // Imposta titolo
            modalTitle.textContent = fileName;

            // Configura il pulsante "Apri in nuova scheda"
            if (openButton) {
                openButton.href = `/serve_project_file/${fileId}/?filename=${encodeURIComponent(fileName)}`;
                openButton.target = '_blank';
                openButton.onclick = null;
            }

            // Configura il pulsante "Download"
            if (downloadButton) {
                downloadButton.href = `/serve_project_file/${fileId}/?download=1&filename=${encodeURIComponent(fileName)}`;
                downloadButton.setAttribute('download', fileName);
                downloadButton.onclick = null;
            }

            // Determina l'estensione del file
            const fileExtension = fileName.split('.').pop().toLowerCase();

            // Gestisci l'anteprima in base all'estensione
            switch (fileExtension) {
                case 'pdf':
                    // Mostra PDF nell'iframe
                    documentFrame.src = `/serve_project_file/${fileId}/?filename=${encodeURIComponent(fileName)}`;
                    documentFrame.style.display = 'block';
                    iframeContainer.style.display = 'block';
                    unsupportedMessage.classList.add('d-none');
                    break;

                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif':
                    // Mostra immagini
                    imagePreview.src = `/serve_project_file/${fileId}/?filename=${encodeURIComponent(fileName)}`;
                    imageContainer.classList.remove('d-none');
                    break;

                case 'docx':
                case 'doc':
                case 'txt':
                case 'csv':
                case 'xls':
                    // Mostra un messaggio specifico per i file Excel
                    unsupportedMessage.innerHTML = `
                        <i class="bi bi-file-earmark-excel me-2 text-success" style="font-size: 1.5rem;"></i>
                        <div>
                            <p>I file Excel non possono essere visualizzati direttamente nel browser.</p>
                            <p>Usa i pulsanti qui sotto per aprire o scaricare il file.</p>
                        </div>
                    `;
                    unsupportedMessage.classList.remove('d-none');
                    break;
                case 'xlsx':
                case 'ppt':
                case 'pptx':
                    // Mostra messaggio per file non visualizzabili in anteprima
                    unsupportedMessage.classList.remove('d-none');
                    imageContainer.classList.add('d-none');
                    iframeContainer.style.display = 'none';
                    break;

                default:
                    // File non supportato
                    unsupportedMessage.classList.remove('d-none');
                    imageContainer.classList.add('d-none');
                    iframeContainer.style.display = 'none';
            }
        });

        // Quando la modale è chiusa, pulisci l'iframe e l'immagine
        documentModal.addEventListener('hidden.bs.modal', function () {
            const documentFrame = document.getElementById('document-frame');
            const imagePreview = document.getElementById('image-preview');
            if (documentFrame) documentFrame.src = '';
            if (imagePreview) imagePreview.src = '';
        });
    }

    // File preview in upload modal
    const fileInput = document.getElementById('project-files');
    const filePreviewContainer = document.getElementById('selected-files-preview');
    const filesList = document.getElementById('files-preview-list');

    if (fileInput) {
        fileInput.addEventListener('change', function() {
            filesList.innerHTML = '';

            if (this.files.length > 0) {
                filePreviewContainer.classList.remove('d-none');

                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    const fileSize = formatFileSize(file.size);
                    const fileExt = getFileExtension(file.name);
                    let iconClass = getFileIconClass(fileExt);

                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.innerHTML = `
                        <div>
                            <i class="bi ${iconClass} me-2"></i>
                            <span>${file.name}</span>
                        </div>
                        <span class="badge bg-secondary rounded-pill">${fileSize}</span>
                    `;

                    filesList.appendChild(listItem);
                }
            } else {
                filePreviewContainer.classList.add('d-none');
            }
        });
    }

    // Folder upload preview
    const folderInput = document.getElementById('project-folder');
    const folderInfoContainer = document.getElementById('selected-folder-info');
    const folderNameElement = document.getElementById('folder-name');
    const fileCountElement = document.getElementById('file-count');
    const validFilesElement = document.getElementById('valid-files');

    if (folderInput) {
        folderInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                folderInfoContainer.classList.remove('d-none');

                // Get folder name from first file's path
                const firstFilePath = this.files[0].webkitRelativePath;
                const folderName = firstFilePath.split('/')[0];
                folderNameElement.textContent = folderName;

                // Count valid files
                const validExtensions = ['.pdf', '.docx', '.doc', '.txt', '.csv', '.xls', '.xlsx', '.ppt', '.pptx', '.jpg', '.jpeg', '.png', '.gif'];
                let validCount = 0;

                for (let i = 0; i < this.files.length; i++) {
                    const fileExt = getFileExtension(this.files[i].name);
                    if (validExtensions.includes(fileExt)) {
                        validCount++;
                    }
                }

                fileCountElement.textContent = this.files.length;
                validFilesElement.textContent = validCount;
            } else {
                folderInfoContainer.classList.add('d-none');
            }
        });
    }

    // Auto-save notes (optional feature)
    const notesTextarea = document.getElementById('project-notes');
    let saveTimeout;

    if (notesTextarea) {
        notesTextarea.addEventListener('input', function() {
            // Clear existing timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }

            // Set new timeout (save after 2 seconds of inactivity)
            saveTimeout = setTimeout(function() {
                const notesForm = document.getElementById('notes-form');

                // Use fetch to submit the form without page reload
                const formData = new FormData(notesForm);

                fetch(notesForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Notes auto-saved');
                })
                .catch(error => {
                    console.error('Error auto-saving notes:', error);
                });

            }, 2000);
        });
    }

    const deleteFileModal = document.getElementById('deleteFileModal');
    if (deleteFileModal) {
        deleteFileModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const fileId = button.getAttribute('data-file-id');
            const fileName = button.getAttribute('data-file-name');

            document.getElementById('delete-file-name').textContent = fileName;
            document.getElementById('delete-file-id').value = fileId;
        });
    }

    // Ferma la propagazione del click sul pulsante di eliminazione
    document.querySelectorAll('.delete-file-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // Impedisce che il click attivi anche il modal del documento
        });
    });

    // Scroll to last message
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Sources toggle
    const sourcesButton = document.querySelector('[data-bs-toggle="collapse"]');
    const sourcesCollapse = document.getElementById('sourcesList');

    if (sourcesButton && sourcesCollapse) {
        sourcesCollapse.addEventListener('show.bs.collapse', function () {
            sourcesButton.innerHTML = '<i class="bi bi-file-earmark-text me-2"></i> Hide Sources <i class="bi bi-chevron-up ms-2"></i>';
        });

        sourcesCollapse.addEventListener('hide.bs.collapse', function () {
            const sourcesCount = document.querySelectorAll('.source-card').length;
            sourcesButton.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i> Show Sources (${sourcesCount}) <i class="bi bi-chevron-down ms-2"></i>`;
        });
    }

    // Helper functions
    function formatFileSize(bytes) {
        if (bytes < 1024) {
            return bytes + ' bytes';
        } else if (bytes < 1024 * 1024) {
            return (bytes / 1024).toFixed(1) + ' KB';
        } else {
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    }

    function getFileExtension(filename) {
        return '.' + filename.split('.').pop().toLowerCase();
    }

    function getFileIconClass(extension) {
        if (extension === '.pdf') {
            return 'bi-file-earmark-pdf';
        } else if (['.doc', '.docx'].includes(extension)) {
            return 'bi-file-earmark-word';
        } else if (['.xls', '.xlsx'].includes(extension)) {
            return 'bi-file-earmark-excel';
        } else if (['.ppt', '.pptx'].includes(extension)) {
            return 'bi-file-earmark-slides';
        } else if (extension === '.txt') {
            return 'bi-file-earmark-text';
        } else if (extension === '.csv') {
            return 'bi-file-earmark-spreadsheet';
        } else if (['.jpg', '.jpeg', '.png', '.gif'].includes(extension)) {
            return 'bi-file-earmark-image';
        } else {
            return 'bi-file-earmark';
        }
    }
});
</script>
{% endblock %}