{% extends 'be/base.html' %}
{% load static %}
{% load custom_filter %}

<!-- Additional CSS for this specific page -->
{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous">
    <style>
        .project-card {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }

        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }

        .stat-card {
            border-left: 4px solid;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.documents {
            border-left-color: #0d6efd;
        }

        .stat-card.notes {
            border-left-color: #20c997;
        }

        .stat-card.interactions {
            border-left-color: #fd7e14;
        }

        .stat-card.projects {
            border-left-color: #6f42c1;
        }

        .project-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            color: white;
            margin-right: 1rem;
        }

        .activity-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.25rem;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 7px;
            height: 100%;
            border-left: 2px dashed #dee2e6;
        }

        .activity-item:last-child::before {
            height: 0;
        }

        .activity-badge {
            position: absolute;
            left: 0;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #0d6efd;
            z-index: 1;
        }

        .activity-badge.file {
            background-color: #0d6efd;
        }

        .activity-badge.note {
            background-color: #20c997;
        }

        .activity-badge.question {
            background-color: #fd7e14;
        }

        .activity-badge.project {
            background-color: #6f42c1;
        }
    </style>
{% endblock %}

<!-- Main content of the page -->
{% block content %}
    {#  INIZIO NAVIGAZIONE SOTTONAVBAR#}
    <div class="app-content-header"> <!--begin::Container-->
        <div class="container-fluid"> <!--begin::Row-->
            <div class="row">
                <div class="col-sm-6">
                    <h3 class="mb-0">Dashboard Progetti</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-end">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                    </ol>
                </div>
            </div> <!--end::Row-->
        </div> <!--end::Container-->
    </div>
    {#  FINE NAVIGAZIONE SOTTONAVBAR#}

    <!-- Statistiche generali -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card projects h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Progetti totali</h5>
                            <h2 class="font-weight-bold mb-0">{{ projects.count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-folder fs-1 text-primary"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {% widthratio projects.count 4 100 %}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card documents h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Documenti</h5>
                            <h2 class="font-weight-bold mb-0">{{ documents_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-files fs-1 text-primary"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {% widthratio documents_count 5 100 %}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card notes h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Note</h5>
                            <h2 class="font-weight-bold mb-0">{{ notes_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-journal-text fs-1 text-success"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {% widthratio notes_count 4 100 %}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card interactions h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Interazioni AI</h5>
                            <h2 class="font-weight-bold mb-0">{{ conversations_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-robot fs-1 text-warning"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {% widthratio conversations_count 3 100 %}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Attività recenti e grafici -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Attività dei progetti</h3>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector active" data-period="week">Settimana</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector" data-period="month">Mese</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector" data-period="year">Anno</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-4">
                        <div>
                            <h4 class="mb-0">{{ total_activities }}</h4>
                            <small class="text-muted">Attività totali</small>
                        </div>
                        <div class="text-end">
                            <h4 class="text-success mb-0">+{{ active_projects }}</h4>
                            <small class="text-muted">Progetti attivi</small>
                        </div>
                    </div>
                    <div class="position-relative mb-4">
                        <div id="activity-chart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- Progetti principali -->
            <div class="card mb-4">
                <div class="card-header border-0 bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">Progetti principali</h3>
                        <a href="{% url 'projects_list' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-grid-3x3-gap-fill me-1"></i> Vedi tutti
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
                        {% if projects %}
                            {% for project in projects|slice:":6" %}
                            <div class="col">
                                <div class="card h-100 project-card border shadow-sm">
                                    <div class="card-header d-flex align-items-center py-2 px-3" style="background-color: {% cycle '#0d6efd' '#20c997' '#fd7e14' '#6f42c1' '#dc3545' '#0dcaf0' %}20;">
                                        <div class="project-icon me-2" style="background-color: {% cycle '#0d6efd' '#20c997' '#fd7e14' '#6f42c1' '#dc3545' '#0dcaf0' %};">
                                            <i class="bi bi-folder2"></i>
                                        </div>
                                        <h5 class="card-title mb-0 text-truncate">{{ project.name }}</h5>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="flex-grow-1">
                                                <div class="progress" style="height: 8px;">
                                                    {% with usage_percentage=project.conversations.count|default:5|divisibleby:100 %}
                                                    <div class="progress-bar bg-info" role="progressbar" style="width: {% if usage_percentage > 75 %}{% cycle '77' '82' '88' %}{% else %}{% cycle '35' '42' '58' '67' %}{% endif %}%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                                                    {% endwith %}
                                                </div>
                                                <small class="text-muted">Utilizzo crediti: <strong>{% cycle '35' '42' '58' '67' '77' '82' %}%</strong></small>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <div>
                                                <i class="bi bi-files text-primary"></i>
                                                <span class="ms-1">{{ project.files.count }} doc</span>
                                            </div>
                                            <div>
                                                <i class="bi bi-journal-text text-success"></i>
                                                <span class="ms-1">{{ project.project_notes.count }} note</span>
                                            </div>
                                            <div>
                                                <i class="bi bi-chat-dots text-warning"></i>
                                                <span class="ms-1">{{ project.conversations.count }} chat</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent pt-0 border-top-0">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Aggiornato: {{ project.updated_at|date:"d M Y" }}</small>
                                            <a href="{% url 'project_details' project.id %}" class="btn btn-sm btn-primary stretched-link">
                                                <i class="bi bi-eye me-1"></i>Visualizza
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="card border-0 text-center py-5 bg-light">
                                    <div class="card-body">
                                        <i class="bi bi-folder-x fs-1 text-muted mb-3"></i>
                                        <h4>Nessun progetto disponibile</h4>
                                        <p class="text-muted">Crea il tuo primo progetto per iniziare</p>
                                        <a href="{% url 'new_project' %}" class="btn btn-primary mt-2">
                                            <i class="bi bi-plus-lg me-1"></i> Crea nuovo progetto
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Distribuzione documenti -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <h3 class="card-title">Tipologie documenti</h3>
                </div>
                <div class="card-body">
                    <div id="documents-chart" style="height: 250px;"></div>
                </div>
            </div>

            <!-- Attività recenti -->
            <div class="card">
                <div class="card-header border-0">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Attività recenti</h3>
                        <a href="#" class="link-primary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">Vedi tutte</a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% for conversation in recent_conversations|slice:":4" %}
                        <div class="activity-item">
                            <div class="activity-badge question"></div>
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-1 fw-bold">{{ conversation.project.name }}</h6>
                                <small class="text-muted">{{ conversation.created_at|time:"H:i" }}</small>
                            </div>
                            <p class="mb-1">{{ conversation.question|truncatechars:60 }}</p>
                            <small class="text-muted">{{ conversation.created_at|date:"d M Y" }}</small>
                        </div>
                        {% empty %}
                            {% for note in recent_notes|slice:":4" %}
                            <div class="activity-item">
                                <div class="activity-badge note"></div>
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1 fw-bold">{{ note.project.name }}</h6>
                                    <small class="text-muted">{{ note.created_at|time:"H:i" }}</small>
                                </div>
                                <p class="mb-1">{{ note.content|truncatechars:60 }}</p>
                                <small class="text-muted">{{ note.created_at|date:"d M Y" }}</small>
                            </div>
                            {% empty %}
                            <div class="activity-item">
                                <div class="activity-badge file"></div>
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1 fw-bold">Progetto Analisi Dati</h6>
                                    <small class="text-muted">10:30</small>
                                </div>
                                <p class="mb-1">Aggiunto nuovo documento "Analisi Q2 2025.pdf"</p>
                                <small class="text-muted">16 Apr 2025</small>
                            </div>
                            <div class="activity-item">
                                <div class="activity-badge note"></div>
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1 fw-bold">Piano Marketing</h6>
                                    <small class="text-muted">09:15</small>
                                </div>
                                <p class="mb-1">Aggiunta nuova nota "Revisione strategia"</p>
                                <small class="text-muted">16 Apr 2025</small>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione Cache degli Embedding -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">
                            <i class="bi bi-database-check me-2"></i>Cache degli Embedding
                        </h3>
                        <div>
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-repeat me-1"></i>Aggiorna statistiche
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Statistiche generali della cache -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card h-100" style="border-left-color: #8e44ad;">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title text-muted mb-0">Embedding totali</h5>
                                            <h2 class="font-weight-bold mb-0">{{ total_cache_stats.count|default:"0" }}</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-hdd-stack fs-1 text-purple" style="color: #8e44ad;"></i>
                                        </div>
                                    </div>
                                    <p class="mt-3 mb-0 text-muted">
                                        {% if cache_stats %}
                                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ cache_stats.total_embeddings|default:0 }}</span>
                                        <span class="text-secondary">In cache</span>
                                        {% else %}
                                        <span class="text-secondary">Nessuna statistica disponibile</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="card stat-card h-100" style="border-left-color: #2ecc71;">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title text-muted mb-0">Riutilizzi</h5>
                                            <h2 class="font-weight-bold mb-0">{{ total_cache_stats.reuses|default:"0" }}</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-recycle fs-1" style="color: #2ecc71;"></i>
                                        </div>
                                    </div>
                                    <p class="mt-3 mb-0 text-muted">
                                        {% if cache_stats %}
                                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ cache_stats.reuse_count|default:0 }}</span>
                                        <span class="text-secondary">Totali riutilizzi</span>
                                        {% else %}
                                        <span class="text-secondary">Nessuna statistica disponibile</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="card stat-card h-100" style="border-left-color: #e74c3c;">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title text-muted mb-0">Dimensione totale</h5>
                                            <h2 class="font-weight-bold mb-0">
                                                {% if cache_stats %}
                                                    {{ cache_stats.size_in_mb|floatformat:2 }} MB
                                                {% else %}
                                                    0 MB
                                                {% endif %}
                                            </h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-hdd fs-1" style="color: #e74c3c;"></i>
                                        </div>
                                    </div>
                                    <p class="mt-3 mb-0 text-muted">
                                        {% if cache_stats %}
                                        <span class="text-success me-1"><i class="bi bi-info-circle"></i></span>
                                        <span class="text-secondary">Media: {{ cache_stats.avg_size_in_kb|floatformat:0 }} KB per file</span>
                                        {% else %}
                                        <span class="text-secondary">Nessuna statistica disponibile</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="card stat-card h-100" style="border-left-color: #3498db;">
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title text-muted mb-0">Risparmio stimato</h5>
                                            <h2 class="font-weight-bold mb-0">
                                                {% if cache_stats %}
                                                    ${{ cache_stats.estimated_savings|floatformat:2 }}
                                                {% else %}
                                                    $0.00
                                                {% endif %}
                                            </h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-currency-dollar fs-1" style="color: #3498db;"></i>
                                        </div>
                                    </div>
                                    <p class="mt-3 mb-0 text-muted">
                                        {% if cache_stats %}
                                        <span class="text-success me-1"><i class="bi bi-graph-up-arrow"></i></span>
                                        <span class="text-secondary">Basato su {{ total_cache_stats.reuses|default:"0" }} riutilizzi</span>
                                        {% else %}
                                        <span class="text-secondary">Nessuna statistica disponibile</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grafici della cache -->
                    <div class="row">
                        <!-- Grafico storico degli embedding -->
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-header border-0 bg-light">
                                    <h5 class="card-title mb-0">Trend degli Embedding</h5>
                                </div>
                                <div class="card-body">
                                    <div id="cache-trend-chart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Grafico tipi di file nella cache -->
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-header border-0 bg-light">
                                    <h5 class="card-title mb-0">Distribuzione tipi di file</h5>
                                </div>
                                <div class="card-body">
                                    <div id="cache-types-chart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Efficienza della cache -->
                    <div class="card">
                        <div class="card-header border-0 bg-light">
                            <h5 class="card-title mb-0">Metriche di efficienza della cache</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">Hit rate</h6>
                                            <div class="progress" style="height: 8px;">
                                                {% with usage=total_cache_stats.usage|default:1 %}
                                                {% with hit_rate=total_cache_stats.reuses|default:0|divisibleby:usage|multiply:100 %}
                                                <div class="progress-bar bg-success" role="progressbar" style="width: {% if hit_rate %}{{ hit_rate }}{% else %}0{% endif %}%;" aria-valuenow="{{ hit_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                                                {% endwith %}
                                                {% endwith %}
                                            </div>
                                            <small class="text-muted">{{ total_cache_stats.reuses|default:0 }} riutilizzi su {{ total_cache_stats.usage|default:0 }} richieste totali</small>
                                        </div>
                                        <div class="ms-3">
                                            {% with usage=total_cache_stats.usage|default:1 %}
                                            {% with hit_rate=total_cache_stats.reuses|default:0|divisibleby:usage|multiply:100 %}
                                            <span class="h4 mb-0 {% if hit_rate > 50 %}text-success{% else %}text-warning{% endif %}">{{ hit_rate|floatformat:1 }}%</span>
                                            {% endwith %}
                                            {% endwith %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">Media riutilizzi per embedding</h6>
                                            <div class="progress" style="height: 8px;">
                                                {% with count=total_cache_stats.count|default:1 %}
                                                {% with avg_reuses=total_cache_stats.usage|default:1|divisibleby:count %}
                                                {% with avg_percent=avg_reuses|multiply:10 %}
                                                <div class="progress-bar bg-info" role="progressbar" style="width: {% if avg_percent > 100 %}100{% else %}{{ avg_percent }}{% endif %}%;" aria-valuenow="{{ avg_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                                                {% endwith %}
                                                {% endwith %}
                                                {% endwith %}
                                            </div>
                                            <small class="text-muted">Numero medio di volte che un embedding viene riutilizzato</small>
                                        </div>
                                        <div class="ms-3">
                                            {% with count=total_cache_stats.count|default:1 %}
                                            {% with avg_reuses=total_cache_stats.usage|default:1|divisibleby:count %}
                                            <span class="h4 mb-0 text-info">{{ avg_reuses|floatformat:1 }}x</span>
                                            {% endwith %}
                                            {% endwith %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Embedding più riutilizzato:</span>
                                            <span class="fw-bold">{{ cache_stats.max_reuses|default:0 }}x</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Dimensione media file:</span>
                                            <span class="fw-bold">{{ cache_stats.avg_size_in_kb|floatformat:0 }} KB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Risparmio medio per riutilizzo:</span>
                                            <span class="fw-bold">$0.0001</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Dimensione totale risparmiata:</span>
                                            {% if cache_stats %}
                                            {% with risparmio=cache_stats.size_in_mb|multiply:cache_stats.reuse_count %}
                                            <span class="fw-bold">{{ risparmio|floatformat:2 }} MB</span>
                                            {% endwith %}
                                            {% else %}
                                            <span class="fw-bold">0.00 MB</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
{% endblock %}

<!-- Additional JS for this specific page -->
{% block extra_js %}
    <script>
        const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
        const Default = {
            scrollbarTheme: "os-theme-light",
            scrollbarAutoHide: "leave",
            scrollbarClickScroll: true,
        };
        document.addEventListener("DOMContentLoaded", function() {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (
                sidebarWrapper &&
                typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== "undefined"
            ) {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                    scrollbars: {
                        theme: Default.scrollbarTheme,
                        autoHide: Default.scrollbarAutoHide,
                        clickScroll: Default.scrollbarClickScroll,
                    },
                });
            }

            // Gestione selettore periodo
            document.querySelectorAll('.period-selector').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.period-selector').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    updateActivityChart(this.getAttribute('data-period'));
                });
            });
        });
    </script> <!--end::OverlayScrollbars Configure--> <!-- OPTIONAL SCRIPTS --> <!-- apexcharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>
    <script>
        // Grafico attività progetti
        const activityChartOptions = {
            series: [
                {
                    name: "Documenti",
                    data: [3, 4, 2, 7, 5, 1, 2],
                    color: "#0d6efd"
                },
                {
                    name: "Note",
                    data: [2, 5, 3, 4, 2, 0, 1],
                    color: "#20c997"
                },
                {
                    name: "Interazioni AI",
                    data: [5, 3, 8, 6, 4, 2, 3],
                    color: "#fd7e14"
                }
            ],
            chart: {
                type: "area",
                height: 300,
                toolbar: {
                    show: false
                },
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: "smooth",
                width: 2
            },
            grid: {
                borderColor: "#e7e7e7",
                row: {
                    colors: ["#f3f3f3", "transparent"],
                    opacity: 0.5
                }
            },
            xaxis: {
                categories: ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"],
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                },
                labels: {
                    style: {
                        colors: "#78909c"
                    }
                }
            },
            yaxis: {
                labels: {
                    style: {
                        colors: "#78909c"
                    }
                }
            },
            legend: {
                horizontalAlign: "left",
                offsetX: 40
            },
            fill: {
                opacity: 0.15,
                type: "gradient",
                gradient: {
                    shade: "light",
                    type: "vertical",
                    shadeIntensity: 0.25,
                    inverseColors: false,
                    opacityFrom: 0.85,
                    opacityTo: 0.55
                }
            }
        };

        const documentChartOptions = {
            series: {{ document_types_values|default:"[42, 28, 15, 10, 5]"|safe }},
            chart: {
                type: "donut",
                height: 250
            },
            labels: {{ document_types_labels|default:'["PDF", "DOCX", "TXT", "XLSX", "Altro"]'|safe }},
            colors: ["#0d6efd", "#20c997", "#fd7e14", "#6f42c1", "#dc3545"],
            legend: {
                position: "bottom"
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: "55%",
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                fontSize: "16px",
                                label: "Totale",
                                formatter: function(w) {
                                    return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                }
                            }
                        }
                    }
                }
            },
            dataLabels: {
                enabled: false
            }
        };

        document.addEventListener("DOMContentLoaded", function() {
            // Inizializza i grafici
            const activityChart = new ApexCharts(
                document.querySelector("#activity-chart"),
                activityChartOptions
            );
            activityChart.render();

            const documentsChart = new ApexCharts(
                document.querySelector("#documents-chart"),
                documentChartOptions
            );
            documentsChart.render();

            // Funzione per aggiornare i dati del grafico attività
            window.updateActivityChart = function(period) {
                let newData;
                let newCategories;

                // Dati simulati per i diversi periodi
                if (period === "week") {
                    newCategories = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];
                    newData = {
                        documents: [3, 4, 2, 7, 5, 1, 2],
                        notes: [2, 5, 3, 4, 2, 0, 1],
                        interactions: [5, 3, 8, 6, 4, 2, 3]
                    };
                } else if (period === "month") {
                    newCategories = ["Sett 1", "Sett 2", "Sett 3", "Sett 4"];
                    newData = {
                        documents: [14, 18, 12, 9],
                        notes: [10, 15, 8, 12],
                        interactions: [22, 18, 19, 14]
                    };
                } else if (period === "year") {
                    newCategories = ["Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"];
                    newData = {
                        documents: [25, 18, 22, 30, 35, 28, 32, 24, 20, 28, 32, 34],
                        notes: [18, 15, 20, 25, 22, 20, 18, 15, 17, 22, 24, 28],
                        interactions: [35, 30, 38, 42, 45, 40, 36, 32, 38, 44, 48, 50]
                    };
                }

                // Aggiorna i dati del grafico
                activityChart.updateOptions({
                    xaxis: {
                        categories: newCategories
                    }
                });

                activityChart.updateSeries([
                    {
                        name: "Documenti",
                        data: newData.documents
                    },
                    {
                        name: "Note",
                        data: newData.notes
                    },
                    {
                        name: "Interazioni AI",
                        data: newData.interactions
                    }
                ]);
            };

            // Configurazione grafico trend della cache
            const cacheTrendOptions = {
                series: [
                    {
                        name: "Embedding totali",
                        data: {{ cache_embeddings_count|safe }},
                        color: "#8e44ad"
                    },
                    {
                        name: "Riutilizzi",
                        data: {{ cache_reuse_count|safe }},
                        color: "#2ecc71"
                    },
                    {
                        name: "Risparmio ($)",
                        data: {{ cache_savings|safe }},
                        color: "#3498db"
                    }
                ],
                chart: {
                    type: "line",
                    height: 300,
                    toolbar: {
                        show: false
                    },
                    zoom: {
                        enabled: false
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: "smooth",
                    width: [3, 3, 2]
                },
                grid: {
                    borderColor: "#e7e7e7",
                    row: {
                        colors: ["#f3f3f3", "transparent"],
                        opacity: 0.5
                    }
                },
                markers: {
                    size: 4,
                    colors: ["#8e44ad", "#2ecc71", "#3498db"],
                    strokeColors: "#fff",
                    strokeWidth: 2,
                    hover: {
                        size: 7
                    }
                },
                xaxis: {
                    categories: {{ cache_dates|safe }},
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    },
                    labels: {
                        style: {
                            colors: "#78909c"
                        }
                    }
                },
                yaxis: [
                    {
                        title: {
                            text: "Conteggio",
                            style: {
                                color: "#8e44ad"
                            }
                        },
                        labels: {
                            style: {
                                colors: "#78909c"
                            }
                        }
                    },
                    {
                        opposite: true,
                        title: {
                            text: "Risparmio ($)",
                            style: {
                                color: "#3498db"
                            }
                        },
                        labels: {
                            style: {
                                colors: "#78909c"
                            }
                        },
                        seriesName: "Risparmio ($)"
                    }
                ],
                tooltip: {
                    y: {
                        formatter: function(value, { series, seriesIndex, dataPointIndex, w }) {
                            if (seriesIndex === 2) {
                                return "$" + value.toFixed(2);
                            }
                            return value;
                        }
                    }
                },
                legend: {
                    position: "top",
                    horizontalAlign: "center"
                }
            };

            // Configurazione grafico a ciambella per tipi di file nella cache
            const cacheTypesOptions = {
                series: {{ cache_file_types_values|default:"[0, 0, 0, 0, 0]"|safe }},
                chart: {
                    type: "donut",
                    height: 300
                },
                labels: {{ cache_file_types_labels|default:'["PDF", "DOCX", "TXT", "CSV", "ALTRO"]'|safe }},
                colors: ["#8e44ad", "#2ecc71", "#3498db", "#e74c3c", "#f39c12"],
                legend: {
                    position: "bottom"
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "55%",
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    fontSize: "16px",
                                    label: "Totale",
                                    formatter: function(w) {
                                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    }
                                }
                            }
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val, opts) {
                        return opts.w.config.series[opts.seriesIndex] + " (" + val.toFixed(1) + "%)";
                    }
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            height: 250
                        },
                        legend: {
                            position: "bottom"
                        }
                    }
                }]
            };

            // Inizializzazione dei grafici della cache
            const cacheTrendChart = new ApexCharts(
                document.querySelector("#cache-trend-chart"),
                cacheTrendOptions
            );
            cacheTrendChart.render();

            const cacheTypesChart = new ApexCharts(
                document.querySelector("#cache-types-chart"),
                cacheTypesOptions
            );
            cacheTypesChart.render();

            // Aggiungi evento al pulsante di aggiornamento statistiche
            document.querySelector('.card-header button').addEventListener('click', function() {
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Aggiornamento...';
                this.disabled = true;

                // Esegui una chiamata AJAX per aggiornare le statistiche
                fetch('{% url "dashboard" %}?update_cache_stats=true', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Ricarica la pagina per visualizzare le statistiche aggiornate
                        window.location.reload();
                    } else {
                        alert('Errore durante l\'aggiornamento delle statistiche');
                        this.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Aggiorna statistiche';
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    alert('Errore di rete. Riprova più tardi.');
                    this.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Aggiorna statistiche';
                    this.disabled = false;
                });
            });
        });
    </script> <!--end::Script-->
{% endblock %}
