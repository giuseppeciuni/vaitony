<!-- Profilo IA Tab -->
<div class="tab-pane fade" id="rag-config" role="tabpanel" aria-labelledby="rag-config-tab">
    <!-- Sezione Configurazione Prompt di Sistema -->
    <div class="ai-prompt-configuration">
    <!-- Header con stato attuale -->
    <div class="current-prompt-header">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="prompt-status-info">
                <h4 class="mb-1">
                    <i class="bi bi-chat-quote-fill text-primary me-2"></i>
                    Prompt di Sistema
                </h4>
                <div class="current-status">
                    {% if project_prompt_config %}
                        {% if project_prompt_config.use_custom_prompt %}
                            <span class="badge bg-warning text-dark px-3 py-2">
                                <i class="bi bi-gear me-1"></i>Prompt Personalizzato Attivo
                            </span>
                        {% elif project_prompt_config.default_system_prompt %}
                            <span class="badge bg-success px-3 py-2">
                                <i class="bi bi-check-circle me-1"></i>{{ project_prompt_config.default_system_prompt.name }}
                            </span>
                        {% else %}
                            <span class="badge bg-secondary px-3 py-2">
                                <i class="bi bi-exclamation-triangle me-1"></i>Nessun Prompt Configurato
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary px-3 py-2">
                            <i class="bi bi-exclamation-triangle me-1"></i>Configurazione Non Inizializzata
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="quick-actions">
                <button type="button" class="btn btn-outline-secondary me-2" id="reset-prompt-btn">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                </button>
                <a href="{% url 'project_prompts' project.id %}" class="btn btn-outline-primary">
                    <i class="bi bi-tools me-1"></i>Gestione Avanzata
                </a>
            </div>
        </div>
    </div>
</div>

    <!-- Configurazione Prompt - Tab Interface -->
    <div class="prompt-config-container">
        <!-- Tab Navigation -->
        <ul class="nav nav-pills nav-fill mb-4" id="promptTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="predefined-tab" data-bs-toggle="pill" data-bs-target="#predefined-prompts" type="button" role="tab">
                    <i class="bi bi-collection me-2"></i>
                    <span>Prompt Predefiniti</span>
                    <small class="d-block text-muted">Scegli tra template pronti</small>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custom-tab" data-bs-toggle="pill" data-bs-target="#custom-prompt" type="button" role="tab">
                    <i class="bi bi-pencil-square me-2"></i>
                    <span>Prompt Personalizzato</span>
                    <small class="d-block text-muted">Crea il tuo prompt</small>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="preview-tab" data-bs-toggle="pill" data-bs-target="#prompt-preview" type="button" role="tab">
                    <i class="bi bi-eye me-2"></i>
                    <span>Anteprima</span>
                    <small class="d-block text-muted">Visualizza prompt attivo</small>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="promptTabsContent">

            <!-- Tab Prompt Predefiniti -->
            <div class="tab-pane fade show active" id="predefined-prompts" role="tabpanel">
                <div class="predefined-prompts-section">
                    {% if prompts_by_category %}
                        {% for category, prompts in prompts_by_category.items %}
                        <div class="prompt-category mb-4">
                            <h6 class="category-title">
                                <i class="bi bi-tag-fill me-2 text-primary"></i>
                                {{ category }}
                            </h6>
                            <div class="prompts-grid">
                                {% for prompt in prompts %}
                                <div class="prompt-card {% if not project_prompt_config.use_custom_prompt and project_prompt_config.default_system_prompt and project_prompt_config.default_system_prompt.id == prompt.id %}selected{% endif %}"
                                     data-prompt-id="{{ prompt.id }}">
                                    <div class="prompt-card-header">
                                        <div class="prompt-title">
                                            <h6 class="mb-1">{{ prompt.name }}</h6>
                                            <div class="prompt-badges">
                                                {% if prompt.is_default %}
                                                <span class="badge badge-default">Default</span>
                                                {% endif %}
                                                <span class="badge badge-category badge-{{ prompt.category }}">
                                                    {{ prompt.get_category_display }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="selection-indicator">
                                            <i class="bi bi-check-circle-fill"></i>
                                        </div>
                                    </div>
                                    <div class="prompt-card-body">
                                        <p class="prompt-description">{{ prompt.description|truncatechars:120 }}</p>
                                        <div class="prompt-stats">
                                            <small class="text-muted">
                                                <i class="bi bi-file-text me-1"></i>{{ prompt.prompt_text|length }} caratteri
                                            </small>
                                        </div>
                                        <div class="prompt-preview-short">
                                            <small class="text-muted">{{ prompt.prompt_text|truncatechars:100 }}</small>
                                        </div>
                                    </div>
                                    <div class="prompt-card-footer">
                                        <button type="button" class="btn btn-primary btn-sm select-prompt-btn w-100"
                                                data-prompt-id="{{ prompt.id }}">
                                            <i class="bi bi-check me-1"></i>Seleziona questo prompt
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="bi bi-collection"></i>
                            </div>
                            <h5>Nessun prompt predefinito disponibile</h5>
                            <p class="text-muted">Contatta l'amministratore per aggiungere prompt predefiniti al sistema.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tab Prompt Personalizzato -->
            <div class="tab-pane fade" id="custom-prompt" role="tabpanel">
                <div class="custom-prompt-section">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="custom-prompt-editor">
                                <form id="custom-prompt-form">
                                    <div class="mb-3">
                                        <label for="prompt-name" class="form-label">Nome del prompt (opzionale)</label>
                                        <input type="text" class="form-control" id="prompt-name" name="prompt_name"
                                               placeholder="Es: Assistente specializzato in...">
                                    </div>

                                    <div class="mb-3">
                                        <label for="custom-prompt-text" class="form-label">
                                            <strong>Testo del Prompt</strong>
                                        </label>
                                        <textarea class="form-control custom-prompt-textarea" id="custom-prompt-text"
                                                  name="custom_prompt_text" rows="15"
                                                  placeholder="Scrivi qui il tuo prompt personalizzato...">{% if project_prompt_config.custom_prompt_text %}{{ project_prompt_config.custom_prompt_text }}{% endif %}</textarea>
                                        <div class="form-text">
                                            <i class="bi bi-lightbulb text-warning me-1"></i>
                                            <strong>Suggerimento:</strong> Inizia definendo il ruolo dell'assistente, poi specifica il compito e il formato delle risposte.
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-secondary" id="clear-custom-prompt">
                                            <i class="bi bi-trash me-1"></i>Svuota
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="load-template">
                                            <i class="bi bi-file-text me-1"></i>Carica Template
                                        </button>
                                        <button type="button" class="btn btn-success flex-fill" id="save-custom-prompt-btn">
                                            <i class="bi bi-save me-1"></i>Salva Prompt Personalizzato
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="prompt-sidebar">
                                <!-- Statistiche in tempo reale -->
                                <div class="stats-card mb-3">
                                    <h6 class="stats-title">
                                        <i class="bi bi-graph-up me-2"></i>Statistiche
                                    </h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-value" id="custom-char-count">0</div>
                                            <div class="stat-label">Caratteri</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="custom-word-count">0</div>
                                            <div class="stat-label">Parole</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="custom-line-count">0</div>
                                            <div class="stat-label">Righe</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="custom-token-count">0</div>
                                            <div class="stat-label">~Token</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Consigli per la scrittura -->
                                <div class="tips-card">
                                    <h6 class="tips-title">
                                        <i class="bi bi-lightbulb me-2"></i>Consigli
                                    </h6>
                                    <div class="tip-list">
                                        <div class="tip-item">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>Definisci chiaramente il ruolo dell'assistente</span>
                                        </div>
                                        <div class="tip-item">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>Specifica il formato delle risposte</span>
                                        </div>
                                        <div class="tip-item">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>Includi esempi quando possibile</span>
                                        </div>
                                        <div class="tip-item">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>Sii specifico sui comportamenti desiderati</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Anteprima -->
            <div class="tab-pane fade" id="prompt-preview" role="tabpanel">
                <div class="preview-section">
                    {% if project_prompt_config %}
                        <div class="prompt-info-header mb-4">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-1">
                                        {% if project_prompt_config.use_custom_prompt %}
                                            <i class="bi bi-gear text-warning me-2"></i>Prompt Personalizzato
                                        {% elif project_prompt_config.default_system_prompt %}
                                            <i class="bi bi-collection text-success me-2"></i>{{ project_prompt_config.default_system_prompt.name }}
                                        {% else %}
                                            <i class="bi bi-exclamation-triangle text-muted me-2"></i>Nessun Prompt
                                        {% endif %}
                                    </h6>
                                    {% if not project_prompt_config.use_custom_prompt and project_prompt_config.default_system_prompt %}
                                        <p class="text-muted mb-0">{{ project_prompt_config.default_system_prompt.description }}</p>
                                    {% endif %}
                                </div>
                                <button class="btn btn-outline-secondary btn-sm copy-prompt-btn" type="button"
                                        data-prompt-text="{% if project_prompt_config.use_custom_prompt %}{{ project_prompt_config.custom_prompt_text|striptags|escapejs }}{% elif project_prompt_config.default_system_prompt %}{{ project_prompt_config.default_system_prompt.prompt_text|escapejs }}{% endif %}"
                                        title="Copia prompt">
                                    <i class="bi bi-clipboard me-1"></i>Copia
                                </button>
                            </div>
                        </div>

                        <div class="prompt-content-preview">
                            {% if project_prompt_config.use_custom_prompt and project_prompt_config.custom_prompt_text %}
                                <div class="prompt-text">{{ project_prompt_config.custom_prompt_text|linebreaks }}</div>
                            {% elif not project_prompt_config.use_custom_prompt and project_prompt_config.default_system_prompt %}
                                <div class="prompt-text">{{ project_prompt_config.default_system_prompt.prompt_text|linebreaks }}</div>
                            {% else %}
                                <div class="empty-preview">
                                    <i class="bi bi-file-text text-muted"></i>
                                    <p class="text-muted">Nessun prompt configurato</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Statistiche del prompt attivo -->
                        <div class="prompt-stats-footer mt-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <small class="text-muted">
                                        Ultima modifica: {{ project_prompt_config.updated_at|date:"d/m/Y H:i" }}
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    {% if project_prompt_config.use_custom_prompt and project_prompt_config.custom_prompt_text %}
                                        <small class="text-muted">
                                            {{ project_prompt_config.custom_prompt_text|length }} caratteri •
                                            {{ project_prompt_config.custom_prompt_text|wordcount }} parole
                                        </small>
                                    {% elif not project_prompt_config.use_custom_prompt and project_prompt_config.default_system_prompt %}
                                        <small class="text-muted">
                                            {{ project_prompt_config.default_system_prompt.prompt_text|length }} caratteri •
                                            {{ project_prompt_config.default_system_prompt.prompt_text|wordcount }} parole
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="empty-preview">
                            <i class="bi bi-info-circle text-muted"></i>
                            <h6>Configurazione non inizializzata</h6>
                            <p class="text-muted">Seleziona un prompt predefinito o crea un prompt personalizzato per iniziare.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Stili principali per la configurazione AI */
.ai-prompt-configuration {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.current-prompt-header {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.current-status .badge {
    font-size: 0.9rem;
    border-radius: 6px;
}

.quick-actions .btn {
    border-radius: 6px;
}

/* Stili per i tab */
.nav-pills .nav-link {
    border-radius: 12px;
    padding: 1rem 1.5rem;
    text-align: center;
    background: white;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    margin: 0 0.25rem;
}

.nav-pills .nav-link:hover {
    background: #e3f2fd;
    border-color: #2196f3;
}

.nav-pills .nav-link.active {
    background: #2196f3;
    border-color: #2196f3;
    color: white;
}

.nav-pills .nav-link small {
    font-size: 0.75rem;
    opacity: 0.8;
}

/* Container per i tab */
.prompt-config-container {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Stili per i prompt predefiniti */
.prompt-category {
    border-bottom: 1px solid #eee;
    padding-bottom: 2rem;
}

.prompt-category:last-child {
    border-bottom: none;
}

.category-title {
    color: #333;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #f0f0f0;
}

.prompts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.prompt-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.prompt-card:hover {
    border-color: #2196f3;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
    transform: translateY(-2px);
}

.prompt-card.selected {
    border-color: #4caf50;
    background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
}

.prompt-card-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.prompt-title h6 {
    color: #333;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.prompt-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.badge-default {
    background: #28a745;
    color: white;
}

.badge-category {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

.badge-balanced { background: #17a2b8; color: white; }
.badge-precision { background: #28a745; color: white; }
.badge-speed { background: #ffc107; color: #000; }
.badge-creative { background: #dc3545; color: white; }
.badge-technical { background: #6c757d; color: white; }

.selection-indicator {
    opacity: 0;
    transition: opacity 0.3s ease;
    color: #4caf50;
    font-size: 1.5rem;
}

.prompt-card.selected .selection-indicator {
    opacity: 1;
}

.prompt-description {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 0.75rem;
}

.prompt-stats {
    margin-bottom: 0.75rem;
}

.prompt-preview-short {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 1rem;
    font-family: monospace;
    font-size: 0.8rem;
    line-height: 1.3;
}

.prompt-card-footer .btn {
    border-radius: 6px;
    font-weight: 500;
}

/* Stili per l'editor personalizzato */
.custom-prompt-section {
    /* Background già gestito dal container padre */
}

.custom-prompt-editor {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.custom-prompt-textarea {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: border-color 0.3s ease;
    resize: vertical;
}

.custom-prompt-textarea:focus {
    border-color: #2196f3;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

/* Sidebar per statistiche e consigli */
.prompt-sidebar .stats-card,
.prompt-sidebar .tips-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.stats-title,
.tips-title {
    color: #333;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 6px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2196f3;
    line-height: 1;
}

.stat-label {
    font-size: 0.75rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 0.25rem;
}

.tip-list {
    space-y: 0.75rem;
}

.tip-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 0.75rem;
    font-size: 0.85rem;
    line-height: 1.4;
}

/* Stili per l'anteprima */
.preview-section {
    background: white;
    border-radius: 8px;
    padding: 2rem;
}

.prompt-info-header {
    border-bottom: 1px solid #eee;
    padding-bottom: 1rem;
}

.prompt-content-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 2rem;
    margin: 1.5rem 0;
    border-left: 4px solid #2196f3;
}

.prompt-text {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.empty-preview,
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #666;
}

.empty-preview i,
.empty-state-icon i {
    font-size: 3rem;
    opacity: 0.3;
    margin-bottom: 1rem;
}

.prompt-stats-footer {
    border-top: 1px solid #eee;
    padding-top: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .ai-prompt-configuration {
        padding: 1rem;
    }

    .current-prompt-header {
        padding: 1rem;
    }

    .prompt-config-container {
        padding: 1rem;
    }

    .prompts-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .nav-pills .nav-link {
        padding: 0.75rem 1rem;
        margin: 0 0.125rem;
    }

    .nav-pills .nav-link small {
        display: none;
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }

    .custom-prompt-section .row {
        flex-direction: column;
    }

    .prompt-sidebar {
        margin-top: 1.5rem;
    }
}

/* Animazioni */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.tab-pane.show {
    animation: fadeIn 0.3s ease-in-out;
}

/* Stati loading */
.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* Stili per copiare */
.copy-prompt-btn:hover {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

/* Toast personalizzati */
.toast {
    border-radius: 8px;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Focus management */
.form-control:focus,
.btn:focus {
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inizializzazione
    initializePromptConfiguration();

    function initializePromptConfiguration() {
        // Setup event listeners
        setupPromptSelection();
        setupCustomPromptEditor();
        setupQuickActions();
        setupTabNavigation();

        // Aggiorna statistiche iniziali se c'è testo nel prompt personalizzato
        const customTextarea = document.getElementById('custom-prompt-text');
        if (customTextarea && customTextarea.value) {
            updateCustomPromptStats();
        }
    }

    // ===== GESTIONE SELEZIONE PROMPT PREDEFINITI =====
    function setupPromptSelection() {
        document.querySelectorAll('.select-prompt-btn').forEach(button => {
            button.addEventListener('click', function() {
                const promptId = this.getAttribute('data-prompt-id');
                selectDefaultPrompt(promptId, this);
            });
        });

        // Click sulla card per selezionare
        document.querySelectorAll('.prompt-card').forEach(card => {
            card.addEventListener('click', function() {
                const promptId = this.getAttribute('data-prompt-id');
                const button = this.querySelector('.select-prompt-btn');
                if (button && !button.disabled) {
                    selectDefaultPrompt(promptId, button);
                }
            });
        });
    }

    function selectDefaultPrompt(promptId, button) {
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Selezionando...';

        // Rimuovi selezione da tutte le card
        document.querySelectorAll('.prompt-card').forEach(card => {
            card.classList.remove('selected');
        });

        const formData = new FormData();
        formData.append('action', 'select_default_prompt');
        formData.append('prompt_id', promptId);
        formData.append('csrfmiddlewaretoken', getCsrfToken());

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = originalText;

            if (data.success) {
                // Seleziona la card
                const selectedCard = document.querySelector(`[data-prompt-id="${promptId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }

                showToast(data.message, 'success');

                // Aggiorna l'interfaccia
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = originalText;
            console.error('Errore:', error);
            showToast('Errore di comunicazione', 'error');
        });
    }

    // ===== GESTIONE PROMPT PERSONALIZZATO =====
    function setupCustomPromptEditor() {
        const customPromptTextarea = document.getElementById('custom-prompt-text');

        if (customPromptTextarea) {
            customPromptTextarea.addEventListener('input', updateCustomPromptStats);

            // Inizializza statistiche
            updateCustomPromptStats();
        }

        // Salva prompt personalizzato
        const saveBtn = document.getElementById('save-custom-prompt-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', saveCustomPrompt);
        }

        // Svuota prompt
        const clearBtn = document.getElementById('clear-custom-prompt');
        if (clearBtn) {
            clearBtn.addEventListener('click', clearCustomPrompt);
        }

        // Carica template
        const loadTemplateBtn = document.getElementById('load-template');
        if (loadTemplateBtn) {
            loadTemplateBtn.addEventListener('click', loadTemplate);
        }
    }

    function updateCustomPromptStats() {
        const textarea = document.getElementById('custom-prompt-text');
        if (!textarea) return;

        const text = textarea.value;
        const charCount = text.length;
        const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
        const lineCount = text.split('\n').length;
        const tokenEstimate = Math.round(wordCount * 1.3);

        updateStatDisplay('custom-char-count', charCount);
        updateStatDisplay('custom-word-count', wordCount);
        updateStatDisplay('custom-line-count', lineCount);
        updateStatDisplay('custom-token-count', tokenEstimate);
    }

    function updateStatDisplay(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value;

            // Animazione del valore
            element.style.transform = 'scale(1.1)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 150);
        }
    }

    function saveCustomPrompt() {
        const button = document.getElementById('save-custom-prompt-btn');
        const form = document.getElementById('custom-prompt-form');
        const textarea = document.getElementById('custom-prompt-text');

        // Validazione
        const text = textarea.value.trim();
        if (!text) {
            showToast('Il testo del prompt non può essere vuoto', 'warning');
            textarea.focus();
            return;
        }

        if (text.length < 50) {
            showToast('Il prompt deve essere di almeno 50 caratteri', 'warning');
            textarea.focus();
            return;
        }

        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';

        const formData = new FormData(form);
        formData.append('action', 'save_custom_prompt');
        formData.append('csrfmiddlewaretoken', getCsrfToken());

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = originalText;

            if (data.success) {
                showToast(data.message, 'success');

                // Aggiorna l'interfaccia
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = originalText;
            console.error('Errore:', error);
            showToast('Errore di comunicazione', 'error');
        });
    }

    function clearCustomPrompt() {
        if (confirm('Vuoi davvero svuotare il prompt personalizzato?')) {
            const textarea = document.getElementById('custom-prompt-text');
            textarea.value = '';
            updateCustomPromptStats();
            textarea.focus();
        }
    }

    function loadTemplate() {
        const template = `Sei un assistente esperto che analizza documenti per [DESCRIVI IL DOMINIO/ARGOMENTO].

Il tuo compito è fornire risposte precise e dettagliate utilizzando ESCLUSIVAMENTE le informazioni contenute nei documenti forniti.

Quando rispondi:
1. Analizza attentamente tutti i documenti rilevanti nel contesto
2. Fornisci risposte complete e ben strutturate
3. Cita sempre le fonti specifiche (nome del documento, pagina se disponibile)
4. Se l'informazione richiesta non è presente nei documenti, dichiaralo chiaramente
5. Mantieni un tono [PROFESSIONALE/AMICHEVOLE/TECNICO] appropriato al contesto

Formato delle risposte:
- Inizia con un riassunto diretto della risposta
- Sviluppa i dettagli nelle sezioni successive
- Concludi con i riferimenti alle fonti utilizzate

Non aggiungere informazioni che non sono presenti nei documenti forniti.`;

        const textarea = document.getElementById('custom-prompt-text');
        if (confirm('Sostituire il contenuto attuale con il template predefinito?')) {
            textarea.value = template;
            updateCustomPromptStats();
            textarea.focus();
        }
    }

    // ===== AZIONI RAPIDE =====
    function setupQuickActions() {
        // Reset prompt
        const resetBtn = document.getElementById('reset-prompt-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', resetPrompt);
        }

        // Copy prompt
        document.querySelectorAll('.copy-prompt-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const promptText = this.getAttribute('data-prompt-text');
                copyToClipboard(promptText);
            });
        });
    }

    function resetPrompt() {
        if (confirm('Ripristinare il prompt predefinito? Questa azione eliminerà eventuali personalizzazioni.')) {
            const button = document.getElementById('reset-prompt-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ripristinando...';

            const formData = new FormData();
            formData.append('action', 'reset_prompt_to_default');
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.innerHTML = originalText;

                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                button.disabled = false;
                button.innerHTML = originalText;
                console.error('Errore:', error);
                showToast('Errore di comunicazione', 'error');
            });
        }
    }

    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Prompt copiato negli appunti!', 'success');
            }).catch(() => {
                fallbackCopyToClipboard(text);
            });
        } else {
            fallbackCopyToClipboard(text);
        }
    }

    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            document.execCommand('copy');
            showToast('Prompt copiato negli appunti!', 'success');
        } catch (err) {
            showToast('Impossibile copiare il prompt', 'error');
        }

        document.body.removeChild(textArea);
    }

    // ===== GESTIONE TAB =====
    function setupTabNavigation() {
        // Auto-focus sui campi quando si cambia tab
        const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', function(e) {
                const targetTab = e.target.getAttribute('data-bs-target');

                if (targetTab === '#custom-prompt') {
                    // Focus sul textarea del prompt personalizzato
                    setTimeout(() => {
                        const textarea = document.getElementById('custom-prompt-text');
                        if (textarea) {
                            textarea.focus();
                        }
                    }, 100);
                }
            });
        });
    }

    // ===== UTILITY =====
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
               '';
    }

    function showToast(message, type = 'info') {
        // Crea container se non esiste
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }

        // Mappa i tipi di messaggio ai colori Bootstrap
        const typeMap = {
            'success': 'success',
            'error': 'danger',
            'warning': 'warning',
            'info': 'info'
        };

        const bootstrapType = typeMap[type] || 'info';

        // Crea il toast
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${bootstrapType} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');

        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        container.appendChild(toastEl);

        // Inizializza e mostra il toast
        const toast = new bootstrap.Toast(toastEl, {
            autohide: true,
            delay: type === 'error' ? 5000 : 3000
        });

        toast.show();

        // Rimuovi l'elemento quando il toast viene nascosto
        toastEl.addEventListener('hidden.bs.toast', function() {
            toastEl.remove();
        });

        return toast;
    }
});
</script>