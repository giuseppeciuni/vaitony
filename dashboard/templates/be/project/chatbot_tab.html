<!-- Chatbot Tab - Widget Custom RAG -->
<div class="tab-pane fade" id="chatbot" role="tabpanel" aria-labelledby="chatbot-tab">
    <div class="row">
        <div class="col-lg-10 mx-auto">

            <!-- Header Widget Info -->
            <div class="card mb-4">
                <div class="card-header bg-gradient-primary text-white d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-robot me-2"></i>Widget Chatbot AI Personalizzato
                        </h5>
                        <small class="opacity-75">Sistema RAG sempre online - Zero dipendenze esterne</small>
                    </div>
                    <div class="form-check form-switch form-check-reverse">
                        <input class="form-check-input fs-5" type="checkbox" id="chatbot-toggle"
                              {% if project.is_public_chat_enabled %}checked{% endif %}>
                        <label class="form-check-label text-white fw-bold" for="chatbot-toggle">
                            <span id="chatbot-status-text">
                                {% if project.is_public_chat_enabled %}ATTIVO{% else %}INATTIVO{% endif %}
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Status Info -->
                <div class="card-body">
                    {% if project.is_public_chat_enabled and project.chat_bot_api_key %}
                        <div class="alert alert-success border-0 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading mb-2">üöÄ Widget Operativo e Sempre Online!</h6>
                                    <p class="mb-2">Il tuo chatbot AI √® completamente configurato e pronto per l'integrazione. Nessun problema di "offline" - funziona 24/7.</p>
                                    <div class="row text-sm">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">
                                                <i class="bi bi-database me-1"></i><strong>Progetto:</strong> <code>{{ project.slug }}</code>
                                            </small>
                                            <small class="text-muted d-block">
                                                <i class="bi bi-key me-1"></i><strong>API Key:</strong> <code>{{ project.chat_bot_api_key|slice:":12" }}...</code>
                                            </small>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">
                                                <i class="bi bi-globe me-1"></i><strong>Lingua:</strong>
                                                {% if project.chatbot_language == 'en' %}üá¨üáß English
                                                {% elif project.chatbot_language == 'es' %}üá™üá∏ Espa√±ol
                                                {% elif project.chatbot_language == 'de' %}üá©üá™ Deutsch
                                                {% elif project.chatbot_language == 'fr' %}üá´üá∑ Fran√ßais
                                                {% else %}üáÆüáπ Italiano{% endif %}
                                            </small>
                                            <small class="text-success d-block">
                                                <i class="bi bi-lightning-charge me-1"></i><strong>Tipo:</strong> Widget Custom RAG
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vantaggi Widget Custom -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="bi bi-clock-fill text-success fs-3 d-block mb-2"></i>
                                    <strong class="d-block">24/7 Online</strong>
                                    <small class="text-muted">Mai offline</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="bi bi-lightning-charge-fill text-warning fs-3 d-block mb-2"></i>
                                    <strong class="d-block">Immediate</strong>
                                    <small class="text-muted">Risposte istantanee</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="bi bi-shield-check-fill text-primary fs-3 d-block mb-2"></i>
                                    <strong class="d-block">Sicuro</strong>
                                    <small class="text-muted">Zero dipendenze</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="bi bi-palette-fill text-info fs-3 d-block mb-2"></i>
                                    <strong class="d-block">Personalizzabile</strong>
                                    <small class="text-muted">100% flessibile</small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning border-0">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill fs-4 text-warning me-3"></i>
                                <div>
                                    <h6 class="alert-heading mb-1">Widget Non Configurato</h6>
                                    <p class="mb-0">Attiva il toggle sopra per generare l'API Key e configurare il chatbot.</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Codice di Integrazione -->
            {% if project.is_public_chat_enabled and project.chat_bot_api_key %}
            <div class="card mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="bi bi-code-slash me-2"></i>Codice di Integrazione
                        </h6>
                        <small class="opacity-75">Copia e incolla nel tuo sito web</small>
                    </div>
                    <button class="btn btn-outline-light btn-sm" onclick="copyEmbedCode()">
                        <i class="bi bi-clipboard me-1"></i>Copia Codice
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="position-relative">
                        <pre class="bg-dark text-light p-4 mb-0" style="font-size: 13px; line-height: 1.4; max-height: 500px; overflow-y: auto;"><code id="embed-code"><!-- ü§ñ Widget Chatbot AI per {{ project.name }} -->
<!-- CSS Widget (sempre aggiornato dal server) -->
&lt;link rel="stylesheet" href="{{ request.scheme }}://{{ request.get_host }}/widget/rag-chat-widget.css"&gt;

&lt;script&gt;
// ‚öôÔ∏è Configurazione Widget Chatbot
window.RAG_WIDGET_CONFIG = {
    // üîß Configurazione Obbligatoria (NON MODIFICARE)
    projectSlug: '{{ project.slug }}',
    apiKey: '{{ project.chat_bot_api_key }}',
    baseUrl: '{{ request.scheme }}://{{ request.get_host }}',

    // üé® Personalizzazioni Aspetto (MODIFICA QUESTI VALORI)
    primaryColor: '#1f93ff',           // Colore principale del widget
    secondaryColor: '#6c757d',         // Colore secondario
    backgroundColor: '#f8f9fa',        // Colore di sfondo messaggi

    // üìç Posizione e Comportamento
    position: 'bottom-right',          // Opzioni: bottom-right, bottom-left, top-right, top-left
    autoOpen: false,                   // Apertura automatica: true/false
    openDelay: 5000,                   // Ritardo apertura automatica (millisecondi)

    // üí¨ Testi Personalizzabili
    title: 'Assistente AI - {{ project.name }}',
    welcomeMessage: '{% if project.chatbot_language == "en" %}Hello! I am the AI assistant for {{ project.name }}. How can I help you today?{% elif project.chatbot_language == "es" %}¬°Hola! Soy el asistente de IA para {{ project.name }}. ¬øC√≥mo puedo ayudarte hoy?{% elif project.chatbot_language == "de" %}Hallo! Ich bin der KI-Assistent f√ºr {{ project.name }}. Wie kann ich Ihnen heute helfen?{% elif project.chatbot_language == "fr" %}Bonjour! Je suis l\'assistant IA pour {{ project.name }}. Comment puis-je vous aider aujourd\'hui?{% else %}Ciao! Sono l\'assistente AI per {{ project.name }}. Come posso aiutarti oggi?{% endif %}',
    placeholderText: '{% if project.chatbot_language == "en" %}Write your message...{% elif project.chatbot_language == "es" %}Escribe tu mensaje...{% elif project.chatbot_language == "de" %}Schreiben Sie Ihre Nachricht...{% elif project.chatbot_language == "fr" %}√âcrivez votre message...{% else %}Scrivi il tuo messaggio...{% endif %}',

    // ‚öôÔ∏è Opzioni Avanzate (Opzionali)
    showBranding: false,               // Mostra "Powered by" nel widget
    enableSounds: true,                // Abilita suoni notifiche
    maxMessageLength: 500,             // Lunghezza massima messaggi utente

    // üéØ Personalizzazioni Avanzate
    borderRadius: '12px',              // Raggio bordi widget
    fontSize: '14px',                  // Dimensione font messaggi
    chatHeight: '500px',               // Altezza finestra chat
    chatWidth: '350px'                 // Larghezza finestra chat
};
&lt;/script&gt;

<!-- üìú JavaScript Widget (sempre aggiornato dal server) -->
&lt;script src="{{ request.scheme }}://{{ request.get_host }}/widget/rag-chat-widget.js"&gt;&lt;/script&gt;

<!-- üîß API e Eventi Personalizzati (Opzionale - per sviluppatori) -->
&lt;script&gt;
// üéâ Eventi del Widget (utili per analytics e integrazioni)
window.addEventListener('ragWidgetReady', function(event) {
    console.log('ü§ñ Widget RAG pronto:', event.detail.config);

    // Esempio: Apri automaticamente per nuovi visitatori
    // if (!localStorage.getItem('chat_visited')) {
    //     setTimeout(() => window.RAGWidget.open(), 3000);
    //     localStorage.setItem('chat_visited', 'true');
    // }
});

window.addEventListener('ragMessageReceived', function(event) {
    console.log('üí¨ Risposta ricevuta:', event.detail);

    // Esempio: Tracciamento Google Analytics
    // if (typeof gtag !== 'undefined') {
    //     gtag('event', 'chat_interaction', {
    //         'event_category': 'chatbot',
    //         'event_label': 'ai_response',
    //         'question_length': event.detail.question.length
    //     });
    // }
});

window.addEventListener('ragChatOpened', function() {
    console.log('üîì Chat aperta');
    // Inserisci qui la tua logica personalizzata
});

window.addEventListener('ragChatClosed', function() {
    console.log('üîí Chat chiusa');
    // Inserisci qui la tua logica personalizzata
});

// üõ†Ô∏è API Widget Disponibili (usa in console o nel tuo JavaScript):
// window.RAGWidget.open()              ‚Üí Apri chat manualmente
// window.RAGWidget.close()             ‚Üí Chiudi chat
// window.RAGWidget.toggle()            ‚Üí Apri/Chiudi chat
// window.RAGWidget.isOpen()            ‚Üí Verifica se chat √® aperta
// window.RAGWidget.sendMessage(msg)    ‚Üí Invia messaggio programmaticamente
// window.RAGWidget.clearHistory()      ‚Üí Cancella cronologia chat
// window.RAGWidget.getHistory()        ‚Üí Ottieni cronologia messaggi
// window.RAGWidget.updateConfig(cfg)   ‚Üí Aggiorna configurazione in tempo reale

// Esempio controllo programmatico:
// setTimeout(() => window.RAGWidget.open(), 5000);           // Apri dopo 5 secondi
// window.RAGWidget.sendMessage('Ciao, ho bisogno di aiuto'); // Invia messaggio automatico
&lt;/script&gt;</code></pre>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-2">üìã Istruzioni di Installazione:</h6>
                            <ol class="mb-0 small">
                                <li><strong>Copia</strong> tutto il codice sopra</li>
                                <li><strong>Incolla</strong> prima del tag <code>&lt;/body&gt;</code> del tuo sito</li>
                                <li><strong>Personalizza</strong> i valori in <code>RAG_WIDGET_CONFIG</code> se necessario</li>
                                <li><strong>Salva</strong> e ricarica la pagina - il widget apparir√† automaticamente!</li>
                            </ol>
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-2">‚ö° Vantaggi Architettura:</h6>
                            <ul class="mb-0 small text-muted">
                                <li>CSS/JS sempre aggiornati dal server</li>
                                <li>Codice leggero da integrare (~2KB)</li>
                                <li>Personalizzazioni semplificate</li>
                                <li>API programmatica completa</li>
                                <li>Eventi per integrazioni avanzate</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Configurazione Lingua -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-translate me-2"></i>Configurazione Lingua Widget
                    </h6>
                </div>
                <div class="card-body">
                    <form id="language-form" method="POST" action="{% url 'project' project.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_chatbot_language">

                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label for="chatbot_language" class="form-label">
                                    <i class="bi bi-globe me-1"></i>Lingua dell'interfaccia chatbot
                                </label>
                                <select class="form-select" id="chatbot_language" name="chatbot_language">
                                    <option value="it" {% if project.chatbot_language == 'it' or not project.chatbot_language %}selected{% endif %}>
                                        üáÆüáπ Italiano
                                    </option>
                                    <option value="en" {% if project.chatbot_language == 'en' %}selected{% endif %}>
                                        üá¨üáß English
                                    </option>
                                    <option value="es" {% if project.chatbot_language == 'es' %}selected{% endif %}>
                                        üá™üá∏ Espa√±ol
                                    </option>
                                    <option value="de" {% if project.chatbot_language == 'de' %}selected{% endif %}>
                                        üá©üá™ Deutsch
                                    </option>
                                    <option value="fr" {% if project.chatbot_language == 'fr' %}selected{% endif %}>
                                        üá´üá∑ Fran√ßais
                                    </option>
                                </select>
                                <div class="form-text">
                                    Modifica la lingua dei messaggi di sistema del widget (benvenuto, placeholder, etc.)
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-info w-100" id="save-language-btn">
                                    <i class="bi bi-check-lg me-1"></i>Aggiorna Lingua
                                </button>
                            </div>
                        </div>
                    </form>

                    {% if project.chat_bot_api_key %}
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Nota:</strong> Dopo aver cambiato la lingua, ri-copia il codice di integrazione per applicare le modifiche.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Anteprima e Documentazione -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-eye me-2"></i>Anteprima e Documentazione
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-palette me-2"></i>Personalizzazioni Disponibili</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Parametro</th>
                                            <th>Descrizione</th>
                                            <th>Esempio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>primaryColor</code></td>
                                            <td>Colore principale</td>
                                            <td><code>'#e74c3c'</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>position</code></td>
                                            <td>Posizione widget</td>
                                            <td><code>'bottom-left'</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>autoOpen</code></td>
                                            <td>Apertura automatica</td>
                                            <td><code>true</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>title</code></td>
                                            <td>Titolo chat</td>
                                            <td><code>'Il Mio Bot'</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>chatHeight</code></td>
                                            <td>Altezza finestra</td>
                                            <td><code>'600px'</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-gear me-2"></i>API JavaScript Disponibili</h6>
                            <div class="bg-light p-3 rounded">
                                <div class="small font-monospace">
                                    <div class="mb-2"><strong>Controllo Base:</strong></div>
                                    <div class="text-muted mb-1">window.RAGWidget.open()</div>
                                    <div class="text-muted mb-1">window.RAGWidget.close()</div>
                                    <div class="text-muted mb-1">window.RAGWidget.toggle()</div>

                                    <div class="mb-2 mt-3"><strong>Interazione:</strong></div>
                                    <div class="text-muted mb-1">window.RAGWidget.sendMessage(text)</div>
                                    <div class="text-muted mb-1">window.RAGWidget.clearHistory()</div>

                                    <div class="mb-2 mt-3"><strong>Status:</strong></div>
                                    <div class="text-muted mb-1">window.RAGWidget.isOpen()</div>
                                    <div class="text-muted mb-1">window.RAGWidget.getHistory()</div>
                                </div>
                            </div>

                            <h6 class="mt-3"><i class="bi bi-lightning me-2"></i>Eventi Disponibili</h6>
                            <div class="small">
                                <span class="badge bg-secondary me-1">ragWidgetReady</span>
                                <span class="badge bg-secondary me-1">ragMessageReceived</span>
                                <span class="badge bg-secondary me-1">ragChatOpened</span>
                                <span class="badge bg-secondary me-1">ragChatClosed</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Tecniche -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Informazioni Tecniche
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-success">‚úÖ Caratteristiche</h6>
                            <ul class="list-unstyled small">
                                <li><i class="bi bi-check text-success me-1"></i>Always online (24/7)</li>
                                <li><i class="bi bi-check text-success me-1"></i>Risposte immediate</li>
                                <li><i class="bi bi-check text-success me-1"></i>Mobile responsive</li>
                                <li><i class="bi bi-check text-success me-1"></i>Zero dipendenze esterne</li>
                                <li><i class="bi bi-check text-success me-1"></i>API programmatica completa</li>
                                <li><i class="bi bi-check text-success me-1"></i>Personalizzazione totale</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-info">üîß Compatibilit√†</h6>
                            <ul class="list-unstyled small">
                                <li><i class="bi bi-browser-chrome text-info me-1"></i>Chrome, Firefox, Safari</li>
                                <li><i class="bi bi-phone text-info me-1"></i>Mobile e desktop</li>
                                <li><i class="bi bi-code text-info me-1"></i>Tutti i CMS (WordPress, etc.)</li>
                                <li><i class="bi bi-lightning text-info me-1"></i>Framework JS (React, Vue, etc.)</li>
                                <li><i class="bi bi-shield text-info me-1"></i>HTTPS e HTTP</li>
                                <li><i class="bi bi-globe text-info me-1"></i>Tutti i domini</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-warning">‚ö° Performance</h6>
                            <ul class="list-unstyled small">
                                <li><i class="bi bi-speedometer text-warning me-1"></i>Caricamento: ~2KB gzip</li>
                                <li><i class="bi bi-cloud text-warning me-1"></i>CSS/JS: Cache 24h</li>
                                <li><i class="bi bi-cpu text-warning me-1"></i>Minimal CPU usage</li>
                                <li><i class="bi bi-memory text-warning me-1"></i>Low memory footprint</li>
                                <li><i class="bi bi-wifi text-warning me-1"></i>Offline-ready (cache)</li>
                                <li><i class="bi bi-graph-up text-warning me-1"></i>Lazy loading</li>
                            </ul>
                        </div>
                    </div>

                    {% if project.is_public_chat_enabled %}
                    <hr>
                    <div class="text-center">
                        <h6 class="mb-3">üöÄ Stato Operativo del Widget</h6>
                        <div class="d-inline-flex align-items-center bg-success text-white px-4 py-2 rounded-pill">
                            <i class="bi bi-circle-fill me-2" style="font-size: 8px;"></i>
                            <strong>ONLINE E OPERATIVO</strong>
                        </div>
                        <div class="small text-muted mt-2">
                            API Endpoint: <code>{{ request.scheme }}://{{ request.get_host }}/api/chat/{{ project.slug }}/</code>
                        </div>
                    </div>
                    {% else %}
                    <hr>
                    <div class="text-center">
                        <h6 class="mb-3">‚ö†Ô∏è Stato Widget</h6>
                        <div class="d-inline-flex align-items-center bg-warning text-dark px-4 py-2 rounded-pill">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>NON CONFIGURATO</strong>
                        </div>
                        <div class="small text-muted mt-2">
                            Attiva il toggle in alto per abilitare il widget
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<!-- JavaScript per gestione interfaccia -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    // Gestione toggle chatbot
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const statusText = document.getElementById('chatbot-status-text');

    if (chatbotToggle) {
        chatbotToggle.addEventListener('change', function() {
            const isEnabled = this.checked;

            if (statusText) {
                statusText.textContent = isEnabled ? 'ATTIVO' : 'INATTIVO';
            }

            // Qui puoi aggiungere chiamata AJAX per salvare lo stato
            // fetch('/api/toggle-chatbot', {...})

            // Ricarica la pagina per aggiornare l'interfaccia
            setTimeout(() => {
                window.location.reload();
            }, 500);
        });
    }

    // Gestione form lingua
    const languageForm = document.getElementById('language-form');
    const saveLanguageBtn = document.getElementById('save-language-btn');

    if (languageForm && saveLanguageBtn) {
        languageForm.addEventListener('submit', function(e) {
            const originalText = saveLanguageBtn.innerHTML;
            saveLanguageBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Aggiornando...';
            saveLanguageBtn.disabled = true;

            // Restore in caso di errore
            setTimeout(() => {
                if (saveLanguageBtn.disabled) {
                    saveLanguageBtn.innerHTML = originalText;
                    saveLanguageBtn.disabled = false;
                }
            }, 10000);
        });
    }
});

// Funzione per copiare il codice embed
function copyEmbedCode() {
    try {
        const codeElement = document.getElementById('embed-code');
        if (!codeElement) {
            throw new Error('Elemento codice non trovato');
        }

        const textToCopy = codeElement.textContent;

        // Usa Clipboard API se disponibile
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showCopySuccess();
            }).catch(() => {
                fallbackCopyToClipboard(textToCopy);
            });
        } else {
            fallbackCopyToClipboard(textToCopy);
        }
    } catch (error) {
        console.error('Errore copia:', error);
        alert('Errore durante la copia. Seleziona manualmente il codice e premi Ctrl+C');
    }
}

function fallbackCopyToClipboard(text) {
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = text;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.left = '-9999px';
    document.body.appendChild(tempTextarea);

    tempTextarea.select();
    tempTextarea.setSelectionRange(0, 99999);

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess();
        } else {
            throw new Error('Copy command failed');
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert('Impossibile copiare automaticamente. Seleziona il codice manualmente.');
    } finally {
        document.body.removeChild(tempTextarea);
    }
}

function showCopySuccess() {
    // Trova il bottone e mostra feedback
    const button = event ? event.target.closest('button') : document.querySelector('button[onclick="copyEmbedCode()"]');

    if (button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copiato!';
        button.classList.remove('btn-outline-light');
        button.classList.add('btn-success');

        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-light');
        }, 2500);
    }

    // Mostra toast se disponibile
    if (typeof showToast === 'function') {
        showToast('Codice widget copiato negli appunti!', 'success');
    }

    console.log('‚úÖ Codice widget copiato con successo');
}

// Smooth scroll per ancore
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Auto-save delle personalizzazioni (opzionale)
function autoSaveConfig() {
    const formData = new FormData();
    formData.append('action', 'auto_save_widget_config');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    // Salva automaticamente le modifiche (implementa se necessario)
    // fetch('/auto-save-config/', { method: 'POST', body: formData });
}

// Preview colori in tempo reale (funzionalit√† futura)
function previewColorChange(color) {
    // Implementa preview live del colore
    console.log('Preview colore:', color);
}

// Validazione configurazione widget
function validateWidgetConfig() {
    const requiredFields = ['projectSlug', 'apiKey', 'baseUrl'];
    const config = window.RAG_WIDGET_CONFIG || {};

    const missing = requiredFields.filter(field => !config[field]);

    if (missing.length > 0) {
        console.warn('Configurazione widget incompleta. Campi mancanti:', missing);
        return false;
    }

    console.log('‚úÖ Configurazione widget valida');
    return true;
}

// Export della configurazione (feature utile)
function exportWidgetConfig() {
    const config = {
        projectSlug: '{{ project.slug }}',
        apiKey: '{{ project.chat_bot_api_key }}',
        baseUrl: '{{ request.scheme }}://{{ request.get_host }}',
        language: '{{ project.chatbot_language|default:"it" }}',
        exportDate: new Date().toISOString()
    };

    const dataStr = JSON.stringify(config, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `widget-config-{{ project.slug }}.json`;
    link.click();

    console.log('üìÑ Configurazione esportata');
}

// Diagnostica widget (per debug)
function runWidgetDiagnostics() {
    console.group('üîç Diagnostica Widget RAG');

    // Test connettivit√† API
    fetch('{{ request.scheme }}://{{ request.get_host }}/api/chat/{{ project.slug }}/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-API-Key': '{{ project.chat_bot_api_key }}'
        },
        body: JSON.stringify({ question: 'test diagnostica' })
    })
    .then(response => {
        console.log('‚úÖ API Status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('‚úÖ API Response:', data.success ? 'OK' : 'ERROR');
    })
    .catch(error => {
        console.error('‚ùå API Error:', error);
    });

    // Test file statici
    fetch('{{ request.scheme }}://{{ request.get_host }}/widget/rag-widget.css')
        .then(response => console.log('‚úÖ CSS Status:', response.status))
        .catch(error => console.error('‚ùå CSS Error:', error));

    fetch('{{ request.scheme }}://{{ request.get_host }}/widget/rag-widget.js')
        .then(response => console.log('‚úÖ JS Status:', response.status))
        .catch(error => console.error('‚ùå JS Error:', error));

    console.groupEnd();
}

// Helper per sviluppatori (accessibile da console)
window.RAGWidgetDev = {
    validateConfig: validateWidgetConfig,
    exportConfig: exportWidgetConfig,
    runDiagnostics: runWidgetDiagnostics,
    previewColor: previewColorChange
};

console.log('ü§ñ RAG Widget Admin Panel caricato');
console.log('üí° Usa window.RAGWidgetDev per funzioni di sviluppo');

</script>

<!-- Stili CSS aggiuntivi per l'interfaccia -->
<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: box-shadow 0.15s ease-in-out;
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.alert {
    border-left: 4px solid;
}

.alert-success {
    border-left-color: #28a745;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-info {
    border-left-color: #17a2b8;
}

.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.form-check-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

pre code {
    display: block;
    overflow-x: auto;
    white-space: pre;
}

.table-sm th,
.table-sm td {
    padding: 0.3rem;
    font-size: 0.875rem;
}

.badge {
    font-size: 0.75em;
}

/* Animazioni subtle */
.card-header {
    transition: all 0.3s ease;
}

.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

/* Responsive miglioramenti */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }

    .table-responsive {
        font-size: 0.875rem;
    }

    pre {
        font-size: 12px;
    }
}

/* Dark mode support (futuro) */
@media (prefers-color-scheme: dark) {
    .bg-light {
        background-color: #343a40 !important;
        color: #fff;
    }
}

/* Print styles */
@media print {
    .card {
        break-inside: avoid;
    }

    .btn,
    .form-check,
    .alert {
        display: none !important;
    }
}

/* Accessibility improvements */
.sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
}

/* Focus indicators */
.btn:focus,
.form-control:focus,
.form-select:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* Success/Error states */
.is-valid {
    border-color: #28a745;
}

.is-invalid {
    border-color: #dc3545;
}

/* Custom scrollbar per il codice */
pre::-webkit-scrollbar {
    height: 8px;
    width: 8px;
}

pre::-webkit-scrollbar-track {
    background: #2d3748;
}

pre::-webkit-scrollbar-thumb {
    background: #4a5568;
    border-radius: 4px;
}

pre::-webkit-scrollbar-thumb:hover {
    background: #718096;
}
</style>