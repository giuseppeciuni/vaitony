{% extends 'users/base_users.html' %}
{% load static %}

{% block user_content %}
    {% if form.errors %}
        <div class="vaitony-alert vaitony-alert-error" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; min-width: 350px; animation: slideInDown 0.5s ease-out;">
            <i class="bi bi-exclamation-triangle-fill" style="margin-right: 0.75rem; font-size: 1.1rem;"></i>
            <div>
                <strong>Errori di validazione:</strong>
                {% for key, value in form.errors.items %}
                    <br/><small>{{ key }}: {{ value.0 }}</small>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <div class="vaitony-auth-container">
        <div class="vaitony-auth-box" style="max-width: 520px;">

            <!-- Password Change Form Card -->
            <div style="background: var(--vaitony-white); border-radius: var(--vaitony-radius-2xl); box-shadow: var(--vaitony-shadow-xl); overflow: hidden;">

                <!-- Security Header -->
                <div style="background: linear-gradient(135deg, var(--vaitony-primary) 0%, var(--vaitony-electric-purple) 50%, var(--vaitony-cyber-cyan) 100%); padding: 2.5rem 2rem; text-align: center; position: relative; overflow: hidden;">

                    <!-- Background Security Pattern -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.1; background-image: url('data:image/svg+xml,<svg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"><g fill=\"none\" fill-rule=\"evenodd\"><g fill=\"%23ffffff\" fill-opacity=\"0.3\"><path d=\"M30 10l10 10v20l-10 10-10-10V20l10-10z\"/></g></svg>'); background-size: 30px 30px;"></div>

                    <!-- Main Security Icon -->
                    <div style="position: relative; z-index: 10;">
                        <div class="vaitony-logo vaitony-ai-pulse" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border: 3px solid rgba(255, 255, 255, 0.3); width: 80px; height: 80px; margin: 0 auto 1.5rem;">
                            <i class="bi bi-key-fill" style="font-size: 2.2rem; color: white;"></i>
                        </div>

                        <h1 style="color: white; font-size: 2.2rem; font-weight: 800; margin-bottom: 0.75rem; letter-spacing: -0.02em;">
                            Cambia Password
                        </h1>

                        <div style="display: inline-flex; align-items: center; background: rgba(255, 255, 255, 0.15); padding: 0.75rem 1.5rem; border-radius: 50px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                            <i class="bi bi-shield-lock" style="color: white; margin-right: 0.75rem; font-size: 1rem;"></i>
                            <span style="color: white; font-size: 0.95rem; font-weight: 600;">Aggiornamento Sicuro</span>
                        </div>
                    </div>
                </div>

                <!-- Form Content -->
                <div style="padding: 3rem 2rem;">

                    <!-- Title Section -->
                    <div style="text-align: center; margin-bottom: 2.5rem;">
                        <h2 style="color: var(--vaitony-dark); font-size: 1.6rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.3;">
                            Aggiorna le Tue Credenziali
                        </h2>
                        <p style="color: var(--vaitony-gray-600); font-size: 1rem; line-height: 1.6; max-width: 400px; margin: 0 auto;">
                            Per la tua sicurezza, inserisci la password attuale e scegli una nuova password robusta.
                        </p>
                    </div>

                    <!-- Security Requirements Card -->
                    <div style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%); border: 1px solid rgba(37, 99, 235, 0.2); border-radius: var(--vaitony-radius-xl); padding: 1.5rem; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: flex-start;">
                            <div style="width: 40px; height: 40px; background: var(--vaitony-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                                <i class="bi bi-info-circle" style="color: white; font-size: 1.1rem;"></i>
                            </div>
                            <div>
                                <h4 style="color: var(--vaitony-dark); font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem;">
                                    Requisiti Password Sicura
                                </h4>
                                <ul style="color: var(--vaitony-gray-600); font-size: 0.875rem; line-height: 1.5; margin: 0; padding-left: 1rem;">
                                    <li>Almeno 8 caratteri</li>
                                    <li>Non deve essere simile alle informazioni personali</li>
                                    <li>Non pu√≤ contenere solo numeri</li>
                                    <li>Evita password utilizzate di recente</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Password Change Form -->
                    <form class="form-signin" role="form" method="post" action="" id="passwordChangeForm">
                        {% csrf_token %}

                        <!-- Current Password -->
                        <div style="margin-bottom: 1.75rem;">
                            <label style="display: block; color: var(--vaitony-dark); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                <i class="bi bi-lock" style="color: var(--vaitony-gray-500); margin-right: 0.5rem;"></i>
                                Password Attuale
                            </label>

                            <div style="position: relative;">
                                <input
                                    type="password"
                                    class="vaitony-input"
                                    id="oldPassword"
                                    name="old_password"
                                    placeholder="Inserisci la tua password corrente"
                                    required
                                    style="padding-left: 3rem; padding-right: 3rem; font-size: 1rem; height: 56px;"
                                />
                                <div style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--vaitony-gray-400); font-size: 1.1rem;">
                                    <i class="bi bi-lock"></i>
                                </div>
                                <button
                                    type="button"
                                    onclick="togglePassword('oldPassword')"
                                    style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--vaitony-gray-400); cursor: pointer; padding: 0.25rem;"
                                >
                                    <i class="bi bi-eye" id="oldPasswordEye"></i>
                                </button>
                            </div>
                        </div>

                        <!-- New Password -->
                        <div style="margin-bottom: 1.75rem;">
                            <label style="display: block; color: var(--vaitony-dark); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                <i class="bi bi-key" style="color: var(--vaitony-primary); margin-right: 0.5rem;"></i>
                                Nuova Password
                            </label>

                            <div style="position: relative;">
                                <input
                                    type="password"
                                    class="vaitony-input"
                                    id="newPassword1"
                                    name="new_password1"
                                    placeholder="Scegli una password sicura"
                                    required
                                    style="padding-left: 3rem; padding-right: 3rem; font-size: 1rem; height: 56px;"
                                />
                                <div style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--vaitony-primary); font-size: 1.1rem;">
                                    <i class="bi bi-key"></i>
                                </div>
                                <button
                                    type="button"
                                    onclick="togglePassword('newPassword1')"
                                    style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--vaitony-gray-400); cursor: pointer; padding: 0.25rem;"
                                >
                                    <i class="bi bi-eye" id="newPassword1Eye"></i>
                                </button>
                            </div>

                            <!-- Password Strength Indicator -->
                            <div style="margin-top: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.8rem; color: var(--vaitony-gray-600);">Sicurezza password:</span>
                                    <span id="passwordStrength" style="font-size: 0.8rem; font-weight: 600; color: var(--vaitony-gray-400);">Non inserita</span>
                                </div>
                                <div style="height: 4px; background: var(--vaitony-gray-200); border-radius: 2px; overflow: hidden;">
                                    <div id="passwordStrengthBar" style="height: 100%; width: 0%; background: var(--vaitony-gray-400); transition: all 0.3s ease; border-radius: 2px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Confirm New Password -->
                        <div style="margin-bottom: 2rem;">
                            <label style="display: block; color: var(--vaitony-dark); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                <i class="bi bi-shield-check" style="color: var(--vaitony-success); margin-right: 0.5rem;"></i>
                                Conferma Nuova Password
                            </label>

                            <div style="position: relative;">
                                <input
                                    type="password"
                                    class="vaitony-input"
                                    id="newPassword2"
                                    name="new_password2"
                                    placeholder="Ripeti la nuova password"
                                    required
                                    style="padding-left: 3rem; padding-right: 3rem; font-size: 1rem; height: 56px;"
                                />
                                <div style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--vaitony-success); font-size: 1.1rem;">
                                    <i class="bi bi-shield-check"></i>
                                </div>
                                <button
                                    type="button"
                                    onclick="togglePassword('newPassword2')"
                                    style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--vaitony-gray-400); cursor: pointer; padding: 0.25rem;"
                                >
                                    <i class="bi bi-eye" id="newPassword2Eye"></i>
                                </button>
                            </div>

                            <!-- Password Match Indicator -->
                            <div id="passwordMatchIndicator" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--vaitony-gray-500); display: none;">
                                <i class="bi bi-info-circle" style="margin-right: 0.25rem;"></i>
                                <span id="passwordMatchText">Le password devono corrispondere</span>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button
                            type="submit"
                            id="changePasswordBtn"
                            class="vaitony-btn vaitony-btn-gradient"
                            style="width: 100%; padding: 1rem 1.5rem; font-size: 1rem; font-weight: 600; position: relative; overflow: hidden;"
                        >
                            <span id="buttonText">
                                <i class="bi bi-shield-plus" style="margin-right: 0.75rem; font-size: 1.1rem;"></i>
                                Aggiorna Password
                            </span>
                            <span id="buttonLoading" style="display: none;">
                                <i class="bi bi-arrow-repeat" style="margin-right: 0.75rem; animation: spin 1s linear infinite;"></i>
                                Aggiornamento in corso...
                            </span>
                        </button>
                    </form>

                    <!-- Security Tips -->
                    <div style="background: var(--vaitony-gray-50); border-radius: var(--vaitony-radius-xl); padding: 2rem; margin-top: 2.5rem;">
                        <h3 style="color: var(--vaitony-dark); font-size: 1.2rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;">
                            <i class="bi bi-lightbulb" style="color: var(--vaitony-warning); margin-right: 0.75rem;"></i>
                            Suggerimenti per una Password Forte
                        </h3>

                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; align-items: flex-start; padding: 1rem; background: white; border-radius: var(--vaitony-radius-lg); box-shadow: var(--vaitony-shadow-sm);">
                                <i class="bi bi-check2-circle" style="color: var(--vaitony-success); margin-right: 0.75rem; margin-top: 0.125rem; font-size: 1.1rem; flex-shrink: 0;"></i>
                                <div>
                                    <h4 style="color: var(--vaitony-dark); font-size: 0.95rem; font-weight: 600; margin-bottom: 0.25rem;">
                                        Usa una Combinazione Mista
                                    </h4>
                                    <p style="color: var(--vaitony-gray-600); font-size: 0.85rem; margin: 0; line-height: 1.4;">
                                        Includi lettere maiuscole, minuscole, numeri e simboli speciali
                                    </p>
                                </div>
                            </div>

                            <div style="display: flex; align-items: flex-start; padding: 1rem; background: white; border-radius: var(--vaitony-radius-lg); box-shadow: var(--vaitony-shadow-sm);">
                                <i class="bi bi-check2-circle" style="color: var(--vaitony-success); margin-right: 0.75rem; margin-top: 0.125rem; font-size: 1.1rem; flex-shrink: 0;"></i>
                                <div>
                                    <h4 style="color: var(--vaitony-dark); font-size: 0.95rem; font-weight: 600; margin-bottom: 0.25rem;">
                                        Evita Informazioni Personali
                                    </h4>
                                    <p style="color: var(--vaitony-gray-600); font-size: 0.85rem; margin: 0; line-height: 1.4;">
                                        Non usare nomi, date di nascita o informazioni facilmente reperibili
                                    </p>
                                </div>
                            </div>

                            <div style="display: flex; align-items: flex-start; padding: 1rem; background: white; border-radius: var(--vaitony-radius-lg); box-shadow: var(--vaitony-shadow-sm);">
                                <i class="bi bi-check2-circle" style="color: var(--vaitony-success); margin-right: 0.75rem; margin-top: 0.125rem; font-size: 1.1rem; flex-shrink: 0;"></i>
                                <div>
                                    <h4 style="color: var(--vaitony-dark); font-size: 0.95rem; font-weight: 600; margin-bottom: 0.25rem;">
                                        Considera un Password Manager
                                    </h4>
                                    <p style="color: var(--vaitony-gray-600); font-size: 0.85rem; margin: 0; line-height: 1.4;">
                                        Utilizza strumenti sicuri per generare e memorizzare password complesse
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Links -->
                    <div style="text-align: center; padding-top: 2rem; border-top: 1px solid var(--vaitony-gray-200); margin-top: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <a
                                href="javascript:history.back()"
                                style="display: flex; align-items: center; justify-content: center; padding: 0.875rem; background: var(--vaitony-gray-100); color: var(--vaitony-gray-700); text-decoration: none; border-radius: var(--vaitony-radius-lg); font-size: 0.9rem; font-weight: 500; transition: var(--vaitony-transition);"
                                onmouseover="this.style.background='var(--vaitony-gray-200)'"
                                onmouseout="this.style.background='var(--vaitony-gray-100)'"
                            >
                                <i class="bi bi-arrow-left" style="margin-right: 0.5rem;"></i>
                                Annulla
                            </a>

                            <a
                                href="#"
                                style="display: flex; align-items: center; justify-content: center; padding: 0.875rem; background: var(--vaitony-white); color: var(--vaitony-primary); border: 2px solid var(--vaitony-primary); text-decoration: none; border-radius: var(--vaitony-radius-lg); font-size: 0.9rem; font-weight: 500; transition: var(--vaitony-transition);"
                                onmouseover="this.style.background='var(--vaitony-primary)'; this.style.color='white'"
                                onmouseout="this.style.background='var(--vaitony-white)'; this.style.color='var(--vaitony-primary)'"
                            >
                                <i class="bi bi-question-circle" style="margin-right: 0.5rem;"></i>
                                Aiuto
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('passwordChangeForm');
            const newPassword1 = document.getElementById('newPassword1');
            const newPassword2 = document.getElementById('newPassword2');
            const strengthIndicator = document.getElementById('passwordStrength');
            const strengthBar = document.getElementById('passwordStrengthBar');
            const matchIndicator = document.getElementById('passwordMatchIndicator');
            const matchText = document.getElementById('passwordMatchText');
            const submitBtn = document.getElementById('changePasswordBtn');
            const buttonText = document.getElementById('buttonText');
            const buttonLoading = document.getElementById('buttonLoading');

            // Password strength checker
            newPassword1.addEventListener('input', function() {
                checkPasswordStrength(this.value);
                checkPasswordMatch();
            });

            newPassword2.addEventListener('input', function() {
                checkPasswordMatch();
            });

            // Form submission
            form.addEventListener('submit', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    return;
                }

                // Show loading state
                buttonText.style.display = 'none';
                buttonLoading.style.display = 'inline-flex';
                submitBtn.disabled = true;
                submitBtn.style.background = 'var(--vaitony-gray-500)';
            });

            function checkPasswordStrength(password) {
                let score = 0;
                let feedback = 'Molto debole';
                let color = 'var(--vaitony-error)';

                if (password.length >= 8) score++;
                if (password.match(/[a-z]/)) score++;
                if (password.match(/[A-Z]/)) score++;
                if (password.match(/[0-9]/)) score++;
                if (password.match(/[^a-zA-Z0-9]/)) score++;

                const width = (score / 5) * 100;

                if (score >= 4) {
                    feedback = 'Molto forte';
                    color = 'var(--vaitony-success)';
                } else if (score >= 3) {
                    feedback = 'Forte';
                    color = 'var(--vaitony-cyber-cyan)';
                } else if (score >= 2) {
                    feedback = 'Media';
                    color = 'var(--vaitony-warning)';
                } else if (score >= 1) {
                    feedback = 'Debole';
                    color = 'var(--vaitony-error)';
                }

                if (password.length === 0) {
                    feedback = 'Non inserita';
                    color = 'var(--vaitony-gray-400)';
                }

                strengthIndicator.textContent = feedback;
                strengthIndicator.style.color = color;
                strengthBar.style.width = width + '%';
                strengthBar.style.background = color;
            }

            function checkPasswordMatch() {
                const password1 = newPassword1.value;
                const password2 = newPassword2.value;

                if (password2.length > 0) {
                    matchIndicator.style.display = 'block';

                    if (password1 === password2) {
                        matchText.textContent = 'Le password corrispondono';
                        matchIndicator.style.color = 'var(--vaitony-success)';
                        matchIndicator.innerHTML = '<i class="bi bi-check-circle" style="margin-right: 0.25rem;"></i>' + matchText.textContent;
                    } else {
                        matchText.textContent = 'Le password non corrispondono';
                        matchIndicator.style.color = 'var(--vaitony-error)';
                        matchIndicator.innerHTML = '<i class="bi bi-x-circle" style="margin-right: 0.25rem;"></i>' + matchText.textContent;
                    }
                } else {
                    matchIndicator.style.display = 'none';
                }
            }

            function validateForm() {
                const oldPassword = document.getElementById('oldPassword').value;
                const newPassword1Val = newPassword1.value;
                const newPassword2Val = newPassword2.value;

                if (!oldPassword || !newPassword1Val || !newPassword2Val) {
                    showNotification('Tutti i campi sono obbligatori', 'error');
                    return false;
                }

                if (newPassword1Val !== newPassword2Val) {
                    showNotification('Le nuove password non corrispondono', 'error');
                    return false;
                }

                if (newPassword1Val.length < 8) {
                    showNotification('La password deve essere di almeno 8 caratteri', 'error');
                    return false;
                }

                return true;
            }
        });

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const eye = document.getElementById(inputId + 'Eye');

            if (input.type === 'password') {
                input.type = 'text';
                eye.className = 'bi bi-eye-slash';
            } else {
                input.type = 'password';
                eye.className = 'bi bi-eye';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: 'var(--vaitony-success)',
                error: 'var(--vaitony-error)',
                info: 'var(--vaitony-info)'
            };

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--vaitony-radius-lg);
                box-shadow: var(--vaitony-shadow-xl);
                z-index: 1000;
                font-weight: 600;
                animation: slideInRight 0.5s ease-out;
                max-width: 300px;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease-in';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInDown {
                from { transform: translateY(-100%) translateX(-50%); opacity: 0; }
                to { transform: translateY(0) translateX(-50%); opacity: 1; }
            }

            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }

            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .vaitony-input:focus {
                transform: translateY(-1px);
                transition: all 0.2s ease;
            }
        `;
        document.head.appendChild(style);
    </script>
{% endblock %}