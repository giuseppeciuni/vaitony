{% extends 'users/base_users.html' %}
{% load static %}

{% block user_content %}
<div class="vaitony-auth-container">
    <div class="vaitony-auth-box" style="max-width: 550px;">

        <!-- Email Error Card -->
        <div style="background: var(--vaitony-white); border-radius: var(--vaitony-radius-2xl); box-shadow: var(--vaitony-shadow-xl); overflow: hidden; position: relative;">

            <!-- Header with Soft Design -->
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #06d6a0 100%); padding: 3rem 2rem; text-align: center; position: relative; overflow: hidden;">

                <!-- Background Pattern -->
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.1; background-image: url('data:image/svg+xml,<svg width=\"50\" height=\"50\" viewBox=\"0 0 50 50\" xmlns=\"http://www.w3.org/2000/svg\"><g fill=\"none\" fill-rule=\"evenodd\"><g fill=\"%23ffffff\" fill-opacity=\"0.3\"><path d=\"M25 5l15 15v20l-15 15-15-15V20L25 5z\"/></g></svg>'); background-size: 25px 25px;"></div>

                <!-- Main Icon -->
                <div style="position: relative; z-index: 10;">
                    <div style="position: relative; display: inline-block; margin-bottom: 1.5rem;">
                        <div class="vaitony-logo" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border: 3px solid rgba(255, 255, 255, 0.3); width: 90px; height: 90px; margin: 0 auto;">
                            <i class="bi bi-envelope-paper-heart" style="font-size: 2.5rem; color: white;"></i>
                        </div>
                    </div>

                    <h1 style="color: white; font-size: 2.2rem; font-weight: 800; margin-bottom: 0.75rem; letter-spacing: -0.02em;">
                        Momentaneamente Non Disponibile
                    </h1>

                    <div style="display: inline-flex; align-items: center; background: rgba(255, 255, 255, 0.15); padding: 0.75rem 1.5rem; border-radius: 50px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                        <i class="bi bi-heart" style="color: white; margin-right: 0.75rem; font-size: 1rem;"></i>
                        <span style="color: white; font-size: 0.95rem; font-weight: 600;">Stiamo Migliorando per Te</span>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div style="padding: 3rem 2rem;">

                <!-- Apology Message -->
                <div style="text-align: center; margin-bottom: 2.5rem;">
                    <h2 style="color: var(--vaitony-dark); font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.3;">
                        üôè Ci Scusiamo per l'Attesa
                    </h2>
                    <p style="color: var(--vaitony-gray-600); font-size: 1.1rem; line-height: 1.6; max-width: 450px; margin: 0 auto;">
                        Stiamo lavorando per garantirti la migliore esperienza possibile. Il servizio torner√† disponibile a breve.
                    </p>

                    {% if user_email %}
                    <div style="background: rgba(37, 99, 235, 0.1); padding: 1rem; border-radius: var(--vaitony-radius-lg); margin-top: 1.5rem; border: 1px solid rgba(37, 99, 235, 0.2);">
                        <p style="color: var(--vaitony-primary); font-size: 0.9rem; margin: 0;">
                            <i class="bi bi-envelope" style="margin-right: 0.5rem;"></i>
                            Ti contatteremo all'indirizzo <strong>{{ user_email }}</strong> appena possibile
                        </p>
                    </div>
                    {% endif %}
                </div>

                <!-- What's Happening -->
                <div style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%); border: 1px solid rgba(37, 99, 235, 0.2); border-radius: var(--vaitony-radius-xl); padding: 2rem; margin-bottom: 2.5rem;">
                    <h3 style="color: var(--vaitony-dark); font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;">
                        <i class="bi bi-heart-fill" style="color: var(--vaitony-primary); margin-right: 0.75rem; font-size: 1.4rem;"></i>
                        Come Ti Stiamo Aiutando
                    </h3>

                    <div style="display: grid; gap: 1.25rem;">
                        <!-- Working for You -->
                        <div style="display: flex; align-items: center; padding: 1rem; background: var(--vaitony-white); border-radius: var(--vaitony-radius-lg); box-shadow: var(--vaitony-shadow-sm); border-left: 4px solid var(--vaitony-primary);">
                            <div style="width: 48px; height: 48px; background: var(--vaitony-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                                <i class="bi bi-people-fill" style="color: white; font-size: 1.2rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="color: var(--vaitony-dark); font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">
                                    Il Nostro Team √® al Lavoro
                                </h4>
                                <p style="color: var(--vaitony-gray-600); font-size: 0.875rem; margin: 0; line-height: 1.4;">
                                    Stiamo dedicando tutte le nostre energie per risolvere velocemente
                                </p>
                            </div>
                            <i class="bi bi-heart-pulse" style="color: var(--vaitony-primary); font-size: 1.5rem;"></i>
                        </div>

                        <!-- Improvements -->
                        <div style="display: flex; align-items: center; padding: 1rem; background: var(--vaitony-white); border-radius: var(--vaitony-radius-lg); box-shadow: var(--vaitony-shadow-sm); border-left: 4px solid var(--vaitony-success);">
                            <div style="width: 48px; height: 48px; background: var(--vaitony-success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                                <i class="bi bi-arrow-up-circle-fill" style="color: white; font-size: 1.2rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="color: var(--vaitony-dark); font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">
                                    Miglioriamo Continuamente
                                </h4>
                                <p style="color: var(--vaitony-gray-600); font-size: 0.875rem; margin: 0; line-height: 1.4;">
                                    Ogni interruzione ci aiuta a rendere VAITony ancora pi√π affidabile
                                </p>
                            </div>
                            <i class="bi bi-arrow-up" style="color: var(--vaitony-success); font-size: 1.5rem;"></i>
                        </div>

                        <!-- Timeline -->
                        <div style="display: flex; align-items: center; padding: 1rem; background: var(--vaitony-white); border-radius: var(--vaitony-radius-lg); box-shadow: var(--vaitony-shadow-sm); border-left: 4px solid var(--vaitony-cyber-cyan);">
                            <div style="width: 48px; height: 48px; background: var(--vaitony-cyber-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                                <i class="bi bi-clock-history" style="color: white; font-size: 1.2rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="color: var(--vaitony-dark); font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">
                                    Saremo Presto Operativi
                                </h4>
                                <p style="color: var(--vaitony-gray-600); font-size: 0.875rem; margin: 0; line-height: 1.4;">
                                    Stiamo facendo il possibile per ridurre al minimo i tempi
                                </p>
                            </div>
                            <i class="bi bi-speedometer2" style="color: var(--vaitony-cyber-cyan); font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                    <!-- Retry Button -->
                    <button
                        id="retryButton"
                        onclick="retryEmailSend()"
                        class="vaitony-btn vaitony-btn-gradient"
                        style="padding: 1rem 1.5rem; font-size: 1rem; font-weight: 600; position: relative; overflow: hidden;"
                    >
                        <span id="retryText">
                            <i class="bi bi-arrow-clockwise" style="margin-right: 0.75rem; font-size: 1.1rem;"></i>
                            {% if action == 'registration' %}
                            Riprova Registrazione
                            {% elif action == 'password_reset' %}
                            Riprova Reset Password
                            {% else %}
                            Riprova
                            {% endif %}
                        </span>
                        <span id="retryLoading" style="display: none;">
                            <i class="bi bi-hourglass-split" style="margin-right: 0.75rem; animation: spin 1s linear infinite;"></i>
                            Verificando...
                        </span>
                    </button>

                    <!-- Alternative Actions -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <a
                            href="mailto:support@vaitony.com?subject=Assistenza VAITony&body=Ciao, ho bisogno di assistenza con il mio account VAITony. Grazie!"
                            style="display: flex; align-items: center; justify-content: center; padding: 0.875rem; background: var(--vaitony-white); color: var(--vaitony-primary); border: 2px solid var(--vaitony-primary); text-decoration: none; border-radius: var(--vaitony-radius-lg); font-size: 0.9rem; font-weight: 500; transition: var(--vaitony-transition);"
                            onmouseover="this.style.background='var(--vaitony-primary)'; this.style.color='white'"
                            onmouseout="this.style.background='var(--vaitony-white)'; this.style.color='var(--vaitony-primary)'"
                        >
                            <i class="bi bi-heart" style="margin-right: 0.5rem;"></i>
                            Contattaci
                        </a>

                        <a
                            href="{% url 'login' %}"
                            style="display: flex; align-items: center; justify-content: center; padding: 0.875rem; background: var(--vaitony-gray-100); color: var(--vaitony-gray-700); text-decoration: none; border-radius: var(--vaitony-radius-lg); font-size: 0.9rem; font-weight: 500; transition: var(--vaitony-transition);"
                            onmouseover="this.style.background='var(--vaitony-gray-200)'"
                            onmouseout="this.style.background='var(--vaitony-gray-100)'"
                        >
                            <i class="bi bi-house" style="margin-right: 0.5rem;"></i>
                            Torna alla Home
                        </a>
                    </div>
                </div>

                <!-- Support Information -->
                <div style="text-align: center; padding-top: 1.5rem; border-top: 1px solid var(--vaitony-gray-200);">
                    <p style="color: var(--vaitony-gray-600); font-size: 0.85rem; margin-bottom: 0.75rem;">
                        <i class="bi bi-people-fill" style="margin-right: 0.25rem;"></i>
                        Il nostro team √® sempre qui per te
                    </p>
                    <div style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap;">
                        <a
                            href="mailto:support@vaitony.com"
                            style="color: var(--vaitony-primary); text-decoration: none; font-size: 0.9rem; font-weight: 600;"
                        >
                            <i class="bi bi-envelope-heart-fill" style="margin-right: 0.25rem;"></i>
                            support@vaitony.com
                        </a>
                        <a
                            href="tel:+393331234567"
                            style="color: var(--vaitony-primary); text-decoration: none; font-size: 0.9rem; font-weight: 600;"
                        >
                            <i class="bi bi-telephone-fill" style="margin-right: 0.25rem;"></i>
                            +39 333 123 4567
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Monitor -->
        <div style="margin-top: 2rem; text-align: center;">
            <div style="display: inline-flex; align-items: center; background: rgba(37, 99, 235, 0.1); padding: 1rem 1.5rem; border-radius: var(--vaitony-radius-lg); border: 1px solid rgba(37, 99, 235, 0.3);">
                <div id="statusIcon" style="margin-right: 0.75rem;">
                    <i class="bi bi-heart-pulse-fill" style="color: var(--vaitony-primary); font-size: 1.2rem;"></i>
                </div>
                <div style="text-align: left;">
                    <div style="font-size: 0.85rem; color: var(--vaitony-gray-600);">Stato Servizi</div>
                    <div id="systemStatus" style="font-size: 0.9rem; font-weight: 600; color: var(--vaitony-primary);">Lavoriamo per Te</div>
                </div>
                <div style="margin-left: 1rem;">
                    <button
                        onclick="checkSystemStatus()"
                        style="background: none; border: 1px solid var(--vaitony-primary); color: var(--vaitony-primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;"
                    >
                        Verifica
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check status periodically
        setTimeout(checkSystemStatus, 5000);
        setInterval(checkSystemStatus, 120000);
    });

    function retryEmailSend() {
        const button = document.getElementById('retryButton');
        const textSpan = document.getElementById('retryText');
        const loadingSpan = document.getElementById('retryLoading');

        // Show loading state
        textSpan.style.display = 'none';
        loadingSpan.style.display = 'inline-flex';
        button.disabled = true;
        button.style.background = 'var(--vaitony-gray-500)';

        // Make AJAX request to retry email
        fetch('{% url "retry_email" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'email={{ user_email|default:"" }}&action={{ action|default:"unknown" }}'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                textSpan.innerHTML = '<i class="bi bi-check-circle" style="margin-right: 0.75rem;"></i>Tutto Risolto!';
                button.style.background = 'var(--vaitony-success)';
                showNotification('Perfetto! Ora tutto funziona correttamente.', 'success');

                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 2000);
                }
            } else {
                textSpan.innerHTML = '<i class="bi bi-arrow-clockwise" style="margin-right: 0.75rem;"></i>Riprova';
                button.style.background = 'linear-gradient(135deg, var(--vaitony-primary) 0%, var(--vaitony-electric-purple) 100%)';
                showNotification('Ancora qualche minuto di pazienza, per favore.', 'info');
            }

            textSpan.style.display = 'inline-flex';
            loadingSpan.style.display = 'none';
            button.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            textSpan.innerHTML = '<i class="bi bi-arrow-clockwise" style="margin-right: 0.75rem;"></i>Riprova';
            textSpan.style.display = 'inline-flex';
            loadingSpan.style.display = 'none';
            button.disabled = false;
            button.style.background = 'linear-gradient(135deg, var(--vaitony-primary) 0%, var(--vaitony-electric-purple) 100%)';
            showNotification('Ci stiamo ancora lavorando. Riprova tra poco.', 'info');
        });
    }

    function checkSystemStatus() {
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('systemStatus');

        // Show checking state
        statusIcon.innerHTML = '<i class="bi bi-arrow-repeat" style="color: var(--vaitony-primary); font-size: 1.2rem; animation: spin 1s linear infinite;"></i>';
        statusText.textContent = 'Verificando...';
        statusText.style.color = 'var(--vaitony-primary)';

        fetch('{% url "email_status" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.status === 'operational') {
                    statusIcon.innerHTML = '<i class="bi bi-heart-fill" style="color: var(--vaitony-success); font-size: 1.2rem;"></i>';
                    statusText.textContent = 'Tutto Funziona!';
                    statusText.style.color = 'var(--vaitony-success)';
                    showNotification('Ottimo! Il servizio √® di nuovo disponibile.', 'success');
                } else {
                    statusIcon.innerHTML = '<i class="bi bi-heart-pulse-fill" style="color: var(--vaitony-primary); font-size: 1.2rem;"></i>';
                    statusText.textContent = 'Lavoriamo per Te';
                    statusText.style.color = 'var(--vaitony-primary)';
                }
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
            statusIcon.innerHTML = '<i class="bi bi-heart-pulse-fill" style="color: var(--vaitony-primary); font-size: 1.2rem;"></i>';
            statusText.textContent = 'Lavoriamo per Te';
            statusText.style.color = 'var(--vaitony-primary)';
        });
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const colors = {
            success: 'var(--vaitony-success)',
            error: 'var(--vaitony-error)',
            warning: 'var(--vaitony-warning)',
            info: 'var(--vaitony-info)'
        };

        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type]};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--vaitony-radius-lg);
            box-shadow: var(--vaitony-shadow-xl);
            z-index: 1000;
            font-weight: 600;
            animation: slideInRight 0.5s ease-out;
            max-width: 350px;
            font-size: 0.9rem;
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.5s ease-in';
            setTimeout(() => notification.remove(), 500);
        }, 4000);
    }

    // Get CSRF token for AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}