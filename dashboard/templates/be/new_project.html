{% extends 'be/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .drop-zone {
        max-width: 100%;
        height: 200px;
        padding: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-weight: 500;
        font-size: 20px;
        cursor: pointer;
        color: #cccccc;
        border: 4px dashed #0d6efd;
        border-radius: 10px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .drop-zone--over {
        border-style: solid;
        background-color: rgba(13, 110, 253, 0.1);
    }

    .drop-zone__input {
        display: none;
    }

    .project-card {
        border-left: 4px solid #0d6efd;
        background-color: #f8f9fa;
        padding: 20px;
        transition: all 0.3s ease;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .project-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .tab-content {
        padding-top: 20px;
    }

    .upload-option {
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .upload-option:hover, .upload-option.active {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }

    .upload-option.active i {
        color: #0d6efd;
    }

    /* Nuovi stili per la visualizzazione paginata dei file */
    .files-preview {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
        background-color: white;
        border-radius: 5px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }

    .file-item:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .file-item:last-child {
        margin-bottom: 0;
    }

    .file-icon {
        margin-right: 10px;
        color: #0d6efd;
    }

    .file-item .file-actions {
        display: flex;
        align-items: center;
    }

    .file-item .file-actions button {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .file-item .file-actions button:hover {
        color: #b02a37;
        transform: scale(1.1);
    }

    .file-item .file-info {
        display: flex;
        align-items: center;
        flex: 1;
    }

    .file-item .file-name {
        font-weight: 500;
        color: #212529;
        flex: 1;
        margin-right: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 400px;
    }

    .file-item .file-size {
        font-size: 0.875rem;
        color: #6c757d;
        white-space: nowrap;
        padding: 0.25em 0.65em;
        border-radius: 0.25rem;
        background-color: #e9ecef;
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 15px;
    }

    .page-status {
        margin-bottom: 10px;
        text-align: center;
        color: #6c757d;
    }

    .file-actions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .animate-fade {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .folder-path {
        margin-bottom: 5px;
        font-family: monospace;
        padding: 5px 10px;
        background-color: #e9ecef;
        border-radius: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .folder-structure {
        margin-bottom: 15px;
    }

    .folder-icon {
        color: #ffc107;
    }

    .file-count-badge {
        position: relative;
        top: -1px;
    }

    /* Loading spinner overlay */
    .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        visibility: hidden;
        opacity: 0;
        transition: all 0.2s ease;
    }

    .spinner-overlay.visible {
        visibility: visible;
        opacity: 1;
    }

    .spinner-container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .spinner-text {
        margin-top: 15px;
        color: #0d6efd;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
{# INIZIO NAVIGAZIONE SOTTONAVBAR #}
<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h3 class="mb-0">New Project</h3>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'projects_list' %}">Projects</a></li>
                    <li class="breadcrumb-item active" aria-current="page">New Project</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{# FINE NAVIGAZIONE SOTTONAVBAR #}

<div class="row">
    <div class="col-lg-8 mx-auto">
        {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0"><i class="bi bi-plus-square me-2"></i> Create a new project</h3>
            </div>
            <div class="card-body">
                <form action="{% url 'new_project' %}" method="post" enctype="multipart/form-data" id="new-project-form">
                    {% csrf_token %}

                    <!-- Project Details -->
                    <div class="project-card mb-4">
                        <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>Project Information</h5>
                        <div class="mb-3">
                            <label for="project-name" class="form-label">Project Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="project-name" name="project_name" required>
                            <div class="form-text">Choose a clear and descriptive name for your project</div>
                        </div>

                        <div class="mb-3">
                            <label for="project-description" class="form-label">Project Description</label>
                            <textarea class="form-control" id="project-description" name="description" rows="3"></textarea>
                            <div class="form-text">Brief description of what this project is about (optional)</div>
                        </div>
                    </div>

                    <!-- Upload Options -->
                    <h5 class="mb-3"><i class="bi bi-file-earmark me-2"></i>Project Files (Optional)</h5>
                    <div class="mb-4">
                        <ul class="nav nav-tabs" id="uploadTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button"
                                    role="tab" aria-controls="files" aria-selected="true">
                                    <i class="bi bi-file-earmark me-1"></i>Upload Files
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="folder-tab" data-bs-toggle="tab" data-bs-target="#folder" type="button"
                                    role="tab" aria-controls="folder" aria-selected="false">
                                    <i class="bi bi-folder me-1"></i>Upload Folder
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="uploadTabsContent">
                            <!-- Files Tab -->
                            <div class="tab-pane fade show active" id="files" role="tabpanel" aria-labelledby="files-tab">
                                <div class="drop-zone" id="file-drop-zone">
                                    <span class="drop-zone__prompt">
                                        <i class="bi bi-file-earmark-plus fs-1 d-block mb-2"></i>
                                        Drop files here or click to select
                                    </span>
                                    <input type="file" name="files" class="drop-zone__input" id="file-input" multiple
                                        accept=".pdf,.docx,.doc,.txt,.csv,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                                </div>

                                <div class="files-preview d-none" id="files-preview">
                                    <div class="file-actions-header">
                                        <h6 class="mb-0"><i class="bi bi-files me-2"></i><span id="file-count-badge">0</span> files selected</h6>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="clear-files-btn">
                                            <i class="bi bi-trash me-1"></i>Clear All
                                        </button>
                                    </div>

                                    <div class="page-status d-none" id="file-pagination-status">
                                        Showing <span id="file-start-range">1</span>-<span id="file-end-range">10</span> of <span id="file-total">0</span> files
                                    </div>

                                    <div id="file-list-container">
                                        <!-- Files will be populated here by JavaScript -->
                                    </div>

                                    <div class="pagination-container mt-3" id="file-pagination">
                                        <nav aria-label="File pagination">
                                            <ul class="pagination pagination-sm">
                                                <!-- Pagination will be populated by JavaScript -->
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>

                            <!-- Folder Tab -->
                            <div class="tab-pane fade" id="folder" role="tabpanel" aria-labelledby="folder-tab">
                                <div class="drop-zone" id="folder-drop-zone">
                                    <span class="drop-zone__prompt">
                                        <i class="bi bi-folder-plus fs-1 d-block mb-2"></i>
                                        Drop folder here or click to select
                                    </span>
                                    <input type="file" name="folder" class="drop-zone__input" id="folder-input" webkitdirectory directory multiple
                                        accept=".pdf,.docx,.doc,.txt,.csv,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                                </div>

                                <div class="files-preview d-none" id="folder-preview">
                                    <div class="file-actions-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-folder2-open me-2 folder-icon"></i>
                                            <span id="folder-name-display">Folder</span>
                                            <span class="badge bg-primary ms-2 file-count-badge" id="folder-file-count-badge">0</span>
                                        </h6>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="clear-folder-btn">
                                            <i class="bi bi-trash me-1"></i>Clear All
                                        </button>
                                    </div>

                                    <div class="folder-structure mb-3" id="folder-structure">
                                        <!-- Folder structure will be shown here -->
                                    </div>

                                    <div class="page-status d-none" id="folder-pagination-status">
                                        Showing <span id="folder-start-range">1</span>-<span id="folder-end-range">10</span> of <span id="folder-total">0</span> files
                                    </div>

                                    <div id="folder-list-container">
                                        <!-- Files will be populated here by JavaScript -->
                                    </div>

                                    <div class="pagination-container mt-3" id="folder-pagination">
                                        <nav aria-label="Folder files pagination">
                                            <ul class="pagination pagination-sm">
                                                <!-- Pagination will be populated by JavaScript -->
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'projects_list' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="create-btn" disabled>
                            <i class="bi bi-plus-square me-2"></i>Create Project
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner Overlay -->
<div class="spinner-overlay" id="spinner-overlay">
    <div class="spinner-container">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="spinner-text" id="spinner-text">Creating project...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Form elements
        const projectNameInput = document.getElementById("project-name");
        const createButton = document.getElementById("create-btn");
        const newProjectForm = document.getElementById("new-project-form");
        const spinnerOverlay = document.getElementById("spinner-overlay");
        const spinnerText = document.getElementById("spinner-text");

        // File upload elements
        const fileDropZone = document.getElementById("file-drop-zone");
        const fileInput = document.getElementById("file-input");
        const filesPreview = document.getElementById("files-preview");
        const fileListContainer = document.getElementById("file-list-container");
        const clearFilesBtn = document.getElementById("clear-files-btn");
        const fileCountBadge = document.getElementById("file-count-badge");
        const filePaginationStatus = document.getElementById("file-pagination-status");
        const fileStartRange = document.getElementById("file-start-range");
        const fileEndRange = document.getElementById("file-end-range");
        const fileTotal = document.getElementById("file-total");
        const filePagination = document.getElementById("file-pagination");

        // Folder upload elements
        const folderDropZone = document.getElementById("folder-drop-zone");
        const folderInput = document.getElementById("folder-input");
        const folderPreview = document.getElementById("folder-preview");
        const folderListContainer = document.getElementById("folder-list-container");
        const clearFolderBtn = document.getElementById("clear-folder-btn");
        const folderNameDisplay = document.getElementById("folder-name-display");
        const folderFileCountBadge = document.getElementById("folder-file-count-badge");
        const folderStructure = document.getElementById("folder-structure");
        const folderPaginationStatus = document.getElementById("folder-pagination-status");
        const folderStartRange = document.getElementById("folder-start-range");
        const folderEndRange = document.getElementById("folder-end-range");
        const folderTotal = document.getElementById("folder-total");
        const folderPagination = document.getElementById("folder-pagination");

        // Tab elements
        const uploadTabs = document.getElementById("uploadTabs");
        const filesTab = document.getElementById("files-tab");
        const folderTab = document.getElementById("folder-tab");

        // Track current tab
        let activeTab = "files";

        // Pagination state
        const paginationState = {
            files: {
                items: [],
                currentPage: 1,
                itemsPerPage: 10
            },
            folder: {
                items: [],
                currentPage: 1,
                itemsPerPage: 10
            }
        };

        // Valid file extensions
        const validExtensions = ['.pdf', '.docx', '.doc', '.txt', '.csv', '.xls', '.xlsx', '.ppt', '.pptx', '.jpg', '.jpeg', '.png', '.gif'];

        // Check if form can be submitted
        function checkFormValidity() {
            const projectName = projectNameInput.value.trim();
            // Enable button only if project name exists
            createButton.disabled = !projectName;
        }

        // Project name input listener
        projectNameInput.addEventListener("input", checkFormValidity);

        // Form submit event
        newProjectForm.addEventListener("submit", function(e) {
            // Verify form is valid
            if (!projectNameInput.value.trim()) {
                e.preventDefault();
                alert("Please enter a project name");
                return false;
            }

            // Show loading spinner
            spinnerOverlay.classList.add("visible");
            spinnerText.textContent = "Creating project...";

            // IMPORTANT: Before submitting, remove disabled attribute
            // from inputs that are not active at this moment
            if (activeTab === "files") {
                // If we're uploading individual files, make sure folder input is not disabled
                if (folderInput.disabled) {
                    folderInput.disabled = false;
                    // But make sure it's empty
                    folderInput.value = "";
                }
            } else {
                // If we're uploading a folder, make sure file input is not disabled
                if (fileInput.disabled) {
                    fileInput.disabled = false;
                    // But make sure it's empty
                    fileInput.value = "";
                }
            }

            // Continue with submission
            return true;
        });

        // Setup drag and drop for files
        setupDropZone(fileDropZone, fileInput, handleFiles);

        // Setup drag and drop for folder
        setupDropZone(folderDropZone, folderInput, handleFolder);

        // Tab change listener
        filesTab.addEventListener("click", function() {
            activeTab = "files";
        });

        folderTab.addEventListener("click", function() {
            activeTab = "folder";
        });

        // Clear files button
        clearFilesBtn.addEventListener("click", function() {
            fileInput.value = "";
            filesPreview.classList.add("d-none");
            fileListContainer.innerHTML = "";
            fileDropZone.querySelector(".drop-zone__prompt").innerHTML = `
                <i class="bi bi-file-earmark-plus fs-1 d-block mb-2"></i>
                Drop files here or click to select
            `;
            paginationState.files.items = [];
            paginationState.files.currentPage = 1;
            updateFilePagination();
        });

        // Clear folder button
        clearFolderBtn.addEventListener("click", function() {
            folderInput.value = "";
            folderPreview.classList.add("d-none");
            folderListContainer.innerHTML = "";
            folderStructure.innerHTML = "";
            folderDropZone.querySelector(".drop-zone__prompt").innerHTML = `
                <i class="bi bi-folder-plus fs-1 d-block mb-2"></i>
                Drop folder here or click to select
            `;
            paginationState.folder.items = [];
            paginationState.folder.currentPage = 1;
            updateFolderPagination();
        });

        // Setup drop zone
        function setupDropZone(dropZoneElement, inputElement, handleFunction) {
            dropZoneElement.addEventListener("click", () => {
                inputElement.click();
            });

            inputElement.addEventListener("change", () => {
                if (inputElement.files.length) {
                    handleFunction(inputElement.files);
                }
            });

            dropZoneElement.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZoneElement.classList.add("drop-zone--over");
            });

            ["dragleave", "dragend"].forEach((type) => {
                dropZoneElement.addEventListener(type, () => {
                    dropZoneElement.classList.remove("drop-zone--over");
                });
            });

            dropZoneElement.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZoneElement.classList.remove("drop-zone--over");

                if (e.dataTransfer.files.length) {
                    inputElement.files = e.dataTransfer.files;
                    handleFunction(e.dataTransfer.files);
                }
            });
        }

        // Handle individual files upload
        function handleFiles(files) {
            if (files.length === 0) {
                filesPreview.classList.add("d-none");
                return;
            }

            // Reset the pagination state
            paginationState.files.items = [];
            paginationState.files.currentPage = 1;

            // Process all files
            let validCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                // Check if this is a valid file type
                const isValid = validExtensions.includes(fileExtension);

                if (isValid) {
                    validCount++;
                    // Add to pagination items
                    paginationState.files.items.push({
                        file: file,
                        extension: fileExtension
                    });
                }
            }

            if (validCount > 0) {
                // Update drop zone visually
                const prompt = fileDropZone.querySelector(".drop-zone__prompt");
                if (prompt) {
                    prompt.innerHTML = `
                        <i class="bi bi-check-circle-fill text-success fs-1 d-block mb-2"></i>
                        <span>${validCount} files selected</span>
                        <p class="small text-muted mt-2">Click to change selection</p>
                    `;
                }

                // Update count badge
                fileCountBadge.textContent = validCount;

                // Show files preview
                filesPreview.classList.remove("d-none");

                // Update pagination
                updateFilePagination();
            }

            // Always check form validity
            checkFormValidity();
        }

        // Handle folder upload
        function handleFolder(files) {
            if (files.length === 0) {
                folderPreview.classList.add("d-none");
                return;
            }

            // Reset the pagination state
            paginationState.folder.items = [];
            paginationState.folder.currentPage = 1;

            // Get the root folder name from the first file's path
            const firstFilePath = files[0].webkitRelativePath;
            const rootFolder = firstFilePath.split('/')[0];
            folderNameDisplay.textContent = rootFolder;

            // Count valid files
            let validCount = 0;
            let folderStructureMap = {};

            // Process all files
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                const relativePath = file.webkitRelativePath;

                // Build folder structure
                const pathParts = relativePath.split('/');
                let currentPath = '';
                let currentMap = folderStructureMap;

                for (let j = 0; j < pathParts.length - 1; j++) {
                    const part = pathParts[j];
                    currentPath = currentPath ? `${currentPath}/${part}` : part;

                    if (!currentMap[part]) {
                        currentMap[part] = {
                            __files: [],
                            __path: currentPath
                        };
                    }

                    currentMap = currentMap[part];
                }

                // Add file to the last folder
                if (validExtensions.includes(fileExtension)) {
                    currentMap.__files.push({
                        name: pathParts[pathParts.length - 1],
                        extension: fileExtension,
                        file: file,
                        path: relativePath
                    });

                    validCount++;
                    // Add to pagination items
                    paginationState.folder.items.push({
                        file: file,
                        extension: fileExtension,
                        path: relativePath
                    });
                }
            }

            if (validCount > 0) {
                // Update drop zone visually
                const prompt = folderDropZone.querySelector(".drop-zone__prompt");
                if (prompt) {
                    prompt.innerHTML = `
                        <i class="bi bi-check-circle-fill text-success fs-1 d-block mb-2"></i>
                        <span>Folder "${rootFolder}" selected</span>
                        <p class="small text-muted mt-2">Click to change selection</p>
                    `;
                }

                // Update count badge
                folderFileCountBadge.textContent = validCount;

                // Build folder structure HTML
                folderStructure.innerHTML = buildFolderStructureHTML(folderStructureMap, rootFolder);

                // Show folder preview
                folderPreview.classList.remove("d-none");

                // Update pagination
                updateFolderPagination();
            }

            // Always check form validity
            checkFormValidity();
        }

        // Build HTML for folder structure
        function buildFolderStructureHTML(structureMap, rootFolder) {
            let html = `<div class="folder-path"><i class="bi bi-folder me-2 folder-icon"></i>${rootFolder}/</div>`;

            // Get top level folders
            const rootMap = structureMap[rootFolder];
            if (rootMap) {
                // Get folders excluding special keys
                const folders = Object.keys(rootMap).filter(key => !key.startsWith('__'));

                if (folders.length > 0) {
                    for (const folder of folders) {
                        html += `<div class="folder-path ms-3"><i class="bi bi-folder me-2 folder-icon"></i>${folder}/</div>`;
                    }
                }
            }

            return html;
        }

        // Update file pagination
        function updateFilePagination() {
            const { items, currentPage, itemsPerPage } = paginationState.files;
            const totalItems = items.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Skip pagination if no items
            if (totalItems === 0) {
                fileListContainer.innerHTML = '';
                filePagination.innerHTML = '';
                filePaginationStatus.classList.add('d-none');
                return;
            }

            // Show pagination status
            filePaginationStatus.classList.remove('d-none');

            // Calculate start and end item indices
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);

            // Update pagination status text
            fileStartRange.textContent = startIndex + 1;
            fileEndRange.textContent = endIndex;
            fileTotal.textContent = totalItems;

            // Clear current list
            fileListContainer.innerHTML = '';

            // Add files for current page
            for (let i = startIndex; i < endIndex; i++) {
                const item = items[i];
                const itemElement = createFileItemElement(item.file, item.extension);
                fileListContainer.appendChild(itemElement);
            }

            // Generate pagination controls
            generatePaginationControls('files', totalPages, currentPage);
        }

        // Update folder pagination
        function updateFolderPagination() {
            const { items, currentPage, itemsPerPage } = paginationState.folder;
            const totalItems = items.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Skip pagination if no items
            if (totalItems === 0) {
                folderListContainer.innerHTML = '';
                folderPagination.innerHTML = '';
                folderPaginationStatus.classList.add('d-none');
                return;
            }

            // Show pagination status
            folderPaginationStatus.classList.remove('d-none');

            // Calculate start and end item indices
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);

            // Update pagination status text
            folderStartRange.textContent = startIndex + 1;
            folderEndRange.textContent = endIndex;
            folderTotal.textContent = totalItems;

            // Clear current list
            folderListContainer.innerHTML = '';

            // Add files for current page
            for (let i = startIndex; i < endIndex; i++) {
                const item = items[i];
                const itemElement = createFileItemElement(item.file, item.extension, item.path);
                folderListContainer.appendChild(itemElement);
            }

            // Generate pagination controls
            generatePaginationControls('folder', totalPages, currentPage);
        }

        // Generate pagination controls
        function generatePaginationControls(type, totalPages, currentPage) {
            const paginationElement = type === 'files' ? filePagination.querySelector('ul') : folderPagination.querySelector('ul');
            paginationElement.innerHTML = '';

            // Skip pagination for single page
            if (totalPages <= 1) {
                return;
            }

            // Previous button
            const prevItem = document.createElement('li');
            prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevItem.innerHTML = `
                <button class="page-link" data-page="prev" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </button>
            `;
            paginationElement.appendChild(prevItem);

            // Page buttons
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust if at the edges
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // First page button if needed
            if (startPage > 1) {
                const firstItem = document.createElement('li');
                firstItem.className = 'page-item';
                firstItem.innerHTML = `
                    <button class="page-link" data-page="1">1</button>
                `;
                paginationElement.appendChild(firstItem);

                // Ellipsis if needed
                if (startPage > 2) {
                    const ellipsisItem = document.createElement('li');
                    ellipsisItem.className = 'page-item disabled';
                    ellipsisItem.innerHTML = `
                        <button class="page-link">...</button>
                    `;
                    paginationElement.appendChild(ellipsisItem);
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageItem.innerHTML = `
                    <button class="page-link" data-page="${i}">${i}</button>
                `;
                paginationElement.appendChild(pageItem);
            }

            // Last page button if needed
            if (endPage < totalPages) {
                // Ellipsis if needed
                if (endPage < totalPages - 1) {
                    const ellipsisItem = document.createElement('li');
                    ellipsisItem.className = 'page-item disabled';
                    ellipsisItem.innerHTML = `
                        <button class="page-link">...</button>
                    `;
                    paginationElement.appendChild(ellipsisItem);
                }

                const lastItem = document.createElement('li');
                lastItem.className = 'page-item';
                lastItem.innerHTML = `
                    <button class="page-link" data-page="${totalPages}">${totalPages}</button>
                `;
                paginationElement.appendChild(lastItem);
            }

            // Next button
            const nextItem = document.createElement('li');
            nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextItem.innerHTML = `
                <button class="page-link" data-page="next" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </button>
            `;
            paginationElement.appendChild(nextItem);

            // Add event listeners to pagination buttons
            paginationElement.querySelectorAll('.page-link').forEach(button => {
                button.addEventListener('click', function() {
                    const pageData = this.getAttribute('data-page');
                    let newPage = currentPage;

                    if (pageData === 'prev') {
                        newPage = Math.max(1, currentPage - 1);
                    } else if (pageData === 'next') {
                        newPage = Math.min(totalPages, currentPage + 1);
                    } else {
                        newPage = parseInt(pageData);
                    }

                    if (newPage !== currentPage) {
                        if (type === 'files') {
                            paginationState.files.currentPage = newPage;
                            updateFilePagination();
                        } else {
                            paginationState.folder.currentPage = newPage;
                            updateFolderPagination();
                        }
                    }
                });
            });
        }

        // Create a file item element
        function createFileItemElement(file, fileExtension, filePath = null) {
            // Format file size
            const fileSizeKB = Math.round(file.size / 1024);
            const fileSizeDisplay = fileSizeKB < 1024
                ? fileSizeKB + " KB"
                : (fileSizeKB / 1024).toFixed(2) + " MB";

            // Get icon class based on file extension
            let iconClass = getFileIconClass(fileExtension);

            // Create file item element
            const fileItem = document.createElement("div");
            fileItem.className = "file-item animate-fade";

            // Display name based on path or just filename
            const displayName = filePath || file.name;

            // Set file item content
            fileItem.innerHTML = `
                <div class="file-info">
                    <i class="bi ${iconClass} file-icon"></i>
                    <span class="file-name" title="${displayName}">${displayName}</span>
                    <span class="file-size">${fileSizeDisplay}</span>
                </div>
                <div class="file-actions">
                    <button type="button" class="remove-file-btn" title="Remove file">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            `;

            // Add event listener for remove button
            const removeButton = fileItem.querySelector('.remove-file-btn');
            removeButton.addEventListener('click', function() {
                const isFolder = filePath !== null;
                const stateKey = isFolder ? 'folder' : 'files';
                const items = paginationState[stateKey].items;

                // Find the index of the file to remove
                const itemIndex = items.findIndex(item =>
                    (isFolder && item.path === filePath) ||
                    (!isFolder && item.file.name === file.name)
                );

                if (itemIndex !== -1) {
                    // Remove the file from the items array
                    items.splice(itemIndex, 1);

                    // Update the file count
                    const countBadge = isFolder ? folderFileCountBadge : fileCountBadge;
                    countBadge.textContent = items.length;

                    // Update pagination
                    if (isFolder) {
                        updateFolderPagination();

                        // Hide folder preview if no files left
                        if (items.length === 0) {
                            folderPreview.classList.add('d-none');
                            folderDropZone.querySelector(".drop-zone__prompt").innerHTML = `
                                <i class="bi bi-folder-plus fs-1 d-block mb-2"></i>
                                Drop folder here or click to select
                            `;
                        }
                    } else {
                        updateFilePagination();

                        // Hide files preview if no files left
                        if (items.length === 0) {
                            filesPreview.classList.add('d-none');
                            fileDropZone.querySelector(".drop-zone__prompt").innerHTML = `
                                <i class="bi bi-file-earmark-plus fs-1 d-block mb-2"></i>
                                Drop files here or click to select
                            `;
                        }
                    }
                }
            });

            return fileItem;
        }

        // Get file icon class based on extension
        function getFileIconClass(fileExtension) {
            if (fileExtension === ".pdf") {
                return "bi-file-earmark-pdf";
            } else if ([".doc", ".docx"].includes(fileExtension)) {
                return "bi-file-earmark-word";
            } else if ([".xls", ".xlsx"].includes(fileExtension)) {
                return "bi-file-earmark-excel";
            } else if ([".ppt", ".pptx"].includes(fileExtension)) {
                return "bi-file-earmark-slides";
            } else if ([".jpg", ".jpeg", ".png", ".gif"].includes(fileExtension)) {
                return "bi-file-earmark-image";
            } else if (fileExtension === ".txt") {
                return "bi-file-earmark-text";
            } else if (fileExtension === ".csv") {
                return "bi-file-earmark-spreadsheet";
            }
            return "bi-file-earmark";
        }

        // Initialize form state
        checkFormValidity();
    });
</script>
{% endblock %}