{% extends 'be/base.html' %}
{% load static %}
{% load custom_filter %}

<!-- Additional CSS for this specific page -->
{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous">
    <style>
        .project-card {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }

        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }

        .stat-card {
            border-left: 4px solid;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.documents {
            border-left-color: #0d6efd;
        }

        .stat-card.notes {
            border-left-color: #20c997;
        }

        .stat-card.interactions {
            border-left-color: #fd7e14;
        }

        .stat-card.projects {
            border-left-color: #6f42c1;
        }

        .project-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            color: white;
            margin-right: 1rem;
        }

        .activity-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.25rem;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 7px;
            height: 100%;
            border-left: 2px dashed #dee2e6;
        }

        .activity-item:last-child::before {
            height: 0;
        }

        .activity-badge {
            position: absolute;
            left: 0;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #0d6efd;
            z-index: 1;
        }

        .activity-badge.file {
            background-color: #0d6efd;
        }

        .activity-badge.note {
            background-color: #20c997;
        }

        .activity-badge.question {
            background-color: #fd7e14;
        }

        .activity-badge.project {
            background-color: #6f42c1;
        }

        /* Stili per la sezione cache più compatta */
        .cache-compact-card {
            transition: all 0.3s ease;
        }

        .cache-compact-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
        }

        .cache-mini-stat {
            padding: 0.5rem;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
    </style>
{% endblock %}

<!-- Main content of the page -->
{% block content %}
    <!-- Header e Navigazione -->
    <div class="app-content-header">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <h3 class="mb-0">Dashboard Progetti</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-end">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiche generali -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card projects h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Progetti totali</h5>
                            <h2 class="font-weight-bold mb-0">{{ projects.count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-folder fs-1 text-primary"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ projects_growth|default:12 }}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card documents h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Documenti</h5>
                            <h2 class="font-weight-bold mb-0">{{ documents_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-files fs-1 text-primary"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ documents_growth|default:18 }}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card notes h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Note</h5>
                            <h2 class="font-weight-bold mb-0">{{ notes_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-journal-text fs-1 text-success"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ notes_growth|default:25 }}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card interactions h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Interazioni AI</h5>
                            <h2 class="font-weight-bold mb-0">{{ conversations_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-robot fs-1 text-warning"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ conversations_growth|default:35 }}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
<div class="row">
        <div class="col-lg-8">
            <!-- Attività recenti e grafici -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Attività dei progetti</h3>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector active" data-period="week">Settimana</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector" data-period="month">Mese</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector" data-period="year">Anno</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-4">
                        <div>
                            <h4 class="mb-0">{{ total_activities }}</h4>
                            <small class="text-muted">Attività totali</small>
                        </div>
                        <div class="text-end">
                            <h4 class="text-success mb-0">+{{ active_projects }}</h4>
                            <small class="text-muted">Progetti attivi</small>
                        </div>
                    </div>
                    <div class="position-relative mb-4">
                        <div id="activity-chart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- Progetti principali -->
            <div class="card mb-4">
                <div class="card-header border-0 bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">Progetti principali</h3>
                        <a href="{% url 'projects_list' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-grid-3x3-gap-fill me-1"></i> Vedi tutti
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
                        {% if projects %}
                            {% for project in projects|slice:":6" %}
                            <div class="col">
                                <div class="card h-100 project-card border shadow-sm">
                                    <div class="card-header d-flex align-items-center py-2 px-3" style="background-color: {% cycle '#0d6efd' '#20c997' '#fd7e14' '#6f42c1' '#dc3545' '#0dcaf0' %}20;">
                                        <div class="project-icon me-2" style="background-color: {% cycle '#0d6efd' '#20c997' '#fd7e14' '#6f42c1' '#dc3545' '#0dcaf0' %};">
                                            <i class="bi bi-folder2"></i>
                                        </div>
                                        <h5 class="card-title mb-0 text-truncate">{{ project.name }}</h5>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <div>
                                                <i class="bi bi-files text-primary"></i>
                                                <span class="ms-1">{{ project.files.count }} doc</span>
                                            </div>
                                            <div>
                                                <i class="bi bi-journal-text text-success"></i>
                                                <span class="ms-1">{{ project.project_notes.count }} note</span>
                                            </div>
                                            <div>
                                                <i class="bi bi-chat-dots text-warning"></i>
                                                <span class="ms-1">{{ project.conversations.count }} chat</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent pt-0 border-top-0">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Aggiornato: {{ project.updated_at|date:"d M Y" }}</small>
                                            <a href="{% url 'project' project.id %}" class="btn btn-sm btn-primary stretched-link">
                                                <i class="bi bi-eye me-1"></i>Visualizza
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="card border-0 text-center py-5 bg-light">
                                    <div class="card-body">
                                        <i class="bi bi-folder-x fs-1 text-muted mb-3"></i>
                                        <h4>Nessun progetto disponibile</h4>
                                        <p class="text-muted">Crea il tuo primo progetto per iniziare</p>
                                        <a href="{% url 'new_project' %}" class="btn btn-primary mt-2">
                                            <i class="bi bi-plus-lg me-1"></i> Crea nuovo progetto
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    <div class="col-lg-4">
            <!-- Distribuzione documenti -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <h3 class="card-title">Tipologie documenti</h3>
                </div>
                <div class="card-body">
                    <div id="documents-chart" style="height: 250px;"></div>
                </div>
            </div>

            <!-- Attività recenti -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Attività recenti</h3>
                        <a href="#" class="link-primary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">Vedi tutte</a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% for activity in recent_activities|slice:":5" %}
                        <div class="activity-item">
                            <div class="activity-badge {{ activity.type }}"></div>
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-1 fw-bold">{{ activity.project_name }}</h6>
                                <small class="text-muted">{{ activity.created_at|time:"H:i" }}</small>
                            </div>
                            <p class="mb-1">{{ activity.description|truncatechars:60 }}</p>
                            <small class="text-muted">{{ activity.created_at|date:"d M Y" }}</small>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox fs-1 text-muted"></i>
                            <p class="text-muted mt-2 mb-0">Nessuna attività recente</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Cache Embedding Compatta -->
            <div class="card cache-compact-card">
                <div class="card-header bg-success bg-opacity-10 border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-piggy-bank-fill text-success me-2"></i>
                            Cache Embedding
                        </h5>
                        <button class="btn btn-sm btn-outline-success" onclick="toggleCacheDetails()">
                            <i class="bi bi-gear"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Risparmio totale in evidenza -->
                    <div class="text-center mb-3">
                        <h3 class="text-success mb-0">${{ cache_stats.estimated_savings|floatformat:2|default:"0.00" }}</h3>
                        <small class="text-muted">Risparmiati</small>
                    </div>

                    <!-- Mini statistiche in griglia -->
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="cache-mini-stat text-center">
                                <h6 class="mb-0">{{ total_cache_stats.reuses|default:"0" }}</h6>
                                <small class="text-muted">Riutilizzi</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="cache-mini-stat text-center">
                                <h6 class="mb-0">{{ cache_stats.hit_rate|floatformat:1|default:"0" }}%</h6>
                                <small class="text-muted">Hit Rate</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="cache-mini-stat text-center">
                                <h6 class="mb-0">{{ cache_stats.size_in_mb|floatformat:1|default:"0" }}MB</h6>
                                <small class="text-muted">Dimensione</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="cache-mini-stat text-center">
                                <h6 class="mb-0">20x</h6>
                                <small class="text-muted">Più veloce</small>
                            </div>
                        </div>
                    </div>

                    <!-- Dettagli cache nascosti di default -->
                    <div id="cacheDetails" class="collapse mt-3">
                        <hr>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="update-cache-stats-btn">
                                <i class="bi bi-arrow-repeat me-1"></i>Aggiorna statistiche
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showCacheModal()">
                                <i class="bi bi-gear me-1"></i>Gestione avanzata
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per la gestione avanzata della cache -->
    <div class="modal fade" id="cacheModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestione Cache Embedding</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Tab navigation -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#statistics">Statistiche</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#management">Gestione</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#reports">Report</a>
                        </li>
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="statistics">
                            <div class="row">
                                <div class="col-md-6">
                                    <div id="cache-savings-chart" style="height: 250px;"></div>
                                </div>
                                <div class="col-md-6">
                                    <div id="cache-types-chart" style="height: 250px;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="management">
                            <div class="d-grid gap-2">
                                <button class="btn btn-warning" onclick="cleanCache()">
                                    <i class="bi bi-trash3 me-1"></i>Pulisci file orfani
                                </button>
                                <button class="btn btn-danger" onclick="clearCache()">
                                    <i class="bi bi-x-circle me-1"></i>Svuota tutta la cache
                                </button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="reports">
                            <form id="reportForm">
                                <div class="mb-3">
                                    <label for="reportType" class="form-label">Tipo di Report</label>
                                    <select class="form-select" id="reportType">
                                        <option value="summary">Riepilogo</option>
                                        <option value="detailed">Dettagliato</option>
                                        <option value="savings">Risparmi</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="generateReport()">
                                    Genera Report
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Grafico attività
    var activityOptions = {
        series: [{
            name: 'File',
            data: {{ activity_files|safe }}
        }, {
            name: 'Note',
            data: {{ activity_notes|safe }}
        }, {
            name: 'Conversazioni',
            data: {{ activity_conversations|safe }}
        }],
        chart: {
            type: 'area',
            height: 300,
            stacked: true,
            toolbar: { show: false }
        },
        colors: ['#0d6efd', '#20c997', '#fd7e14'],
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        fill: {
            type: 'gradient',
            gradient: {
                opacityFrom: 0.6,
                opacityTo: 0.8,
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'left'
        },
        xaxis: {
            categories: {{ activity_dates|safe }}
        }
    };
    new ApexCharts(document.querySelector("#activity-chart"), activityOptions).render();

    // Grafico documenti
    var documentsOptions = {
        series: {{ document_types_values|safe }},
        chart: {
            type: 'donut',
            height: 250
        },
        labels: {{ document_types_labels|safe }},
        colors: ['#0d6efd', '#6c757d', '#28a745', '#dc3545', '#ffc107'],
        legend: {
            position: 'bottom'
        }
    };
    new ApexCharts(document.querySelector("#documents-chart"), documentsOptions).render();

    // Gestione cache
    window.toggleCacheDetails = function() {
        var cacheDetails = document.getElementById('cacheDetails');
        var bsCollapse = new bootstrap.Collapse(cacheDetails, {
            toggle: true
        });
    }

    window.showCacheModal = function() {
        var cacheModal = new bootstrap.Modal(document.getElementById('cacheModal'));
        cacheModal.show();
    }

    // Update cache stats
    document.getElementById('update-cache-stats-btn').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Aggiornamento...';

        fetch('{% url "dashboard" %}?update_cache_stats=1', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Errore: ' + data.message);
            }
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Aggiorna statistiche';
        });
    });

    // Funzioni per la gestione della cache
    window.cleanCache = function() {
        if (confirm('Pulire i file orfani dalla cache?')) {
            callManagementCommand('manage_embedding_cache', ['--clean']);
        }
    }

    window.clearCache = function() {
        if (confirm('ATTENZIONE: Questa operazione cancellerà tutta la cache. Continuare?')) {
            callManagementCommand('clear_embedding_cache', ['--force']);
        }
    }

    window.generateReport = function() {
        const reportType = document.getElementById('reportType').value;
        callManagementCommand('report_cache_usage', ['--type', reportType]);
    }

    function callManagementCommand(command, args) {
        fetch('{% url "execute_management_command" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                command: command,
                args: args
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Operazione completata con successo!');
                location.reload();
            } else {
                alert('Errore: ' + data.message);
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}