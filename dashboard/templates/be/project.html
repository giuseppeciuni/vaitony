{% extends 'be/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* Base Styles */
    .project-header {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Tab Navigation */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 1.5rem;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom: 3px solid #0d6efd;
        background: transparent;
    }

    /* Card Styles */
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        margin-bottom: 1.5rem;
    }

    .card-header {
        background-color: white;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    /* Document Cards */
    .document-card {
        transition: transform 0.2s;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 0.5rem;
        cursor: pointer;
    }

    .document-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
    }

    .document-icon {
        font-size: 2rem;
    }

    .document-icon.pdf { color: #dc3545; }
    .document-icon.doc, .document-icon.docx { color: #0d6efd; }
    .document-icon.xls, .document-icon.xlsx { color: #198754; }
    .document-icon.jpg, .document-icon.jpeg, .document-icon.png, .document-icon.gif { color: #6f42c1; }

    .card-title {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        max-height: 2.4em;
        overflow: hidden;
    }

    /* Quick Note Section Styles */
    .quick-note-section .card {
        border: 2px dashed #dee2e6;
        transition: all 0.3s ease;
    }

    .quick-note-section .card:hover {
        border-color: #0d6efd;
    }

    .note-input-wrapper textarea {
        font-size: 1rem;
        line-height: 1.6;
        transition: all 0.3s ease;
    }

    .note-input-wrapper textarea:focus {
        background-color: #fff !important;
        box-shadow: none;
        outline: none;
    }

    .note-toolbar {
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
    }

    /* Paste Drop Zone */
    .paste-drop-zone {
        border: 2px dashed #dee2e6;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .paste-drop-zone:hover {
        border-color: #0d6efd;
        background: #e9ecef;
    }

    .paste-drop-zone.dragover {
        border-color: #0d6efd;
        background: #e7f1ff;
    }

    /* Notes Grid */
    .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }

    .note-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 1rem;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
    }

    .note-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .note-actions {
        display: flex;
        gap: 0.25rem;
    }

    .btn-ghost {
        background: transparent;
        border: none;
        padding: 0.25rem;
        color: #6c757d;
        border-radius: 0.25rem;
    }

    .btn-ghost:hover {
        background: #f8f9fa;
        color: #0d6efd;
    }

    .note-content {
        flex-grow: 1;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
        line-height: 1.6;
    }

    .note-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #e9ecef;
        padding-top: 0.5rem;
    }

    /* Empty State */
    .empty-notes-state {
        background: #f8f9fa;
        border-radius: 1rem;
        padding: 3rem;
    }

    /* Animation */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .note-card {
        animation: fadeInUp 0.3s ease forwards;
    }

    /* Sources List */
    .source-item {
        border-left: 3px solid #0d6efd;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }

    /* Empty States */
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
    }

    .empty-state i {
        font-size: 2.5rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }

    /* Tab Content Adjustments */
    .tab-content {
        min-height: calc(100vh - 170px);
        padding-bottom: 60px;
    }

    /* Chat Interface - Versione Aggiornata */
    .chat-messages {
        height: calc(100vh - 220px);
        overflow-y: auto;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 1rem;
        box-shadow: inset 0 0 0.5rem rgba(0,0,0,0.05);
        scroll-behavior: smooth;
    }

    .message-container {
        display: flex;
        margin-bottom: 1.25rem;
        position: relative;
    }

    .user-container {
        justify-content: flex-end;
        padding-right: 1.5rem;
    }

    .user-message, .ai-message {
        max-width: 70%;
        padding: 1rem;
        border-radius: 1.25rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        position: relative;
    }

    .user-message {
        background-color: #0d6efd;
        color: white;
        border-bottom-right-radius: 0.25rem;
        margin-right: 0.5rem;
    }

    .ai-message {
        background-color: white;
        color: #212529;
        border-bottom-left-radius: 0.25rem;
        margin-left: 0.5rem;
    }

    .message-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .user-avatar {
        background-color: #0d6efd;
        color: white;
    }

    .ai-avatar {
        background-color: #6f42c1;
        color: white;
    }

    .message-time {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.75);
        position: absolute;
        bottom: 0.4rem;
        right: 0.75rem;
    }

    .ai-message .message-time {
        color: #6c757d;
    }

    /* Chat Input */
    .chat-input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 1rem 1.5rem;
        z-index: 1000;
        border-top: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 -0.25rem 0.75rem rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    /* Adjust for sidebar on desktop */
    @media (min-width: 992px) {
        .chat-input-container {
            left: 250px;
        }
    }

    .chat-input-wrapper {
        max-width: 900px;
        margin: 0 auto;
        position: relative;
        display: flex;
        align-items: center;
    }

    .chat-input-container .form-control {
        border-radius: 1.5rem;
        padding: 0.75rem 3.5rem 0.75rem 1.25rem;
        resize: none;
        border: 1px solid rgba(0,0,0,0.2);
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }

    .chat-input-container .form-control:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        border-color: #0d6efd;
    }

    .chat-input-container .btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        background-color: #0d6efd;
        color: white;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }

    .chat-input-container .btn:hover {
        background-color: #0b5ed7;
        transform: translateY(-50%) scale(1.05);
    }

    .chat-input-container .btn:active {
        transform: translateY(-50%) scale(0.95);
    }

    .chat-input-container .btn i {
        font-size: 1.25rem;
    }

    /* Empty chat state */
    .chat-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 2rem;
        color: #6c757d;
        text-align: center;
    }

    .chat-empty-state i {
        font-size: 3.5rem;
        margin-bottom: 1.25rem;
        color: #dee2e6;
    }

    .chat-empty-state h4 {
        margin-bottom: 0.75rem;
        color: #495057;
    }

    /* Typing indicator */
    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background-color: white;
        border-radius: 1.25rem;
        margin-bottom: 1.25rem;
        margin-left: 0.5rem;
        width: max-content;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .typing-indicator span {
        height: 0.5rem;
        width: 0.5rem;
        margin: 0 0.1rem;
        background-color: #6c757d;
        border-radius: 50%;
        display: inline-block;
        opacity: 0.4;
    }

    .typing-indicator span:nth-child(1) {
        animation: typing 1.5s infinite 0s;
    }

    .typing-indicator span:nth-child(2) {
        animation: typing 1.5s infinite 0.3s;
    }

    .typing-indicator span:nth-child(3) {
        animation: typing 1.5s infinite 0.6s;
    }

    @keyframes typing {
        0% { opacity: 0.4; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
        100% { opacity: 0.4; transform: scale(1); }
    }
/* Message separator */
    .message-date-separator {
        text-align: center;
        margin: 1.5rem 0;
        position: relative;
    }

    .message-date-separator::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 1px;
        background-color: #dee2e6;
        z-index: 1;
    }

    .message-date-separator span {
        background-color: #f8f9fa;
        padding: 0 1rem;
        position: relative;
        z-index: 2;
        color: #6c757d;
        font-size: 0.85rem;
    }

    /* Stili per il tab RAG Config */
    .rag-info {
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 0.5rem;
    }

    .rag-presets {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    /* Card per preset RAG selezionato */
    .selected-preset-card {
        border: 2px solid;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        background: white;
        overflow: hidden;
    }

    .selected-preset-header {
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .selected-preset-body {
        padding: 1rem;
        background: white;
    }

    .selected-preset-specs {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .selected-preset-specs > div {
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 0.375rem;
        text-align: center;
        border: 1px solid #e9ecef;
    }

    /* Stili specifici per i diversi preset */
    .preset-balanced {
        border-color: #0d6efd !important;
    }

    .preset-balanced .selected-preset-header {
        background: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }

    .preset-high-precision {
        border-color: #198754 !important;
    }

    .preset-high-precision .selected-preset-header {
        background: rgba(25, 135, 84, 0.1);
        color: #198754;
    }

    .preset-speed {
        border-color: #ffc107 !important;
    }

    .preset-speed .selected-preset-header {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    .preset-max-precision {
        border-color: #0dcaf0 !important;
    }

    .preset-max-precision .selected-preset-header {
        background: rgba(13, 202, 240, 0.1);
        color: #0dcaf0;
    }

    .preset-max-speed {
        border-color: #dc3545 !important;
    }

    .preset-max-speed .selected-preset-header {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .preset-extended-context {
        border-color: #6610f2 !important;
    }

    .preset-extended-context .selected-preset-header {
        background: rgba(102, 16, 242, 0.1);
        color: #6610f2;
    }

    .badge-default {
        background-color: #6c757d;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: normal;
    }

    /* Card per motore IA e configurazione RAG */
    .engine-config-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .engine-config-card h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 0.5rem;
    }

    .engine-info {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .engine-info img {
        max-height: 40px;
        margin-right: 1rem;
    }

    .provider-logo {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }

    .config-params {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .params-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .param-item {
        background: white;
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e9ecef;
    }

    .param-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .param-value {
        font-weight: 600;
        color: #212529;
    }

    .customized-badge {
        background-color: #0d6efd;
        color: white;
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
        margin-left: 0.5rem;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .nav-tabs .nav-link {
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        .chat-input-container {
            padding: 8px 10px;
        }

        .chat-messages {
            height: calc(100vh - 200px);
        }

        .rag-presets {
            grid-template-columns: 1fr;
        }

        .params-grid {
            grid-template-columns: 1fr;
        }

        .notes-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Project Header -->
    <div class="project-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0">{{ project.name }}</h1>
            <div>
                <a href="{% url 'project_config' project.id %}" class="btn btn-sm btn-outline-primary me-2">
                    <i class="bi bi-sliders me-1"></i> Configurazione Progetto
                </a>
                <a href="{% url 'projects_list' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Indietro
                </a>
            </div>
        </div>
        {% if project.description %}
        <p class="text-muted mt-2 mb-0">{{ project.description }}</p>
        {% endif %}
    </div>

    <!-- Aggiungiamo qui il blocco dei messaggi -->
    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="projectTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button">
                <i class="bi bi-files me-1"></i> Documenti
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ask-tab" data-bs-toggle="tab" data-bs-target="#ask" type="button">
                <i class="bi bi-robot me-1"></i> Chiedi all'AI
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button">
                <i class="bi bi-journal-text me-1"></i> Note
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources" type="button">
                <i class="bi bi-file-text me-1"></i> Fonti
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rag-config-tab" data-bs-toggle="tab" data-bs-target="#rag-config" type="button">
                <i class="bi bi-gear me-1"></i> Profilo IA
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content py-3" id="projectTabsContent">
        <!-- Documents Tab -->
        <div class="tab-pane fade show active" id="documents" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Documenti del progetto</h2>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                    <i class="bi bi-plus-lg me-1"></i> Carica
                </button>
            </div>

            {% if project_files %}
            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                {% for file in project_files %}
                <div class="col">
                    <div class="document-card card h-100" data-file-id="{{ file.id }}">
                        <div class="card-body text-center p-3 view-document" data-bs-toggle="modal" data-bs-target="#documentModal"
                             data-file-id="{{ file.id }}" data-file-name="{{ file.filename }}" data-file-size="{{ file.file_size|filesizeformat }}"
                             data-file-path="{% url 'serve_project_file' file.id %}">
                            {% if file.extension == '.pdf' %}
                                <i class="bi bi-file-earmark-pdf document-icon pdf mb-2"></i>
                            {% elif file.extension == '.doc' or file.extension == '.docx' %}
                                <i class="bi bi-file-earmark-word document-icon doc mb-2"></i>
                            {% elif file.extension == '.xls' or file.extension == '.xlsx' %}
                                <i class="bi bi-file-earmark-excel document-icon xls mb-2"></i>
                            {% elif file.extension == '.jpg' or file.extension == '.jpeg' or file.extension == '.png' or file.extension == '.gif' %}
                                <i class="bi bi-file-earmark-image document-icon jpg mb-2"></i>
                            {% else %}
                                <i class="bi bi-file-earmark document-icon mb-2"></i>
                            {% endif %}
                            <div class="card-title text-truncate small">{{ file.filename }}</div>
                            <small class="text-muted d-block">{{ file.file_size|filesizeformat }}</small>
                        </div>
                        <div class="card-footer bg-white border-top-0 py-2 px-3">
                            <button class="btn btn-sm btn-outline-danger w-100 delete-file-btn"
                                    data-file-id="{{ file.id }}" data-file-name="{{ file.filename }}"
                                    data-bs-toggle="modal" data-bs-target="#deleteFileModal">
                                <i class="bi bi-trash"></i> Elimina
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-folder-x"></i>
                <h3>Nessun documento</h3>
                <p class="text-muted">Carica file per iniziare</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                    <i class="bi bi-upload me-1"></i> Carica file
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Ask AI Tab -->
        <div class="tab-pane fade" id="ask" role="tabpanel">
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 mb-0">Chiedi all'IA sui tuoi documenti</h2>
                    <span class="badge bg-primary d-flex align-items-center">
                        <i class="bi bi-lightning-fill me-1"></i> Powered by
                        {% if user.ai_engine_settings.selected_engine == 'openai' %}ChatGPT
                        {% elif user.ai_engine_settings.selected_engine == 'claude' %}Claude
                        {% elif user.ai_engine_settings.selected_engine == 'deepseek' %}DeepSeek
                        {% elif user.ai_engine_settings.selected_engine == 'gemini' %}Gemini
                        {% else %}AI Engine{% endif %}
                    </span>
                </div>

                <!-- Chat messages area -->
                <div class="chat-messages p-0 rounded" id="chat-messages">
                    {% if conversation_history %}
                        {% for message in conversation_history %}
                            <div class="message-container {% if message.is_user %}user-container{% endif %}">
                                <div class="message-avatar {% if message.is_user %}user-avatar{% else %}ai-avatar{% endif %}">
                                    {% if message.is_user %}
                                        <i class="bi bi-person-fill"></i>
                                    {% else %}
                                        <i class="bi bi-robot"></i>
                                    {% endif %}
                                </div>
                                <div class="{% if message.is_user %}user-message{% else %}ai-message{% endif %}">
                                    {{ message.content|linebreaks }}
                                    <span class="message-time">
                                        {{ message.timestamp|date:"H:i" }}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="chat-empty-state">
                            <i class="bi bi-chat-square-dots"></i>
                            <h4>Chiedi qualsiasi cosa riguardo i tuoi documenti</h4>
                            <p class="text-muted mb-4">L'IA analizzerà i tuoi file e le tue note per darti risposte dettagliate</p>
                            <div class="suggestions">
                                <button class="btn btn-sm btn-outline-primary m-1 suggestion-btn" data-text="Riassumi i punti principali di tutti i documenti">
                                    <i class="bi bi-file-text me-1"></i> Riassumi tutti i documenti
                                </button>
                                <button class="btn btn-sm btn-outline-primary m-1 suggestion-btn" data-text="Quali sono le informazioni più importanti in questi documenti?">
                                    <i class="bi bi-lightbulb me-1"></i> Informazioni principali
                                </button>
                                <button class="btn btn-sm btn-outline-primary m-1 suggestion-btn" data-text="Elenca 5 punti chiave tratti dalle mie note">
                                    <i class="bi bi-list-check me-1"></i> Punti chiave dalle note
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Input fisso posizionato fuori dai tab, visibile solo quando si è nel tab "Chiedi all'AI" -->
        <div class="chat-input-container" id="fixed-chat-input" style="display: none;">
            <div class="chat-input-wrapper">
                <textarea class="form-control" id="question-input" rows="1"
                          placeholder="Scrivi la tua domanda qui o premi '/' per i suggerimenti..."></textarea>
                <button id="send-question-btn" class="btn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
<!-- Notes Tab con nuovo design -->
        <div class="tab-pane fade" id="notes" role="tabpanel">
            <!-- Quick Add Note Section -->
            <div class="quick-note-section mb-4">
                <div class="card shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-grow-1 me-3">
                                <div class="note-input-wrapper position-relative">
                                    <textarea
                                        id="quick-note-input"
                                        class="form-control border-0 bg-light"
                                        placeholder="Scrivi o incolla qui le tue note... (Ctrl+V per incollare)"
                                        rows="3"
                                        style="resize: vertical; min-height: 60px; max-height: 300px;"></textarea>

                                    <!-- Toolbar che appare quando il textarea è in focus -->
                                    <div class="note-toolbar d-none align-items-center justify-content-between mt-2">
                                        <div class="toolbar-left">
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="paste-btn" title="Incolla da clipboard">
                                                <i class="bi bi-clipboard"></i> Incolla
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="clear-btn" title="Pulisci">
                                                <i class="bi bi-x-circle"></i> Pulisci
                                            </button>
                                            <span class="text-muted small">
                                                <span id="char-count">0</span> caratteri
                                            </span>
                                        </div>
                                        <div class="toolbar-right">
                                            <div class="form-check form-switch me-3">
                                                <input class="form-check-input" type="checkbox" id="include-in-rag" checked>
                                                <label class="form-check-label small" for="include-in-rag">
                                                    Includi in AI
                                                </label>
                                            </div>
                                            <button type="button" class="btn btn-primary btn-sm" id="save-note-btn" disabled>
                                                <i class="bi bi-check-lg me-1"></i> Salva Nota
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="paste-drop-zone text-center p-3 border-dashed rounded d-none" id="drop-zone">
                                <i class="bi bi-cloud-upload fs-2 text-muted mb-2"></i>
                                <p class="mb-0 small text-muted">Trascina qui il testo o clicca per incollare</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Note salvate</h2>
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-2">{{ project_notes.count }} note</span>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importNotesModal">
                        <i class="bi bi-file-earmark-arrow-down me-1"></i> Importa
                    </button>
                </div>
            </div>

            {% if project_notes %}
            <div class="notes-grid">
                {% for note in project_notes %}
                <div class="note-card" data-note-id="{{ note.id }}">
                    <div class="note-header">
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            {{ note.updated_at|date:"d M Y H:i" }}
                        </small>
                        <div class="note-actions">
                            <button class="btn btn-sm btn-ghost edit-note-btn"
                                    data-bs-toggle="modal" data-bs-target="#editNoteModal"
                                    data-note-id="{{ note.id }}"
                                    data-note-content="{{ note.content }}"
                                    title="Modifica">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-ghost delete-note-btn"
                                    data-note-id="{{ note.id }}"
                                    title="Elimina">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="note-content">
                        {{ note.content|truncatechars:200 }}
                    </div>
                    <div class="note-footer">
                        <div class="form-check form-switch">
                            <input class="form-check-input include-note-check" type="checkbox"
                                   id="include-note-{{ note.id }}" data-note-id="{{ note.id }}"
                                   {% if note.is_included_in_rag %}checked{% endif %}>
                            <label class="form-check-label small" for="include-note-{{ note.id }}">
                                AI
                            </label>
                        </div>
                        <small class="text-muted">
                            {{ note.content|wordcount }} parole
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-notes-state text-center py-5">
                <i class="bi bi-journal-text fs-1 text-muted mb-3"></i>
                <h3>Nessuna nota ancora</h3>
                <p class="text-muted">Inizia aggiungendo la tua prima nota nel box sopra</p>
            </div>
            {% endif %}
        </div>

        <!-- Sources Tab -->
        <div class="tab-pane fade" id="sources" role="tabpanel">
            <h2 class="h5 mb-3">Fonti di riferimento AI</h2>

            {% if conversation_history and conversation_history.0.sources %}
            <div class="list-group">
                {% for source in conversation_history.0.sources %}
                <div class="source-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong class="source-title">{{ source.filename|default:"Documento" }}</strong>
                        <small class="text-muted">{{ source.page|default:"" }}</small>
                    </div>
                    <div class="source-content small p-2 bg-light rounded">
                        {{ source.content }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-file-text"></i>
                <h3>Nessuna fonte disponibile</h3>
                <p class="text-muted">Fai una domanda all'AI per vedere le fonti di riferimento</p>
            </div>
            {% endif %}
        </div>

        <!-- Profilo IA Tab -->
        <div class="tab-pane fade" id="rag-config" role="tabpanel" aria-labelledby="rag-config-tab">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <!-- Card Provider LLM e Engine -->
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-cpu me-2"></i>Motore IA del Progetto
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if project.llm_config.engine %}
                                <div class="engine-info">
                                    <div class="provider-logo">
                                        {% if project.llm_config.engine.provider.logo %}
                                            <img src="{{ project.llm_config.engine.provider.logo.url }}"
                                                 alt="{{ project.llm_config.engine.provider.name }}"
                                                 style="max-height: 40px;">
                                        {% else %}
                                            {% if project.llm_config.engine.provider.name == 'OpenAI' %}
                                                <i class="bi bi-cpu-fill fs-3" style="color: #10a37f;"></i>
                                            {% elif project.llm_config.engine.provider.name == 'Anthropic' %}
                                                <i class="bi bi-chat-square-heart-fill fs-3" style="color: #b83280;"></i>
                                            {% elif project.llm_config.engine.provider.name == 'Google' %}
                                                <i class="bi bi-google fs-3" style="color: #4285F4;"></i>
                                            {% elif project.llm_config.engine.provider.name == 'DeepSeek' %}
                                                <i class="bi bi-braces fs-3" style="color: #0066cc;"></i>
                                            {% else %}
                                                <i class="bi bi-robot fs-3" style="color: #6c757d;"></i>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h6 class="mb-1">{{ project.llm_config.engine.provider.name }}</h6>
                                        <h5 class="mb-0 text-primary">{{ project.llm_config.engine.name }}</h5>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <p class="text-muted mb-0">
                                        {{ project.llm_config.engine.description }}
                                    </p>
                                </div>

                                <hr>

                                <div class="config-params">
                                    <h6 class="mb-3">Parametri Configurati</h6>
                                    <div class="params-grid">
                                        <div class="param-item">
                                            <div class="param-label">Temperatura</div>
                                            <div class="param-value">{{ project.llm_config.get_temperature }}</div>
                                        </div>
                                        <div class="param-item">
                                            <div class="param-label">Max Tokens</div>
                                            <div class="param-value">{{ project.llm_config.get_max_tokens }}</div>
                                        </div>
                                        <div class="param-item">
                                            <div class="param-label">Timeout</div>
                                            <div class="param-value">{{ project.llm_config.get_timeout }}s</div>
                                        </div>
                                        {% if project.llm_config.engine.supports_vision %}
                                        <div class="param-item">
                                            <div class="param-label">Supporto Visione</div>
                                            <div class="param-value">
                                                <i class="bi bi-check-circle-fill text-success"></i> Attivo
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    Nessun motore IA configurato per questo progetto.
                                </div>
                            {% endif %}
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="{% url 'project_config' project.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-gear me-1"></i>Modifica Configurazione
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <!-- Card Preset RAG Selezionato -->
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-search me-2"></i>Profilo RAG Attivo
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if project.project_config.rag_preset %}
                                {% with preset=project.project_config.rag_preset %}
                                <div class="selected-preset-card
                                    {% if preset.template_type.name == "Bilanciato" %}preset-balanced{% endif %}
                                    {% if preset.template_type.name == "Alta Precisione" %}preset-high-precision{% endif %}
                                    {% if preset.template_type.name == "Velocità" %}preset-speed{% endif %}
                                    {% if preset.template_type.name == "Massima Precisione" %}preset-max-precision{% endif %}
                                    {% if preset.template_type.name == "Massima Velocità" %}preset-max-speed{% endif %}
                                    {% if preset.template_type.name == "Contesto Esteso" %}preset-extended-context{% endif %}">
                                    <div class="selected-preset-header">
                                        <span>{{ preset.name }}</span>
                                        {% if preset.is_default %}
                                            <span class="badge-default">Default</span>
                                        {% endif %}
                                    </div>
                                    <div class="selected-preset-body">
                                        <p class="mb-3">
                                            {{ preset.description }}
                                        </p>
                                        <div class="selected-preset-specs">
                                            <div>
                                                <strong>Chunk Size</strong>
                                                <div>{{ preset.chunk_size }}</div>
                                            </div>
                                            <div>
                                                <strong>Overlap</strong>
                                                <div>{{ preset.chunk_overlap }}</div>
                                            </div>
                                            <div>
                                                <strong>Top K</strong>
                                                <div>{{ preset.similarity_top_k }}</div>
                                            </div>
                                            <div>
                                                <strong>Similarità</strong>
                                                <div>{{ preset.similarity_threshold }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr>

                                <div class="mt-4">
                                    <h6 class="mb-3">Impostazioni RAG Avanzate</h6>
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="autoCitationCheck" disabled
                                                       {% if preset.auto_citation %}checked{% endif %}>
                                                <label class="form-check-label" for="autoCitationCheck">
                                                    Auto Citazione
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="prioritizeFilenamesCheck" disabled
                                                       {% if preset.prioritize_filenames %}checked{% endif %}>
                                                <label class="form-check-label" for="prioritizeFilenamesCheck">
                                                    Priorità Nome File
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="equalNotesWeightCheck" disabled
                                                       {% if preset.equal_notes_weight %}checked{% endif %}>
                                                <label class="form-check-label" for="equalNotesWeightCheck">
                                                    Note con Peso Uguale
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="strictContextCheck" disabled
                                                       {% if preset.strict_context %}checked{% endif %}>
                                                <label class="form-check-label" for="strictContextCheck">
                                                    Contesto Stretto
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endwith %}
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    Nessun profilo RAG configurato per questo progetto.
                                </div>
                            {% endif %}
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="{% url 'project_config' project.id %}" class="btn btn-outline-success btn-sm">
                                <i class="bi bi-gear me-1"></i>Modifica Configurazione
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Parametri RAG Personalizzati (se presenti) -->
            {% if customized_values %}
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-sliders me-2"></i>Parametri Personalizzati
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Questo progetto utilizza alcuni parametri personalizzati che sovrascrivono il preset selezionato.
                            </div>
                            <div class="params-grid">
                                {% if 'chunk_size' in customized_values %}
                                <div class="param-item">
                                    <div class="param-label">Chunk Size <span class="customized-badge">Personalizzato</span></div>
                                    <div class="param-value">{{ rag_values.chunk_size }}</div>
                                </div>
                                {% endif %}
                                {% if 'chunk_overlap' in customized_values %}
                                <div class="param-item">
                                    <div class="param-label">Overlap <span class="customized-badge">Personalizzato</span></div>
                                    <div class="param-value">{{ rag_values.chunk_overlap }}</div>
                                </div>
                                {% endif %}
                                {% if 'similarity_top_k' in customized_values %}
                                <div class="param-item">
                                    <div class="param-label">Top K <span class="customized-badge">Personalizzato</span></div>
                                    <div class="param-value">{{ rag_values.similarity_top_k }}</div>
                                </div>
                                {% endif %}
                                {% if 'similarity_threshold' in customized_values %}
                                <div class="param-item">
                                    <div class="param-label">Threshold <span class="customized-badge">Personalizzato</span></div>
                                    <div class="param-value">{{ rag_values.similarity_threshold }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- Include Modals -->
{% include 'be/project_modals.html' %}
{% endblock %}

{% block extra_js %}
<script>
// Quick Note System Functions
function initQuickNoteSystem() {
    const quickNoteInput = document.getElementById('quick-note-input');
    const saveNoteBtn = document.getElementById('save-note-btn');
    const clearBtn = document.getElementById('clear-btn');
    const pasteBtn = document.getElementById('paste-btn');
    const charCount = document.getElementById('char-count');
    const toolbar = document.querySelector('.note-toolbar');
    const dropZone = document.getElementById('drop-zone');
    const includeInRag = document.getElementById('include-in-rag');

    // Mostra/nascondi toolbar
    quickNoteInput.addEventListener('focus', () => {
        toolbar.classList.remove('d-none');
        toolbar.classList.add('d-flex');
        // Auto-resize textarea
        quickNoteInput.style.height = 'auto';
        quickNoteInput.style.height = quickNoteInput.scrollHeight + 'px';
    });

    // Update char count e abilita/disabilita save button
    quickNoteInput.addEventListener('input', () => {
        const count = quickNoteInput.value.length;
        charCount.textContent = count;
        saveNoteBtn.disabled = count === 0;

        // Auto-resize
        quickNoteInput.style.height = 'auto';
        quickNoteInput.style.height = quickNoteInput.scrollHeight + 'px';
    });

    // Paste button
    pasteBtn.addEventListener('click', async () => {
        try {
            const text = await navigator.clipboard.readText();
            quickNoteInput.value += text;
            quickNoteInput.dispatchEvent(new Event('input'));
        } catch (err) {
            console.error('Failed to read clipboard:', err);
        }
    });

    // Clear button
    clearBtn.addEventListener('click', () => {
        quickNoteInput.value = '';
        quickNoteInput.dispatchEvent(new Event('input'));
        quickNoteInput.focus();
    });

    // Save note
    saveNoteBtn.addEventListener('click', () => {
        const content = quickNoteInput.value.trim();
        if (!content) return;

        // Disabilita i controlli durante il salvataggio
        saveNoteBtn.disabled = true;
        quickNoteInput.disabled = true;

        fetch('{% url "project" project.id %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'action': 'add_note',
                'project_id': '{{ project.id }}',
                'content': content,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Pulisci il campo
                quickNoteInput.value = '';
                quickNoteInput.dispatchEvent(new Event('input'));

                // Mostra notifica di successo
                showToast('Nota salvata con successo!', 'success');

                // Aggiorna la lista delle note (per ora ricarica la pagina)
                location.reload(); // In produzione, aggiornare dinamicamente
            } else {
                showToast('Errore: ' + (data.error || 'Impossibile salvare la nota'), 'danger');
            }
        })
        .catch(error => {
            console.error('Errore:', error);
            showToast('Errore di rete', 'danger');
        })
        .finally(() => {
            // Riabilita i controlli
            saveNoteBtn.disabled = false;
            quickNoteInput.disabled = false;
            quickNoteInput.focus();
        });
    });

    // Keyboard shortcuts
    quickNoteInput.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Enter to save
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            if (!saveNoteBtn.disabled) {
                saveNoteBtn.click();
            }
        }
    });

    // Drag and drop support
    document.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.remove('d-none');
        dropZone.classList.add('dragover');
    });

    document.addEventListener('dragleave', (e) => {
        if (!e.relatedTarget) {
            dropZone.classList.add('d-none');
            dropZone.classList.remove('dragover');
        }
    });

    document.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.add('d-none');
        dropZone.classList.remove('dragover');

        const text = e.dataTransfer.getData('text/plain');
        if (text) {
            quickNoteInput.value += text;
            quickNoteInput.dispatchEvent(new Event('input'));
            quickNoteInput.focus();
        }
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

document.addEventListener('DOMContentLoaded', function() {
    // Inizializza il sistema di note rapide
    initQuickNoteSystem();

    // Persistenza del tab attivo
    const triggerTabList = document.querySelectorAll('#projectTabs button');
    const activeTab = document.querySelector('#projectTabs button.active');
    if (activeTab && activeTab.getAttribute('data-bs-target') === '#ask') {
        document.getElementById('fixed-chat-input').style.display = 'block';
    }

    // Gestione della visibilità dell'input fisso in base al tab attivo
    document.querySelectorAll('#projectTabs button').forEach(tabButton => {
        tabButton.addEventListener('shown.bs.tab', function(event) {
            const targetTab = event.target.getAttribute('data-bs-target');
            const fixedInput = document.getElementById('fixed-chat-input');
            fixedInput.style.display = targetTab === '#ask' ? 'block' : 'none';
        });
    });

    // Salva il tab attivo nel localStorage
    triggerTabList.forEach(tabEl => {
        tabEl.addEventListener('shown.bs.tab', function(event) {
            localStorage.setItem('activeProjectTab', event.target.getAttribute('data-bs-target'));
        });
    });

    // Gestione delle azioni dei form
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        if (!form.getAttribute('action')) {
            form.setAttribute('action', '{% url "project" project.id %}');
        }
    });

    // Modal per la visualizzazione dei documenti
    const documentModal = document.getElementById('documentModal');
    if (documentModal) {
        documentModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const fileId = button.getAttribute('data-file-id');
            const fileName = button.getAttribute('data-file-name');
            const fileSize = button.getAttribute('data-file-size');
            const filePath = button.getAttribute('data-file-path');

            // Imposta i dettagli del documento
            document.getElementById('document-filename').textContent = fileName;
            document.getElementById('document-filesize').textContent = fileSize || '';

            // Imposta gli URL per le azioni
            const openDocumentLink = document.getElementById('open-document');
            const downloadDocumentLink = document.getElementById('download-document');

            if (openDocumentLink) openDocumentLink.href = filePath;
            if (downloadDocumentLink) downloadDocumentLink.href = filePath + '?download=1';

            // Determina il tipo di file
            const fileExtension = fileName.split('.').pop().toLowerCase();

            // Reset dei container
            const iframeContainer = document.getElementById('iframe-container');
            const imageContainer = document.getElementById('image-container');
            const unsupportedContainer = document.getElementById('unsupported-file-message');
            const documentFrame = document.getElementById('document-frame');
            const imagePreview = document.getElementById('image-preview');

            iframeContainer.style.display = 'none';
            imageContainer.style.display = 'none';
            unsupportedContainer.style.display = 'none';

            // Mostra l'anteprima appropriata
            if (fileExtension === 'pdf') {
                documentFrame.src = filePath;
                documentFrame.style.display = 'block';
                iframeContainer.style.display = 'block';
            }
            else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                imagePreview.src = filePath;
                imageContainer.style.display = 'block';
            }
            else {
                unsupportedContainer.style.display = 'block';
            }
        });
    }

    // Modal per l'eliminazione dei file
    const deleteFileModal = document.getElementById('deleteFileModal');
    if (deleteFileModal) {
        deleteFileModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const fileId = button.getAttribute('data-file-id');
            const fileName = button.getAttribute('data-file-name');

            document.getElementById('delete-file-id').value = fileId;
            document.getElementById('delete-file-name').textContent = fileName;
        });

        // Gestione del form di eliminazione
        const deleteFileForm = document.getElementById('delete-file-form');
        if (deleteFileForm) {
            deleteFileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const fileId = document.getElementById('delete-file-id').value;

                fetch('{% url "project" project.id %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'action': 'delete_file',
                        'project_id': '{{ project.id }}',
                        'file_id': fileId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    })
                })
                .then(response => {
                    const modal = bootstrap.Modal.getInstance(deleteFileModal);
                    modal.hide();

                    const fileCard = document.querySelector(`.document-card[data-file-id="${fileId}"]`);
                    if (fileCard) {
                        fileCard.closest('.col').remove();
                    }

                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <strong>Successo!</strong> File eliminato correttamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.project-header').after(alertDiv);

                    setTimeout(() => alertDiv.remove(), 3000);

                    if (document.querySelectorAll('.document-card').length === 0) {
                        const documentsTab = document.getElementById('documents');
                        if (documentsTab) {
                            documentsTab.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h2 class="h5 mb-0">Documenti del progetto</h2>
                                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                                        <i class="bi bi-plus-lg me-1"></i> Carica
                                    </button>
                                </div>
                                <div class="empty-state">
                                    <i class="bi bi-folder-x"></i>
                                    <h3>Nessun documento</h3>
                                    <p class="text-muted">Carica file per iniziare</p>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                                        <i class="bi bi-upload me-1"></i> Carica file
                                    </button>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    alert('Errore durante l\'eliminazione del file. Riprova più tardi.');
                });
            });
        }
    }

    // Modal per la modifica delle note
    const editNoteModal = document.getElementById('editNoteModal');
    if (editNoteModal) {
        editNoteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const noteId = button.getAttribute('data-note-id');
            const noteContent = button.getAttribute('data-note-content');

            document.getElementById('edit-note-id').value = noteId;
            document.getElementById('edit-note-content').value = noteContent;
        });
    }

    // Form per l'aggiunta di note (se ancora presente il vecchio form)
    const addNoteForm = document.getElementById('add-note-form');
    if (addNoteForm) {
        addNoteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const content = document.getElementById('note-content').value.trim();
            if (!content) return;

            fetch('{% url "project" project.id %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'action': 'add_note',
                    'project_id': '{{ project.id }}',
                    'content': content,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
                    modal.hide();
                    window.location.reload();
                } else {
                    alert('Errore: ' + (data.error || 'Impossibile aggiungere la nota'));
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di rete. Riprova più tardi.');
            });
        });
    }

    // Funzionalità di chat con l'AI
    const sendButton = document.getElementById('send-question-btn');
    const questionInput = document.getElementById('question-input');
    const chatMessages = document.getElementById('chat-messages');

    if (sendButton && questionInput && chatMessages) {
        sendButton.addEventListener('click', sendQuestion);
        questionInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuestion();
            }
            if (e.key === '/' && questionInput.value === '') {
                e.preventDefault();
                // Mostra suggerimenti
                showSuggestions();
            }
        });

        // Focus automatico sull'input quando la tab è attiva
        document.getElementById('ask-tab').addEventListener('shown.bs.tab', function() {
            setTimeout(() => {
                questionInput.focus();
                // Migliora lo scroll al fondo con doppio ritardo per garantire che tutti gli elementi siano renderizzati
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 300);
            }, 200);
        });

        // Gestione dei suggerimenti
        document.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                questionInput.value = this.getAttribute('data-text');
                questionInput.focus();
            });
        });

        function showSuggestions() {
            // Implementa la logica per mostrare suggerimenti dinamici
            const suggestionsPopup = document.createElement('div');
            suggestionsPopup.className = 'dropdown-menu show p-2';
            suggestionsPopup.style.position = 'absolute';
            suggestionsPopup.style.bottom = '60px';
            suggestionsPopup.style.width = '100%';
            suggestionsPopup.style.maxHeight = '200px';
            suggestionsPopup.style.overflowY = 'auto';

            const suggestions = [
                { text: 'Riassumi il contenuto di tutti i documenti', icon: 'file-text' },
                { text: 'Quali sono i punti chiave del progetto?', icon: 'key' },
                { text: 'Estrai le informazioni più importanti dalle note', icon: 'journal-text' },
                { text: 'Trova eventuali contraddizioni nei documenti', icon: 'exclamation-triangle' },
                { text: 'Crea una lista di azioni da eseguire in base ai contenuti', icon: 'check2-square' }
            ];

            suggestions.forEach(suggestion => {
                const item = document.createElement('button');
                item.className = 'dropdown-item d-flex align-items-center';
                item.innerHTML = `<i class="bi bi-${suggestion.icon} me-2"></i> ${suggestion.text}`;
                item.addEventListener('click', function() {
                    questionInput.value = suggestion.text;
                    suggestionsPopup.remove();
                    questionInput.focus();
                });
                suggestionsPopup.appendChild(item);
            });

            document.querySelector('.chat-input-wrapper').appendChild(suggestionsPopup);

            // Chiudi i suggerimenti quando si fa clic all'esterno
            document.addEventListener('click', function closePopup(e) {
                if (!suggestionsPopup.contains(e.target) && e.target !== questionInput) {
                    suggestionsPopup.remove();
                    document.removeEventListener('click', closePopup);
                }
            });
        }

        function getCurrentTimeString() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function sendQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            // Rimuovi lo stato vuoto se presente
            const emptyState = chatMessages.querySelector('.chat-empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Aggiunge il messaggio dell'utente
            const userMsg = document.createElement('div');
            userMsg.className = 'message-container user-container';
            userMsg.innerHTML = `
                <div class="message-avatar user-avatar">
                    <i class="bi bi-person-fill"></i>
                </div>
                <div class="user-message">
                    ${question.replace(/\n/g, '<br>')}
                    <span class="message-time">${getCurrentTimeString()}</span>
                </div>
            `;
            chatMessages.appendChild(userMsg);

            // Scroll automatico
            scrollToBottom();

            // Reset input
            questionInput.value = '';
            questionInput.disabled = true;
            sendButton.disabled = true;
            sendButton.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';

            // Aggiungi indicatore di digitazione
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message-container';
            typingIndicator.innerHTML = `
                <div class="message-avatar ai-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            scrollToBottom();

            // Timeout per la richiesta
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 30000);

            fetch('{% url "project" project.id %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'action': 'ask_question',
                    'project_id': '{{ project.id }}',
                    'question': question,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }),
                signal: controller.signal
            })
            .then(response => {
                if (!response.ok) throw new Error(`Errore HTTP! Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                // Rimuovi indicatore di digitazione
                typingIndicator.remove();

                if (data.success) {
                    // Aggiunge la risposta dell'AI
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'message-container';
                    aiMsg.innerHTML = `
                        <div class="message-avatar ai-avatar">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="ai-message">
                            ${data.answer.replace(/\n/g, '<br>')}
                            <span class="message-time">${getCurrentTimeString()}</span>
                        </div>
                    `;
                    chatMessages.appendChild(aiMsg);

                    // Aggiorna le fonti se presenti
                    if (data.sources && data.sources.length > 0) {
                        updateSourcesTab(data.sources);

                        // Notifica visiva sulle fonti
                        const sourcesNotice = document.createElement('div');
                        sourcesNotice.className = 'text-center mt-3 mb-3';
                        sourcesNotice.innerHTML = `
                            <span class="badge bg-light text-primary shadow-sm">
                                <i class="bi bi-info-circle me-1"></i>
                                ${data.sources.length} fonti disponibili nel tab "Fonti"
                            </span>
                        `;
                        chatMessages.appendChild(sourcesNotice);
                    }
                } else if (data.error === "api_auth_error") {
                    // Gestione specifica dell'errore di autenticazione API
                    showApiAuthErrorMessage();
                } else {
                    throw new Error(data.error || 'Errore sconosciuto dal server');
                }
            })
            .catch(error => {
                // Rimuovi indicatore di digitazione
                typingIndicator.remove();

                // Gestione errori: verifica se è un errore di autenticazione API
                if (error.message && (error.message.includes('invalid_api_key') ||
                                     error.message.includes('authentication') ||
                                     error.message.includes('api_auth_error'))) {
                    showApiAuthErrorMessage();
                } else {
                    // Altri tipi di errore
                    showError(`Errore: ${error.message}`);
                }
            })
            .finally(() => {
                // Ripristina sempre lo stato iniziale
                questionInput.disabled = false;
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="bi bi-send-fill"></i>';
                scrollToBottom();
                questionInput.focus();
                clearTimeout(timeout);
            });
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        function showApiAuthErrorMessage() {
            // Crea una risposta di errore dell'AI con avviso e suggerimento di azione
            const errorMsg = document.createElement('div');
            errorMsg.className = 'message-container';
            errorMsg.innerHTML = `
                <div class="message-avatar ai-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="ai-message">
                    <div class="alert alert-danger mb-2">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Problema con le chiavi API</strong>
                    </div>
                    <p>Non è stato possibile contattare il servizio AI a causa di un errore di autenticazione.</p>
                    <div class="alert alert-light border">
                        <h6 class="mb-2"><i class="bi bi-wrench me-1"></i> Come risolvere:</h6>
                        <ol class="mb-2">
                            <li>Vai alle <a href="{% url 'ia_engine' %}" class="fw-medium">Impostazioni del Motore IA</a></li>
                            <li>Verifica che le chiavi API siano corrette</li>
                            <li>Oppure passa alla modalità "Usa credito piattaforma"</li>
                        </ol>
                    </div>
                    <span class="message-time">${getCurrentTimeString()}</span>
                </div>
            `;
            chatMessages.appendChild(errorMsg);

            // Mostra anche una notifica Toast per attirare l'attenzione
            showErrorToast('Errore di autenticazione API', 'Controlla le tue chiavi API nelle impostazioni del motore IA');
        }


        function showError(message) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'message-container';
            errorMsg.innerHTML = `
                <div class="message-avatar ai-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="ai-message">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        ${message}
                    </div>
                    <span class="message-time">${getCurrentTimeString()}</span>
                </div>
            `;
            chatMessages.appendChild(errorMsg);
        }

        function showErrorToast(title, message) {
            // Crea un toast di errore con stile migliorato
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '1080';

            const toastEl = document.createElement('div');
            toastEl.className = 'toast show';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.style.boxShadow = '0 0.5rem 1rem rgba(0,0,0,0.15)';
            toastEl.style.borderRadius = '0.5rem';
            toastEl.style.overflow = 'hidden';
            toastEl.style.border = 'none';

            toastEl.innerHTML = `
                <div class="toast-header bg-danger text-white">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong class="me-auto">${title}</strong>
                    <small>Adesso</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Chiudi"></button>
                </div>
                <div class="toast-body bg-white">
                    <p class="mb-2">${message}</p>
                    <div class="mt-2 pt-2 border-top d-flex justify-content-end">
                        <a href="{% url 'ia_engine' %}" class="btn btn-sm btn-outline-primary me-2">
                            <i class="bi bi-gear me-1"></i> Vai alle impostazioni
                        </a>
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="toast">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;

            toastContainer.appendChild(toastEl);
            document.body.appendChild(toastContainer);

            // Rimuovi il toast dopo 15 secondi
            setTimeout(() => {
                if (document.body.contains(toastContainer)) {
                    toastContainer.remove();
                }
            }, 15000);

            // Aggiungi un event listener per rimuovere il toast quando viene chiuso
            toastEl.querySelector('.btn-close').addEventListener('click', () => {
                toastContainer.remove();
            });
            toastEl.querySelector('.btn-secondary').addEventListener('click', () => {
                toastContainer.remove();
            });
        }

        // Assicurati che il focus sia sull'input e lo scroll sia in fondo all'apertura
        scrollToBottom();
    }

    // Aggiorna il tab delle fonti
    function updateSourcesTab(sources) {
        const sourcesTab = document.getElementById('sources');
        if (!sourcesTab) return;

        let sourcesHTML = `
            <h2 class="h5 mb-3">Fonti di riferimento AI</h2>
            <div class="list-group">
        `;

        sources.forEach(source => {
            sourcesHTML += `
                <div class="source-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong class="source-title">${source.filename || 'Documento'}</strong>
                        <small class="text-muted">${source.metadata && source.metadata.page ? 'Pag. ' + (source.metadata.page + 1) : ''}</small>
                    </div>
                    <div class="source-content small p-2 bg-light rounded">
                        ${source.content}
                    </div>
                </div>
            `;
        });

        sourcesHTML += `</div>`;
        sourcesTab.innerHTML = sourcesHTML;

const sourcesTabButton = document.getElementById('sources-tab');
        if (sourcesTabButton) {
            if (!sourcesTabButton.querySelector('.badge')) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary ms-1';
                badge.textContent = sources.length;
                sourcesTabButton.appendChild(badge);
            } else {
                sourcesTabButton.querySelector('.badge').textContent = sources.length;
            }
        }
    }

    // Gestione eliminazione note
    document.querySelectorAll('.delete-note-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Eliminare questa nota?')) {
                const noteId = this.getAttribute('data-note-id');
                fetch('{% url "project" project.id %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'action': 'delete_note',
                        'project_id': '{{ project.id }}',
                        'note_id': noteId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Trova la card della nota
                        const noteCard = this.closest('.note-card');
                        // Aggiungi animazione di fade out
                        noteCard.style.animation = 'fadeOutUp 0.3s ease forwards';
                        // Rimuovi l'elemento dopo l'animazione
                        setTimeout(() => {
                            noteCard.remove();
                            // Aggiorna il conteggio delle note
                            const notesCount = document.querySelectorAll('.note-card').length;
                            const badgeElement = document.querySelector('#notes-tab .badge');
                            if (badgeElement) {
                                badgeElement.textContent = notesCount + ' note';
                            }
                            // Se non ci sono più note, mostra lo stato vuoto
                            if (notesCount === 0) {
                                const notesGrid = document.querySelector('.notes-grid');
                                if (notesGrid) {
                                    notesGrid.innerHTML = `
                                        <div class="empty-notes-state text-center py-5">
                                            <i class="bi bi-journal-text fs-1 text-muted mb-3"></i>
                                            <h3>Nessuna nota ancora</h3>
                                            <p class="text-muted">Inizia aggiungendo la tua prima nota nel box sopra</p>
                                        </div>
                                    `;
                                }
                            }
                        }, 300);
                        showToast('Nota eliminata con successo', 'success');
                    } else {
                        showToast('Errore: ' + (data.error || 'Impossibile eliminare la nota'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    showToast('Errore di rete. Riprova più tardi.', 'danger');
                });
            }
        });
    });

    // Toggle per l'inclusione delle note nella ricerca AI
    document.querySelectorAll('.include-note-check').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const noteId = this.getAttribute('data-note-id');
            const isIncluded = this.checked;

            fetch('{% url "project" project.id %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'action': 'toggle_note_inclusion',
                    'project_id': '{{ project.id }}',
                    'note_id': noteId,
                    'is_included': isIncluded,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(isIncluded ? 'Nota inclusa nella ricerca AI' : 'Nota esclusa dalla ricerca AI', 'success');
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                this.checked = !isIncluded; // Ripristina lo stato precedente
                showToast('Errore durante l\'aggiornamento', 'danger');
            });
        });
    });

    // Gestione modifica note
    const editNoteForm = document.querySelector('#editNoteModal form');
    if (editNoteForm) {
        editNoteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const noteId = document.getElementById('edit-note-id').value;
            const content = document.getElementById('edit-note-content').value.trim();

            if (!content) return;

            fetch('{% url "project" project.id %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'action': 'edit_note',
                    'project_id': '{{ project.id }}',
                    'note_id': noteId,
                    'content': content,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editNoteModal'));
                    modal.hide();
                    // Per ora ricarica la pagina
                    location.reload();
                    // In produzione, aggiornare dinamicamente la nota modificata
                } else {
                    showToast('Errore: ' + (data.error || 'Impossibile modificare la nota'), 'danger');
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                showToast('Errore di rete. Riprova più tardi.', 'danger');
            });
        });
    }

    // Gestione importazione note (se implementata)
    const importNotesBtn = document.getElementById('import-notes-btn');
    if (importNotesBtn) {
        importNotesBtn.addEventListener('click', function() {
            const fileInput = document.getElementById('import-file');
            const textArea = document.getElementById('import-text');

            // Implementare la logica di importazione
            showToast('Funzionalità in sviluppo', 'info');
        });
    }

    // Gestione hash URL per l'apertura automatica dei tab
    if (window.location.hash) {
        const hash = window.location.hash.substring(1);
        const tabEl = document.querySelector(`button[data-bs-target="#${hash}"]`);
        if (tabEl) {
            setTimeout(() => {
                new bootstrap.Tab(tabEl).show();
            }, 100);
        }
    }

    // Gestione aggiornamento delle note che mostra i dettagli completi
    document.querySelectorAll('.note-card').forEach(card => {
        card.addEventListener('click', function(e) {
            // Evita il click sui pulsanti di azione
            if (e.target.closest('.note-actions')) return;

            // Toggle espansione del contenuto della nota
            const contentDiv = this.querySelector('.note-content');
            if (contentDiv.classList.contains('expanded')) {
                contentDiv.classList.remove('expanded');
                contentDiv.style.maxHeight = '4.5em'; // Circa 3 righe
            } else {
                contentDiv.classList.add('expanded');
                contentDiv.style.maxHeight = 'none';
            }
        });
    });

    // Aggiungi CSS per l'animazione fadeOutUp
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        .note-content {
            max-height: 4.5em;
            overflow: hidden;
            transition: max-height 0.3s ease;
            cursor: pointer;
        }

        .note-content.expanded {
            max-height: none;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}