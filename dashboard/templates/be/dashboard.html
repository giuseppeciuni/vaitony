{% extends 'be/base.html' %}
{% load static %}
{% load custom_filter %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous">
    <style>
        .project-card {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }

        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }

        .stat-card {
            border-left: 4px solid;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.projects {
            border-left-color: #6f42c1;
        }
         .stat-card.documents {
            border-left-color: #0d6efd;
        }

        .stat-card.notes {
            border-left-color: #20c997;
        }

         .stat-card.urls {
            border-left-color: #ffc107; /* Using warning color for URLs */
        }

        .stat-card.interactions {
            border-left-color: #fd7e14;
        }

        .project-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            color: white;
            margin-right: 1rem;
        }

        .activity-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.25rem;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 7px;
            height: 100%;
            border-left: 2px dashed #dee2e6;
        }

        .activity-item:last-child::before {
            height: 0;
        }

        .activity-badge {
            position: absolute;
            left: 0;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            z-index: 1;
        }

        .activity-badge.file {
            background-color: #0d6efd; /* Primary */
        }

        .activity-badge.note {
            background-color: #20c997; /* Success */
        }

        .activity-badge.question {
            background-color: #fd7e14; /* Warning */
        }

        .activity-badge.url {
            background-color: #ffc107; /* Yellow */
        }

        .activity-badge.project {
            background-color: #6f42c1; /* Indigo */
        }

        /* Stili per la sezione cache più compatta */
        .cache-compact-card {
            transition: all 0.3s ease;
        }

        .cache-compact-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
        }

        .cache-mini-stat {
            padding: 0.5rem;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="app-content-header">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <h3 class="mb-0">Dashboard Progetti</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-end">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card projects h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Progetti totali</h5>
                            <h2 class="font-weight-bold mb-0">{{ projects.count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-folder fs-1 text-primary"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ projects_growth|default:0 }}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card documents h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Documenti</h5>
                            <h2 class="font-weight-bold mb-0">{{ documents_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-files fs-1 text-primary"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ documents_growth|default:0 }}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>

         <div class="col-md-3">
            <div class="card stat-card urls h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">URLs</h5>
                            <h2 class="font-weight-bold mb-0">{{ urls_count|default:0 }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-link fs-1 text-warning"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ urls_growth|default:0 }}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>


        <div class="col-md-3">
            <div class="card stat-card notes h-100">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-0">Note</h5>
                            <h2 class="font-weight-bold mb-0">{{ notes_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-journal-text fs-1 text-success"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-1"><i class="bi bi-arrow-up"></i> {{ notes_growth|default:0 }}%</span>
                        <span class="text-secondary">Rispetto al mese scorso</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Grafico Attività dei Progetti -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Attività dei progetti</h3>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector active" data-period="week">Settimana</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector" data-period="month">Mese</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector" data-period="year">Anno</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-4">
                        <div>
                            <h4 class="mb-0">{{ total_activities }}</h4>
                            <small class="text-muted">Attività totali</small>
                        </div>
                        <div class="text-end">
                            <h4 class="text-success mb-0">+{{ active_projects }}</h4>
                            <small class="text-muted">Progetti attivi</small>
                        </div>
                    </div>
                    <div class="position-relative mb-4">
                        <div id="activity-chart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- Grafico Attività Totali -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Statistiche Attività Totali</h3>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector active" data-period="month">Mensile</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector" data-period="quarter">Trimestrale</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary period-selector" data-period="year">Annuale</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="position-relative mb-4">
                        <div id="project-activity-chart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- Statistiche RAG (Cache Embedding) -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <h3 class="card-title">Statistiche RAG (Cache Embedding)</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="cache-savings-chart" style="height: 250px;"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="cache-hit-rate-chart" style="height: 250px;"></div>
                        </div>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-sm btn-outline-secondary" onclick="showCacheModal()">
                            <i class="bi bi-gear me-1"></i>Gestione avanzata cache
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tipi di documenti nella cache -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <h3 class="card-title">Tipi di Documenti nella Cache</h3>
                </div>
                <div class="card-body">
                    <div id="cache-types-chart" style="height: 250px;"></div>
                </div>
            </div>

            <!-- Progetti principali -->
            <div class="card mb-4">
                <div class="card-header border-0 bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">Progetti principali</h3>
                        <a href="{% url 'projects_list' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-grid-3x3-gap-fill me-1"></i> Vedi tutti
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
                        {% if projects %}
                            {% for project in projects|slice:":6" %}
                            <div class="col">
                                <div class="card h-100 project-card border shadow-sm">
                                    <div class="card-header d-flex align-items-center py-2 px-3" style="background-color: {% cycle '#0d6efd' '#20c997' '#fd7e14' '#6f42c1' '#dc3545' '#0dcaf0' %}20;">
                                        <div class="project-icon me-2" style="background-color: {% cycle '#0d6efd' '#20c997' '#fd7e14' '#6f42c1' '#dc3545' '#0dcaf0' %};">
                                            <i class="bi bi-folder2"></i>
                                        </div>
                                        <h5 class="card-title mb-0 text-truncate">{{ project.name }}</h5>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <div>
                                                <i class="bi bi-files text-primary"></i>
                                                <span class="ms-1">{{ project.files.count }} doc</span>
                                            </div>
                                            <div>
                                                <i class="bi bi-link text-warning"></i>
                                                <span class="ms-1">{{ project.urls.count|default:0 }} urls</span>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <div>
                                                <i class="bi bi-journal-text text-success"></i>
                                                <span class="ms-1">{{ project.project_notes.count }} note</span>
                                            </div>
                                            <div>
                                                <i class="bi bi-chat-dots text-info"></i>
                                                <span class="ms-1">{{ project.conversations.count|default:0 }} chat</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent pt-0 border-top-0">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Aggiornato: {{ project.updated_at|date:"d M Y" }}</small>
                                            <a href="{% url 'project_details' project.id %}" class="btn btn-sm btn-primary stretched-link">
                                                <i class="bi bi-eye me-1"></i>Visualizza
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="card border-0 text-center py-5 bg-light">
                                    <div class="card-body">
                                        <i class="bi bi-folder-x fs-1 text-muted mb-3"></i>
                                        <h4>Nessun progetto disponibile</h4>
                                        <p class="text-muted">Crea il tuo primo progetto per iniziare</p>
                                        <a href="{% url 'new_project' %}" class="btn btn-primary mt-2">
                                            <i class="bi bi-plus-lg me-1"></i> Crea nuovo progetto
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Tipologie documenti -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <h3 class="card-title">Tipologie documenti</h3>
                </div>
                <div class="card-body">
                    <div id="documents-chart" style="height: 250px;"></div>
                </div>
            </div>

            <!-- Attività recenti -->
            <div class="card mb-4">
                <div class="card-header border-0">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Attività recenti</h3>
                        <a href="#" class="link-primary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">Vedi tutte</a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% for activity in recent_activities|slice:":5" %}
                        <div class="activity-item">
                            <div class="activity-badge {{ activity.type }}"></div>
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-1 fw-bold">{{ activity.project_name }}</h6>
                                <small class="text-muted">{{ activity.created_at|time:"H:i" }}</small>
                            </div>
                            <p class="mb-1">{{ activity.description|truncatechars:60 }}</p>
                            {% if activity.type == 'file' and activity.file_id %}
                                <small class="text-muted"><a href="{% url 'serve_project_file' activity.file_id %}" target="_blank">Visualizza File</a></small>
                            {% elif activity.type == 'url' and activity.url %}
                                <small class="text-muted"><a href="{{ activity.url }}" target="_blank">Visita URL</a></small>
                            {% endif %}
                            <small class="text-muted d-block">{{ activity.created_at|date:"d M Y" }}</small>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox fs-1 text-muted"></i>
                            <p class="text-muted mt-2 mb-0">Nessuna attività recente</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Cache Embedding Card -->
            <div class="card cache-compact-card">
                <div class="card-header bg-success bg-opacity-10 border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-piggy-bank-fill text-success me-2"></i>
                            Cache Embedding
                        </h5>
                        <button class="btn btn-sm btn-outline-success" onclick="toggleCacheDetails()">
                            <i class="bi bi-gear"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h3 class="text-success mb-0">${{ cache_stats.estimated_savings|floatformat:2|default:"0.00" }}</h3>
                        <small class="text-muted">Risparmiati stimati</small>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <div class="cache-mini-stat text-center">
                                <h6 class="mb-0">{{ total_cache_stats.reuses|default:"0" }}</h6>
                                <small class="text-muted">Riutilizzi</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="cache-mini-stat text-center">
                                <h6 class="mb-0">{{ cache_stats.hit_rate|floatformat:1|default:"0" }}%</h6>
                                <small class="text-muted">Hit Rate</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="cache-mini-stat text-center">
                                <h6 class="mb-0">{{ cache_stats.size_in_mb|floatformat:1|default:"0" }}MB</h6>
                                <small class="text-muted">Dimensione</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="cache-mini-stat text-center">
                                <h6 class="mb-0">{{ total_cache_stats.count|default:0 }}</h6>
                                <small class="text-muted">Embedding Unici</small>
                            </div>
                        </div>
                    </div>

                    <div id="cacheDetails" class="collapse mt-3">
                        <hr>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="update-cache-stats-btn">
                                <i class="bi bi-arrow-repeat me-1"></i>Aggiorna statistiche
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showCacheModal()">
                                <i class="bi bi-gear me-1"></i>Gestione avanzata
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal di Gestione Cache -->
    <div class="modal fade" id="cacheModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestione Cache Embedding</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#cache-modal-statistics">Statistiche</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#cache-modal-management">Gestione</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#cache-modal-reports">Report</a>
                        </li>
                    </ul>

                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="cache-modal-statistics">
                            <div class="row">
                                <div class="col-md-6">
                                    <div id="cache-modal-savings-chart" style="height: 250px;"></div>
                                </div>
                                <div class="col-md-6">
                                    <div id="cache-modal-types-chart" style="height: 250px;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="cache-modal-management">
                            <p>Qui puoi eseguire operazioni di manutenzione sulla cache degli embedding.</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-warning" onclick="cleanCache()">
                                    <i class="bi bi-trash3 me-1"></i>Pulisci file orfani (Richiede accesso al file system)
                                </button>
                                <button class="btn btn-danger" onclick="clearCache()">
                                    <i class="bi bi-x-circle me-1"></i>Svuota tutta la cache
                                </button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="cache-modal-reports">
                            <p>Genera report sull'utilizzo e i risparmi della cache.</p>
                            <form id="reportForm">
                                <div class="mb-3">
                                    <label for="reportType" class="form-label">Tipo di Report</label>
                                    <select class="form-select" id="reportType">
                                        <option value="summary">Riepilogo</option>
                                        <option value="detailed">Dettagliato</option>
                                        <option value="savings">Risparmi stimati</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="generateReport()">
                                    Genera Report
                                </button>
                            </form>
                            <div id="reportOutput" class="mt-3 alert alert-info" style="display: none;">
                                <h5>Output Report:</h5>
                                <pre id="reportContent"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inizializza le variabili con dati dai template o predefiniti
    const activityDates = {{ activity_dates|safe }};
    const activityFiles = {{ activity_files|safe }};
    const activityNotes = {{ activity_notes|safe }};
    const activityConversations = {{ activity_conversations|safe }};
    const activityUrls = {{ activity_urls|default:"[]"|safe }};

    // Dati per il grafico delle attività dei progetti (mensili)
    const projectActivityDates = {{ project_activity_dates|default:"[]"|safe }};
    const projectActivityCounts = {{ project_activity_counts|default:"[]"|safe }};

    // Dati per il grafico dei tipi di documenti
    const documentTypesValues = {{ document_types_values|safe }};
    const documentTypesLabels = {{ document_types_labels|safe }};

    // Dati per il grafico dei tipi di documenti nella cache
    const cacheDocumentTypesValues = {{ cache_document_types_values|default:"[]"|safe }};
    const cacheDocumentTypesLabels = {{ cache_document_types_labels|default:"[]"|safe }};

    // Dati di esempio se mancano quelli reali
    let projectActivityDatesDisplay = projectActivityDates;
    let projectActivityCountsDisplay = projectActivityCounts;
    let cacheDocumentTypesValuesDisplay = cacheDocumentTypesValues;
    let cacheDocumentTypesLabelsDisplay = cacheDocumentTypesLabels;

    if (!projectActivityDates.length) {
        projectActivityDatesDisplay = ["Gen 2023", "Feb 2023", "Mar 2023", "Apr 2023", "Mag 2023", "Giu 2023"];
        projectActivityCountsDisplay = [10, 25, 15, 30, 22, 18];
        console.log("Usando dati di esempio per il grafico attività mensili");
    }

    if (!cacheDocumentTypesValues.length) {
        cacheDocumentTypesValuesDisplay = [45, 30, 15, 25, 10, 5];
        cacheDocumentTypesLabelsDisplay = ['PDF', 'TXT', 'DOCX', 'URL', 'NOTE', 'ALTRO'];
        console.log("Usando dati di esempio per il grafico dei tipi di documenti nella cache");
    }

    // Grafico attività
    var activityOptions = {
        series: [{
            name: 'File',
            data: activityFiles
        }, {
            name: 'Note',
            data: activityNotes
        }, {
            name: 'Conversazioni',
            data: activityConversations
        }, {
            name: 'URLs',
            data: activityUrls
        }],
        chart: {
            type: 'area',
            height: 300,
            stacked: true,
            toolbar: { show: false }
        },
        colors: ['#0d6efd', '#20c997', '#fd7e14', '#ffc107'],
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        fill: {
            type: 'gradient',
            gradient: {
                opacityFrom: 0.6,
                opacityTo: 0.8,
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'left'
        },
        xaxis: {
            categories: activityDates
        },
        yaxis: {
            title: {
                text: 'Numero di Attività'
            }
        }
    };
    var activityChart = new ApexCharts(document.querySelector("#activity-chart"), activityOptions);
    activityChart.render();


    // Grafico documenti
    var documentsOptions = {
        series: documentTypesValues,
        chart: {
            type: 'donut',
            height: 250
        },
        labels: documentTypesLabels,
        colors: ['#0d6efd', '#6c757d', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6610f2'],
        legend: {
            position: 'bottom'
        },
        responsive: [{
            breakpoint: 480,
            options: {
                chart: {
                    width: 200
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };
    var documentsChart = new ApexCharts(document.querySelector("#documents-chart"), documentsOptions);
    documentsChart.render();

    // Grafico Attività Totali del Progetto (mensile)
    var projectActivityOptions = {
        series: [{
            name: 'Attività Totali',
            data: projectActivityCountsDisplay
        }],
        chart: {
            type: 'bar',
            height: 300,
            toolbar: { show: false }
        },
        colors: ['#6f42c1'],
        plotOptions: {
            bar: {
                borderRadius: 4,
                dataLabels: {
                    position: 'top'
                }
            }
        },
        dataLabels: {
            enabled: true,
            offsetY: -20,
            style: {
                fontSize: '12px',
                colors: ["#304758"]
            }
        },
        xaxis: {
            categories: projectActivityDatesDisplay,
            position: 'bottom',
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            }
        },
        yaxis: {
            title: {
                text: 'Attività'
            }
        }
    };

    if (document.querySelector("#project-activity-chart")) {
        var projectActivityChart = new ApexCharts(document.querySelector("#project-activity-chart"), projectActivityOptions);
        projectActivityChart.render();
    } else {
        console.error("Elemento #project-activity-chart non trovato nel DOM");
    }

    // Grafico tipi documenti nella cache
    var cacheTypesOptions = {
        series: cacheDocumentTypesValuesDisplay,
        chart: {
            type: 'donut',
            height: 250
        },
        labels: cacheDocumentTypesLabelsDisplay,
        colors: ['#0d6efd', '#6c757d', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6610f2'],
        legend: {
            position: 'bottom'
        },
        responsive: [{
            breakpoint: 480,
            options: {
                chart: {
                    width: 200
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };

    if (document.querySelector("#cache-types-chart")) {
        var cacheTypesChart = new ApexCharts(document.querySelector("#cache-types-chart"), cacheTypesOptions);
        cacheTypesChart.render();
    } else {
        console.error("Elemento #cache-types-chart non trovato nel DOM");
    }

    // Grafico per i risparmi della Cache
    const cacheStats = {{ cache_stats|safe }};
    var cacheSavingsOptions = {
        series: [{
            name: 'Risparmi Stimati (€)',
            data: [cacheStats.estimated_savings]
        }],
        chart: {
            type: 'bar',
            height: 250,
            toolbar: { show: false }
        },
        colors: ['#20c997'],
        plotOptions: {
            bar: {
                horizontal: true,
            }
        },
        dataLabels: {
            enabled: true,
            formatter: function (val) {
                return "€" + val;
            }
        },
        xaxis: {
            categories: ['Totale Risparmi'],
            title: {
                text: 'Importo Risparmiato'
            }
        }
    };
    var cacheSavingsChart = new ApexCharts(document.querySelector("#cache-savings-chart"), cacheSavingsOptions);
    cacheSavingsChart.render();

    // Grafico Hit Rate Cache
    var cacheHitRateOptions = {
        series: [cacheStats.hit_rate],
        chart: {
            type: 'radialBar',
            height: 250,
            sparkline: {
                enabled: true
            }
        },
        plotOptions: {
            radialBar: {
                track: {
                    background: '#e7e7e7',
                },
                dataLabels: {
                    name: {
                        offsetY: -10,
                        fontSize: '13px'
                    },
                    value: {
                        offsetY: 5,
                        fontSize: '20px',
                        formatter: function (val) {
                            return val + "%";
                        }
                    }
                }
            }
        },
        labels: ['Hit Rate'],
        colors: ['#0d6efd'],
        stroke: {
            lineCap: 'round'
        },
    };
    var cacheHitRateChart = new ApexCharts(document.querySelector("#cache-hit-rate-chart"), cacheHitRateOptions);
    cacheHitRateChart.render();

    // Inizializza i grafici nei modali quando vengono visualizzati
    document.getElementById('cacheModal').addEventListener('shown.bs.modal', function () {
        // Grafico nel modale per i risparmi
        if (!window.cacheModalSavingsChart && document.querySelector("#cache-modal-savings-chart")) {
            window.cacheModalSavingsChart = new ApexCharts(
                document.querySelector("#cache-modal-savings-chart"),
                cacheSavingsOptions
            );
            window.cacheModalSavingsChart.render();
        }

        // Grafico nel modale per i tipi di documenti
        if (!window.cacheModalTypesChart && document.querySelector("#cache-modal-types-chart")) {
            window.cacheModalTypesChart = new ApexCharts(
                document.querySelector("#cache-modal-types-chart"),
                cacheTypesOptions
            );
            window.cacheModalTypesChart.render();
        }
    });

    // Toggle cache details
    window.toggleCacheDetails = function() {
        var cacheDetails = document.getElementById('cacheDetails');
        var bsCollapse = new bootstrap.Collapse(cacheDetails, {
            toggle: true
        });
    }

    // Show cache modal
    window.showCacheModal = function() {
        var cacheModal = new bootstrap.Modal(document.getElementById('cacheModal'));
        cacheModal.show();
    }

    // Update cache stats button handler
    document.getElementById('update-cache-stats-btn').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Aggiornamento...';

        // Fetch statistics update via AJAX
        fetch('{% url "dashboard" %}?update_cache_stats=1', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page on success to show updated stats
                location.reload();
            } else {
                alert('Errore nell\'aggiornamento delle statistiche: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Si è verificato un errore durante l\'aggiornamento.');
        })
        .finally(() => {
            // Re-enable button and restore text after request completes
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Aggiorna statistiche';
        });
    });

    // Funzioni per la gestione della cache
    window.cleanCache = function() {
        if (confirm('Questa operazione tenterà di rimuovere i file dalla cache che non sono più associati a nessun ProjectFile. Continuare?')) {
            callManagementCommand('manage_embedding_cache', ['--clean']);
        }
    }

    window.clearCache = function() {
        if (confirm('ATTENZIONE: Questa operazione cancellerà *tutta* la cache degli embedding, rimuovendo tutti i file dalla directory di cache e i record dal database. Questo richiederà una ri-vettorializzazione completa dei tuoi documenti e URL indicizzati. Continuare?')) {
            callManagementCommand('clear_embedding_cache', ['--force']);
        }
    }

    window.generateReport = function() {
        const reportType = document.getElementById('reportType').value;
        const reportOutputDiv = document.getElementById('reportOutput');
        const reportContentPre = document.getElementById('reportContent');

        // Clear previous output and show loading
        reportContentPre.textContent = 'Generazione report...';
        reportOutputDiv.style.display = 'block';

        // Call the backend command to generate the report
        callManagementCommand('report_cache_usage', ['--type', reportType]).then(data => {
            if (data.success) {
                // Assuming the command output is returned in data.message or a similar field
                reportContentPre.textContent = data.message || 'Report generato con successo (nessun output specifico).';
                reportOutputDiv.className = 'mt-3 alert alert-success';
            } else {
                reportContentPre.textContent = 'Errore nella generazione del report: ' + data.message;
                reportOutputDiv.className = 'mt-3 alert alert-danger';
            }
        }).catch(error => {
            console.error('Report generation error:', error);
            reportContentPre.textContent = 'Si è verificato un errore durante la generazione del report.';
            reportOutputDiv.className = 'mt-3 alert alert-danger';
        });
    }

    // Helper function per chiamare i comandi Django
    function callManagementCommand(command, args) {
        return fetch('{% url "execute_management_command" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                command: command,
                args: args
            })
        })
        .then(response => {
            if (!response.ok) {
                // If response is not OK (e.g., 403, 500), try to read JSON error or throw
                return response.json().then(err => { throw new Error(err.message || 'Errore di rete'); }).catch(() => {
                    throw new Error('Errore di rete o risposta non JSON');
                });
            }
            return response.json();
        })
        .then(data => {
            // Handle the JSON response from the backend
            if (data.success) {
                // For management commands that trigger background tasks or don't return explicit data
                // you might want to just show a success message or reload for simplicity.
                // If the command returns output in `data.message`, the generateReport function handles it.
                if (command !== 'report_cache_usage') { // Avoid double alert for report
                    alert('Operazione completata con successo: ' + (data.message || ''));
                    location.reload(); // Reload to see updated stats if applicable
                }
            } else {
                alert('Errore nell\'operazione: ' + (data.message || 'Errore sconosciuto'));
            }
            return data; // Return data for further processing (like in generateReport)
        })
        .catch(error => {
            console.error('Error calling management command:', error);
            alert('Si è verificato un errore durante l\'esecuzione del comando: ' + error.message);
            throw error; // Re-throw to be caught by the caller if needed
        });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Optional: Add event listeners for period selectors if you implement data filtering
    document.querySelectorAll('.period-selector').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.period-selector').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const period = this.dataset.period;
            console.log('Selected period:', period);
            // Implement logic here to fetch and update chart data based on period
            // This would require AJAX calls to your backend view with the selected period
        });
    });

});
</script>
{% endblock %}