{% extends 'be/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* Stili generali */
    .project-header {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #0d6efd;
    }

    .project-title {
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }

    .project-title i {
        margin-right: 0.75rem;
        color: #0d6efd;
    }

    .project-description {
        color: #6c757d;
        margin-bottom: 0;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 500;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }

    /* Stili per i documenti */
    .documents-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .document-card {
        width: 150px;
        overflow: hidden;
        transition: all 0.2s;
        cursor: pointer;
    }

    .document-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .document-thumb {
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }

    .document-icon {
        font-size: 3rem;
        color: #6c757d;
    }

    .document-icon.pdf {
        color: #dc3545;
    }

    .document-icon.doc, .document-icon.docx {
        color: #0d6efd;
    }

    .document-icon.xls, .document-icon.xlsx {
        color: #198754;
    }

    .document-icon.ppt, .document-icon.pptx {
        color: #fd7e14;
    }

    .document-icon.txt {
        color: #6c757d;
    }

    .document-icon.img {
        color: #6f42c1;
    }

    .document-name {
        font-size: 0.875rem;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 0 0.5rem;
    }

    /* Stili per le notes */
    .notes-container {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }

    .notes-toolbar {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }

    .notes-editor {
        padding: 1rem;
        min-height: 200px;
    }

    /* Stili per Ask Anything */
    .ask-container {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .chat-messages {
        max-height: 350px;
        overflow-y: auto;
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: white;
        padding: 1rem;
    }

    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
    }

    .user-message {
        background-color: #e9f5ff;
        border-top-right-radius: 0;
        margin-left: 2rem;
    }

    .ai-message {
        background-color: #f1f3f5;
        border-top-left-radius: 0;
        margin-right: 2rem;
    }

    .message-header {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .message-content {
        word-wrap: break-word;
    }

    .chat-input-container {
        display: flex;
        flex-direction: column;
    }

    .chat-input {
        resize: none;
        border-radius: 0.5rem;
    }

    .loader {
        display: none;
        margin-top: 1rem;
        text-align: center;
    }

    /* Sources styles */
    .sources-wrapper {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .source-card {
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 1rem !important;
    }

    .source-header {
        background-color: #f8f9fa;
        font-weight: 500;
    }

    .source-icon {
        font-size: 1.25rem;
    }

    .source-content {
        padding: 1rem;
    }

    .source-chunk {
        font-family: var(--bs-font-monospace);
        font-size: 0.875rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 200px;
        overflow-y: auto;
        border-left: 3px solid #0d6efd;
    }

    .empty-project {
        text-align: center;
        padding: 3rem 2rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }

    .empty-project i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }

    /* Upload buttons */
    .upload-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .upload-button {
        flex: 1;
        text-align: center;
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        transition: all 0.2s;
        cursor: pointer;
    }

    .upload-button:hover {
        border-color: #0d6efd;
        background-color: #e9f5ff;
    }

    .upload-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: #0d6efd;
    }

    .upload-text {
        font-weight: 500;
    }

    /* Bottoni in basso */
    .action-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
{# INIZIO NAVIGAZIONE SOTTONAVBAR #}
<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h3 class="mb-0">Project Details</h3>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'projects_list' %}">Projects</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ project.name }}</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{# FINE NAVIGAZIONE SOTTONAVBAR #}

{% if messages %}
<div class="container-fluid">
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="container-fluid">
    <!-- Project Header -->
    <div class="project-header">
        <div class="row">
            <div class="col-md-8">
                <h4 class="project-title">
                    <i class="bi bi-kanban"></i>
                    {{ project.name }}
                </h4>
                <p class="project-description">
                    {% if project.description %}
                        {{ project.description }}
                    {% else %}
                        <span class="text-muted">No description provided</span>
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <span class="badge bg-success badge-status">Active</span>
                <p class="small text-muted mt-2">Created on: {{ project.created_at|date:"M d, Y" }}</p>
            </div>
        </div>
    </div>

    <!-- Documents Section -->
    <h5 class="section-title">Documents</h5>

    {% if project_files %}
    <div class="documents-container">
        {% for file in project_files %}
        <div class="document-card" data-bs-toggle="modal" data-bs-target="#documentModal" data-file-id="{{ file.id }}" data-file-name="{{ file.name }}" data-file-url="{{ file.url }}">
            <div class="document-thumb">
                {% if file.extension == '.pdf' %}
                <i class="bi bi-file-earmark-pdf document-icon pdf"></i>
                {% elif file.extension == '.doc' or file.extension == '.docx' %}
                <i class="bi bi-file-earmark-word document-icon doc"></i>
                {% elif file.extension == '.xls' or file.extension == '.xlsx' %}
                <i class="bi bi-file-earmark-excel document-icon xls"></i>
                {% elif file.extension == '.ppt' or file.extension == '.pptx' %}
                <i class="bi bi-file-earmark-slides document-icon ppt"></i>
                {% elif file.extension == '.txt' %}
                <i class="bi bi-file-earmark-text document-icon txt"></i>
                {% elif file.extension == '.jpg' or file.extension == '.jpeg' or file.extension == '.png' or file.extension == '.gif' %}
                <i class="bi bi-file-earmark-image document-icon img"></i>
                {% else %}
                <i class="bi bi-file-earmark document-icon"></i>
                {% endif %}
            </div>
            <div class="document-name" title="{{ file.name }}">{{ file.name }}</div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-project mb-4">
        <i class="bi bi-file-earmark-x"></i>
        <h4>No documents yet</h4>
        <p class="text-muted">Upload files to start working with this project.</p>
    </div>
    {% endif %}

    <!-- Upload Buttons -->
    <div class="upload-actions">
        <div class="upload-button" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
            <div class="upload-icon">
                <i class="bi bi-file-earmark-plus"></i>
            </div>
            <div class="upload-text">Upload Files</div>
        </div>
        <div class="upload-button" data-bs-toggle="modal" data-bs-target="#uploadFolderModal">
            <div class="upload-icon">
                <i class="bi bi-folder-plus"></i>
            </div>
            <div class="upload-text">Upload Folder</div>
        </div>
    </div>

    <!-- Notes Section -->
    <h5 class="section-title">Notes</h5>
    <form method="post" action="{% url 'project' %}" id="notes-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="save_notes">
        <input type="hidden" name="project_id" value="{{ project.id }}">

        <div class="notes-container">
            <div class="notes-toolbar">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-type-bold"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-type-italic"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-type-underline"></i>
                    </button>
                </div>
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-list-ul"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-list-ol"></i>
                    </button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-link"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-image"></i>
                    </button>
                </div>
            </div>

            <div class="notes-editor">
                <textarea class="form-control border-0" name="notes" id="project-notes" rows="6" style="resize: none;"
                    placeholder="Enter your project notes here...">{{ project.notes }}</textarea>
            </div>
        </div>

        <div class="mt-3 text-end">
            <button type="submit" class="btn btn-outline-primary">
                <i class="bi bi-save me-2"></i> Save Notes
            </button>
        </div>
    </form>

    <!-- Ask Anything Section -->
    <h5 class="section-title">Ask Anything</h5>

    <div class="ask-container">
        <div class="chat-messages" id="chat-messages">
            {% if conversation_history %}
                {% for message in conversation_history %}
                    <div class="message {% if message.is_user %}user-message{% else %}ai-message{% endif %}">
                        <div class="message-header">
                            {% if message.is_user %}You{% else %}AI Assistant{% endif %}
                        </div>
                        <div class="message-content">
                            {{ message.content|linebreaks }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-chat-square-text mb-3" style="font-size: 3rem; color: #dee2e6;"></i>
                    <h5>Ask me anything about your documents</h5>
                    <p class="text-muted">I can analyze your project files and answer questions about their content.</p>
                    <div class="mt-3">
                        <p><strong>Examples of questions you can ask:</strong></p>
                        <ul class="text-start d-inline-block">
                            <li>Summarize the main points from all documents</li>
                            <li>What does document X say about topic Y?</li>
                            <li>Compare the information in these documents</li>
                            <li>Extract important dates and events</li>
                        </ul>
                    </div>
                </div>
            {% endif %}

            {% if answer %}
                <div class="message ai-message" id="last-response">
                    <div class="message-header">
                        AI Assistant
                    </div>
                    <div class="message-content">
                        {{ answer|linebreaks }}

                        {% if sources %}
                            <div class="sources-wrapper mt-3">
                                <button class="btn btn-sm btn-outline-primary w-100" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#sourcesList"
                                    aria-expanded="false" aria-controls="sourcesList">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    Show Sources ({{ sources|length }})
                                    <i class="bi bi-chevron-down ms-2"></i>
                                </button>

                                <div class="collapse mt-2" id="sourcesList">
                                    <div class="sources-list">
                                        {% for source in sources %}
                                            <div class="card mb-2 source-card">
                                                <div class="card-header d-flex align-items-center source-header p-2">
                                                    {% if source.type == ".pdf" %}
                                                        <i class="bi bi-file-earmark-pdf source-icon me-2"></i>
                                                    {% elif source.type == ".docx" or source.type == ".doc" %}
                                                        <i class="bi bi-file-earmark-word source-icon me-2"></i>
                                                    {% elif source.type == ".txt" %}
                                                        <i class="bi bi-file-earmark-text source-icon me-2"></i>
                                                    {% elif source.type == ".csv" %}
                                                        <i class="bi bi-file-earmark-spreadsheet source-icon me-2"></i>
                                                    {% elif source.type == ".jpg" or source.type == ".jpeg" or source.type == ".png" or source.type == ".gif" %}
                                                        <i class="bi bi-file-earmark-image source-icon me-2"></i>
                                                    {% else %}
                                                        <i class="bi bi-file-earmark source-icon me-2"></i>
                                                    {% endif %}
                                                    <span class="small">{{ source.filename }}</span>
                                                </div>
                                                <div class="card-body source-content p-2">
                                                    <div class="source-chunk p-2 bg-light rounded">
                                                        {{ source.content|linebreaks }}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <form method="post" action="{% url 'project' %}" id="ask-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="ask_question">
            <input type="hidden" name="project_id" value="{{ project.id }}">

            <div class="chat-input-container">
                <textarea class="form-control chat-input mb-2" name="question" rows="3"
                    placeholder="Type your question here..." required></textarea>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send me-2"></i> Send
                    </button>
                </div>
            </div>
        </form>

        <div class="loader mt-3" id="loading-indicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Processing your question, this may take a moment...</p>
        </div>
    </div>

    <!-- Action Buttons (Bottom) -->
    <div class="action-buttons">
        <a href="{% url 'projects_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i> Back to Projects
        </a>
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">
            <i class="bi bi-trash me-2"></i> Delete Project
        </button>
    </div>
</div>

<!-- Modal: View Document -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentModalLabel">Document Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="ratio ratio-16x9">
                    <iframe id="document-frame" src="" allowfullscreen></iframe>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary" id="download-document" download>
                    <i class="bi bi-download me-1"></i> Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Upload Files -->
<div class="modal fade" id="uploadFilesModal" tabindex="-1" aria-labelledby="uploadFilesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFilesModalLabel">Upload Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'project' %}" enctype="multipart/form-data" id="upload-files-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_files">
                    <input type="hidden" name="project_id" value="{{ project.id }}">

                    <div class="mb-3">
                        <label for="project-files" class="form-label">Select Files</label>
                        <input type="file" class="form-control" id="project-files" name="files[]" multiple
                            accept=".pdf,.docx,.doc,.txt,.csv,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                        <div class="form-text">
                            Supported file types: PDF, DOCX, TXT, CSV, XLS, XLSX, PPT, PPTX, JPG, JPEG, PNG, GIF.
                        </div>
                    </div>

                    <div id="selected-files-preview" class="d-none mt-4">
                        <h6>Selected Files</h6>
                        <div id="files-preview-list" class="list-group">
                            <!-- Selected files will be shown here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="upload-files-form" class="btn btn-primary">
                    <i class="bi bi-cloud-upload me-1"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Upload Folder -->
<div class="modal fade" id="uploadFolderModal" tabindex="-1" aria-labelledby="uploadFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFolderModalLabel">Upload Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Select an entire folder to upload all its contents at once.
                </div>

                <form method="post" action="{% url 'project' %}" enctype="multipart/form-data" id="upload-folder-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_folder">
                    <input type="hidden" name="project_id" value="{{ project.id }}">

                    <div class="mb-3">
                        <label for="project-folder" class="form-label">Select Folder</label>
                        <input type="file" class="form-control" id="project-folder" name="folder[]" webkitdirectory directory multiple
                            accept=".pdf,.docx,.doc,.txt,.csv,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                    </div>

                    <div id="selected-folder-info" class="d-none mt-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Folder Summary</h6>
                                <p class="mb-1"><strong>Folder name:</strong> <span id="folder-name"></span></p>
                                <p class="mb-1"><strong>Total files:</strong> <span id="file-count">0</span></p>
                                <p class="mb-0"><strong>Valid files:</strong> <span id="valid-files">0</span></p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="upload-folder-form" class="btn btn-primary">
                    <i class="bi bi-cloud-upload me-1"></i> Upload Folder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Delete Project Confirmation -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteProjectModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Warning: This action cannot be undone!
                </div>
                <p>Are you sure you want to delete this project and all its associated files?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'projects_list' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_project">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i> Delete Project
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Document modal
        const documentModal = document.getElementById('documentModal');
        if (documentModal) {
            documentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const fileId = button.getAttribute('data-file-id');
                const fileName = button.getAttribute('data-file-name');
                const fileUrl = button.getAttribute('data-file-url');

                const modalTitle = documentModal.querySelector('.modal-title');
                const documentFrame = document.getElementById('document-frame');
                const downloadButton = document.getElementById('download-document');

                modalTitle.textContent = fileName;
                documentFrame.src = fileUrl;
                downloadButton.href = fileUrl;
                downloadButton.setAttribute('download', fileName);
            });
        }

        // File preview in upload modal
        const fileInput = document.getElementById('project-files');
        const filePreviewContainer = document.getElementById('selected-files-preview');
        const filesList = document.getElementById('files-preview-list');

        if (fileInput) {
            fileInput.addEventListener('change', function() {
                filesList.innerHTML = '';

                if (this.files.length > 0) {
                    filePreviewContainer.classList.remove('d-none');

                    for (let i = 0; i < this.files.length; i++) {
                        const file = this.files[i];
                        const fileSize = formatFileSize(file.size);
                        const fileExt = getFileExtension(file.name);
                        let iconClass = getFileIconClass(fileExt);

                        const listItem = document.createElement('div');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            <div>
                                <i class="bi ${iconClass} me-2"></i>
                                <span>${file.name}</span>
                            </div>
                            <span class="badge bg-secondary rounded-pill">${fileSize}</span>
                        `;

                        filesList.appendChild(listItem);
                    }
                } else {
                    filePreviewContainer.classList.add('d-none');
                }
            });
        }

        // Folder upload preview
        const folderInput = document.getElementById('project-folder');
        const folderInfoContainer = document.getElementById('selected-folder-info');
        const folderNameElement = document.getElementById('folder-name');
        const fileCountElement = document.getElementById('file-count');
        const validFilesElement = document.getElementById('valid-files');

        if (folderInput) {
            folderInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    folderInfoContainer.classList.remove('d-none');

                    // Get folder name from first file's path
                    const firstFilePath = this.files[0].webkitRelativePath;
                    const folderName = firstFilePath.split('/')[0];
                    folderNameElement.textContent = folderName;

                    // Count valid files
                    const validExtensions = ['.pdf', '.docx', '.doc', '.txt', '.csv', '.xls', '.xlsx', '.ppt', '.pptx', '.jpg', '.jpeg', '.png', '.gif'];
                    let validCount = 0;

                    for (let i = 0; i < this.files.length; i++) {
                        const fileExt = getFileExtension(this.files[i].name);
                        if (validExtensions.includes(fileExt)) {
                            validCount++;
                        }
                    }

                    fileCountElement.textContent = this.files.length;
                    validFilesElement.textContent = validCount;
                } else {
                    folderInfoContainer.classList.add('d-none');
                }
            });
        }

        // Ask form loading indicator
        const askForm = document.getElementById('ask-form');
        const loadingIndicator = document.getElementById('loading-indicator');

        if (askForm) {
            askForm.addEventListener('submit', function() {
                // Show loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'block';
                }

                // Disable submit button
                const submitButton = askForm.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                }

                // Add user message to chat
                const chatMessages = document.getElementById('chat-messages');
                const question = askForm.querySelector('textarea[name="question"]').value;

                if (chatMessages && question) {
                    const userMessage = document.createElement('div');
                    userMessage.className = 'message user-message';
                    userMessage.innerHTML = `
                        <div class="message-header">You</div>
                        <div class="message-content">${question}</div>
                    `;
                    chatMessages.appendChild(userMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        // Scroll to last message
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Sources toggle
        const sourcesButton = document.querySelector('[data-bs-toggle="collapse"]');
        const sourcesCollapse = document.getElementById('sourcesList');

        if (sourcesButton && sourcesCollapse) {
            sourcesCollapse.addEventListener('show.bs.collapse', function () {
                sourcesButton.innerHTML = '<i class="bi bi-file-earmark-text me-2"></i> Hide Sources <i class="bi bi-chevron-up ms-2"></i>';
            });

            sourcesCollapse.addEventListener('hide.bs.collapse', function () {
                const sourcesCount = document.querySelectorAll('.source-card').length;
                sourcesButton.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i> Show Sources (${sourcesCount}) <i class="bi bi-chevron-down ms-2"></i>`;
            });
        }

        // Auto-save notes (optional feature)
        const notesTextarea = document.getElementById('project-notes');
        let saveTimeout;

        if (notesTextarea) {
            notesTextarea.addEventListener('input', function() {
                // Clear existing timeout
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }

                // Set new timeout (save after 2 seconds of inactivity)
                saveTimeout = setTimeout(function() {
                    const notesForm = document.getElementById('notes-form');

                    // Use fetch to submit the form without page reload
                    const formData = new FormData(notesForm);

                    fetch(notesForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Notes auto-saved');
                    })
                    .catch(error => {
                        console.error('Error auto-saving notes:', error);
                    });

                }, 2000);
            });
        }

        // Helper functions
        function formatFileSize(bytes) {
            if (bytes < 1024) {
                return bytes + ' bytes';
            } else if (bytes < 1024 * 1024) {
                return (bytes / 1024).toFixed(1) + ' KB';
            } else {
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }
        }

        function getFileExtension(filename) {
            return '.' + filename.split('.').pop().toLowerCase();
        }

        function getFileIconClass(extension) {
            if (extension === '.pdf') {
                return 'bi-file-earmark-pdf';
            } else if (['.doc', '.docx'].includes(extension)) {
                return 'bi-file-earmark-word';
            } else if (['.xls', '.xlsx'].includes(extension)) {
                return 'bi-file-earmark-excel';
            } else if (['.ppt', '.pptx'].includes(extension)) {
                return 'bi-file-earmark-slides';
            } else if (extension === '.txt') {
                return 'bi-file-earmark-text';
            } else if (extension === '.csv') {
                return 'bi-file-earmark-spreadsheet';
            } else if (['.jpg', '.jpeg', '.png', '.gif'].includes(extension)) {
                return 'bi-file-earmark-image';
            } else {
                return 'bi-file-earmark';
            }
        }
    });
</script>
{% endblock %}