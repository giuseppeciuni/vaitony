{% extends 'be/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .engine-card {
        border-radius: 0.75rem;
        transition: all 0.2s;
        border: 1px solid rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .engine-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }

    .engine-card.selected {
        border: 2px solid #0d6efd;
        box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.15);
    }

    .engine-header {
        padding: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .engine-body {
        padding: 1.25rem;
    }

    .engine-footer {
        padding: 1rem;
        background-color: rgba(0,0,0,0.03);
        border-top: 1px solid rgba(0,0,0,0.1);
    }

    .param-label {
        font-weight: 500;
        color: #495057;
    }

    .param-help {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .engine-logo {
        width: 40px;
        height: 40px;
        object-fit: contain;
    }

    .selected-badge {
        position: absolute;
        right: -10px;
        top: -10px;
        background-color: #0d6efd;
        color: white;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: scale(0);
        transition: transform 0.3s ease;
    }

    .engine-card.selected .selected-badge {
        transform: scale(1);
    }

    .param-row {
        margin-bottom: 1.25rem;
        padding-bottom: 1.25rem;
        border-bottom: 1px dashed rgba(0,0,0,0.1);
    }

    .param-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .tooltip-inner {
        max-width: 300px;
    }

    .config-panel {
        display: none;
    }

    .config-panel.active {
        display: block;
    }

    /* Slider customization */
    .form-range::-webkit-slider-thumb {
        background: #0d6efd;
    }

    .form-range::-moz-range-thumb {
        background: #0d6efd;
    }

    .form-range::-ms-thumb {
        background: #0d6efd;
    }

    .api-key-status-success {
        color: #28a745;
    }

    .api-key-status-warning {
        color: #ffc107;
    }

    .api-key-status-danger {
        color: #dc3545;
    }

    .engine-section {
        display: none;
    }

    .engine-section.active {
        display: block;
    }

    .empty-state {
        padding: 3rem;
        text-align: center;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }

    .empty-state-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .api-key-card {
        transition: all 0.2s;
    }

    .api-key-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
    }
</style>
{% endblock %}


{% block content %}
<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h1 class="mb-0 h4">Configurazione Motore IA</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                    <li class="breadcrumb-item">Impostazioni</li>
                    <li class="breadcrumb-item active">Motore IA</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Alert info -->
    <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
        <div class="d-flex">
            <div class="flex-shrink-0">
                <i class="bi bi-info-circle-fill fs-4 me-3"></i>
            </div>
            <div>
                <h4 class="alert-heading">Configurazione API Keys</h4>
                <p>Prima di poter utilizzare un motore di intelligenza artificiale, devi configurare le relative chiavi API personali.</p>
                <p class="mb-0"><strong>Nota:</strong> Le API keys personali sono sempre crittografate per proteggere la tua sicurezza. L'interfaccia mostrer√† solo i modelli per cui hai configurato una chiave API valida.</p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
    </div>

    <!-- API Keys Configuration -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Configurazione API Keys</h5>
            <span class="badge bg-info" id="api-keys-count">
                <i class="bi bi-key"></i> <span id="active-keys-count">0</span> chiavi configurate
            </span>
        </div>
        <div class="card-body">
            <div class="alert alert-warning mb-4">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Per utilizzare i modelli di intelligenza artificiale, devi inserire almeno una chiave API valida. Solo i modelli corrispondenti alle chiavi inserite saranno disponibili per la selezione.
            </div>

            <div class="row row-cols-1 row-cols-md-2 g-4 mb-3">
                <!-- OpenAI API Key Card -->
                <div class="col">
                    <div class="card h-100 api-key-card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{% static 'dist/assets/img/openai.svg' %}" alt="OpenAI Logo" class="engine-logo me-2">
                                    <h5 class="mb-0">OpenAI API Key</h5>
                                </div>
                                <span class="badge api-key-status api-key-status-warning" id="openai-status">
                                    <i class="bi bi-dash-circle"></i> Non configurata
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Consente l'accesso ai modelli GPT come GPT-4o, GPT-4, GPT-3.5 e altri. Ideali per compiti generali di comprensione e generazione di testo.</p>

                            <form id="openai-api-form" method="post" action="{% url 'ia_engine' %}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="save_api_key">
                                <input type="hidden" name="provider_id" value="{{ openai_provider_id|default:'1' }}">

                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="openai-api-key" name="api_key"
                                               placeholder="sk-..." value="{{ decrypted_api_keys.1|default:'' }}">
                                        <button class="btn btn-outline-secondary toggle-password" type="button"
                                                data-target="openai-api-key">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Formato: sk-... (Inizia con "sk-" seguito da caratteri alfanumerici)</div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="https://platform.openai.com/account/api-keys" target="_blank"
                                       class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-box-arrow-up-right me-1"></i> Ottieni chiave
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-1"></i> Salva
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Claude API Key Card -->
                <div class="col">
                    <div class="card h-100 api-key-card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{% static 'dist/assets/img/claude.png' %}" alt="Claude Logo" class="engine-logo me-2">
                                    <h5 class="mb-0">Anthropic API Key</h5>
                                </div>
                                <span class="badge api-key-status api-key-status-warning" id="claude-status">
                                    <i class="bi bi-dash-circle"></i> Non configurata
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Consente l'accesso ai modelli Claude di Anthropic, noti per la loro precisione, ragionamento e comprensione delle sfumature.</p>

                            <form id="claude-api-form" method="post" action="{% url 'ia_engine' %}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="save_api_key">
                                <input type="hidden" name="provider_id" value="{{ decrypted_api_keys.2|default:'' }}">

                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="claude-api-key" name="api_key"
                                               placeholder="sk-ant-..." value="{{ api_keys.claude_provider_id.api_key|default:'' }}">
                                        <button class="btn btn-outline-secondary toggle-password" type="button"
                                                data-target="claude-api-key">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Formato: sk-ant-... (Inizia con "sk-ant-" seguito da caratteri alfanumerici)</div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="https://console.anthropic.com/account/keys" target="_blank"
                                       class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-box-arrow-up-right me-1"></i> Ottieni chiave
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-1"></i> Salva
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Gemini API Key Card -->
                <div class="col">
                    <div class="card h-100 api-key-card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{% static 'dist/assets/img/gemini.svg' %}" alt="Gemini Logo" class="engine-logo me-2">
                                    <h5 class="mb-0">Google Gemini API Key</h5>
                                </div>
                                <span class="badge api-key-status api-key-status-warning" id="gemini-status">
                                    <i class="bi bi-dash-circle"></i> Non configurata
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Consente l'accesso ai modelli Gemini di Google, versatili e con buon equilibrio tra costo e prestazioni per attivit√† generali.</p>

                            <form id="gemini-api-form" method="post" action="{% url 'ia_engine' %}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="save_api_key">
                                <input type="hidden" name="provider_id" value="{{ decrypted_api_keys.3|default:'' }}">

                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="gemini-api-key" name="api_key"
                                               placeholder="AIza..." value="{{ api_keys.gemini_provider_id.api_key|default:'' }}">
                                        <button class="btn btn-outline-secondary toggle-password" type="button"
                                                data-target="gemini-api-key">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Formato: AIza... (Inizia con "AIza" seguito da caratteri alfanumerici)</div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="https://ai.google.dev/" target="_blank"
                                       class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-box-arrow-up-right me-1"></i> Ottieni chiave
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-1"></i> Salva
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- DeepSeek API Key Card -->
                <div class="col">
                    <div class="card h-100 api-key-card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{% static 'dist/assets/img/deepseek.svg' %}" alt="DeepSeek Logo" class="engine-logo me-2">
                                    <h5 class="mb-0">DeepSeek API Key</h5>
                                </div>
                                <span class="badge api-key-status api-key-status-warning" id="deepseek-status">
                                    <i class="bi bi-dash-circle"></i> Non configurata
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Consente l'accesso ai modelli DeepSeek, particolarmente efficienti per analisi di codice e documentazione tecnica a costi contenuti.</p>

                            <form id="deepseek-api-form" method="post" action="{% url 'ia_engine' %}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="save_api_key">
                                <input type="hidden" name="provider_id" value="{{ decrypted_api_keys.4|default:'' }}">

                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="deepseek-api-key" name="api_key"
                                               placeholder="sk-..." value="{{ api_keys.deepseek_provider_id.api_key|default:'' }}">
                                        <button class="btn btn-outline-secondary toggle-password" type="button"
                                                data-target="deepseek-api-key">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Formato: sk-... (Inizia con "sk-" seguito da caratteri alfanumerici)</div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="https://platform.deepseek.com/" target="_blank"
                                       class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-box-arrow-up-right me-1"></i> Ottieni chiave
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-1"></i> Salva
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validate API Keys button -->
            <div class="text-center mt-4">
                <button id="validate-all-keys" class="btn btn-outline-primary">
                    <i class="bi bi-shield-check me-1"></i> Verifica tutte le chiavi API
                </button>
            </div>
        </div>
    </div>
<!-- Engine Selection Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Selezione Motore IA</h5>
        </div>
        <div class="card-body">
            <p>Seleziona il modello di intelligenza artificiale da utilizzare per interagire con i tuoi documenti. Saranno visibili solo i motori per cui hai configurato una chiave API valida.</p>

            <!-- Stato vuoto (nessuna chiave configurata) -->
            <div id="empty-engines-state" class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-robot"></i>
                </div>
                <h4>Nessun motore disponibile</h4>
                <p class="text-muted">Configura almeno una chiave API valida per visualizzare i motori di intelligenza artificiale disponibili.</p>
                <a href="#" class="btn btn-primary" onclick="document.querySelector('.card-header').scrollIntoView({behavior: 'smooth'}); return false;">
                    <i class="bi bi-key me-1"></i> Configura chiavi API
                </a>
            </div>

            <!-- Engine Cards Container - Visibile solo se ci sono chiavi configurate -->
            <div id="engine-cards-container" class="row row-cols-1 row-cols-md-3 g-4 mb-4" style="display: none;">
                <!-- OpenAI Card - Visibile solo se la chiave √® configurata -->
                <div class="col engine-section" id="openai-engine-section">
                    <div class="card h-100 engine-card {% if selected_engine == 'openai' %}selected{% endif %}" id="openai-card">
                        <div class="selected-badge">
                            <i class="bi bi-check-lg"></i>
                        </div>
                        <div class="engine-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{% static 'dist/assets/img/openai.svg' %}" alt="OpenAI Logo" class="engine-logo me-2">
                                    <h5 class="mb-0">ChatGPT <span id="openai-model-display">4o</span></h5>
                                </div>
                                <span class="badge bg-success">Consigliato</span>
                            </div>
                        </div>
                        <div class="engine-body">
                            <p class="card-text">Il modello OpenAI GPT-4o √® uno dei pi√π potenti e versatili, con una vasta conoscenza e ottime capacit√† di comprensione del contesto.</p>

                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-lightning me-2 text-warning"></i>
                                    <span class="fw-medium">Velocit√†:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star text-muted"></i>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-brightness-high me-2 text-primary"></i>
                                    <span class="fw-medium">Precisione:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-half text-primary"></i>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center">
                                    <i class="bi bi-currency-euro me-2 text-success"></i>
                                    <span class="fw-medium">Costo:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star text-muted"></i>
                                        <i class="bi bi-star text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="engine-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-medium">Stato: <span class="{% if selected_engine == 'openai' %}text-success{% else %}text-secondary{% endif %}">{% if selected_engine == 'openai' %}Attivo{% else %}Inattivo{% endif %}</span></span>
                                <button class="btn btn-sm {% if selected_engine == 'openai' %}btn-primary{% else %}btn-outline-primary{% endif %} select-engine" data-engine="openai">{% if selected_engine == 'openai' %}Selezionato{% else %}Seleziona{% endif %}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Claude Card - Visibile solo se la chiave √® configurata -->
                <div class="col engine-section" id="claude-engine-section">
                     <div class="card h-100 engine-card {% if selected_engine == 'claude' %}selected{% endif %}" id="claude-card">
                        <div class="selected-badge">
                            <i class="bi bi-check-lg"></i>
                        </div>
                        <div class="engine-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{% static 'dist/assets/img/claude.png' %}" alt="Anthropic Logo" class="engine-logo me-2">
                                    <h5 class="mb-0">Claude 3.7 Sonnet</h5>
                                </div>
                                <span class="badge bg-info">Alta precisione</span>
                            </div>
                        </div>
                        <div class="engine-body">
                            <p class="card-text">Claude 3.7 Sonnet di Anthropic √® noto per la sua precisione e ragionamento strutturato, con un'ottima capacit√† di seguire istruzioni.</p>

                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-lightning me-2 text-warning"></i>
                                    <span class="fw-medium">Velocit√†:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star text-muted"></i>
                                        <i class="bi bi-star text-muted"></i>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-brightness-high me-2 text-primary"></i>
                                    <span class="fw-medium">Precisione:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center">
                                    <i class="bi bi-currency-euro me-2 text-success"></i>
                                    <span class="fw-medium">Costo:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="engine-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-medium">Stato: <span class="{% if selected_engine == 'claude' %}text-success{% else %}text-secondary{% endif %}">{% if selected_engine == 'claude' %}Attivo{% else %}Inattivo{% endif %}</span></span>
                                <button class="btn btn-sm {% if selected_engine == 'claude' %}btn-primary{% else %}btn-outline-primary{% endif %} select-engine" data-engine="claude">{% if selected_engine == 'claude' %}Selezionato{% else %}Seleziona{% endif %}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DeepSeek Card - Visibile solo se la chiave √® configurata -->
<div class="col engine-section" id="deepseek-engine-section">
                     <div class="card h-100 engine-card {% if selected_engine == 'deepseek' %}selected{% endif %}" id="deepseek-card">
                        <div class="selected-badge">
                            <i class="bi bi-check-lg"></i>
                        </div>
                        <div class="engine-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{% static 'dist/assets/img/deepseek.svg' %}" alt="DeepSeek Logo" class="engine-logo me-2">
                                    <h5 class="mb-0">DeepSeek Coder</h5>
                                </div>
                                <span class="badge bg-warning">Economico</span>
                            </div>
                        </div>
                        <div class="engine-body">
                            <p class="card-text">DeepSeek Coder √® specializzato nell'analisi e comprensione del codice, ma funziona bene anche per l'analisi di documenti tecnici.</p>

                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-lightning me-2 text-warning"></i>
                                    <span class="fw-medium">Velocit√†:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-brightness-high me-2 text-primary"></i>
                                    <span class="fw-medium">Precisione:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star text-muted"></i>
                                        <i class="bi bi-star text-muted"></i>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center">
                                    <i class="bi bi-currency-euro me-2 text-success"></i>
                                    <span class="fw-medium">Costo:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star text-muted"></i>
                                        <i class="bi bi-star text-muted"></i>
                                        <i class="bi bi-star text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="engine-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-medium">Stato: <span class="{% if selected_engine == 'deepseek' %}text-success{% else %}text-secondary{% endif %}">{% if selected_engine == 'deepseek' %}Attivo{% else %}Inattivo{% endif %}</span></span>
                                <button class="btn btn-sm {% if selected_engine == 'deepseek' %}btn-primary{% else %}btn-outline-primary{% endif %} select-engine" data-engine="deepseek">{% if selected_engine == 'deepseek' %}Selezionato{% else %}Seleziona{% endif %}</button>
                            </div>
                        </div>
                     </div>
                </div>

                <!-- Gemini Card - Visibile solo se la chiave √® configurata -->
                <div class="col engine-section" id="gemini-engine-section">
                    <div class="card h-100 engine-card {% if selected_engine == 'gemini' %}selected{% endif %}" id="gemini-card">
                        <div class="selected-badge">
                            <i class="bi bi-check-lg"></i>
                        </div>
                        <div class="engine-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{% static 'dist/assets/img/gemini.svg' %}" alt="Gemini Logo" class="engine-logo me-2">
                                    <h5 class="mb-0">Gemini 1.5 Pro</h5>
                                </div>
                                <span class="badge bg-primary">Versatile</span>
                            </div>
                        </div>
                        <div class="engine-body">
                            <p class="card-text">Gemini di Google √® un modello multimodale avanzato, ottimo per analisi complesse, codice, creativit√† e compiti generali.</p>

                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-lightning me-2 text-warning"></i>
                                    <span class="fw-medium">Velocit√†:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star text-muted"></i>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-brightness-high me-2 text-primary"></i>
                                    <span class="fw-medium">Precisione:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-fill text-primary"></i>
                                        <i class="bi bi-star-half text-primary"></i>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center">
                                    <i class="bi bi-currency-euro me-2 text-success"></i>
                                    <span class="fw-medium">Costo:</span>
                                    <div class="ms-2">
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star-fill text-success"></i>
                                        <i class="bi bi-star text-muted"></i>
                                        <i class="bi bi-star text-muted"></i>
                                        <i class="bi bi-star text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="engine-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-medium">Stato: <span class="{% if selected_engine == 'gemini' %}text-success{% else %}text-secondary{% endif %}">{% if selected_engine == 'gemini' %}Attivo{% else %}Inattivo{% endif %}</span></span>
                                <button class="btn btn-sm {% if selected_engine == 'gemini' %}btn-primary{% else %}btn-outline-primary{% endif %} select-engine" data-engine="gemini">{% if selected_engine == 'gemini' %}Selezionato{% else %}Seleziona{% endif %}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Parameters Configuration Panel -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Configurazione Parametri</h5>
        </div>
        <div class="card-body">
            <!-- Stato vuoto (nessun motore selezionato) -->
            <div id="empty-config-state" class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-sliders"></i>
                </div>
                <h4>Nessun motore selezionato</h4>
                <p class="text-muted">Seleziona un motore di intelligenza artificiale per configurarne i parametri.</p>
            </div>

            <!-- OpenAI Config Panel -->
            <div id="openai-config" class="config-panel {% if selected_engine == 'openai' %}active{% endif %}">
                <form id="openai-form" method="post" action="{% url 'ia_engine' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_engine_settings">
                    <input type="hidden" name="engine_type" value="openai">

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="gpt-temperature" class="param-label">Temperatura</label>
                            <div class="d-flex align-items-center mt-2">
                                <input type="range" class="form-range flex-grow-1 me-2" id="gpt-temperature" name="temperature" min="0" max="2" step="0.1" value="0.7">
                                <span id="gpt-temperature-value" class="badge bg-primary">0.7</span>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Controlla la casualit√† delle risposte. Valori bassi (0-0.3) creano risposte pi√π precise e deterministiche, valori alti (0.7-2.0) producono output pi√π creativi e variabili.
                            </p>
                            <div class="mt-2 d-flex">
                                <span class="badge bg-secondary me-2">0 = Preciso</span>
                                <span class="badge bg-secondary me-2">0.7 = Bilanciato</span>
                                <span class="badge bg-secondary">2.0 = Creativo</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Esempi:</strong></p>
                                <ul class="small">
                                    <li><strong>0.0:</strong> "La capitale dell'Italia √® Roma. √à stata fondata nel 753 a.C."</li>
                                    <li><strong>0.7:</strong> "Roma, capitale dell'Italia, √® una citt√† dalle profonde radici storiche che risalgono alla sua leggendaria fondazione nel 753 a.C."</li>
                                    <li><strong>1.5:</strong> "L'eterna citt√† di Roma, cuore pulsante dell'Italia, emerge maestosa dal lontano 753 a.C., intrecciando la sua anima millenaria con la vivacit√† di una capitale moderna."</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="gpt_max_tokens" class="param-label">Limite Tokens</label>
                            <input type="number" class="form-control" id="gpt_max_tokens" name="max_tokens" value="{{ gpt_max_tokens|default:4096 }}" min="100" max="8192" step="1">
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Limita la lunghezza massima della risposta in token (circa 4 caratteri per token). Un valore pi√π alto permette risposte pi√π dettagliate ma aumenta i costi.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-secondary me-2">Min: 100</span>
                                <span class="badge bg-secondary me-2">Standard: 4096</span>
                                <span class="badge bg-secondary">Max: 8192</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Esempi di lunghezza:</strong></p>
                                <ul class="small">
                                    <li><strong>500 token:</strong> ‚âà 375 parole (un paragrafo dettagliato)</li>
                                    <li><strong>2000 token:</strong> ‚âà 1500 parole (un breve articolo)</li>
                                    <li><strong>4096 token:</strong> ‚âà 3000 parole (un saggio completo)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="gpt_timeout" class="param-label">Timeout (secondi)</label>
                            <input type="number" class="form-control" id="gpt_timeout" name="timeout" value="{{ gpt_timeout|default:60 }}" min="10" max="300" step="1">
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Tempo massimo atteso per una risposta. Un valore pi√π alto d√† al modello pi√π tempo per rispondere a domande complesse, ma potrebbe rallentare l'esperienza utente.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-secondary me-2">Min: 10s</span>
                                <span class="badge bg-secondary me-2">Standard: 60s</span>
                                <span class="badge bg-secondary">Max: 300s</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Quando aumentare:</strong> Per analisi di documenti molto lunghi o domande che richiedono ragionamenti complessi.</p>
                                <p class="param-help mb-0"><strong>Quando diminuire:</strong> Per risposte rapide a domande semplici o in contesti che richiedono interazioni veloci.</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="gpt_model" class="param-label">Versione modello</label>
                            <select class="form-select" id="gpt_model" name="model">
                                <option value="gpt-4o" {% if gpt_model == 'gpt-4o' %}selected{% endif %}>GPT-4o (ultima versione)</option>
                                <option value="gpt-4-turbo" {% if gpt_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo" {% if gpt_model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo (economico)</option>
                            </select>
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Seleziona la versione del modello da utilizzare. Le versioni pi√π recenti offrono migliori prestazioni ma possono avere costi pi√π elevati.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-success me-2">GPT-4o: Prestazioni migliori</span>
                                <span class="badge bg-info me-2">GPT-4 Turbo: Bilanciato</span>
                                <span class="badge bg-warning">GPT-3.5: Economico</span>
                            </div>
                            <div class="mt-2">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Modello</th>
                                            <th>Ideale per</th>
                                            <th>Differenze principali</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>GPT-4o</strong></td>
                                            <td>Analisi complesse, ragionamento avanzato</td>
                                            <td>Migliore comprensione, multimodale, pi√π recente</td>
                                        </tr>
                                        <tr>
                                            <td><strong>GPT-4 Turbo</strong></td>
                                            <td>Buon compromesso costo/prestazioni</td>
                                            <td>Buona qualit√†, conoscenze aggiornate</td>
                                        </tr>
                                        <tr>
                                            <td><strong>GPT-3.5 Turbo</strong></td>
                                            <td>Attivit√† semplici, test, bozze</td>
                                            <td>Veloce, economico, meno preciso</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i> Salva configurazione OpenAI
                        </button>
                    </div>
                </form>
            </div>

            <!-- Claude Config Panel -->
            <div id="claude-config" class="config-panel {% if selected_engine == 'claude' %}active{% endif %}">
                <form id="claude-form" method="post" action="{% url 'ia_engine' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_engine_settings">
                    <input type="hidden" name="engine_type" value="claude">
                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="claude-temperature" class="param-label">Temperatura</label>
                            <div class="d-flex align-items-center mt-2">
                                <input type="range" class="form-range flex-grow-1 me-2" id="claude-temperature" name="temperature" min="0" max="1" step="0.01" value="0.5">
                                <span id="claude-temperature-value" class="badge bg-primary">0.5</span>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Controlla la casualit√† delle risposte. Claude √® generalmente pi√π conservativo, quindi la scala √® da 0 a 1. Valori pi√π bassi producono risposte pi√π deterministiche.
                            </p>
                            <div class="mt-2 d-flex">
                                <span class="badge bg-secondary me-2">0 = Deterministico</span>
                                <span class="badge bg-secondary me-2">0.5 = Bilanciato</span>
                                <span class="badge bg-secondary">1.0 = Creativo</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Esempi:</strong></p>
                                <ul class="small">
                                    <li><strong>0.0:</strong> "L'acqua bolle a 100 gradi Celsius a livello del mare. Questo √® un fatto scientifico ben stabilito."</li>
                                    <li><strong>0.5:</strong> "A livello del mare, l'acqua bolle a 100¬∞C. Questo punto di ebollizione varia con l'altitudine e la pressione atmosferica."</li>
                                    <li><strong>1.0:</strong> "Il danzare delle molecole d'acqua raggiunge il suo culmine a 100¬∞C, quando il liquido si trasforma in vapore, liberandosi dai vincoli che lo tenevano in uno stato coeso."</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="claude_max_tokens" class="param-label">Limite Tokens</label>
                            <input type="number" class="form-control" id="claude_max_tokens" name="max_tokens" value="{{ claude_max_tokens|default:4096 }}" min="100" max="10000" step="1">
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Limita la lunghezza massima della risposta. Claude supporta risposte pi√π lunghe, fino a 10.000 token.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-secondary me-2">Min: 100</span>
                                <span class="badge bg-secondary me-2">Standard: 4096</span>
                                <span class="badge bg-secondary">Max: 10000</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Casi d'uso per diversi limiti:</strong></p>
                                <ul class="small">
                                    <li><strong>1000-2000:</strong> Risposte concise, riassunti, analisi brevi</li>
                                    <li><strong>4000-6000:</strong> Analisi approfondite, spiegazioni dettagliate</li>
                                    <li><strong>8000-10000:</strong> Report completi, documentazione estesa, analisi di documenti lunghi</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="claude_timeout" class="param-label">Timeout (secondi)</label>
                            <input type="number" class="form-control" id="claude_timeout" name="timeout" value="{{ claude_timeout|default:90 }}" min="10" max="300" step="1">
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Tempo massimo di attesa per una risposta. Claude richiede spesso pi√π tempo per le risposte ma produce risultati pi√π ponderati.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-secondary me-2">Min: 10s</span>
                                <span class="badge bg-secondary me-2">Standard: 90s</span>
                                <span class="badge bg-secondary">Max: 300s</span>
                            </div>
                            <div class="mt-2">
                                <div class="alert alert-info py-2 px-3">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>Consiglio:</strong> Per risposte lunghe o complesse, considera di impostare un timeout di almeno 120 secondi. Claude tende a elaborare pi√π approfonditamente le risposte rispetto ad altri modelli.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="claude_model" class="param-label">Versione modello</label>
                            <select class="form-select" id="claude_model" name="model">
                                <option value="claude-3-7-sonnet" {% if claude_model == 'claude-3-7-sonnet' %}selected{% endif %}>Claude 3.7 Sonnet</option>
                                <option value="claude-3-opus" {% if claude_model == 'claude-3-opus' %}selected{% endif %}>Claude 3 Opus (pi√π potente)</option>
                                <option value="claude-3-haiku" {% if claude_model == 'claude-3-haiku' %}selected{% endif %}>Claude 3 Haiku (pi√π veloce)</option>
                            </select>
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Seleziona la versione del modello Claude da utilizzare. Opus offre la massima qualit√† ma a costi pi√π elevati, Haiku √® pi√π veloce ed economico.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-success me-2">Opus: Massima qualit√†</span>
                                <span class="badge bg-info me-2">Sonnet: Bilanciato</span>
                                <span class="badge bg-warning">Haiku: Veloce ed economico</span>
                            </div>
                            <div class="mt-2">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Modello</th>
                                            <th>Contesto</th>
                                            <th>Punti di forza</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Claude 3 Opus</strong></td>
                                            <td>200K token</td>
                                            <td>Ragionamento complesso, analisi approfondita, massima precisione</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Claude 3.7 Sonnet</strong></td>
                                            <td>100K token</td>
                                            <td>Ottimo bilanciamento tra prestazioni e costo, buona comprensione</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Claude 3 Haiku</strong></td>
                                            <td>48K token</td>
                                            <td>Risposte rapide, pi√π economico, adatto per attivit√† semplici</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i> Salva configurazione Claude
                        </button>
                    </div>
                </form>
            </div>
<!-- DeepSeek Config Panel -->
            <div id="deepseek-config" class="config-panel {% if selected_engine == 'deepseek' %}active{% endif %}">
                <form id="deepseek-form" method="post" action="{% url 'ia_engine' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_engine_settings">
                    <input type="hidden" name="engine_type" value="deepseek">
                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="deepseek-temperature" class="param-label">Temperatura</label>
                            <div class="d-flex align-items-center mt-2">
                                <input type="range" class="form-range flex-grow-1 me-2" id="deepseek-temperature" name="temperature" min="0" max="1.5" step="0.1" value="0.4">
                                <span id="deepseek-temperature-value" class="badge bg-primary">0.4</span>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Controlla la casualit√† delle risposte. DeepSeek lavora meglio con temperature pi√π basse, soprattutto per analisi di codice e documentazione tecnica.
                            </p>
                            <div class="mt-2 d-flex">
                                <span class="badge bg-secondary me-2">0 = Preciso</span>
                                <span class="badge bg-secondary me-2">0.4 = Bilanciato</span>
                                <span class="badge bg-secondary">1.5 = Creativo</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Esempi di risposte con diverse temperature:</strong></p>
                                <ul class="small">
                                    <li><strong>0.1:</strong> Risposta tecnica concisa e precisa, ideale per codice e debugging</li>
                                    <li><strong>0.4:</strong> Buon equilibrio tra precisione e dettaglio nella spiegazione</li>
                                    <li><strong>1.0+:</strong> Risposte pi√π discorsive che possono esplorare soluzioni alternative</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="deepseek_max_tokens" class="param-label">Limite Tokens</label>
                            <input type="number" class="form-control" id="deepseek_max_tokens" name="max_tokens" value="{{ deepseek_max_tokens|default:2048 }}" min="100" max="4096" step="1">
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Limita la lunghezza massima della risposta. DeepSeek ha un limite massimo inferiore rispetto ad altri modelli ma √® molto efficiente per risposte concise.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-secondary me-2">Min: 100</span>
                                <span class="badge bg-secondary me-2">Standard: 2048</span>
                                <span class="badge bg-secondary">Max: 4096</span>
                            </div>
                            <div class="mt-2">
                                <div class="alert alert-warning py-2 px-3">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    <strong>Nota:</strong> Valori pi√π alti di 2048 possono ridurre l'efficienza del modello DeepSeek. Per output pi√π lunghi, considera di utilizzare GPT o Claude.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="deepseek_timeout" class="param-label">Timeout (secondi)</label>
                            <input type="number" class="form-control" id="deepseek_timeout" name="timeout" value="{{ deepseek_timeout|default:30 }}" min="5" max="180" step="1">
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Tempo massimo di attesa per una risposta. DeepSeek √® generalmente pi√π veloce degli altri modelli, quindi richiede timeout pi√π brevi.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-secondary me-2">Min: 5s</span>
                                <span class="badge bg-secondary me-2">Standard: 30s</span>
                                <span class="badge bg-secondary">Max: 180s</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Consigli sul timeout:</strong></p>
                                <ul class="small">
                                    <li>Per analisi di snippet di codice: 10-20 secondi</li>
                                    <li>Per revisione di codice e documentazione: 30-60 secondi</li>
                                    <li>Per analisi approfondite o generazione di codice complesso: 60-120 secondi</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="deepseek_model" class="param-label">Versione modello</label>
                            <select class="form-select" id="deepseek_model" name="model">
                                <option value="deepseek-coder" {% if deepseek_model == 'deepseek-coder' %}selected{% endif %}>DeepSeek Coder</option>
                                <option value="deepseek-chat" {% if deepseek_model == 'deepseek-chat' %}selected{% endif %}>DeepSeek Chat</option>
                                <option value="deepseek-lite" {% if deepseek_model == 'deepseek-lite' %}selected{% endif %}>DeepSeek Lite (veloce)</option>
                            </select>
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Seleziona la variante del modello DeepSeek. Coder √® specializzato nell'analisi di codice e documentazione tecnica, Chat √® pi√π versatile e Lite √® ottimizzato per la velocit√†.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-success me-2">Coder: Ottimo per documenti tecnici</span>
                                <span class="badge bg-info me-2">Chat: Versatile</span>
                                <span class="badge bg-warning">Lite: Veloce ed economico</span>
                            </div>
                            <div class="mt-2">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Modello</th>
                                            <th>Ideale per</th>
                                            <th>Caratteristiche</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>DeepSeek Coder</strong></td>
                                            <td>Analisi/scrittura codice, documentazione tecnica</td>
                                            <td>Comprende 50+ linguaggi, ottimo per debugging</td>
                                        </tr>
                                        <tr>
                                            <td><strong>DeepSeek Chat</strong></td>
                                            <td>Analisi generale, conversazioni miste</td>
                                            <td>Buon bilanciamento tra capacit√† tecniche e generali</td>
                                        </tr>
                                        <tr>
                                            <td><strong>DeepSeek Lite</strong></td>
                                            <td>Risposte rapide, progetti con budget limitato</td>
                                            <td>Ottimizzato per efficienza e velocit√†</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i> Salva configurazione DeepSeek
                        </button>
                    </div>
                </form>
            </div>

            <!-- Gemini Config Panel -->
            <div id="gemini-config" class="config-panel {% if selected_engine == 'gemini' %}active{% endif %}">
                <form id="gemini-form" method="post" action="{% url 'ia_engine' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_engine_settings">
                    <input type="hidden" name="engine_type" value="gemini">
                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="gemini-temperature" class="param-label">Temperatura</label>
                            <div class="d-flex align-items-center mt-2">
                                <input type="range" class="form-range flex-grow-1 me-2" id="gemini-temperature" name="temperature" min="0" max="1" step="0.1" value="0.7">
                                <span id="gemini-temperature-value" class="badge bg-primary">0.7</span>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Controlla la casualit√† delle risposte. Valori pi√π bassi rendono le risposte pi√π prevedibili e focalizzate, mentre valori pi√π alti producono risposte pi√π creative e varie.
                            </p>
                            <div class="mt-2 d-flex">
                                <span class="badge bg-secondary me-2">0 = Preciso</span>
                                <span class="badge bg-secondary me-2">0.7 = Bilanciato</span>
                                <span class="badge bg-secondary">1.0 = Creativo</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Esempi di utilizzo:</strong></p>
                                <ul class="small">
                                    <li><strong>Bassa temperatura (0.1-0.3):</strong> Analisi di dati, risposta a domande fattuali, estrazione di informazioni da documenti</li>
                                    <li><strong>Media temperatura (0.4-0.7):</strong> Riassunti, spiegazioni, traduzioni, risposta generale alle domande</li>
                                    <li><strong>Alta temperatura (0.8-1.0):</strong> Generazione di idee, brainstorming, scrittura creativa, esplorazione di concetti</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="gemini_max_tokens" class="param-label">Limite Tokens</label>
                            <input type="number" class="form-control" id="gemini_max_tokens" name="max_tokens" value="{{ gemini_max_tokens|default:8192 }}" min="100" max="32768" step="1">
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Limita la lunghezza massima della risposta in token. Gemini supporta risposte molto lunghe, fino a 32.768 token in alcuni casi.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-secondary me-2">Min: 100</span>
                                <span class="badge bg-secondary me-2">Standard: 8192</span>
                                <span class="badge bg-secondary">Max: 32768</span>
                            </div>
                            <div class="mt-2">
                                <div class="alert alert-info py-2 px-3">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Gemini eccelle nell'analisi di documenti lunghi, ma tenere presente che risposte molto lunghe (>10.000 token) possono richiedere pi√π tempo di elaborazione.
                                </div>
                                <p class="param-help mb-0"><strong>Riferimento:</strong> 8192 token equivalgono a circa 25-30 pagine di testo standard.</p>
                            </div>
                        </div>
                    </div>

                    <div class="row param-row align-items-center">
                        <div class="col-md-3">
                            <label for="gemini_timeout" class="param-label">Timeout (secondi)</label>
                            <input type="number" class="form-control" id="gemini_timeout" name="timeout" value="{{ gemini_timeout|default:60 }}" min="10" max="300" step="1">
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Tempo massimo di attesa per una risposta. Modelli pi√π avanzati di Gemini possono richiedere pi√π tempo per risposte complesse.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-secondary me-2">Min: 10s</span>
                                <span class="badge bg-secondary me-2">Standard: 60s</span>
                                <span class="badge bg-secondary">Max: 300s</span>
                            </div>
                            <div class="mt-2">
                                <p class="param-help mb-0"><strong>Considerazioni sul timeout:</strong></p>
                                <ul class="small">
                                    <li>Il modello Gemini 1.5 Pro con dimensioni di risposta elevate pu√≤ richiedere fino a 120-180 secondi</li>
                                    <li>Gemini 1.5 Flash risponde generalmente entro 30-60 secondi, anche per task complessi</li>
                                    <li>Aumentare il timeout in caso di errori di tempo scaduto durante l'analisi di documenti complessi</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="gemini_model" class="param-label">Versione modello</label>
                            <select class="form-select" id="gemini_model" name="model">
                                <option value="gemini-1.5-pro" {% if gemini_model == 'gemini-1.5-pro' %}selected{% endif %}>Gemini 1.5 Pro</option>
                                <option value="gemini-1.5-flash" {% if gemini_model == 'gemini-1.5-flash' %}selected{% endif %}>Gemini 1.5 Flash (veloce)</option>
                                <option value="gemini-1.0-pro" {% if gemini_model == 'gemini-1.0-pro' %}selected{% endif %}>Gemini 1.0 Pro (economico)</option>
                            </select>
                        </div>
                        <div class="col-md-9">
                            <p class="param-help mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Seleziona la versione del modello Gemini da utilizzare. Le versioni pi√π recenti e avanzate offrono migliori prestazioni ma possono avere costi pi√π elevati.
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-success me-2">1.5 Pro: Massima qualit√† e lunghezza</span>
                                <span class="badge bg-info me-2">1.5 Flash: Veloce ed efficiente</span>
                                <span class="badge bg-warning">1.0 Pro: Pi√π economico</span>
                            </div>
                            <div class="mt-2">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Modello</th>
                                            <th>Contesto</th>
                                            <th>Punti di forza</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Gemini 1.5 Pro</strong></td>
                                            <td>1M token</td>
                                            <td>Contesto ultra lungo, multimodale, comprensione avanzata</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Gemini 1.5 Flash</strong></td>
                                            <td>128K token</td>
                                            <td>Ottimo bilanciamento tra velocit√† e qualit√†</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Gemini 1.0 Pro</strong></td>
                                            <td>32K token</td>
                                            <td>Soluzione economica per attivit√† standard</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i> Salva configurazione Gemini
                        </button>
                    </div>
                </form>
            </div>

        </div>
        <div class="card-footer d-flex justify-content-between">
            <button class="btn btn-outline-secondary" id="reset-defaults-btn">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Ripristina valori predefiniti
            </button>
        </div>
    </div>
    <!-- Usage Information -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Guida Dettagliata ai Parametri</h5>
        </div>
        <div class="card-body">
            <div class="accordion" id="parametersGuide">
                <!-- Temperatura -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTemperature">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTemperature" aria-expanded="true" aria-controls="collapseTemperature">
                            <i class="bi bi-thermometer-half me-2"></i> Temperatura
                        </button>
                    </h2>
                    <div id="collapseTemperature" class="accordion-collapse collapse show" aria-labelledby="headingTemperature" data-bs-parent="#parametersGuide">
                        <div class="accordion-body">
                            <h6 class="fw-bold">Definizione:</h6>
                            <p>La temperatura controlla il grado di casualit√† nelle risposte dell'IA. Tecnicamente, influenza la distribuzione di probabilit√† durante la selezione del token successivo.</p>

                            <h6 class="fw-bold">Come funziona:</h6>
                            <ul>
                                <li><strong>Temperatura bassa (0.0-0.3):</strong> Il modello seleziona quasi sempre i token con la probabilit√† pi√π alta, producendo risposte pi√π deterministiche e ripetibili.</li>
                                <li><strong>Temperatura media (0.4-0.7):</strong> Il modello introduce una certa variabilit√† nella selezione dei token, bilanciando prevedibilit√† e creativit√†.</li>
                                <li><strong>Temperatura alta (0.8-2.0):</strong> Il modello considera con maggiore probabilit√† anche token meno probabili, producendo output pi√π casuali e creativi.</li>
                            </ul>

                            <h6 class="fw-bold">Esempi pratici:</h6>
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <span class="fw-bold">Domanda: "Scrivi una breve descrizione dell'Italia."</span>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card h-100">
                                                <div class="card-header bg-light">Temperatura: 0.1</div>
                                                <div class="card-body">
                                                    <p class="card-text">L'Italia √® un paese situato nell'Europa meridionale con una popolazione di circa 60 milioni di abitanti. La sua capitale √® Roma. L'Italia √® conosciuta per la sua ricca storia, arte, cucina e cultura.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card h-100">
                                                <div class="card-header bg-light">Temperatura: 0.7</div>
                                                <div class="card-body">
                                                    <p class="card-text">L'Italia, penisola a forma di stivale che si estende nel Mediterraneo, √® culla di una civilt√† millenaria. Dalla maestosa Roma alle canali di Venezia, il paese incanta con la sua arte rinascimentale, l'opera lirica e una cucina che ha conquistato il mondo intero.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card h-100">
                                                <div class="card-header bg-light">Temperatura: 1.5</div>
                                                <div class="card-body">
                                                    <p class="card-text">L'Italia: un mosaico di passioni dove il tempo danza tra antichi ruderi e caff√® animati. Lo stivale mediterraneo vibra di vita, con melodie di Verdi che si fondono col profumo di basilico e il rombo di Vespe sui ciottoli di piazze senza tempo. Una sinfonia per i sensi che seduce dal primo assaggio.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h6 class="fw-bold">Quando usare valori specifici:</h6>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Impostazione</th>
                                        <th>Valore Temperatura</th>
                                        <th>Ideale per</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Massima precisione</td>
                                        <td>0.0 - 0.2</td>
                                        <td>Domande fattuali, analisi di documenti tecnici, riassunti oggettivi</td>
                                    </tr>
                                    <tr>
                                        <td>Uso generale</td>
                                        <td>0.3 - 0.7</td>
                                        <td>La maggior parte delle conversazioni, spiegazioni, traduzioni</td>
                                    </tr>
                                    <tr>
                                        <td>Creativit√†</td>
                                        <td>0.8 - 1.2</td>
                                        <td>Scrittura creativa, brainstorming, generazione di idee</td>
                                    </tr>
                                    <tr>
                                        <td>Alta variabilit√†</td>
                                        <td>1.3 - 2.0</td>
                                        <td>Poesia sperimentale, esplorazione di idee non convenzionali</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Limite Token -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTokens">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTokens" aria-expanded="false" aria-controls="collapseTokens">
                            <i class="bi bi-text-paragraph me-2"></i> Limite Token
                        </button>
                    </h2>
                    <div id="collapseTokens" class="accordion-collapse collapse" aria-labelledby="headingTokens" data-bs-parent="#parametersGuide">
                        <div class="accordion-body">
                            <h6 class="fw-bold">Definizione:</h6>
                            <p>Il limite di token stabilisce la lunghezza massima della risposta che il modello pu√≤ generare. I token sono unit√† di testo che corrispondono approssimativamente a 4 caratteri o 3/4 di una parola in italiano.</p>

                            <h6 class="fw-bold">Esempi di lunghezza in token:</h6>
                            <ul>
                                <li><strong>500 token:</strong> ‚âà 375 parole (circa 1-2 pagine di testo)</li>
                                <li><strong>1.000 token:</strong> ‚âà 750 parole (circa 3 pagine di testo)</li>
                                <li><strong>2.000 token:</strong> ‚âà 1.500 parole (circa 6 pagine di testo)</li>
                                <li><strong>4.000 token:</strong> ‚âà 3.000 parole (circa 12 pagine di testo)</li>
                                <li><strong>8.000 token:</strong> ‚âà 6.000 parole (circa 24 pagine di testo)</li>
                            </ul>

                            <h6 class="fw-bold">Considerazioni importanti:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">Vantaggi di limiti pi√π alti</div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>Risposte pi√π complete e dettagliate</li>
                                                <li>Possibilit√† di generare testi lunghi in un'unica risposta</li>
                                                <li>Migliore gestione di compiti complessi</li>
                                                <li>Pi√π spazio per esempi ed elaborazioni</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">Svantaggi di limiti pi√π alti</div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>Tempi di risposta pi√π lunghi</li>
                                                <li>Costi pi√π elevati (la maggior parte dei provider addebitano per token)</li>
                                                <li>Possibile divagazione nelle risposte molto lunghe</li>
                                                <li>Maggiore consumo di memoria nel browser</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h6 class="fw-bold">Guida alla selezione del limite di token:</h6>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Scenario</th>
                                        <th>Limite consigliato</th>
                                        <th>Note</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Risposte brevi, chiarimenti</td>
                                        <td>500-1.000</td>
                                        <td>Economico e veloce per domande semplici</td>
                                    </tr>
                                    <tr>
                                        <td>Spiegazioni standard, riassunti</td>
                                        <td>1.000-2.000</td>
                                        <td>Buon equilibrio tra dettaglio e concisione</td>
                                    </tr>
                                    <tr>
                                        <td>Analisi approfondite, tutorial</td>
                                        <td>2.000-4.000</td>
                                        <td>Adatto per la maggior parte dei contenuti dettagliati</td>
                                    </tr>
                                    <tr>
                                        <td>Report completi, documenti lunghi</td>
                                        <td>4.000-8.000</td>
                                        <td>Per contenuti estesi che richiedono molti dettagli</td>
                                    </tr>
                                    <tr>
                                        <td>Analisi di documenti complessi</td>
                                        <td>8.000+</td>
                                        <td>Solo per Gemini 1.5 Pro o Claude 3 Opus che gestiscono bene risposte molto lunghe</td>
                                    </tr>
                                </tbody>
                            </table>

                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <strong>Consiglio:</strong> √à generalmente pi√π efficace impostare un limite di token ragionevole e, se necessario, fare domande di follow-up piuttosto che impostare limiti molto alti per ogni risposta.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeout -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTimeout">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTimeout" aria-expanded="false" aria-controls="collapseTimeout">
                            <i class="bi bi-hourglass-split me-2"></i> Timeout
                        </button>
                    </h2>
                    <div id="collapseTimeout" class="accordion-collapse collapse" aria-labelledby="headingTimeout" data-bs-parent="#parametersGuide">
                        <div class="accordion-body">
                            <h6 class="fw-bold">Definizione:</h6>
                            <p>Il timeout definisce il tempo massimo, in secondi, che il sistema attender√† una risposta dall'API del modello di intelligenza artificiale prima di interrompere la richiesta.</p>

                            <h6 class="fw-bold">Perch√© √® importante:</h6>
                            <p>Un timeout adeguato garantisce che:</p>
                            <ul>
                                <li>Il sistema non rimanga bloccato in attesa indefinita</li>
                                <li>L'utente riceva un messaggio di errore appropriato in caso di problemi</li>
                                <li>Il modello abbia tempo sufficiente per elaborare richieste complesse</li>
                            </ul>

                            <h6 class="fw-bold">Confronto tempi di risposta tra modelli:</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Modello</th>
                                            <th>Risposta breve<br><small>(500-1000 token)</small></th>
                                            <th>Risposta media<br><small>(2000-4000 token)</small></th>
                                            <th>Risposta lunga<br><small>(4000+ token)</small></th>
                                            <th>Timeout consigliato</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>GPT-3.5 Turbo</td>
                                            <td>5-10s</td>
                                            <td>15-30s</td>
                                            <td>30-60s</td>
                                            <td>60s</td>
                                        </tr>
                                        <tr>
                                            <td>GPT-4o</td>
                                            <td>10-15s</td>
                                            <td>20-40s</td>
                                            <td>40-80s</td>
                                            <td>90s</td>
                                        </tr>
                                        <tr>
                                            <td>Claude 3.7 Sonnet</td>
                                            <td>10-20s</td>
                                            <td>30-60s</td>
                                            <td>60-120s</td>
                                            <td>120s</td>
                                        </tr>
                                        <tr>
                                            <td>DeepSeek Coder</td>
                                            <td>3-8s</td>
                                            <td>10-20s</td>
                                            <td>20-40s</td>
                                            <td>40s</td>
                                        </tr>
                                        <tr>
                                            <td>Gemini 1.5 Pro</td>
                                            <td>8-15s</td>
                                            <td>20-40s</td>
                                            <td>40-120s</td>
                                            <td>120s</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h6 class="fw-bold mt-3">Fattori che influenzano il tempo di risposta:</h6>
                            <ul>
                                <li><strong>Complessit√† della domanda:</strong> Domande che richiedono ragionamento o sintesi di molte informazioni richiedono pi√π tempo</li>
                                <li><strong>Lunghezza della risposta:</strong> Risposte pi√π lunghe richiedono pi√π tempo per essere generate</li>
                                <li><strong>Carico dei server:</strong> Nei momenti di picco, le risposte possono richiedere pi√π tempo</li>
                                <li><strong>Modello utilizzato:</strong> Modelli pi√π avanzati possono richiedere pi√π tempo per elaborare</li>
                                <li><strong>Temperatura:</strong> Temperature pi√π alte possono aumentare leggermente il tempo di risposta</li>
                            </ul>

                            <div class="alert alert-warning mt-3">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Nota:</strong> Se ricevi frequentemente errori di timeout, prova ad aumentare il valore. Tuttavia, timeout molto lunghi (>3 minuti) potrebbero indicare problemi con la richiesta stessa o con l'API.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modelli -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingModels">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseModels" aria-expanded="false" aria-controls="collapseModels">
                            <i class="bi bi-robot me-2"></i> Scelta del Modello
                        </button>
                    </h2>
                    <div id="collapseModels" class="accordion-collapse collapse" aria-labelledby="headingModels" data-bs-parent="#parametersGuide">
                        <div class="accordion-body">
                            <h6 class="fw-bold">Guida alla scelta del modello giusto:</h6>
                            <p>Ogni provider offre diversi modelli con caratteristiche specifiche. Ecco come scegliere quello pi√π adatto alle tue esigenze:</p>

                            <h6 class="fw-bold mt-3">Confronto tra provider:</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Provider</th>
                                            <th>Punti di forza</th>
                                            <th>Limitazioni</th>
                                            <th>Ideale per</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>OpenAI</strong></td>
                                            <td>Versatilit√†, bilanciamento, ampia conoscenza generale</td>
                                            <td>Costi pi√π elevati per i modelli pi√π recenti</td>
                                            <td>Uso generale, compiti creativi, analisi varie</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Claude</strong></td>
                                            <td>Eccellente ragionamento, precisione, comprensione di testi lunghi</td>
                                            <td>Meno creativo in alcuni contesti</td>
                                            <td>Analisi approfondite, riassunti di documenti, ragionamento complesso</td>
                                        </tr>
                                        <tr>
                                            <td><strong>DeepSeek</strong></td>
                                            <td>Efficiente, veloce, economico, ottimo per codice</td>
                                            <td>Contesto pi√π limitato, meno preciso per conoscenza generale</td>
                                            <td>Analisi e generazione di codice, documentazione tecnica</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Gemini</strong></td>
                                            <td>Contesto molto lungo, multimodale, buon bilanciamento costo/qualit√†</td>
                                            <td>Prestazioni variabili su compiti specializzati</td>
                                            <td>Analisi di documenti lunghi, generazione di testi estesi</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h6 class="fw-bold mt-4">Casi d'uso specifici:</h6>
                            <div class="row row-cols-1 row-cols-md-2 g-4 mb-3">
                                <div class="col">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">Analisi di documenti tecnici</div>
                                        <div class="card-body">
                                            <p class="fw-medium mb-1">Scelta consigliata:</p>
                                            <ol class="mb-1">
                                                <li>Claude 3 Opus (per documenti molto lunghi)</li>
                                                <li>GPT-4o (per analisi approfondita)</li>
                                                <li>DeepSeek Coder (per documentazione principalmente tecnica)</li>
                                            </ol>
                                            <p class="small text-muted mb-0">Motivazione: I modelli Claude eccellono nell'analisi di testi lunghi, mentre GPT-4o offre un'ottima comprensione tecnica.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">Generazione di contenuti creativi</div>
                                        <div class="card-body">
                                            <p class="fw-medium mb-1">Scelta consigliata:</p>
                                            <ol class="mb-1">
                                                <li>GPT-4o (alta temperatura)</li>
                                                <li>Gemini 1.5 Pro</li>
                                                <li>Claude 3.7 Sonnet</li>
                                            </ol>
                                            <p class="small text-muted mb-0">Motivazione: I modelli OpenAI tendono ad eccellere in compiti creativi, soprattutto con temperature pi√π elevate.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">Analisi di codice e debugging</div>
                                        <div class="card-body">
                                            <p class="fw-medium mb-1">Scelta consigliata:</p>
                                            <ol class="mb-1">
                                                <li>DeepSeek Coder</li>
                                                <li>GPT-4o</li>
                                                <li>Gemini 1.5 Pro</li>
                                            </ol>
                                            <p class="small text-muted mb-0">Motivazione: DeepSeek Coder √® specializzato per codice, mentre GPT-4o ha eccellenti capacit√† di comprensione e debug di codice.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">Uso a basso costo</div>
                                        <div class="card-body">
                                            <p class="fw-medium mb-1">Scelta consigliata:</p>
                                            <ol class="mb-1">
                                                <li>DeepSeek Lite</li>
                                                <li>GPT-3.5 Turbo</li>
                                                <li>Gemini 1.0 Pro</li>
                                            </ol>
                                            <p class="small text-muted mb-0">Motivazione: Questi modelli offrono il miglior rapporto qualit√†/prezzo per compiti quotidiani che non richiedono capacit√† avanzate.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info mt-3">
                                <i class="bi bi-lightbulb-fill me-2"></i>
                                <strong>Consiglio:</strong> Sperimenta con diversi modelli per gli stessi compiti per determinare quale funziona meglio per le tue esigenze specifiche. Le prestazioni possono variare notevolmente in base al tipo di contenuto, lingua e complessit√†.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function checkInitialApiKeys() {
        // Aggiorna il contatore di chiavi iniziali
        const providerIds = {
            'openai': '{{ openai_provider_id|default:"1" }}',
            'claude': '{{ claude_provider_id|default:"2" }}',
            'deepseek': '{{ deepseek_provider_id|default:"3" }}',
            'gemini': '{{ gemini_provider_id|default:"4" }}'
        };

        for (const provider in providerIds) {
            const statusElement = document.getElementById(`${provider}-status`);
            const apiKeyValue = '{{ api_keys.openai_provider_id.api_key|default:"" }}'.replace(/enc_/g, '');

            if (apiKeyValue && apiKeyValue.trim() !== '') {
                statusElement.innerHTML = '<i class="bi bi-check-circle"></i> Configurata';
                statusElement.className = 'badge api-key-status api-key-status-success';
            }
        }

        // Chiama updateApiKeyStatus per aggiornare tutti gli stati
        updateApiKeyStatus();
    }

    // Chiama questa funzione all'avvio
    checkInitialApiKeys();

    // Conteggio chiavi API attive e gestione visibilit√† motori
    function updateApiKeyStatus() {
        // Inizializza contatore
        let activeKeysCount = 0;
        let hasOpenAI = false;
        let hasClaude = false;
        let hasDeepSeek = false;
        let hasGemini = false;

        // Verifica OpenAI
        const openaiKey = document.getElementById('openai-api-key').value;
        const openaiStatus = document.getElementById('openai-status');
        if (openaiKey && openaiKey.trim().startsWith('sk-')) {
            openaiStatus.innerHTML = '<i class="bi bi-check-circle"></i> Configurata';
            openaiStatus.className = 'badge api-key-status api-key-status-success';
            activeKeysCount++;
            hasOpenAI = true;
        } else if (openaiKey && openaiKey.trim() !== '') {
            openaiStatus.innerHTML = '<i class="bi bi-exclamation-circle"></i> Formato non valido';
            openaiStatus.className = 'badge api-key-status api-key-status-danger';
        }

        // Verifica Claude
        const claudeKey = document.getElementById('claude-api-key').value;
        const claudeStatus = document.getElementById('claude-status');
        if (claudeKey && claudeKey.trim().startsWith('sk-ant-')) {
            claudeStatus.innerHTML = '<i class="bi bi-check-circle"></i> Configurata';
            claudeStatus.className = 'badge api-key-status api-key-status-success';
            activeKeysCount++;
            hasClaude = true;
        } else if (claudeKey && claudeKey.trim() !== '') {
            claudeStatus.innerHTML = '<i class="bi bi-exclamation-circle"></i> Formato non valido';
            claudeStatus.className = 'badge api-key-status api-key-status-danger';
        }

        // Verifica DeepSeek
        const deepseekKey = document.getElementById('deepseek-api-key').value;
        const deepseekStatus = document.getElementById('deepseek-status');
        if (deepseekKey && deepseekKey.trim().startsWith('sk-')) {
            deepseekStatus.innerHTML = '<i class="bi bi-check-circle"></i> Configurata';
            deepseekStatus.className = 'badge api-key-status api-key-status-success';
            activeKeysCount++;
            hasDeepSeek = true;
        } else if (deepseekKey && deepseekKey.trim() !== '') {
            deepseekStatus.innerHTML = '<i class="bi bi-exclamation-circle"></i> Formato non valido';
            deepseekStatus.className = 'badge api-key-status api-key-status-danger';
        }

        // Verifica Gemini
        const geminiKey = document.getElementById('gemini-api-key').value;
        const geminiStatus = document.getElementById('gemini-status');
        if (geminiKey && geminiKey.trim().startsWith('AIza')) {
            geminiStatus.innerHTML = '<i class="bi bi-check-circle"></i> Configurata';
            geminiStatus.className = 'badge api-key-status api-key-status-success';
            activeKeysCount++;
            hasGemini = true;
        } else if (geminiKey && geminiKey.trim() !== '') {
            geminiStatus.innerHTML = '<i class="bi bi-exclamation-circle"></i> Formato non valido';
            geminiStatus.className = 'badge api-key-status api-key-status-danger';
        }

        // Aggiorna contatore chiavi
        document.getElementById('active-keys-count').textContent = activeKeysCount;

        // Mostra/nascondi sezioni motori in base alle chiavi presenti
        const engineContainer = document.getElementById('engine-cards-container');
        const emptyState = document.getElementById('empty-engines-state');

        // Sezioni motori
        const openaiSection = document.getElementById('openai-engine-section');
        const claudeSection = document.getElementById('claude-engine-section');
        const deepseekSection = document.getElementById('deepseek-engine-section');
        const geminiSection = document.getElementById('gemini-engine-section');

        // Mostra/nascondi in base alle chiavi
        if (activeKeysCount > 0) {
            engineContainer.style.display = 'flex';
            emptyState.style.display = 'none';

            // Imposta visibilit√† per ciascun motore
            openaiSection.style.display = hasOpenAI ? 'block' : 'none';
            claudeSection.style.display = hasClaude ? 'block' : 'none';
            deepseekSection.style.display = hasDeepSeek ? 'block' : 'none';
            geminiSection.style.display = hasGemini ? 'block' : 'none';
        } else {
            engineContainer.style.display = 'none';
            emptyState.style.display = 'block';
        }

        // Gestisci la visualizzazione dei pannelli di configurazione
        const emptyConfigState = document.getElementById('empty-config-state');
        const configPanels = document.querySelectorAll('.config-panel');

        // Verifica se c'√® almeno un pannello di configurazione attivo
        let hasActivePanel = false;
        configPanels.forEach(panel => {
            if (panel.classList.contains('active')) {
                hasActivePanel = true;

                // Verifica se il panel attivo corrisponde a un motore con chiave valida
                const engineType = panel.id.split('-')[0];
                if ((engineType === 'openai' && !hasOpenAI) ||
                    (engineType === 'claude' && !hasClaude) ||
                    (engineType === 'deepseek' && !hasDeepSeek) ||
                    (engineType === 'gemini' && !hasGemini)) {
                    panel.classList.remove('active');
                    hasActivePanel = false;
                }
            }
        });

        // Mostra/nascondi lo stato vuoto
        emptyConfigState.style.display = hasActivePanel ? 'none' : 'block';
    }

    // Inizializza lo stato del modello visualizzato (per OpenAI)
    const updateModelDisplay = () => {
        const modelSelect = document.getElementById('gpt_model');
        const modelDisplay = document.getElementById('openai-model-display');

        if (modelSelect && modelDisplay) {
            const selectedOption = modelSelect.options[modelSelect.selectedIndex];
            let displayText = '';

            if (selectedOption.value === 'gpt-4o') {
                displayText = '4o';
            } else if (selectedOption.value === 'gpt-4-turbo') {
                displayText = '4 Turbo';
            } else if (selectedOption.value === 'gpt-3.5-turbo') {
                displayText = '3.5 Turbo';
            } else {
                displayText = selectedOption.value.replace('gpt-', '');
            }

            modelDisplay.textContent = displayText;
        }
    };

    // Inizializza la visualizzazione del modello corrente
    updateModelDisplay();

    // Aggiorna la visualizzazione quando il modello cambia
    const gptModelSelect = document.getElementById('gpt_model');
    if (gptModelSelect) {
        gptModelSelect.addEventListener('change', updateModelDisplay);
    }

    // Engine selection
    const engineCards = document.querySelectorAll('.engine-card');
    const configPanels = document.querySelectorAll('.config-panel');

    // Add event listeners to engine selection buttons
    document.querySelectorAll('.select-engine').forEach(button => {
        button.addEventListener('click', function() {
            // Controlla se abbiamo una chiave per questo motore
            const engine = this.getAttribute('data-engine');

            // Verifica chiave valida prima di procedere
            let engineHasKey = false;
            if (engine === 'openai' && document.getElementById('openai-status').classList.contains('api-key-status-success')) {
                engineHasKey = true;
            } else if (engine === 'claude' && document.getElementById('claude-status').classList.contains('api-key-status-success')) {
                engineHasKey = true;
            } else if (engine === 'deepseek' && document.getElementById('deepseek-status').classList.contains('api-key-status-success')) {
                engineHasKey = true;
            } else if (engine === 'gemini' && document.getElementById('gemini-status').classList.contains('api-key-status-success')) {
                engineHasKey = true;
            }

            if (!engineHasKey) {
                showToast(`Impossibile selezionare ${engine}: chiave API mancante o non valida`, 'warning');
                return;
            }

            // Ottieni la versione del modello selezionato
            const modelSelect = document.querySelector(`#${engine}_model`);
            const modelVersion = modelSelect ? modelSelect.value : '';

            // Update UI for selected engine
            engineCards.forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`${engine}-card`).classList.add('selected');

            // Update button styles
            document.querySelectorAll('.select-engine').forEach(btn => {
                if (btn.getAttribute('data-engine') === engine) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-primary');
                    btn.textContent = 'Selezionato';
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                    btn.textContent = 'Seleziona';
                }
            });

            // Show corresponding config panel
            configPanels.forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${engine}-config`).classList.add('active');

            // Nascondi lo stato vuoto della configurazione
            document.getElementById('empty-config-state').style.display = 'none';

            // Update status indicators
            engineCards.forEach(card => {
                const statusSpan = card.querySelector('.fw-medium span');
                if (card.classList.contains('selected')) {
                    statusSpan.textContent = 'Attivo';
                    statusSpan.className = 'text-success';
                } else {
                    statusSpan.textContent = 'Inattivo';
                    statusSpan.className = 'text-secondary';
                }
            });

            // Salva la selezione del motore via AJAX
            const formData = new FormData();
            formData.append('action', 'select_engine');
            formData.append('engine', engine);
            formData.append('model_version', modelVersion);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('{% url "ia_engine" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Motore selezionato: ' + engine, 'success');
                } else {
                    showToast('Errore nella selezione del motore: ' + (data.message || 'Errore sconosciuto'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Errore di comunicazione', 'danger');
            });
        });
    });

    // Range sliders value display
    const updateRangeValue = (inputId, valueId) => {
        const input = document.getElementById(inputId);
        const valueDisplay = document.getElementById(valueId);

        if (input && valueDisplay) {
            input.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
            });
        }
    };

    updateRangeValue('gpt-temperature', 'gpt-temperature-value');
    updateRangeValue('claude-temperature', 'claude-temperature-value');
    updateRangeValue('deepseek-temperature', 'deepseek-temperature-value');
    updateRangeValue('gemini-temperature', 'gemini-temperature-value');

    // Toggle password visibility
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);
            const icon = this.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    });

    // Reset to defaults
    document.getElementById('reset-defaults-btn').addEventListener('click', function() {
        const activeEngine = document.querySelector('.config-panel.active')?.id.split('-')[0];

        if (!activeEngine) {
            showToast("Nessun motore selezionato", "warning");
            return;
        }

        switch(activeEngine) {
            case 'openai':
                document.getElementById('gpt-temperature').value = '0.7';
                document.getElementById('gpt-temperature-value').textContent = '0.7';
                document.getElementById('gpt_max_tokens').value = '4096';
                document.getElementById('gpt_timeout').value = '60';
                document.getElementById('gpt_model').value = 'gpt-3.5-turbo';
                updateModelDisplay(); // Aggiorna la visualizzazione del modello
                break;
            case 'claude':
                document.getElementById('claude-temperature').value = '0.5';
                document.getElementById('claude-temperature-value').textContent = '0.5';
                document.getElementById('claude_max_tokens').value = '4096';
                document.getElementById('claude_timeout').value = '90';
                document.getElementById('claude_model').value = 'claude-3-7-sonnet';
                break;
            case 'deepseek':
                document.getElementById('deepseek-temperature').value = '0.4';
                document.getElementById('deepseek-temperature-value').textContent = '0.4';
                document.getElementById('deepseek_max_tokens').value = '2048';
                document.getElementById('deepseek_timeout').value = '30';
                document.getElementById('deepseek_model').value = 'deepseek-coder';
                break;
            case 'gemini':
                document.getElementById('gemini-temperature').value = '0.7';
                document.getElementById('gemini-temperature-value').textContent = '0.7';
                document.getElementById('gemini_max_tokens').value = '8192';
                document.getElementById('gemini_timeout').value = '60';
                document.getElementById('gemini_model').value = 'gemini-1.5-pro';
                break;
        }

        // Show success toast
        showToast('Valori ripristinati con successo', 'success');
    });

    // Aggiungi listener per input delle chiavi API
    document.querySelectorAll('input[type="password"]').forEach(input => {
        input.addEventListener('input', function() {
            updateApiKeyStatus();
        });
    });
// Gestisci i form di invio delle API key
    document.querySelectorAll('#openai-api-form, #claude-api-form, #deepseek-api-form, #gemini-api-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Ottieni i dati del form
            const formData = new FormData(this);

            // Verifica che la chiave API sia stata fornita
            const apiKey = formData.get('api_key');
            if (!apiKey || apiKey.trim() === '') {
                showToast('Per favore inserisci una chiave API valida', 'warning');
                return;
            }

            // Verifica formato in base al provider
            const providerId = formData.get('provider_id');
            let isValid = true;
            let providerName = '';

            // Determina il provider dal form id
            if (this.id === 'openai-api-form') {
                isValid = apiKey.trim().startsWith('sk-');
                providerName = 'OpenAI';
            } else if (this.id === 'claude-api-form') {
                isValid = apiKey.trim().startsWith('sk-ant-');
                providerName = 'Claude';
            } else if (this.id === 'deepseek-api-form') {
                isValid = apiKey.trim().startsWith('sk-');
                providerName = 'DeepSeek';
            } else if (this.id === 'gemini-api-form') {
                isValid = apiKey.trim().startsWith('AIza');
                providerName = 'Gemini';
            }

            if (!isValid) {
                showToast(`Formato chiave ${providerName} non valido. Verifica e riprova.`, 'warning');
                return;
            }

            // Mostra stato di caricamento
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Salvataggio...';

            // Invia AJAX
            fetch('{% url "ia_engine" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Ripristina bottone
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;

                if (data.success) {
                    showToast(data.message || `Chiave API ${providerName} salvata con successo`, 'success');
                    updateApiKeyStatus();
                } else {
                    showToast(data.message || `Errore nel salvare la chiave API ${providerName}`, 'danger');
                }
            })
            .catch(error => {
                // Ripristina bottone
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;

                console.error('Error:', error);
                showToast(`Errore di comunicazione durante il salvataggio della chiave ${providerName}`, 'danger');
            });
        });
    });

    // Gestione verifica di tutte le chiavi
    document.getElementById('validate-all-keys').addEventListener('click', function() {
        // Mostra stato caricamento
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Verifico le chiavi...';

        // Crea FormData con tutte le chiavi da validare
        const formData = new FormData();
        formData.append('action', 'validate_all_keys');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        // Aggiungi le chiavi presenti
        ['openai', 'claude', 'deepseek', 'gemini'].forEach(provider => {
            const input = document.getElementById(`${provider}-api-key`);
            if (input && input.value.trim() !== '') {
                formData.append(`${provider}_key`, input.value.trim());
            }
        });

        // Invia richiesta
        fetch('{% url "ia_engine" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Ripristina bottone
            btn.disabled = false;
            btn.innerHTML = originalText;

            if (data.success) {
                // Aggiorna gli stati delle chiavi
                if (data.results) {
                    let validCount = 0;
                    let totalCount = 0;

                    for (const [provider, result] of Object.entries(data.results)) {
                        totalCount++;
                        if (result.valid) {
                            validCount++;
                            document.getElementById(`${provider}-status`).innerHTML = '<i class="bi bi-check-circle"></i> Verificata';
                            document.getElementById(`${provider}-status`).className = 'badge api-key-status api-key-status-success';
                        } else {
                            document.getElementById(`${provider}-status`).innerHTML = '<i class="bi bi-x-circle"></i> Non valida';
                            document.getElementById(`${provider}-status`).className = 'badge api-key-status api-key-status-danger';
                        }
                    }

                    showToast(`Verifica completata: ${validCount}/${totalCount} chiavi valide`, validCount === totalCount ? 'success' : 'warning');
                } else {
                    showToast('Verifica completata', 'success');
                }

                updateApiKeyStatus();
            } else {
                showToast(data.message || 'Errore durante la verifica delle chiavi', 'danger');
            }
        })
        .catch(error => {
            // Ripristina bottone
            btn.disabled = false;
            btn.innerHTML = originalText;

            console.error('Error:', error);
            showToast('Errore di comunicazione durante la verifica delle chiavi', 'danger');
        });
    });

    // Toast function
    function showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        // Create toast element
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');

        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Chiudi"></button>
            </div>
        `;

        // Add to container
        toastContainer.appendChild(toastEl);

        // Initialize and show toast
        const toast = new bootstrap.Toast(toastEl, {
            autohide: true,
            delay: 3000
        });
        toast.show();

        // Remove from DOM after hidden
        toastEl.addEventListener('hidden.bs.toast', function() {
            toastEl.remove();
        });
    }

    // Esegui la verifica iniziale dello stato delle chiavi API
    updateApiKeyStatus();
});
</script>
{% endblock %}