{% extends 'be/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* Base Styles */
    .project-header {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Tab Navigation */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 1.5rem;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom: 3px solid #0d6efd;
        background: transparent;
    }

    /* Card Styles */
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        margin-bottom: 1.5rem;
    }

    .card-header {
        background-color: white;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    /* Document Cards */
    .document-card {
        transition: transform 0.2s;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 0.5rem;
        cursor: pointer;
    }

    .document-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
    }

    .document-icon {
        font-size: 2rem;
    }

    .document-icon.pdf { color: #dc3545; }
    .document-icon.doc, .document-icon.docx { color: #0d6efd; }
    .document-icon.xls, .document-icon.xlsx { color: #198754; }
    .document-icon.jpg, .document-icon.jpeg, .document-icon.png, .document-icon.gif { color: #6f42c1; }

    .card-title {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        max-height: 2.4em;
        overflow: hidden;
    }

    /* Chat Interface */
    .chat-messages {
        height: calc(100vh - 170px);
        overflow-y: auto;
        padding-bottom: 20px;
    }

    .user-message {
        background-color: #e9f5ff;
        border-radius: 1rem 1rem 0 1rem;
    }

    .ai-message {
        background-color: #f8f9fa;
        border-radius: 1rem 1rem 1rem 0;
    }

    /* Notes List */
    .note-item {
        border-bottom: 1px solid rgba(0,0,0,0.05);
        transition: background-color 0.2s;
    }

    .note-item:hover {
        background-color: #f8f9fa;
    }

    /* Sources List */
    .source-item {
        border-left: 3px solid #0d6efd;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }

    /* Empty States */
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
    }

    .empty-state i {
        font-size: 2.5rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }

    /* Tab Content Adjustments */
    .tab-content {
        min-height: calc(100vh - 170px);
        padding-bottom: 60px;
    }

    /* Chat Input Fixed */
    .chat-input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 12px 15px;
        z-index: 1000;
        border-top: 1px solid #dee2e6;
    }

    /* Adjust for sidebar on desktop */
    @media (min-width: 992px) {
        .chat-input-container {
            left: 250px;
        }
    }

    .chat-input-wrapper {
        display: flex;
        align-items: center;
        position: relative;
        flex: 1;
    }

    .chat-input-container .form-control {
        border-radius: 20px;
        padding-right: 50px;
        resize: none;
        height: 45px;
        padding-top: 10px;
    }

    .chat-input-container .btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .nav-tabs .nav-link {
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        .chat-input-container {
            padding: 8px 10px;
        }

        .chat-messages {
            height: calc(100vh - 200px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Project Header -->
    <div class="project-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0">{{ project.name }}</h1>
            <a href="{% url 'projects_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Indietro
            </a>
        </div>
        {% if project.description %}
        <p class="text-muted mt-2 mb-0">{{ project.description }}</p>
        {% endif %}
    </div>

    <!-- Aggiungiamo qui il blocco dei messaggi -->
    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="projectTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button">
                <i class="bi bi-files me-1"></i> Documenti
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ask-tab" data-bs-toggle="tab" data-bs-target="#ask" type="button">
                <i class="bi bi-robot me-1"></i> Chiedi all'AI
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button">
                <i class="bi bi-journal-text me-1"></i> Note
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources" type="button">
                <i class="bi bi-file-text me-1"></i> Fonti
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rag-config-tab" data-bs-toggle="tab" data-bs-target="#rag-config" type="button">
                <i class="bi bi-gear me-1"></i> Profilo IA
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content py-3" id="projectTabsContent">
        <!-- Documents Tab -->
        <div class="tab-pane fade show active" id="documents" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Documenti del progetto</h2>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                    <i class="bi bi-plus-lg me-1"></i> Carica
                </button>
            </div>

            {% if project_files %}
            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                {% for file in project_files %}
                <div class="col">
                    <div class="document-card card h-100" data-file-id="{{ file.id }}">
                        <div class="card-body text-center p-3 view-document" data-bs-toggle="modal" data-bs-target="#documentModal"
                             data-file-id="{{ file.id }}" data-file-name="{{ file.filename }}" data-file-size="{{ file.file_size|filesizeformat }}"
                             data-file-path="{% url 'serve_project_file' file.id %}">
                            {% if file.extension == '.pdf' %}
                                <i class="bi bi-file-earmark-pdf document-icon pdf mb-2"></i>
                            {% elif file.extension == '.doc' or file.extension == '.docx' %}
                                <i class="bi bi-file-earmark-word document-icon doc mb-2"></i>
                            {% elif file.extension == '.xls' or file.extension == '.xlsx' %}
                                <i class="bi bi-file-earmark-excel document-icon xls mb-2"></i>
                            {% elif file.extension == '.jpg' or file.extension == '.jpeg' or file.extension == '.png' or file.extension == '.gif' %}
                                <i class="bi bi-file-earmark-image document-icon jpg mb-2"></i>
                            {% else %}
                                <i class="bi bi-file-earmark document-icon mb-2"></i>
                            {% endif %}
                            <div class="card-title text-truncate small">{{ file.filename }}</div>
                            <small class="text-muted d-block">{{ file.file_size|filesizeformat }}</small>
                        </div>
                        <div class="card-footer bg-white border-top-0 py-2 px-3">
                            <button class="btn btn-sm btn-outline-danger w-100 delete-file-btn"
                                    data-file-id="{{ file.id }}" data-file-name="{{ file.filename }}"
                                    data-bs-toggle="modal" data-bs-target="#deleteFileModal">
                                <i class="bi bi-trash"></i> Elimina
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-folder-x"></i>
                <h3>Nessun documento</h3>
                <p class="text-muted">Carica file per iniziare</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                    <i class="bi bi-upload me-1"></i> Carica file
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Ask AI Tab -->
        <div class="tab-pane fade" id="ask" role="tabpanel">
            <div class="mb-4">
                <h2 class="h5 mb-3">Chiedi informazioni sul tuo progetto</h2>

                <!-- Solo l'area messaggi qui - l'input è fuori e fisso in basso -->
                <div class="chat-messages p-3 bg-light rounded" id="chat-messages">
                    {% if conversation_history %}
                        {% for message in conversation_history %}
                        <div class="mb-3 p-3 {% if message.is_user %}user-message ml-auto{% else %}ai-message mr-auto{% endif %}"
                             style="max-width: 80%;">
                            <div class="small fw-bold mb-1">
                                {% if message.is_user %}Tu{% else %}Assistente AI{% endif %}
                            </div>
                            <div>{{ message.content|linebreaks }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state py-4">
                            <i class="bi bi-chat-square-text"></i>
                            <h4>Chiedi qualsiasi cosa</h4>
                            <p class="text-muted">Posso analizzare i tuoi documenti e le tue note</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Input fisso posizionato fuori dai tab, visibile solo quando si è nel tab "Chiedi all'AI" -->
        <div class="chat-input-container" id="fixed-chat-input" style="display: none;">
            <div class="chat-input-wrapper">
                <textarea class="form-control" id="question-input" rows="1"
                          placeholder="Scrivi la tua domanda qui..."></textarea>
                <button id="send-question-btn" class="btn btn-primary">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>

        <!-- Notes Tab -->
        <div class="tab-pane fade" id="notes" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Note del progetto</h2>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                    <i class="bi bi-plus-lg me-1"></i> Aggiungi nota
                </button>
            </div>

            {% if project_notes %}
            <div class="list-group">
                {% for note in project_notes %}
                <div class="list-group-item note-item p-3" data-note-id="{{ note.id }}">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted">{{ note.updated_at|date:"d M Y H:i" }}</small>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1 edit-note-btn"
                                    data-bs-toggle="modal" data-bs-target="#editNoteModal"
                                    data-note-id="{{ note.id }}" data-note-content="{{ note.content }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-note-btn"
                                    data-note-id="{{ note.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="note-content mb-2">{{ note.content }}</div>
                    <div class="form-check form-switch">
                        <input class="form-check-input include-note-check" type="checkbox"
                               id="include-note-{{ note.id }}" data-note-id="{{ note.id }}"
                               {% if note.is_included_in_rag %}checked{% endif %}>
                        <label class="form-check-label small" for="include-note-{{ note.id }}">
                            Includi nella ricerca AI
                        </label>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-journal"></i>
                <h3>Nessuna nota</h3>
                <p class="text-muted">Aggiungi la tua prima nota per iniziare</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                    <i class="bi bi-plus-lg me-1"></i> Aggiungi nota
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Sources Tab -->
        <div class="tab-pane fade" id="sources" role="tabpanel">
            <h2 class="h5 mb-3">Fonti di riferimento AI</h2>

            {% if conversation_history and conversation_history.0.sources %}
            <div class="list-group">
                {% for source in conversation_history.0.sources %}
                <div class="source-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong class="source-title">{{ source.filename|default:"Documento" }}</strong>
                        <small class="text-muted">{{ source.page|default:"" }}</small>
                    </div>
                    <div class="source-content small p-2 bg-light rounded">
                        {{ source.content }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-file-text"></i>
                <h3>Nessuna fonte disponibile</h3>
                <p class="text-muted">Fai una domanda all'AI per vedere le fonti di riferimento</p>
            </div>
            {% endif %}
        </div>

        <!-- Contenuto del tab RAG Config -->
        <div class="tab-pane fade" id="rag-config" role="tabpanel" aria-labelledby="rag-config-tab">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Configurazione del Profilo IA Corrente</h5>
                </div>
                <div class="card-body">
                    <!-- Profilo Corrente -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2">Profilo Attivo</h6>
                        {% if current_preset %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="badge bg-primary me-2">{{ current_preset.template_type.name }}</div>
                            <h5 class="mb-0">{{ current_preset.name }}</h5>
                        </div>
                        <p class="text-muted">{{ current_preset.description }}</p>
                        {% else %}
                        <p class="text-muted">Nessun profilo selezionato. Vengono usati i valori predefiniti di sistema.</p>
                        {% endif %}

                        <div class="d-flex mt-2">
                            <a href="{% url 'rag_settings' %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-sliders me-1"></i> Modifica Configurazione
                            </a>
                        </div>
                    </div>

                    <!-- Parametri in uso -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2">Parametri di Indicizzazione</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless">
                                    <tbody>
                                        <tr>
                                            <td class="text-muted">Dimensione chunk:</td>
                                            <td class="fw-medium">
                                                {{ rag_values.chunk_size }}
                                                {% if 'chunk_size' in customized_values %}
                                                <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Sovrapposizione chunk:</td>
                                            <td class="fw-medium">
                                                {{ rag_values.chunk_overlap }}
                                                {% if 'chunk_overlap' in customized_values %}
                                                <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6 class="border-bottom pb-2">Parametri di Ricerca</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless">
                                    <tbody>
                                        <tr>
                                            <td class="text-muted">Top K risultati:</td>
                                            <td class="fw-medium">
                                                {{ rag_values.similarity_top_k }}
                                                {% if 'similarity_top_k' in customized_values %}
                                                <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Lambda MMR:</td>
                                            <td class="fw-medium">
                                                {{ rag_values.mmr_lambda }}
                                                {% if 'mmr_lambda' in customized_values %}
                                                <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Soglia similarità:</td>
                                            <td class="fw-medium">
                                                {{ rag_values.similarity_threshold }}
                                                {% if 'similarity_threshold' in customized_values %}
                                                <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Tipo retriever:</td>
                                            <td class="fw-medium">
                                                {{ rag_values.retriever_type }}
                                                {% if 'retriever_type' in customized_values %}
                                                <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6 class="border-bottom pb-2">Comportamento IA</h6>
                        <div class="row">
                            <div class="col-12">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 ps-0">
                                        <span>Citazioni automatiche</span>
                                        <span>
                                            {% if rag_values.auto_citation %}
                                            <span class="badge bg-success">Attivo</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Disattivo</span>
                                            {% endif %}
                                            {% if 'auto_citation' in customized_values %}
                                            <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                            {% endif %}
                                        </span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 ps-0">
                                        <span>Priorità ai nomi file</span>
                                        <span>
                                            {% if rag_values.prioritize_filenames %}
                                            <span class="badge bg-success">Attivo</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Disattivo</span>
                                            {% endif %}
                                            {% if 'prioritize_filenames' in customized_values %}
                                            <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                            {% endif %}
                                        </span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 ps-0">
                                        <span>Uguale peso note/documenti</span>
                                        <span>
                                            {% if rag_values.equal_notes_weight %}
                                            <span class="badge bg-success">Attivo</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Disattivo</span>
                                            {% endif %}
                                            {% if 'equal_notes_weight' in customized_values %}
                                            <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                            {% endif %}
                                        </span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 ps-0">
                                        <span>Modo rigoroso (solo contesto)</span>
                                        <span>
                                            {% if rag_values.strict_context %}
                                            <span class="badge bg-success">Attivo</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Disattivo</span>
                                            {% endif %}
                                            {% if 'strict_context' in customized_values %}
                                            <span class="badge bg-info ms-1" title="Personalizzato">P</span>
                                            {% endif %}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        I parametri contrassegnati con <span class="badge bg-info">P</span> sono personalizzati dall'utente
                        e sovrascrivono quelli del profilo selezionato.
                    </div>
                </div>
            </div>
        </div>

    </div>

<!--    &lt;!&ndash; Danger Zone &ndash;&gt;-->
<!--    <div class="mt-4 pt-3 border-top text-end">-->
<!--        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">-->
<!--            <i class="bi bi-trash me-1"></i> Elimina progetto-->
<!--        </button>-->
<!--    </div>-->
</div>

<!-- Include Modals -->
{% include 'be/project_modals.html' %}
{% endblock %}



{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Persistenza del tab attivo
    const triggerTabList = document.querySelectorAll('#projectTabs button');
    const activeTab = document.querySelector('#projectTabs button.active');
    if (activeTab && activeTab.getAttribute('data-bs-target') === '#ask') {
        document.getElementById('fixed-chat-input').style.display = 'block';
    }

    // Gestione della visibilità dell'input fisso in base al tab attivo
    document.querySelectorAll('#projectTabs button').forEach(tabButton => {
        tabButton.addEventListener('shown.bs.tab', function(event) {
            const targetTab = event.target.getAttribute('data-bs-target');
            const fixedInput = document.getElementById('fixed-chat-input');
            fixedInput.style.display = targetTab === '#ask' ? 'block' : 'none';
        });
    });

    // Salva il tab attivo nel localStorage
    triggerTabList.forEach(tabEl => {
        tabEl.addEventListener('shown.bs.tab', function(event) {
            localStorage.setItem('activeProjectTab', event.target.getAttribute('data-bs-target'));
        });
    });

    // Gestione delle azioni dei form
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        if (!form.getAttribute('action')) {
            form.setAttribute('action', '{% url "project" project.id %}');
        }
    });

    // Modal per la visualizzazione dei documenti
    const documentModal = document.getElementById('documentModal');
    if (documentModal) {
        documentModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const fileId = button.getAttribute('data-file-id');
            const fileName = button.getAttribute('data-file-name');
            const fileSize = button.getAttribute('data-file-size');
            const filePath = button.getAttribute('data-file-path');

            // Imposta i dettagli del documento
            document.getElementById('document-filename').textContent = fileName;
            document.getElementById('document-filesize').textContent = fileSize || '';

            // Imposta gli URL per le azioni
            const openDocumentLink = document.getElementById('open-document');
            const downloadDocumentLink = document.getElementById('download-document');

            if (openDocumentLink) openDocumentLink.href = filePath;
            if (downloadDocumentLink) downloadDocumentLink.href = filePath + '?download=1';

            // Determina il tipo di file
            const fileExtension = fileName.split('.').pop().toLowerCase();

            // Reset dei container
            const iframeContainer = document.getElementById('iframe-container');
            const imageContainer = document.getElementById('image-container');
            const unsupportedContainer = document.getElementById('unsupported-file-message');
            const documentFrame = document.getElementById('document-frame');
            const imagePreview = document.getElementById('image-preview');

            iframeContainer.style.display = 'none';
            imageContainer.style.display = 'none';
            unsupportedContainer.style.display = 'none';

            // Mostra l'anteprima appropriata
            if (fileExtension === 'pdf') {
                documentFrame.src = filePath;
                documentFrame.style.display = 'block';
                iframeContainer.style.display = 'block';
            }
            else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                imagePreview.src = filePath;
                imageContainer.style.display = 'block';
            }
            else {
                unsupportedContainer.style.display = 'block';
            }
        });
    }

    // Modal per l'eliminazione dei file
    const deleteFileModal = document.getElementById('deleteFileModal');
    if (deleteFileModal) {
        deleteFileModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const fileId = button.getAttribute('data-file-id');
            const fileName = button.getAttribute('data-file-name');

            document.getElementById('delete-file-id').value = fileId;
            document.getElementById('delete-file-name').textContent = fileName;
        });

        // Gestione del form di eliminazione
        const deleteFileForm = document.getElementById('delete-file-form');
        if (deleteFileForm) {
            deleteFileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const fileId = document.getElementById('delete-file-id').value;

                fetch('{% url "project" project.id %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'action': 'delete_file',
                        'project_id': '{{ project.id }}',
                        'file_id': fileId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    })
                })
                .then(response => {
                    const modal = bootstrap.Modal.getInstance(deleteFileModal);
                    modal.hide();

                    const fileCard = document.querySelector(`.document-card[data-file-id="${fileId}"]`);
                    if (fileCard) {
                        fileCard.closest('.col').remove();
                    }

                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <strong>Successo!</strong> File eliminato correttamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.project-header').after(alertDiv);

                    setTimeout(() => alertDiv.remove(), 3000);

                    if (document.querySelectorAll('.document-card').length === 0) {
                        const documentsTab = document.getElementById('documents');
                        if (documentsTab) {
                            documentsTab.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h2 class="h5 mb-0">Documenti del progetto</h2>
                                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                                        <i class="bi bi-plus-lg me-1"></i> Carica
                                    </button>
                                </div>
                                <div class="empty-state">
                                    <i class="bi bi-folder-x"></i>
                                    <h3>Nessun documento</h3>
                                    <p class="text-muted">Carica file per iniziare</p>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFilesModal">
                                        <i class="bi bi-upload me-1"></i> Carica file
                                    </button>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    alert('Errore durante l\'eliminazione del file. Riprova più tardi.');
                });
            });
        }
    }

    // Modal per la modifica delle note
    const editNoteModal = document.getElementById('editNoteModal');
    if (editNoteModal) {
        editNoteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const noteId = button.getAttribute('data-note-id');
            const noteContent = button.getAttribute('data-note-content');

            document.getElementById('edit-note-id').value = noteId;
            document.getElementById('edit-note-content').value = noteContent;
        });
    }

    // Form per l'aggiunta di note
    const addNoteForm = document.getElementById('add-note-form');
    if (addNoteForm) {
        addNoteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const content = document.getElementById('note-content').value.trim();
            if (!content) return;

            fetch('{% url "project" project.id %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'action': 'add_note',
                    'project_id': '{{ project.id }}',
                    'content': content,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
                    modal.hide();
                    window.location.reload();
                } else {
                    alert('Errore: ' + (data.error || 'Impossibile aggiungere la nota'));
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di rete. Riprova più tardi.');
            });
        });
    }

    // Funzionalità di chat con l'AI
    const sendButton = document.getElementById('send-question-btn');
    const questionInput = document.getElementById('question-input');
    const chatMessages = document.getElementById('chat-messages');

    if (sendButton && questionInput) {
        sendButton.addEventListener('click', sendQuestion);
        questionInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuestion();
            }
        });

        function sendQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            // Aggiunge il messaggio dell'utente
            const userMsg = document.createElement('div');
            userMsg.className = 'mb-3 p-3 user-message ml-auto';
            userMsg.style.maxWidth = '80%';
            userMsg.innerHTML = `
                <div class="small fw-bold mb-1">Tu</div>
                <div>${question.replace(/\n/g, '<br>')}</div>
            `;
            chatMessages.appendChild(userMsg);

            // Reset input
            questionInput.value = '';
            questionInput.disabled = true;
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            // Scroll automatico
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Timeout per la richiesta
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 30000);

            fetch('{% url "project" project.id %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'action': 'ask_question',
                    'project_id': '{{ project.id }}',
                    'question': question,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }),
                signal: controller.signal
            })
            .then(response => {
                if (!response.ok) throw new Error(`Errore HTTP! Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Aggiunge la risposta dell'AI
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'mb-3 p-3 ai-message mr-auto';
                    aiMsg.style.maxWidth = '80%';
                    aiMsg.innerHTML = `
                        <div class="small fw-bold mb-1">Assistente AI</div>
                        <div>${data.answer.replace(/\n/g, '<br>')}</div>
                    `;
                    chatMessages.appendChild(aiMsg);

                    // Aggiorna le fonti se presenti
                    if (data.sources && data.sources.length > 0) {
                        updateSourcesTab(data.sources);
                    }
                } else if (data.error === "api_auth_error") {
                    // Gestione specifica dell'errore di autenticazione API
                    showApiAuthErrorMessage();
                } else {
                    throw new Error(data.error || 'Errore sconosciuto dal server');
                }
            })
            .catch(error => {
                // Gestione errori: verifica se è un errore di autenticazione API
                if (error.message && (error.message.includes('invalid_api_key') ||
                                     error.message.includes('authentication') ||
                                     error.message.includes('api_auth_error'))) {
                    showApiAuthErrorMessage();
                } else {
                    // Altri tipi di errore
                    showError(`Errore: ${error.message}`);
                }
            })
            .finally(() => {
                // Ripristina sempre lo stato iniziale
                questionInput.disabled = false;
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="bi bi-send"></i>';
                chatMessages.scrollTop = chatMessages.scrollHeight;
                clearTimeout(timeout);
            });
        }

        function showApiAuthErrorMessage() {
            // Crea una risposta di errore dell'AI con avviso e suggerimento di azione
            const errorMsg = document.createElement('div');
            errorMsg.className = 'mb-3 p-3 ai-message mr-auto';
            errorMsg.style.maxWidth = '80%';

            errorMsg.innerHTML = `
                <div class="small fw-bold mb-1">Assistente AI</div>
                <div class="alert alert-danger mb-2">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Problema con le chiavi API</strong>
                </div>
                <p>Non è stato possibile contattare il servizio AI a causa di un errore di autenticazione.</p>
                <div class="alert alert-light border">
                    <h6 class="mb-2"><i class="bi bi-wrench me-1"></i> Come risolvere:</h6>
                    <ol class="mb-2">
                        <li>Vai alle <a href="{% url 'ia_engine' %}" class="fw-medium">Impostazioni del Motore IA</a></li>
                        <li>Verifica che le chiavi API siano corrette</li>
                        <li>Oppure passa alla modalità "Usa credito piattaforma"</li>
                    </ol>
                </div>
            `;

            chatMessages.appendChild(errorMsg);

            // Mostra anche una notifica Toast per attirare l'attenzione
            showErrorToast('Errore di autenticazione API', 'Controlla le tue chiavi API nelle impostazioni del motore IA');
        }

        function showError(message) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'mb-3 p-3 ai-message mr-auto';
            errorMsg.style.maxWidth = '80%';
            errorMsg.innerHTML = `
                <div class="small fw-bold mb-1">Assistente AI</div>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                </div>
            `;
            chatMessages.appendChild(errorMsg);
        }

        function showErrorToast(title, message) {
            // Crea un toast di errore persistente
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '1080';

            const toastEl = document.createElement('div');
            toastEl.className = 'toast show';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');

            toastEl.innerHTML = `
                <div class="toast-header bg-danger text-white">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Chiudi"></button>
                </div>
                <div class="toast-body">
                    ${message}
                    <div class="mt-2 pt-2 border-top">
                        <a href="{% url 'ia_engine' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-gear me-1"></i> Vai alle impostazioni
                        </a>
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="toast">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;

            toastContainer.appendChild(toastEl);
            document.body.appendChild(toastContainer);

            // Rimuovi il toast dopo 10 secondi
            setTimeout(() => {
                toastContainer.remove();
            }, 10000);
        }
    }

    // Aggiorna il tab delle fonti
    function updateSourcesTab(sources) {
        const sourcesTab = document.getElementById('sources');
        if (!sourcesTab) return;

        let sourcesHTML = `
            <h2 class="h5 mb-3">Fonti di riferimento AI</h2>
            <div class="list-group">
        `;

        sources.forEach(source => {
            sourcesHTML += `
                <div class="source-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong class="source-title">${source.filename || 'Documento'}</strong>
                        <small class="text-muted">${source.metadata && source.metadata.page ? 'Pag. ' + (source.metadata.page + 1) : ''}</small>
                    </div>
                    <div class="source-content small p-2 bg-light rounded">
                        ${source.content}
                    </div>
                </div>
            `;
        });

        sourcesHTML += `</div>`;
        sourcesTab.innerHTML = sourcesHTML;

        const sourcesTabButton = document.getElementById('sources-tab');
        if (sourcesTabButton) {
            if (!sourcesTabButton.querySelector('.badge')) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary ms-1';
                badge.textContent = sources.length;
                sourcesTabButton.appendChild(badge);
            } else {
                sourcesTabButton.querySelector('.badge').textContent = sources.length;
            }
        }
    }

    // Gestione eliminazione note
    document.querySelectorAll('.delete-note-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Eliminare questa nota?')) {
                const noteId = this.getAttribute('data-note-id');
                fetch('{% url "project" project.id %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'action': 'delete_note',
                        'project_id': '{{ project.id }}',
                        'note_id': noteId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`.note-item[data-note-id="${noteId}"]`).remove();
                    } else {
                        alert('Errore: ' + (data.error || 'Impossibile eliminare la nota'));
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    alert('Errore di rete. Riprova più tardi.');
                });
            }
        });
    });

    // Toggle per l'inclusione delle note nella ricerca AI
    document.querySelectorAll('.include-note-check').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const noteId = this.getAttribute('data-note-id');
            const isIncluded = this.checked;

            fetch('{% url "project" project.id %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'action': 'toggle_note_inclusion',
                    'project_id': '{{ project.id }}',
                    'note_id': noteId,
                    'is_included': isIncluded,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                })
            })
            .catch(error => {
                console.error('Errore:', error);
                this.checked = !isIncluded;
            });
        });
    });

    // Gestione hash URL per l'apertura automatica dei tab
    if (window.location.hash) {
        const hash = window.location.hash.substring(1);
        const tabEl = document.querySelector(`button[data-bs-target="#${hash}"]`);
        if (tabEl) {
            setTimeout(() => {
                new bootstrap.Tab(tabEl).show();
            }, 100);
        }
    }
});
</script>
{% endblock %}