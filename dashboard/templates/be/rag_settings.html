{% extends 'be/base.html' %}
{% load custom_filter %}
{% load static %}

{% block extra_css %}
<style>
    .config-card {
        border-radius: 0.75rem;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        transition: all 0.2s;
        overflow: hidden;
    }

    .config-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }

    .config-header {
        background-color: rgba(13, 110, 253, 0.05);
        padding: 1.25rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .param-row {
        margin-bottom: 1.25rem;
        padding-bottom: 1.25rem;
        border-bottom: 1px dashed rgba(0,0,0,0.1);
    }

    .param-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .param-label {
        font-weight: 500;
        color: #495057;
    }

    .param-help {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .preset-badge {
        position: absolute;
        right: -10px;
        top: -10px;
        background-color: #0d6efd;
        color: white;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: scale(0);
        transition: transform 0.3s ease;
    }

    .preset-card.selected .preset-badge {
        transform: scale(1);
    }

    .preset-card {
        transition: all 0.2s;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 0.5rem;
        position: relative;
        overflow: hidden;
    }

    .preset-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }

    .preset-card.selected {
        border: 2px solid #0d6efd;
        box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.15);
    }

    .preset-header {
        padding: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .preset-body {
        padding: 1.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h1 class="mb-0 h4">Configurazione Parametri RAG</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                    <li class="breadcrumb-item">Impostazioni</li>
                    <li class="breadcrumb-item active">Parametri RAG</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- General Information Card -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Parametri di Retrieval Augmented Generation</h5>
            <p>Configura i parametri del sistema RAG che influenzano come l'intelligenza artificiale cerca e utilizza informazioni dai tuoi documenti per rispondere alle domande.</p>
            <div class="alert alert-info d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                <div>
                    La configurazione RAG influisce sulla qualità e precisione delle risposte, sulla quantità di contesto utilizzato e sulla velocità di elaborazione. Ottimizza questi parametri in base al tipo di documenti e domande del tuo progetto.
                </div>
            </div>
        </div>
    </div>

    <!-- Preset Configurations -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Configurazioni Preimpostate</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">Scegli una configurazione preimpostata o personalizza i parametri singolarmente nella sezione sottostante.</p>

            <!-- Template type tabs -->
            <ul class="nav nav-tabs mb-4" id="presetTabs" role="tablist">
                {% for template_type in template_types %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if template_type.name == current_template %}active{% endif %}"
                            id="tab-{{ template_type.name|slugify }}"
                            data-bs-toggle="tab"
                            data-bs-target="#content-{{ template_type.name|slugify }}"
                            type="button"
                            role="tab"
                            aria-controls="content-{{ template_type.name|slugify }}"
                            aria-selected="{% if template_type.name == current_template %}true{% else %}false{% endif %}">
                        {{ template_type.name }}
                    </button>
                </li>
                {% endfor %}
            </ul>

            <!-- Template type tab contents -->
            <div class="tab-content" id="presetTabContent">
                {% for template_type in template_types %}
                <div class="tab-pane fade {% if template_type.name == current_template %}show active{% endif %}"
                     id="content-{{ template_type.name|slugify }}"
                     role="tabpanel"
                     aria-labelledby="tab-{{ template_type.name|slugify }}">

                    <div class="row row-cols-1 row-cols-md-3 g-4">
                        {% for preset in template_settings|get_item:template_type.name %}
                        <div class="col">
                            <div class="card h-100 preset-card {% if preset.id == current_preset_id %}selected{% endif %}" id="preset-{{ preset.id }}">
                                <div class="preset-badge">
                                    <i class="bi bi-check-lg"></i>
                                </div>
                                <div class="preset-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">{{ preset.name }}</h5>
                                        {% if preset.is_default %}
                                        <span class="badge bg-primary">Predefinito</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="preset-body">
                                    <p class="card-text">{{ preset.description }}</p>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="fw-medium">Dimensione chunk:</span>
                                            <span>{{ preset.chunk_size }} caratteri</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="fw-medium">Sovrapposizione:</span>
                                            <span>{{ preset.chunk_overlap }} caratteri</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="fw-medium">Top K risultati:</span>
                                            <span>{{ preset.similarity_top_k }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="fw-medium">Similarità minima:</span>
                                            <span>{{ preset.similarity_threshold }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent text-center">
                                    <form method="post" class="select-preset-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="select_preset">
                                        <input type="hidden" name="preset_id" value="{{ preset.id }}">
                                        <button type="submit" class="btn {% if preset.id == current_preset_id %}btn-primary{% else %}btn-outline-primary{% endif %} select-preset">
                                            {% if preset.id == current_preset_id %}Selezionato{% else %}Seleziona{% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-warning">
                                Nessuna configurazione predefinita disponibile per questo tipo di template.
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Parameters Configuration -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Configurazione Personalizzata</h5>
        </div>
        <div class="card-body">
            <form id="rag-params-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="save_settings">

                <!-- Chunk Size -->
                <div class="row param-row align-items-center">
                    <div class="col-md-3">
                        <label for="chunk-size" class="param-label">Dimensione Chunk</label>
                        <input type="range" class="form-range" id="chunk-size" name="chunk_size" min="100" max="1000" step="50" value="{{ current_values.chunk_size }}">
                        <div class="d-flex justify-content-between">
                            <span class="small">100</span>
                            <span class="small fw-bold" id="chunk-size-value">{{ current_values.chunk_size }}</span>
                            <span class="small">1000</span>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <p class="param-help mb-0">
                            <i class="bi bi-info-circle me-1"></i>
                            Determina la lunghezza di ciascun frammento di testo in caratteri. Valori più piccoli creano più frammenti dettagliati ma aumentano il tempo di elaborazione.
                        </p>
                        <div class="mt-2">
                            <span class="badge bg-info me-2">Documenti brevi: 300-400</span>
                            <span class="badge bg-success me-2">Bilanciato: 500</span>
                            <span class="badge bg-warning">Documenti lunghi: 800-1000</span>
                        </div>
                    </div>
                </div>

                <!-- Chunk Overlap -->
                <div class="row param-row align-items-center">
                    <div class="col-md-3">
                        <label for="chunk-overlap" class="param-label">Sovrapposizione Chunk</label>
                        <input type="range" class="form-range" id="chunk-overlap" name="chunk_overlap" min="0" max="200" step="10" value="{{ current_values.chunk_overlap }}">
                        <div class="d-flex justify-content-between">
                            <span class="small">0</span>
                            <span class="small fw-bold" id="chunk-overlap-value">{{ current_values.chunk_overlap }}</span>
                            <span class="small">200</span>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <p class="param-help mb-0">
                            <i class="bi bi-info-circle me-1"></i>
                            Controlla quanti caratteri si sovrappongono tra chunk adiacenti. Una maggiore sovrapposizione aiuta a mantenere il contesto ma aumenta il numero di chunk.
                        </p>
                        <div class="mt-2">
                            <span class="badge bg-warning me-2">Minima: 0-20</span>
                            <span class="badge bg-success me-2">Standard: 50</span>
                            <span class="badge bg-info">Alta: 100-200</span>
                        </div>
                    </div>
                </div>

                <!-- Top K Results -->
                <div class="row param-row align-items-center">
                    <div class="col-md-3">
                        <label for="similarity-top-k" class="param-label">Top K Risultati</label>
                        <input type="range" class="form-range" id="similarity-top-k" name="similarity_top_k" min="2" max="15" step="1" value="{{ current_values.similarity_top_k }}">
                        <div class="d-flex justify-content-between">
                            <span class="small">2</span>
                            <span class="small fw-bold" id="similarity-top-k-value">{{ current_values.similarity_top_k }}</span>
                            <span class="small">15</span>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <p class="param-help mb-0">
                            <i class="bi bi-info-circle me-1"></i>
                            Numero di frammenti di testo più rilevanti da utilizzare per generare la risposta. Valori più alti includono più contesto ma possono diluire la rilevanza.
                        </p>
                        <div class="mt-2">
                            <span class="badge bg-warning me-2">Minimo: 2-3</span>
                            <span class="badge bg-success me-2">Standard: 4-6</span>
                            <span class="badge bg-info">Massimo: 8-15</span>
                        </div>
                    </div>
                </div>

                <!-- MMR Lambda -->
                <div class="row param-row align-items-center">
                    <div class="col-md-3">
                        <label for="mmr-lambda" class="param-label">Valore Lambda MMR</label>
                        <input type="range" class="form-range" id="mmr-lambda" name="mmr_lambda" min="0" max="1" step="0.05" value="{{ current_values.mmr_lambda }}">
                        <div class="d-flex justify-content-between">
                            <span class="small">0</span>
                            <span class="small fw-bold" id="mmr-lambda-value">{{ current_values.mmr_lambda }}</span>
                            <span class="small">1</span>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <p class="param-help mb-0">
                            <i class="bi bi-info-circle me-1"></i>
                            Controlla il bilanciamento tra rilevanza e diversità dei risultati. Valori più alti (verso 1) favoriscono la rilevanza, valori più bassi (verso 0) favoriscono la diversità.
                        </p>
                        <div class="mt-2">
                            <span class="badge bg-info me-2">Diversità: 0.3-0.5</span>
                            <span class="badge bg-success me-2">Bilanciato: 0.7</span>
                            <span class="badge bg-warning">Rilevanza: 0.8-1.0</span>
                        </div>
                    </div>
                </div>

                <!-- Similarity Threshold -->
                <div class="row param-row align-items-center">
                    <div class="col-md-3">
                        <label for="similarity-threshold" class="param-label">Soglia di Similarità</label>
                        <input type="range" class="form-range" id="similarity-threshold" name="similarity_threshold" min="0" max="1" step="0.05" value="{{ current_values.similarity_threshold }}">
                        <div class="d-flex justify-content-between">
                            <span class="small">0</span>
                            <span class="small fw-bold" id="similarity-threshold-value">{{ current_values.similarity_threshold }}</span>
                            <span class="small">1</span>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <p class="param-help mb-0">
                            <i class="bi bi-info-circle me-1"></i>
                            Imposta la soglia minima di rilevanza per includere un frammento nelle risposte. Valori più alti sono più selettivi, solo i frammenti più rilevanti vengono inclusi.
                        </p>
                        <div class="mt-2">
                            <span class="badge bg-warning me-2">Bassa: 0.4-0.5</span>
                            <span class="badge bg-success me-2">Media: 0.7</span>
                            <span class="badge bg-info">Alta: 0.8-0.9</span>
                        </div>
                    </div>
                </div>

                <!-- Retriever Type -->
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="retriever-type" class="param-label">Tipo di Retriever</label>
                        <select class="form-select" id="retriever-type" name="retriever_type">
                            <option value="mmr" {% if current_values.retriever_type == 'mmr' %}selected{% endif %}>MMR (Maximum Marginal Relevance)</option>
                            <option value="similarity" {% if current_values.retriever_type == 'similarity' %}selected{% endif %}>Similarity Search</option>
                            <option value="similarity_score_threshold" {% if current_values.retriever_type == 'similarity_score_threshold' %}selected{% endif %}>Similarity with Threshold</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <p class="param-help mb-0">
                            <i class="bi bi-info-circle me-1"></i>
                            Definisce la strategia di ricerca utilizzata per trovare i frammenti di testo più rilevanti.
                        </p>
                        <div class="mt-2">
                            <span class="badge bg-success me-2">MMR: Bilancia rilevanza e diversità</span>
                            <span class="badge bg-primary me-2">Similarity: Solo i più rilevanti</span>
                            <span class="badge bg-info">Threshold: Filtra per rilevanza minima</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="card-footer d-flex justify-content-between">
            <button class="btn btn-outline-secondary" id="reset-defaults-btn">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Ripristina predefiniti
            </button>
            <button class="btn btn-primary" id="save-settings-btn">
                <i class="bi bi-save me-1"></i> Salva configurazione
            </button>
        </div>
    </div>

    <!-- Advanced Prompt Settings -->
    <div class="card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="card-title mb-0">Impostazioni Avanzate dei Prompt</h5>
            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedPromptSettings">
                <i class="bi bi-sliders me-1"></i> Mostra/Nascondi
            </button>
        </div>
        <div class="collapse" id="advancedPromptSettings">
            <div class="card-body">
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                    <div>
                        Queste impostazioni avanzate influenzano il modo in cui l'IA interpreta e utilizza i documenti. Modifiche imprudenti possono ridurre la qualità delle risposte.
                    </div>
                </div>

                <form id="advanced-prompt-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_advanced_settings">

                    <div class="mb-4">
                        <label for="system-prompt" class="form-label fw-medium">Prompt di Sistema</label>
                        <textarea class="form-control" id="system-prompt" name="system_prompt" rows="6">{{ current_values.system_prompt }}</textarea>
                        <div class="form-text">
                            Istruzioni di base che guidano l'IA nell'elaborazione dei documenti e nella generazione di risposte.
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto-citation" name="auto_citation" {% if current_values.auto_citation %}checked{% endif %}>
                                <label class="form-check-label" for="auto-citation">
                                    <strong>Citazione automatica</strong>
                                </label>
                            </div>
                            <p class="form-text">Includi riferimenti alle fonti nelle risposte (es. documenti o note specifiche)</p>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="prioritize-filenames" name="prioritize_filenames" {% if current_values.prioritize_filenames %}checked{% endif %}>
                                <label class="form-check-label" for="prioritize-filenames">
                                    <strong>Priorità nomi file</strong>
                                </label>
                            </div>
                            <p class="form-text">Dai priorità ai documenti con nomi menzionati nella domanda</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="equal-notes-weight" name="equal_notes_weight" {% if current_values.equal_notes_weight %}checked{% endif %}>
                                <label class="form-check-label" for="equal-notes-weight">
                                    <strong>Stesso peso note/documenti</strong>
                                </label>
                            </div>
                            <p class="form-text">Tratta note e documenti con uguale importanza nelle risposte</p>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="strict-context" name="strict_context" {% if current_values.strict_context %}checked{% endif %}>
                                <label class="form-check-label" for="strict-context">
                                    <strong>Modo rigoroso</strong>
                                </label>
                            </div>
                            <p class="form-text">Risposte basate SOLO sui documenti (rifiuta di rispondere se mancano informazioni)</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card-footer text-end">
                <button class="btn btn-primary" id="save-advanced-btn">
                    <i class="bi bi-save me-1"></i> Salva impostazioni avanzate
                </button>
            </div>
        </div>
    </div>

    <!-- Usage Information -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Guida ai Parametri RAG</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <h6 class="alert-heading"><i class="bi bi-info-circle-fill me-2"></i>Ottimizzazione dei parametri</h6>
                <hr>

                <p class="mb-2"><strong>Per documenti tecnici o molto specifici:</strong></p>
                <ul class="mb-3">
                    <li>Riduci la dimensione dei chunk (300-400 caratteri)</li>
                    <li>Aumenta la sovrapposizione dei chunk (80-100 caratteri)</li>
                    <li>Imposta una soglia di similarità più alta (0.7-0.8)</li>
                    <li>Usa un valore lambda MMR più alto (0.8-0.9) per favorire la rilevanza</li>
                </ul>

                <p class="mb-2"><strong>Per documenti narrativi o meno strutturati:</strong></p>
                <ul class="mb-3">
                    <li>Aumenta la dimensione dei chunk (700-900 caratteri)</li>
                    <li>Mantieni una sovrapposizione media (50-70 caratteri)</li>
                    <li>Abbassa leggermente la soglia di similarità (0.5-0.6)</li>
                    <li>Usa un valore lambda MMR più basso (0.5-0.7) per favorire la diversità</li>
                </ul>

                <p class="mb-2"><strong>Per progetti con molti documenti:</strong></p>
                <ul class="mb-0">
                    <li>Aumenta il numero di risultati Top K (8-12)</li>
                    <li>Usa MMR con un valore lambda medio (0.5-0.7)</li>
                    <li>Imposta una soglia di similarità più alta (0.6-0.7) per filtrare risultati meno rilevanti</li>
                    <li>Considera chunk più grandi (600-800 caratteri) per ridurre il numero totale di frammenti</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Funzione per ottenere elementi di un dizionario per Django template
        // (Questa funzionalità sarebbe implementata come template filter in Django)
        // Per il template reale, dovresti creare un filtro personalizzato in Django

        // Gestisci i valori visualizzati per i range slider
        function updateRangeValue(inputId, valueId) {
            const input = document.getElementById(inputId);
            const valueDisplay = document.getElementById(valueId);

            input.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
            });
        }

        // Inizializza gli slider con i valori corretti
        updateRangeValue('chunk-size', 'chunk-size-value');
        updateRangeValue('chunk-overlap', 'chunk-overlap-value');
        updateRangeValue('similarity-top-k', 'similarity-top-k-value');
        updateRangeValue('mmr-lambda', 'mmr-lambda-value');
        updateRangeValue('similarity-threshold', 'similarity-threshold-value');

        // Gestisci le form per selezionare i preset
        const presetForms = document.querySelectorAll('.select-preset-form');
        presetForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                // Mostra indicatore di caricamento
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Caricamento...';

                // Invia richiesta AJAX
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Rimuovi la selezione da tutte le card
                        document.querySelectorAll('.preset-card').forEach(card => {
                            card.classList.remove('selected');
                            const btn = card.querySelector('.select-preset');
                            if (btn) {
                                btn.classList.remove('btn-primary');
                                btn.classList.add('btn-outline-primary');
                                btn.textContent = 'Seleziona';
                            }
                        });

                        // Seleziona la card corrente
                        const presetId = formData.get('preset_id');
                        const selectedCard = document.getElementById(`preset-${presetId}`);
                        if (selectedCard) {
                            selectedCard.classList.add('selected');
                            const selectedBtn = selectedCard.querySelector('.select-preset');
                            if (selectedBtn) {
                                selectedBtn.classList.remove('btn-outline-primary');
                                selectedBtn.classList.add('btn-primary');
                                selectedBtn.textContent = 'Selezionato';
                            }
                        }

                        // Mostra toast di conferma
                        showToast(data.message || 'Configurazione selezionata con successo', 'success');

                        // Ricarica la pagina per aggiornare tutti i valori
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                    showToast('Si è verificato un errore durante la selezione della configurazione.', 'danger');
                });
            });
        });

        // Salva le impostazioni personalizzate
        document.getElementById('save-settings-btn').addEventListener('click', function() {
            const form = document.getElementById('rag-params-form');
            const formData = new FormData(form);

            // Mostra indicatore di caricamento
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Salvataggio...';

            // Invia richiesta AJAX
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Ripristina il pulsante
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save me-1"></i> Salva configurazione';

                if (data.success) {
                    showToast(data.message || 'Configurazione salvata con successo', 'success');
                } else {
                    showToast(data.error || 'Errore durante il salvataggio della configurazione', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save me-1"></i> Salva configurazione';
                showToast('Si è verificato un errore durante il salvataggio della configurazione.', 'danger');
            });
        });

        // Salva le impostazioni avanzate
        document.getElementById('save-advanced-btn').addEventListener('click', function() {
            const form = document.getElementById('advanced-prompt-form');
            const formData = new FormData(form);

            // Mostra indicatore di caricamento
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Salvataggio...';

            // Invia richiesta AJAX
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Ripristina il pulsante
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save me-1"></i> Salva impostazioni avanzate';

                if (data.success) {
                    showToast(data.message || 'Impostazioni avanzate salvate con successo', 'success');
                } else {
                    showToast(data.error || 'Errore durante il salvataggio delle impostazioni avanzate', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save me-1"></i> Salva impostazioni avanzate';
                showToast('Si è verificato un errore durante il salvataggio delle impostazioni avanzate.', 'danger');
            });
        });

        // Reset ai valori predefiniti
        document.getElementById('reset-defaults-btn').addEventListener('click', function() {
            // Conferma reset
            if (!confirm('Sei sicuro di voler ripristinare i valori predefiniti? Questo annullerà tutte le personalizzazioni.')) {
                return;
            }

            // Trova il preset predefinito per il template attivo
            const activeTab = document.querySelector('.nav-link.active');
            if (!activeTab) return;

            const templateType = activeTab.textContent.trim();
            const defaultPreset = document.querySelector(`#content-${templateType.toLowerCase().replace(/\s+/g, '-')} .preset-card .badge.bg-primary`);

            if (defaultPreset) {
                // Clicca sul pulsante di selezione del preset predefinito
                const presetCard = defaultPreset.closest('.preset-card');
                if (presetCard) {
                    const selectButton = presetCard.querySelector('.select-preset');
                    if (selectButton) {
                        selectButton.click();
                    }
                }
            } else {
                showToast('Nessuna configurazione predefinita trovata per questo template.', 'warning');
            }
        });

        // Funzione per mostrare toast di notifica
        function showToast(message, type = 'info') {
            // Crea container per i toast se non esiste
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            // Crea elemento toast
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');

            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Chiudi"></button>
                </div>
            `;

            // Aggiungi al container
            toastContainer.appendChild(toastEl);

            // Inizializza e mostra toast con Bootstrap
            const toast = new bootstrap.Toast(toastEl, {
                autohide: true,
                delay: 3000
            });
            toast.show();

            // Rimuovi dal DOM dopo la chiusura
            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        }
    });
</script>
{% endblock %}