{% extends 'be/base.html' %}

{% load static %}



{% block title %}Configurazione Completa - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Stili generali per la configurazione */
    .config-section {
        margin-bottom: 2rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        overflow: hidden;
        background: white;
    }

    .config-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.25rem;
        border-bottom: 1px solid #dee2e6;
    }

    .config-body {
        padding: 1.5rem;
    }

    /* Stili per le card dei preset */
    .preset-card {
        cursor: pointer;
        transition: all 0.3s ease;
        height: 100%;
        position: relative;
        border: 2px solid transparent;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .preset-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }

    .preset-card.selected {
        border-color: #0d6efd;
        box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.25);
    }

    .preset-badge {
        position: absolute;
        right: -5px;
        top: -5px;
        background: #0d6efd;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        transform: scale(0);
        transition: transform 0.3s ease;
    }

    .preset-card.selected .preset-badge {
        transform: scale(1);
    }

    /* Stili per i motori LLM */
    .engine-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        border-radius: 0.5rem;
        position: relative;
    }

    .engine-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
    }

    .engine-card.selected {
        border-color: #28a745;
        box-shadow: 0 0.25rem 0.5rem rgba(40, 167, 69, 0.25);
    }

    .engine-badge {
        position: absolute;
        right: -5px;
        top: -5px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        transform: scale(0);
        transition: transform 0.3s ease;
    }

    .engine-card.selected .engine-badge {
        transform: scale(1);
    }

    /* Stili per i parametri */
    .param-row {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px dashed rgba(0,0,0,0.1);
    }

    .param-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .param-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .param-description {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .param-value-display {
        font-weight: bold;
        color: #0d6efd;
    }

    /* Stili per gli slider */
    .range-container {
        position: relative;
        margin: 1rem 0;
    }

    .range-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .range-value {
        text-align: center;
        margin-bottom: 0.5rem;
    }

    /* Stili per le tabs */
    .nav-tabs .nav-link {
        border-radius: 0.5rem 0.5rem 0 0;
        margin-right: 0.25rem;
    }

    .nav-tabs .nav-link.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }

    /* Indicatori di stato */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .status-active {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .status-custom {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    /* Tooltips personalizzati */
    .param-help {
        cursor: help;
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .config-header {
            padding: 1rem;
        }

        .config-body {
            padding: 1rem;
        }

        .preset-card,
        .engine-card {
            margin-bottom: 1rem;
        }
    }

    /* Animazioni per il feedback */
    .saving-feedback {
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .saving-feedback.show {
        opacity: 1;
    }

    /* Stili per form avanzati */
    .advanced-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .form-switch .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header della pagina -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-gear-fill text-primary me-2"></i>
                Configurazione Completa
            </h1>
            <p class="text-muted mb-0">
                <strong>{{ project.name }}</strong> - Gestione RAG e Motore LLM
            </p>
        </div>
        <div>
            <a href="{% url 'project' project.id %}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left me-1"></i> Torna al progetto
            </a>
            <a href="{% url 'projects_list' %}" class="btn btn-outline-primary">
                <i class="bi bi-list me-1"></i> Tutti i progetti
            </a>
        </div>
    </div>

    <!-- Messaggi di feedback -->
    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Stato attuale della configurazione -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-diagram-3 text-info me-2"></i>
                        Configurazione RAG
                    </h6>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator {% if is_custom_config %}status-custom{% else %}status-active{% endif %}">
                            {% if is_custom_config %}
                                <i class="bi bi-gear me-1"></i> Personalizzata
                            {% else %}
                                <i class="bi bi-check-circle me-1"></i> {{ current_preset_name|title }}
                            {% endif %}
                        </span>
                    </div>
                    <small class="text-muted d-block mt-1">
                        Chunk: {{ rag_values.chunk_size }} • Top K: {{ rag_values.similarity_top_k }} • Tipo: {{ rag_values.retriever_type|upper }}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-cpu text-success me-2"></i>
                        Motore LLM
                    </h6>
                    {% if current_engine %}
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-active">
                            <i class="bi bi-check-circle me-1"></i> {{ current_engine.name }}
                        </span>
                    </div>
                    <small class="text-muted d-block mt-1">
                        Provider: {{ current_engine.provider.name }} • Temp: {{ engine_parameters.temperature }} • Tokens: {{ engine_parameters.max_tokens }}
                    </small>
                    {% else %}
                    <div class="text-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Nessun motore configurato
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs di configurazione -->
    <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="rag-presets-tab" data-bs-toggle="tab" data-bs-target="#rag-presets" type="button" role="tab">
                <i class="bi bi-collection me-1"></i> Preset RAG
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rag-custom-tab" data-bs-toggle="tab" data-bs-target="#rag-custom" type="button" role="tab">
                <i class="bi bi-sliders me-1"></i> RAG Personalizzato
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="llm-config-tab" data-bs-toggle="tab" data-bs-target="#llm-config" type="button" role="tab">
                <i class="bi bi-cpu me-1"></i> Motore LLM
            </button>
        </li>
    </ul>

    <!-- Contenuto delle tabs -->
    <div class="tab-content" id="configTabsContent">

        <!-- Tab Preset RAG -->
        <div class="tab-pane fade show active" id="rag-presets" role="tabpanel">
            <div class="config-section">
                <div class="config-header">
                    <h5 class="mb-1">
                        <i class="bi bi-collection text-primary me-2"></i>
                        Configurazioni RAG Predefinite
                    </h5>
                    <p class="text-muted mb-0">Scegli una configurazione ottimizzata per il tuo caso d'uso specifico</p>
                </div>
                <div class="config-body">
                    <div class="row row-cols-1 row-cols-md-2 g-4">
                        {% for preset in rag_presets %}
                        <div class="col">
                            <div class="card preset-card {% if current_preset_name == preset.name %}selected{% endif %}"
                                 data-preset="{{ preset.name }}">
                                <div class="preset-badge">
                                    <i class="bi bi-check"></i>
                                </div>
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">{{ preset.display_name }}</h6>
                                        {% if preset.recommended %}
                                        <span class="badge bg-success">Consigliato</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">{{ preset.description }}</p>

                                    <!-- Parametri del preset -->
                                    <div class="small text-muted">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Chunk:</strong> {{ preset.params.chunk_size }}<br>
                                                <strong>Overlap:</strong> {{ preset.params.chunk_overlap }}<br>
                                                <strong>Top K:</strong> {{ preset.params.similarity_top_k }}
                                            </div>
                                            <div class="col-6">
                                                <strong>Soglia:</strong> {{ preset.params.similarity_threshold }}<br>
                                                <strong>Lambda:</strong> {{ preset.params.mmr_lambda }}<br>
                                                <strong>Tipo:</strong> {{ preset.params.retriever_type|upper }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer text-center">
                                    <button type="button"
                                            class="btn {% if current_preset_name == preset.name %}btn-primary{% else %}btn-outline-primary{% endif %} apply-preset"
                                            data-preset="{{ preset.name }}">
                                        {% if current_preset_name == preset.name %}
                                            <i class="bi bi-check-circle me-1"></i> Attivo
                                        {% else %}
                                            <i class="bi bi-play-circle me-1"></i> Applica
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab RAG Personalizzato -->
        <div class="tab-pane fade" id="rag-custom" role="tabpanel">
            <div class="config-section">
                <div class="config-header">
                    <h5 class="mb-1">
                        <i class="bi bi-sliders text-warning me-2"></i>
                        Configurazione RAG Personalizzata
                    </h5>
                    <p class="text-muted mb-0">Configura manualmente tutti i parametri del sistema RAG</p>
                </div>
                <div class="config-body">
                    <form id="custom-rag-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="save_custom_rag">

                        <!-- Parametri di Chunking -->
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-scissors me-2"></i>
                            Parametri di Chunking
                        </h6>

                        <!-- Dimensione Chunk -->
                        <div class="param-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="param-label">Dimensione Chunk (caratteri)</label>
                                    <div class="range-container">
                                        <div class="range-value">
                                            <span class="param-value-display" id="chunk-size-value">{{ rag_values.chunk_size }}</span>
                                        </div>
                                        <input type="range" class="form-range" id="chunk-size" name="chunk_size"
                                               min="100" max="2000" step="50" value="{{ rag_values.chunk_size }}">
                                        <div class="range-labels">
                                            <span>100</span>
                                            <span>2000</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="param-description">
                                        <i class="bi bi-info-circle text-info me-1"></i>
                                        Determina la lunghezza di ciascun frammento di testo. Valori più piccoli aumentano la precisione ma richiedono più risorse.
                                    </div>
                                    <div class="small text-muted">
                                        <strong>Suggerimenti:</strong>
                                        <ul class="mb-0">
                                            <li>100-400: Documenti tecnici, massima precisione</li>
                                            <li>400-800: Documenti generali, buon equilibrio</li>
                                            <li>800-2000: Documenti narrativi, velocità</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sovrapposizione Chunk -->
                        <div class="param-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="param-label">Sovrapposizione Chunk (caratteri)</label>
                                    <div class="range-container">
                                        <div class="range-value">
                                            <span class="param-value-display" id="chunk-overlap-value">{{ rag_values.chunk_overlap }}</span>
                                        </div>
                                        <input type="range" class="form-range" id="chunk-overlap" name="chunk_overlap"
                                               min="0" max="500" step="10" value="{{ rag_values.chunk_overlap }}">
                                        <div class="range-labels">
                                            <span>0</span>
                                            <span>500</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="param-description">
                                        <i class="bi bi-info-circle text-info me-1"></i>
                                        Caratteri sovrapposti tra chunk adiacenti. Aiuta a mantenere il contesto tra frammenti.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Parametri di Ricerca -->
                        <h6 class="text-primary mb-3 mt-4">
                            <i class="bi bi-search me-2"></i>
                            Parametri di Ricerca
                        </h6>

                        <!-- Top K -->
                        <div class="param-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="param-label">Top K Risultati</label>
                                    <div class="range-container">
                                        <div class="range-value">
                                            <span class="param-value-display" id="similarity-top-k-value">{{ rag_values.similarity_top_k }}</span>
                                        </div>
                                        <input type="range" class="form-range" id="similarity-top-k" name="similarity_top_k"
                                               min="1" max="20" step="1" value="{{ rag_values.similarity_top_k }}">
                                        <div class="range-labels">
                                            <span>1</span>
                                            <span>20</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="param-description">
                                        <i class="bi bi-info-circle text-info me-1"></i>
                                        Numero di frammenti più rilevanti da utilizzare per generare la risposta.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lambda MMR -->
                        <div class="param-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="param-label">Lambda MMR</label>
                                    <div class="range-container">
                                        <div class="range-value">
                                            <span class="param-value-display" id="mmr-lambda-value">{{ rag_values.mmr_lambda }}</span>
                                        </div>
                                        <input type="range" class="form-range" id="mmr-lambda" name="mmr_lambda"
                                               min="0" max="1" step="0.05" value="{{ rag_values.mmr_lambda }}">
                                        <div class="range-labels">
                                            <span>0 (Diversità)</span>
                                            <span>1 (Rilevanza)</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="param-description">
                                        <i class="bi bi-info-circle text-info me-1"></i>
                                        Bilanciamento tra rilevanza e diversità. Verso 1 = più rilevanza, verso 0 = più diversità.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Soglia Similarità -->
                        <div class="param-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="param-label">Soglia Similarità</label>
                                    <div class="range-container">
                                        <div class="range-value">
                                            <span class="param-value-display" id="similarity-threshold-value">{{ rag_values.similarity_threshold }}</span>
                                        </div>
                                        <input type="range" class="form-range" id="similarity-threshold" name="similarity_threshold"
                                               min="0" max="1" step="0.05" value="{{ rag_values.similarity_threshold }}">
                                        <div class="range-labels">
                                            <span>0 (Permissivo)</span>
                                            <span>1 (Rigoroso)</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="param-description">
                                        <i class="bi bi-info-circle text-info me-1"></i>
                                        Soglia minima di rilevanza per includere un frammento nella risposta.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tipo Retriever -->
                        <div class="param-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="param-label">Tipo di Retriever</label>
                                    <select class="form-select" name="retriever_type">
                                        <option value="mmr" {% if rag_values.retriever_type == 'mmr' %}selected{% endif %}>
                                            MMR (Bilanciato)
                                        </option>
                                        <option value="similarity" {% if rag_values.retriever_type == 'similarity' %}selected{% endif %}>
                                            Similarity (Veloce)
                                        </option>
                                        <option value="similarity_score_threshold" {% if rag_values.retriever_type == 'similarity_score_threshold' %}selected{% endif %}>
                                            Similarity with Threshold (Preciso)
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <div class="param-description">
                                        <i class="bi bi-info-circle text-info me-1"></i>
                                        Strategia di ricerca per trovare i frammenti più rilevanti.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pulsanti di controllo -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" id="reset-to-preset">
                                <i class="bi bi-arrow-counterclockwise me-1"></i> Ripristina preset
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-1"></i> Salva configurazione personalizzata
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tab Motore LLM -->
        <div class="tab-pane fade" id="llm-config" role="tabpanel">
            <!-- Selezione Motore -->
            <div class="config-section mb-4">
                <div class="config-header">
                    <h5 class="mb-1">
                        <i class="bi bi-cpu text-success me-2"></i>
                        Selezione Motore LLM
                    </h5>
                    <p class="text-muted mb-0">Scegli il modello di intelligenza artificiale da utilizzare per questo progetto</p>
                </div>
                <div class="config-body">
                    {% if available_engines %}
                        {% for provider_name, provider_data in engines_by_provider.items %}
                        <div class="mb-4">
                            <h6 class="text-secondary mb-3">
                                <i class="bi bi-building me-2"></i>
                                {{ provider_name }}
                            </h6>
                            <div class="row row-cols-1 row-cols-md-3 g-3">
                                {% for engine in provider_data.engines %}
                                <div class="col">
                                    <div class="card engine-card {% if current_engine.id == engine.id %}selected{% endif %}"
                                         data-engine-id="{{ engine.id }}">
                                        <div class="engine-badge">
                                            <i class="bi bi-check"></i>
                                        </div>
                                        <div class="card-body">
                                            <h6 class="card-title">{{ engine.name }}</h6>
                                            <p class="card-text small text-muted">{{ engine.description|truncatechars:80 }}</p>

                                            <div class="small text-muted">
                                                <div><strong>Modello:</strong> {{ engine.model_id }}</div>
                                                <div><strong>Contesto:</strong> {{ engine.context_window|floatformat:0 }} token</div>
                                                {% if engine.supports_vision %}
                                                <span class="badge bg-info mt-1">Vision</span>
                                                {% endif %}
                                                {% if engine.supports_functions %}
                                                <span class="badge bg-success mt-1">Functions</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="card-footer text-center">
                                            <button type="button"
                                                    class="btn {% if current_engine.id == engine.id %}btn-success{% else %}btn-outline-success{% endif %} select-engine"
                                                    data-engine-id="{{ engine.id }}">
                                                {% if current_engine.id == engine.id %}
                                                    <i class="bi bi-check-circle me-1"></i> Attivo
                                                {% else %}
                                                    <i class="bi bi-play-circle me-1"></i> Seleziona
                                                {% endif %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Nessun motore disponibile</h4>
                        <p class="text-muted">Configura almeno una chiave API per visualizzare i motori disponibili.</p>
                        <a href="{% url 'ia_engine_settings' %}" class="btn btn-primary">
                            <i class="bi bi-key me-1"></i> Configura chiavi API
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Parametri Motore -->
            {% if current_engine %}
            <div class="config-section">
                <div class="config-header">
                    <h5 class="mb-1">
                        <i class="bi bi-sliders text-primary me-2"></i>
                        Parametri Motore: {{ current_engine.name }}
                    </h5>
                    <p class="text-muted mb-0">Personalizza i parametri del motore LLM (lascia vuoto per utilizzare i valori predefiniti)</p>
                </div>
                <div class="config-body">
                    <form id="llm-params-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="save_llm_params">

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="temperature" class="form-label">Temperature</label>
                                    <input type="number" class="form-control" id="temperature" name="temperature"
                                           min="0" max="2" step="0.1"
                                           value="{% if llm_config.temperature %}{{ llm_config.temperature }}{% endif %}"
                                           placeholder="Predefinito: {{ current_engine.default_temperature }}">
                                    <div class="form-text">Controlla la creatività (0 = deterministica, 2 = molto creativa)</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="max-tokens" class="form-label">Max Tokens</label>
                                    <input type="number" class="form-control" id="max-tokens" name="max_tokens"
                                           min="1" max="32000"
                                           value="{% if llm_config.max_tokens %}{{ llm_config.max_tokens }}{% endif %}"
                                           placeholder="Predefinito: {{ current_engine.default_max_tokens }}">
                                    <div class="form-text">Numero massimo di token nella risposta</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="timeout" class="form-label">Timeout (secondi)</label>
                                    <input type="number" class="form-control" id="timeout" name="timeout"
                                           min="10" max="300"
                                           value="{% if llm_config.timeout %}{{ llm_config.timeout }}{% endif %}"
                                           placeholder="Predefinito: {{ current_engine.default_timeout }}">
                                    <div class="form-text">Tempo massimo di attesa per la risposta</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-1"></i> Salva parametri motore
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal di conferma per cambio motore -->
<div class="modal fade" id="engine-change-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Conferma Cambio Motore
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Il cambio di motore LLM comporterà:</p>
                <ul>
                    <li>Ricostruzione dell'indice vettoriale del progetto</li>
                    <li>Possibili variazioni nei risultati delle ricerche</li>
                    <li>Tempo di elaborazione aggiuntivo</li>
                </ul>
                <p class="mb-0"><strong>Vuoi procedere con il cambio di motore?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-warning" id="confirm-engine-change">
                    <i class="bi bi-check-circle me-1"></i> Procedi
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variabili globali
    let selectedEngineId = null;
    let confirmationModal = null;

    // Inizializza modal di conferma
    confirmationModal = new bootstrap.Modal(document.getElementById('engine-change-modal'));

    // ======= GESTIONE PRESET RAG =======

    // Gestione selezione preset
    document.querySelectorAll('.apply-preset').forEach(button => {
        button.addEventListener('click', function() {
            const presetName = this.getAttribute('data-preset');
            applyRagPreset(presetName, this);
        });
    });

    function applyRagPreset(presetName, button) {
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Applicando...';

        const formData = new FormData();
        formData.append('action', 'apply_rag_preset');
        formData.append('preset_name', presetName);
        formData.append('csrfmiddlewaretoken', getCsrfToken());

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = originalText;

            if (data.success) {
                showToast(data.message, 'success');

                // Aggiorna UI preset
                updatePresetSelection(presetName);

                // Ricarica la pagina per aggiornare tutti i valori
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = originalText;
            console.error('Errore:', error);
            showToast('Errore di comunicazione', 'danger');
        });
    }

    function updatePresetSelection(selectedPreset) {
        // Rimuovi selezione da tutte le card
        document.querySelectorAll('.preset-card').forEach(card => {
            card.classList.remove('selected');
            const btn = card.querySelector('.apply-preset');
            if (btn) {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
                btn.innerHTML = '<i class="bi bi-play-circle me-1"></i> Applica';
            }
        });

        // Seleziona la card corrente
        const selectedCard = document.querySelector(`[data-preset="${selectedPreset}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
            const selectedBtn = selectedCard.querySelector('.apply-preset');
            if (selectedBtn) {
                selectedBtn.classList.remove('btn-outline-primary');
                selectedBtn.classList.add('btn-primary');
                selectedBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> Attivo';
            }
        }
    }

    // ======= GESTIONE RAG PERSONALIZZATO =======

    // Aggiorna valori slider in tempo reale
    document.querySelectorAll('input[type="range"]').forEach(slider => {
        const valueDisplay = document.getElementById(slider.id + '-value');
        if (valueDisplay) {
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
            });
        }
    });

    // Gestione form RAG personalizzato
    const customRagForm = document.getElementById('custom-rag-form');
    if (customRagForm) {
        customRagForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';

            const formData = new FormData(this);
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;

                if (data.success) {
                    showToast(data.message, 'success');

                    // Aggiorna indicatore stato a "Personalizzata"
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(data.message, 'danger');
                }
            })
            .catch(error => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                console.error('Errore:', error);
                showToast('Errore di comunicazione', 'danger');
            });
        });
    }

    // Reset a preset
    const resetToPresetBtn = document.getElementById('reset-to-preset');
    if (resetToPresetBtn) {
        resetToPresetBtn.addEventListener('click', function() {
            if (confirm('Ripristinare la configurazione al preset bilanciato?')) {
                applyRagPreset('balanced', this);
            }
        });
    }

    // ======= GESTIONE MOTORE LLM =======

    // Gestione selezione motore
    document.querySelectorAll('.select-engine').forEach(button => {
        button.addEventListener('click', function() {
            selectedEngineId = this.getAttribute('data-engine-id');

            // Se il motore è già selezionato, non fare nulla
            if (this.classList.contains('btn-success')) {
                return;
            }

            // Mostra modal di conferma
            confirmationModal.show();
        });
    });

    // Conferma cambio motore
    const confirmEngineChangeBtn = document.getElementById('confirm-engine-change');
    if (confirmEngineChangeBtn) {
        confirmEngineChangeBtn.addEventListener('click', function() {
            if (selectedEngineId) {
                selectEngine(selectedEngineId, true);
                confirmationModal.hide();
            }
        });
    }

    function selectEngine(engineId, confirmed = false) {
    const formData = new FormData();
    formData.append('action', 'select_llm_engine');
    formData.append('engine_id', engineId);
    formData.append('confirmed_change', confirmed ? 'true' : 'false');
    formData.append('csrfmiddlewaretoken', getCsrfToken());

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');

            // Aggiorna UI motore
            updateEngineSelection(engineId);

            // Mostra sezione parametri LLM
            const llmParamsSection = document.getElementById('llm-parameters-section');
            if (llmParamsSection) {
                llmParamsSection.style.display = 'block';
            }

            // AGGIUNTA: Aggiorna i valori effettivi se forniti
            if (data.updated_values) {
                updateEngineParameters(data.updated_values);
            }

            // RIMUOVI il reload automatico per vedere i cambiamenti subito
            // setTimeout(() => {
            //     window.location.reload();
            // }, 1500);

        } else if (data.require_confirmation) {
            // Dovrebbe aprire il modal, ma è già gestito sopra
            confirmationModal.show();
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        showToast('Errore di comunicazione', 'danger');
    });
}

    function updateEngineSelection(selectedEngineId) {
        // Rimuovi selezione da tutte le card
        document.querySelectorAll('.engine-card').forEach(card => {
            card.classList.remove('selected');
            const btn = card.querySelector('.select-engine');
            if (btn) {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
                btn.innerHTML = '<i class="bi bi-play-circle me-1"></i> Seleziona';
            }
        });

        // Seleziona la card corrente
        const selectedCard = document.querySelector(`[data-engine-id="${selectedEngineId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
            const selectedBtn = selectedCard.querySelector('.select-engine');
            if (selectedBtn) {
                selectedBtn.classList.remove('btn-outline-success');
                selectedBtn.classList.add('btn-success');
                selectedBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> Attivo';
            }
        }
    }

    // funzione per aggiornare i parametri del motore
    function updateEngineParameters(values) {
        console.log('Updating engine parameters:', values);

        // Aggiorna i placeholder
        if (values.default_temperature !== undefined) {
            const tempField = document.getElementById('temperature');
            if (tempField) {
                tempField.placeholder = `Default: ${values.default_temperature}`;
            }
        }

        if (values.default_max_tokens !== undefined) {
            const tokensField = document.getElementById('max_tokens');
            if (tokensField) {
                tokensField.placeholder = `Default: ${values.default_max_tokens}`;
            }
        }

        if (values.default_timeout !== undefined) {
            const timeoutField = document.getElementById('timeout');
            if (timeoutField) {
                timeoutField.placeholder = `Default: ${values.default_timeout}`;
            }
        }

        // Aggiorna la sezione "Valori Effettivi in Uso"
        if (values.effective_temperature !== undefined) {
            updateEffectiveValues(values);
        }

        // Aggiorna i testi delle descrizioni
        updateEngineDescriptions(values);
    }

    // funzione per aggiornare le descrizioni
    function updateEngineDescriptions(values) {
        // Aggiorna il testo delle descrizioni con i nuovi valori default
        const descriptions = document.querySelectorAll('small.form-text');
        descriptions.forEach(desc => {
            const text = desc.textContent;
            if (text.includes('Default motore:')) {
                const input = desc.closest('.form-group').querySelector('input');
                if (input) {
                    if (input.id === 'temperature' && values.default_temperature !== undefined) {
                        desc.innerHTML = `Range: 0.0 - 2.0 (Default motore: ${values.default_temperature})`;
                    } else if (input.id === 'max_tokens' && values.default_max_tokens !== undefined) {
                        desc.innerHTML = `Range: 1 - 32000 (Default motore: ${values.default_max_tokens})`;
                    } else if (input.id === 'timeout' && values.default_timeout !== undefined) {
                        desc.innerHTML = `Range: 10 - 300 secondi (Default motore: ${values.default_timeout}s)`;
                    }
                }
            }
        });
    }

    // ======= GESTIONE PARAMETRI MOTORE LLM =======

    // Gestione form parametri LLM
    const llmParamsForm = document.getElementById('llm-params-form');
    if (llmParamsForm) {
        llmParamsForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';

            const formData = new FormData(this);
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;

                if (data.success) {
                    showToast(data.message, 'success');

                    // Aggiorna i valori effettivi se forniti
                    if (data.updated_values) {
                        updateEffectiveValues(data.updated_values);
                        updatePlaceholders(data.updated_values);
                    }
                } else {
                    showToast(data.message, 'danger');
                }
            })
            .catch(error => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                console.error('Errore:', error);
                showToast('Errore di comunicazione', 'danger');
            });
        });
    }

    // Pulsante per ripristinare ai valori default
    const resetLlmParamsBtn = document.getElementById('reset-llm-params');
    if (resetLlmParamsBtn) {
        resetLlmParamsBtn.addEventListener('click', function() {
            if (confirm('Sei sicuro di voler ripristinare tutti i parametri ai valori predefiniti del motore?')) {
                // Svuota tutti i campi per usare i default
                const temperatureField = document.getElementById('temperature');
                const maxTokensField = document.getElementById('max_tokens');
                const timeoutField = document.getElementById('timeout');

                if (temperatureField) temperatureField.value = '';
                if (maxTokensField) maxTokensField.value = '';
                if (timeoutField) timeoutField.value = '';

                // Invia il form per salvare i valori vuoti
                if (llmParamsForm) {
                    llmParamsForm.dispatchEvent(new Event('submit'));
                }
            }
        });
    }

    // Validazione in tempo reale dei campi
    const temperatureField = document.getElementById('temperature');
    if (temperatureField) {
        temperatureField.addEventListener('input', function() {
            const val = parseFloat(this.value);
            const isValid = isNaN(val) || (val >= 0 && val <= 2);
            this.classList.toggle('is-invalid', !isValid && this.value !== '');
            this.classList.toggle('is-valid', isValid && this.value !== '');
        });
    }

    const maxTokensField = document.getElementById('max_tokens');
    if (maxTokensField) {
        maxTokensField.addEventListener('input', function() {
            const val = parseInt(this.value);
            const isValid = isNaN(val) || (val >= 1 && val <= 32000);
            this.classList.toggle('is-invalid', !isValid && this.value !== '');
            this.classList.toggle('is-valid', isValid && this.value !== '');
        });
    }

    const timeoutField = document.getElementById('timeout');
    if (timeoutField) {
        timeoutField.addEventListener('input', function() {
            const val = parseInt(this.value);
            const isValid = isNaN(val) || (val >= 10 && val <= 300);
            this.classList.toggle('is-invalid', !isValid && this.value !== '');
            this.classList.toggle('is-valid', isValid && this.value !== '');
        });
    }

    // Funzione per aggiornare i valori effettivi nella UI
    function updateEffectiveValues(values) {
        const alertInfo = document.querySelector('.alert-info');
        if (alertInfo) {
            const newContent = `
                <h6><i class="fas fa-info-circle"></i> Valori Effettivi in Uso:</h6>
                <div class="row">
                    <div class="col-md-4"><strong>Temperature:</strong> ${values.effective_temperature}</div>
                    <div class="col-md-4"><strong>Max Tokens:</strong> ${values.effective_max_tokens}</div>
                    <div class="col-md-4"><strong>Timeout:</strong> ${values.effective_timeout}s</div>
                </div>
            `;
            alertInfo.innerHTML = newContent;

            // Animazione per evidenziare l'aggiornamento
            alertInfo.classList.add('border-success');
            setTimeout(() => {
                alertInfo.classList.remove('border-success');
            }, 2000);
        }
    }

    // Funzione per aggiornare i placeholder
    function updatePlaceholders(values) {
        if (values.effective_temperature !== undefined) {
            const tempField = document.getElementById('temperature');
            if (tempField) {
                tempField.placeholder = `Default: ${values.effective_temperature}`;
            }
        }
        if (values.effective_max_tokens !== undefined) {
            const tokensField = document.getElementById('max_tokens');
            if (tokensField) {
                tokensField.placeholder = `Default: ${values.effective_max_tokens}`;
            }
        }
        if (values.effective_timeout !== undefined) {
            const timeoutField = document.getElementById('timeout');
            if (timeoutField) {
                timeoutField.placeholder = `Default: ${values.effective_timeout}`;
            }
        }
    }

    // ======= FUNZIONI UTILITY =======

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    }

    function showToast(message, type = 'info', autoHide = 3000) {
        // Crea container per i toast se non esiste
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        // Crea elemento toast
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');

        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        // Aggiungi al container
        toastContainer.appendChild(toastEl);

        // Inizializza e mostra toast con Bootstrap
        const toast = new bootstrap.Toast(toastEl, {
            autohide: autoHide > 0,
            delay: autoHide
        });
        toast.show();

        // Rimuovi dal DOM dopo la chiusura
        toastEl.addEventListener('hidden.bs.toast', function() {
            toastEl.remove();
        });

        return toast;
    }

    // Inizializza i tooltip se presenti
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}