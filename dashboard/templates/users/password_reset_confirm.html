{% extends 'users/base_users.html' %}
{% load static %}

{% block user_content %}
    {% if form.errors %}
        <div class="vaitony-alert vaitony-alert-error">
            <i class="bi bi-exclamation-triangle" style="margin-right: 0.5rem;"></i>
            <strong>Errori di validazione:</strong>
            {% for key, value in form.errors.items %}
                <br/>{{ key }}: {{ value.0 }}
            {% endfor %}
        </div>
    {% endif %}

    <div class="vaitony-auth-container">
        <div class="vaitony-auth-box">
            <div class="vaitony-auth-card">
                <!-- Header con branding VAITony -->
                <div class="vaitony-auth-header">
                    <div class="vaitony-logo">
                        <i class="bi bi-shield-lock" style="font-size: 2rem;"></i>
                    </div>
                    <h1 class="vaitony-brand vaitony-mb-sm">VAITony</h1>
                    <p class="vaitony-mb-xs" style="opacity: 0.9; font-size: 1rem;">Nuova Password</p>
                </div>

                <!-- Body del form -->
                <div class="vaitony-auth-body">
                    <div class="vaitony-page-header vaitony-mb-lg">
                        <h2 class="vaitony-text-center vaitony-mb-sm" style="color: var(--vaitony-dark); font-size: 1.5rem; font-weight: 600;">
                            Imposta Nuova Password
                        </h2>
                        <p class="vaitony-text-center" style="color: var(--vaitony-gray-600); font-size: 0.95rem; line-height: 1.5;">
                            Scegli una password sicura per proteggere il tuo account VAITony
                        </p>
                    </div>

                    <!-- Security Requirements -->
                    <div class="vaitony-alert vaitony-alert-info vaitony-mb-lg">
                        <i class="bi bi-shield-check" style="margin-right: 0.5rem;"></i>
                        <strong>Requisiti di sicurezza:</strong>
                        <ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem; font-size: 0.85rem;">
                            <li>Almeno 8 caratteri</li>
                            <li>Non deve essere simile alla tua email</li>
                            <li>Non pu√≤ contenere solo numeri</li>
                            <li>Evita password comuni o prevedibili</li>
                        </ul>
                    </div>

                    <form method="post">
                        {% csrf_token %}

                        <div class="vaitony-form-group">
                            <label class="vaitony-form-label" for="newPassword1">
                                <i class="bi bi-lock-fill vaitony-mr-sm"></i>Nuova Password
                            </label>
                            <div class="vaitony-input-group">
                                <input
                                    type="password"
                                    class="vaitony-input"
                                    id="newPassword1"
                                    name="new_password1"
                                    placeholder="Inserisci la nuova password"
                                    required
                                />
                                <i class="bi bi-lock-fill vaitony-input-icon"></i>
                            </div>
                        </div>

                        <div class="vaitony-form-group">
                            <label class="vaitony-form-label" for="newPassword2">
                                <i class="bi bi-shield-check vaitony-mr-sm"></i>Conferma Password
                            </label>
                            <div class="vaitony-input-group">
                                <input
                                    type="password"
                                    class="vaitony-input"
                                    id="newPassword2"
                                    name="new_password2"
                                    placeholder="Ripeti la nuova password"
                                    required
                                />
                                <i class="bi bi-shield-check vaitony-input-icon"></i>
                            </div>
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="vaitony-mb-lg">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.8rem; color: var(--vaitony-gray-600);">Sicurezza password:</span>
                                <span id="password-strength" style="font-size: 0.8rem; font-weight: 600;">Non inserita</span>
                            </div>
                            <div style="height: 4px; background: var(--vaitony-gray-200); border-radius: 2px; overflow: hidden;">
                                <div id="password-strength-bar" style="height: 100%; width: 0%; background: var(--vaitony-gray-400); transition: all 0.3s ease;"></div>
                            </div>
                        </div>

                        <button type="submit" class="vaitony-btn vaitony-btn-gradient vaitony-w-full vaitony-mb-lg">
                            <i class="bi bi-check-circle" style="margin-right: 0.5rem;"></i>
                            Conferma Nuova Password
                        </button>
                    </form>

                    <!-- Security Tips -->
                    <div style="background: var(--vaitony-gray-50); padding: 1.5rem; border-radius: var(--vaitony-radius-lg);">
                        <h3 style="color: var(--vaitony-dark); font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">
                            <i class="bi bi-lightbulb" style="margin-right: 0.5rem; color: var(--vaitony-warning);"></i>
                            Suggerimenti per una password sicura
                        </h3>
                        <div style="color: var(--vaitony-gray-600); font-size: 0.8rem; line-height: 1.5;">
                            <p style="margin-bottom: 0.5rem;">
                                <i class="bi bi-check2" style="margin-right: 0.5rem; color: var(--vaitony-success);"></i>
                                Usa una combinazione di lettere maiuscole e minuscole
                            </p>
                            <p style="margin-bottom: 0.5rem;">
                                <i class="bi bi-check2" style="margin-right: 0.5rem; color: var(--vaitony-success);"></i>
                                Includi numeri e caratteri speciali
                            </p>
                            <p style="margin-bottom: 0;">
                                <i class="bi bi-check2" style="margin-right: 0.5rem; color: var(--vaitony-success);"></i>
                                Evita informazioni personali facilmente reperibili
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Next Steps -->
            <div class="vaitony-text-center vaitony-mt-lg">
                <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: var(--vaitony-radius-lg); max-width: 350px; margin: 0 auto;">
                    <i class="bi bi-arrow-right-circle" style="font-size: 1.2rem; color: var(--vaitony-success); margin-bottom: 0.5rem;"></i>
                    <p style="color: var(--vaitony-gray-600); font-size: 0.75rem; margin: 0; line-height: 1.4;">
                        <strong>Dopo il reset:</strong><br/>
                        Verrai reindirizzato automaticamente alla pagina di login.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Password Strength Checker
        document.addEventListener('DOMContentLoaded', function() {
            const password1 = document.getElementById('newPassword1');
            const strengthText = document.getElementById('password-strength');
            const strengthBar = document.getElementById('password-strength-bar');

            function checkPasswordStrength(password) {
                let score = 0;
                let feedback = 'Debole';
                let color = 'var(--vaitony-error)';

                if (password.length >= 8) score++;
                if (password.match(/[a-z]/)) score++;
                if (password.match(/[A-Z]/)) score++;
                if (password.match(/[0-9]/)) score++;
                if (password.match(/[^a-zA-Z0-9]/)) score++;

                const width = (score / 5) * 100;

                if (score >= 4) {
                    feedback = 'Forte';
                    color = 'var(--vaitony-success)';
                } else if (score >= 3) {
                    feedback = 'Media';
                    color = 'var(--vaitony-warning)';
                } else if (score >= 1) {
                    feedback = 'Debole';
                    color = 'var(--vaitony-error)';
                } else {
                    feedback = 'Molto debole';
                    color = 'var(--vaitony-error)';
                }

                if (password.length === 0) {
                    feedback = 'Non inserita';
                    color = 'var(--vaitony-gray-400)';
                }

                strengthText.textContent = feedback;
                strengthText.style.color = color;
                strengthBar.style.width = width + '%';
                strengthBar.style.background = color;
            }

            password1.addEventListener('input', function() {
                checkPasswordStrength(this.value);
            });
        });
    </script>
{% endblock %}